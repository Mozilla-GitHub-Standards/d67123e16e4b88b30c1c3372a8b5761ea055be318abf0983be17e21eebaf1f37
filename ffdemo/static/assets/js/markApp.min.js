(function(a){a.markApp={modules:{},instances:[],fn:{}};a.fn.markApp=function(){var c=a(this),b=c.data("markApp-context");if(!b||typeof b=="undefined"){b={app:null,$container:c,frameCount:0,width:0,height:0,minWidth:700,minHeight:500,countries:[],mouseX:null,mouseY:null,mouseDown:false,mouseIn:false,modules:{},usersMark:null,translatedStrings:{},locale:window.location.pathname.split("/").length>1?window.location.pathname.split("/")[1]:"en",instance:a.markApp.instances.push(c)-1,evt:{resize:function(){var f=
a(window).width(),i=a(window).height()-(a("header").height()+a("#callout-boxes").height());if(f<b.minWidth)f=b.minWidth;if(i<b.minHeight)i=b.minHeight;b.$container.parent().width(f);b.$container.parent().height(i);b.width=f;b.height=i;a(".autoResize").height(i).width(f).trigger("resize.markApp",[f,i])},mousemove:function(f){b.mouseX=f.layerX;b.mouseY=f.layerY},mousedown:function(f){"preventDefault"in f&&f.preventDefault();b.mouseDown=true},mouseup:function(f){"preventDefault"in f&&f.preventDefault();
b.mouseDown=false},mouseover:function(f){"preventDefault"in f&&f.preventDefault();b.mouseIn=true},mouseout:function(f){"preventDefault"in f&&f.preventDefault();b.mouseX=null;b.mouseY=null;b.mouseIn=false},ready:function(){b.fn.loadTranslations()}},public_fn:{addModule:function(f,i){var j,n={};if(typeof i=="string")j=i;else if(typeof i=="object")for(var p in i){j=p;n=i[p];break}if(a.markApp.modules[j]){f.modules[j]=f.modules[j]||{};"init"in a.markApp.modules[j].fn&&a.markApp.modules[j].fn.init(f,n)}},
unloadModule:function(f,i){if(i=="all")for(i in f.modules){"deinit"in a.markApp.modules[i].fn&&a.markApp.modules[i].fn.deinit(f);delete f.modules[i]}else if(i in f.modules){"deinit"in a.markApp.modules[i].fn&&a.markApp.modules[i].fn.deinit(f);delete f.modules[i]}}},fn:{trigger:function(f,i,j){if(typeof i=="undefined")i={type:"custom"};if(f in b.evt)if(b.evt[f](i)==false)return false;for(var n in b.modules)n in a.markApp.modules&&"evt"in a.markApp.modules[n]&&f in a.markApp.modules[n].evt&&a.markApp.modules[n].evt[f](b,
i,j)},loop:function(){setTimeout(function(){b.fn.loop()},42);b.frameCount++;b.fn.trigger("loop",{},[])},withCountryCodes:function(f){"US"in b.countries?f(b.countries):a.ajax({url:"/media/assets/js/vendor/country_codes.json",dataType:"JSON",success:function(i){b.countries=i;for(var j=0;j<i.length;j++)b.countries[i[j].code]=i[j].name;f(b.countries)},error:function(){}})},showLoader:function(f,i){i=typeof i==="string"?i:"";f=typeof f==="string"?f:b.fn.getString("default-loading-msg");var j=a("<div />").width(b.width).height(b.height).hide().addClass("overlay-wrapper autoResize").addClass(i).attr("id",
"markapp-loader").append(a("<div />").text(f));b.$container.append(j);j.fadeIn("fast")},hideLoader:function(){a("#markapp-loader").fadeOut("fast",function(){a(this).remove()})},showError:function(f){f=typeof f==="string"?f:b.fn.getString("default-error-msg");f=a("<div />").width(b.width).height(b.height).hide().click(function(i){i.preventDefault();b.fn.hideError()}).addClass("overlay-wrapper autoResize").attr("id","markapp-error").append(a("<div />").attr("id","markapp-error-content").append(a("<p />").html(f)));
b.$container.append(f);f.fadeIn("fast")},hideError:function(){a("#markapp-error").fadeOut("fast",function(){a(this).remove()})},loadTranslations:function(){a("div.translated-strings").each(function(){a(this).children().each(function(){var f=a(this);if(f.is("ol")){b.translatedStrings[f.attr("id")]=[];f.children().each(function(){b.translatedStrings[f.attr("id")].push(a(this).html())})}else b.translatedStrings[f.attr("id")]=f.html()})})},getString:function(f,i){return f in b.translatedStrings?typeof b.translatedStrings[f]===
"object"&&typeof i==="number"?b.translatedStrings[f][i]:b.translatedStrings[f]:f},storeData:function(f,i){if(typeof localStorage!="undefined")try{if(typeof i==="object")i=JSON.stringify(i);localStorage.setItem(f,i)}catch(j){}},getData:function(f){if(typeof localStorage!="undefined")if(f=localStorage.getItem(f)){if(f[0]=="{")f=JSON.parse(f);return f}else return false}}};a(window).delayedBind(300,"resize",function(f){return b.fn.trigger("resize",f)}).bind("keydown keypress keyup",function(f){return b.fn.trigger(f.type,
f)}).trigger("resize");b.$container.bind("mousemove mousedown mouseup mouseover mouseout ready swap",function(f){return b.fn.trigger(f.type,f)});b.fn.loop()}var d=a.makeArray(arguments);if(d.length>0){var g=d.shift();if(g in b.public_fn)b.public_fn[g](b,typeof d[0]=="undefined"?{}:d[0])}return c.data("markApp-context",b)}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.linear={defaults:{reference_mark:null,country_code:null,playback:false,is_flagged:false,linear_root:"linear"},config:{marks:{},flaggings:{},orderedMarks:[],leftBuffer:[],rightBuffer:[],bufferSize:20,bufferMinSize:5,scene:null,cameraChange:{},tweens:{},layerManager:null,initialized:false,requestingMarks:false,moreLeft:true,moreRight:true,hoverMark:null,currentMark:null,playbackTimes:{},eventChange:false},
evt:{ready:function(c){modules.linear.fn.initInterface(c)},resize:function(c){c.modules.linear.eventChange=true;c.modules.linear.layerManager.resizeAll(c.width,c.height)},keydown:function(c,b){var d=c.modules.linear;switch(b.keyCode){case 38:b.preventDefault();d.cameraChange.aZ=10;break;case 40:b.preventDefault();d.cameraChange.aZ=-10;break;case 39:b.preventDefault();d.cameraChange.aX=10;modules.linear.fn.hideMarkInformation(c);break;case 37:b.preventDefault();d.cameraChange.aX=-10;modules.linear.fn.hideMarkInformation(c)}},
keyup:function(c,b){var d=c.modules.linear;switch(b.keyCode){case 38:case 40:b.preventDefault();d.cameraChange.aZ=0;break;case 39:case 37:b.preventDefault();d.cameraChange.aX=0}},keypress:function(c,b){switch(b.keyCode){case 38:case 40:case 39:case 37:b.preventDefault()}},mousedown:function(c){var b=c.modules.linear;if(mark=modules.linear.fn.hitTest(c,c.mouseX,c.mouseY))if(mark==b.currentMark)modules.linear.fn.centerCurrentMark(c,function(){modules.linear.fn.showMarkInformation(c)});else b.country_code?
c.app.setLocation("#/"+b.linear_root+"/country/"+b.country_code+"/"+mark.reference):c.app.setLocation("#/"+b.linear_root+"/"+mark.reference)},mousemove:function(c){var b=c.modules.linear;b.eventChange=true;if(mark=modules.linear.fn.hoverTest(c,c.mouseX,c.mouseY,b.hoverMark)){if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=mark;if(b.currentMark&&b.hoverMark.reference==b.currentMark.reference&&b.hoverMark.contributor_name&&a("#mark-information").is(":visible"))a("#contributor-quote-box").fadeIn("fast").css({left:c.mouseX-
15,top:c.mouseY-a("#contributor-quote-box").height()-15});else{a("#contributor-quote-box:visible").fadeOut("fast");b.hoverMark.color="255,111,40"}}else if(b.hoverMark){b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=null;a("#contributor-quote-box:visible").fadeOut("fast")}},loop:function(c){var b=c.modules.linear,d=b.layerManager.layers.drawingLayer,g={x:b.scene.camera.position.x,y:b.scene.camera.position.y,z:b.scene.camera.position.z};if("cameraEase"in b.tweens)TWEEN.update();
else{b.cameraChange.vZ+=b.cameraChange.aZ;b.cameraChange.vX+=b.cameraChange.aX;b.cameraChange.vX*=0.93;b.cameraChange.vZ*=0.93;b.scene.camera.position.x+=b.cameraChange.vX;b.scene.camera.position.z+=b.cameraChange.vZ;var f=modules.linear.fn.closestMark(c);if(f){var i=b.scene.camera.position.y-(f.position.y+f.bHeight/2);if(i!=0&&Math.abs(i)>=10)b.scene.camera.position.y+=i>0?-10:10}}if(!b.eventChange&&g.x==b.scene.camera.position.x&&g.y==b.scene.camera.position.y&&g.z==b.scene.camera.position.z)return false;
if(b.hoverMark&&!modules.linear.fn.hoverTest(c,c.mouseX,c.mouseY,b.hoverMark)){b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=null;a("#contributor-quote-box:visible").fadeOut("fast")}d.clean();modules.linear.fn.updateScene(c,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);modules.linear.fn.updateBuffers(c,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);Mark.renderer.renderScene(b.scene,{cursor:{x:c.mouseX,y:c.mouseY},width:c.width,height:c.height});
b.eventChange=false;for(f in b.scene.timers){c=(new Date).getTime();b.scene.timers[f].end<c&&delete b.scene.timers[f];b.eventChange=true}}},fn:{init:function(c,b){var d=c.modules.linear;if("$linear"in c.modules.linear){b.country_code!=d.country_code&&modules.linear.fn.dumpAllMarks(c);a.extend(d,d,b);for(option in modules.linear.defaults)if(b[option]==null)d[option]=modules.linear.defaults[option];modules.linear.fn.updateInterface(c);modules.linear.fn.initMarks(c)}else{a.extend(d,modules.linear.defaults,
b);a.extend(d,d,modules.linear.config);d.$linear=a("<div />").addClass("linear-container");c.$container.append(d.$linear);d.scene=new Mark.scene;d.cameraChange={aX:0,aY:0,aZ:0,vX:0,vY:0,vZ:0};d.layerManager=new Mark.layerManager(d.$linear.get(0));d.layerManager.addLayer("drawingLayer");d.scene.canvasContext=d.layerManager.layers.drawingLayer.context;c.fn.trigger("resize");d.initialized=true}d.flaggings=c.fn.getData("markFlaggings")||{}},deinit:function(c){var b=c.modules.linear;b.$linear.fadeOut("fast",
function(){b.layerManager.removeAll();b.$linear.remove();b.initialized=false})},initInterface:function(c){var b=c.modules.linear;a("#stats").hide();a("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a, #mark-browsing-next a, #mark-browsing-prev a").click(function(d){d.preventDefault()}).bind("mouseup mouseout",function(d){d.preventDefault();if(a(this).data("mouseDown")){if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))c.modules.linear.cameraChange.aZ=0;else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a"))c.modules.linear.cameraChange.aX=
0;a(this).data("mouseDown",false)}}).bind("mousedown",function(d){d.preventDefault();a(this).data("mouseDown",true);if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))c.modules.linear.cameraChange.aZ=a(this).is("#mark-browsing-zoom-in a")?10:-10;else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a")){c.modules.linear.cameraChange.aX=a(this).is("#mark-browsing-next a")?10:-10;modules.linear.fn.hideMarkInformation(c)}});c.fn.withCountryCodes(function(d){for(var g=a("#country-select"),
f=0;f<d.length;f++){var i=a("<option />").val(d[f].code).text(d[f].name);g.append(i)}g.change(function(){var j=a(this).val();if(j.length!=2&&b.country_code)c.app.setLocation("#/"+b.linear_root+"/");else j.length==2&&j!=b.country_code&&c.app.setLocation("#/"+b.linear_root+"/country/"+j+"/");a(this).blur();c.$container.focus()});b.country_code&&g.val(b.country_code)});a("#mark-information").hide();a("#mark-playback").click(function(d){d.preventDefault();modules.linear.fn.replayCurrentMark(c)});a("#mark-flag").click(function(d){d.preventDefault();
modules.linear.fn.flagCurrentMark(c)});a("#delete-mark").click(function(d){d.preventDefault();modules.linear.fn.deleteCurrentMark(c)});a("#approve-mark-checkbox").change(function(d){d.preventDefault();d=a(this).is(":checked");modules.linear.fn.approveCurrentMark(c,d)});a("#twitter-share").socialShare({share_url:"http://twitter.com/share",share_params:{text:c.fn.getString("twitter-msg")}});a("#facebook-share").socialShare({share_url:"http://www.facebook.com/sharer.php",share_params:{t:c.fn.getString("facebook-msg")}});
modules.linear.fn.updateInterface(c);modules.linear.fn.initMarks(c);a("#sammy #country-select").selectBox({autoWidth:false});a("#sammy #contributor-select").selectBox({autoWidth:false})},initMarks:function(c){var b=c.modules.linear;if(b.reference_mark&&b.reference_mark!="")b.reference_mark in b.marks?modules.linear.fn.jumpToMark(c,b.reference_mark,b.playback):modules.linear.fn.loadMarks(c,{reference:b.reference_mark,include_forward:20,include_back:20,include_mark:1,success:function(d){if(d.success){modules.linear.fn.setupMarks(c,
d.marks);modules.linear.fn.jumpToMark(c,b.reference_mark,b.playback)}else c.fn.showError(b.errorMsg);b.requestingMarks=false}});else modules.linear.fn.loadMarks(c,{offset:0,max:20,success:function(d){if(d.success){modules.linear.fn.setupMarks(c,d.marks);if(firstMark=b.marks[d.marks[0].reference]){b.scene.camera.position.x=-4E3;b.scene.camera.position.z=-3E3;d="cameraEase"in b.tweens?b.tweens.cameraEase:new TWEEN.Tween(b.scene.camera.position);d.to({x:firstMark.bWidth/2,y:firstMark.bHeight/2,z:-1E3},
2E3).onComplete(function(){delete b.tweens.cameraEase;typeof callback==="function"&&callback(this)}).easing(TWEEN.Easing.Quartic.EaseInOut).start();b.tweens.cameraEase=d}}else c.fn.showError(b.errorMsg);b.requestingMarks=false}})},updateInterface:function(c){var b=c.modules.linear,d=c.fn.getData("userMark");d&&(b.country_code?d.country_code==b.country_code:true)?a("#your-mark-link").attr("href","#/"+b.linear_root+"/"+c.fn.getData("userMark").reference).show():a("#your-mark-link").hide();var g={};
if(b.country_code){g.country_code=b.country_code;a("#contributor-select").next().hide();a("#contributor-select-label").hide()}else{a("#contributor-select").next().show();a("#contributor-select-label").show()}a("#mark-browsing-options").is(".country-"+(b.country_code?b.country_code:"all"))||a.ajax({url:"/requests/init_viz_data",data:g,dataType:"JSON",success:function(f){a("#mark-browsing-options").removeAttr("class").addClass("country-"+(b.country_code?b.country_code:"all"));a("#stats-number-of-marks").text(f.total_marks);
a("#stats-number-of-countries").text(f.total_countries);var i=new Date(f.first_mark_at);i=Math.ceil(((new Date).getTime()-i.getTime())/864E5);a("#stats-number-of-days").text(i);a("#stats").fadeIn("fast");if(b.country_code){a("#first-mark-link").attr("href","#/"+b.linear_root+"/country/"+b.country_code+"/"+f.country_first_mark);a("#last-mark-link").attr("href","#/"+b.linear_root+"/country/"+b.country_code+"/"+f.country_last_mark)}else{a("#first-mark-link").attr("href","#/"+b.linear_root+"/"+f.first_mark);
a("#last-mark-link").attr("href","#/"+b.linear_root+"/"+f.last_mark)}a("#mark-browsing").collapsibleMod();a("#stats").collapsibleMod({collapsedHeight:10});if(a("#contributor-select option").size()==1){i=a("#contributor-select");if(f.contributor_marks)for(var j=0;j<f.contributor_marks.length;j++){var n=a("<option />").val(f.contributor_marks[j].reference).text(f.contributor_marks[j].contributor);i.append(n)}i.change(function(){var p=a(this).val();p.length!="label"&&c.app.setLocation("#/"+b.linear_root+
"/"+p);a(this).blur();c.$container.focus()});if(b.country_code){g.country_code=b.country_code;a("#contributor-select").next().hide();a("#contributor-select-label").hide()}else{a("#contributor-select").next().show();a("#contributor-select-label").show()}}}})},dumpAllMarks:function(c){c=c.modules.linear;for(mark in c.marks)delete c.marks[mark];c.scene.objects=[];c.leftBuffer=[];c.rightBuffer=[];c.moreRight=true;c.moreLeft=true;c.scene.camera.position.x=0;c.scene.camera.position.y=0;c.scene.camera.position.z=
-1E3},loadMarks:function(c,b){var d=c.modules.linear,g=b.success;delete b.success;if(d.country_code)b.country_code=d.country_code;var f=b.reference?"/requests/marks_by_reference":"/requests/all_marks";if(d.is_flagged)f="/requests/marks_by_flagged";if(b.reference&&!(b.reference in d.marks)){modules.linear.fn.dumpAllMarks(c);c.fn.showLoader(c.fn.getString("loading-marks-msg"),"overlay-light")}else b.reference||c.fn.showLoader(c.fn.getString("loading-marks-msg"),"overlay-light");a.ajax({url:f,data:b,
dataType:"JSON"}).success(g).success(function(){c.fn.hideLoader()})},setupMarks:function(c,b){var d=c.modules.linear;if(b.length!=0){for(var g=0;g<b.length;g++)b[g].reference in d.marks&&b.shift(g,1);g=[];for(var f in d.marks)g.push([f,d.marks[f].id]);g.sort(function(r,q){return r[1]-q[1]});var i=g.length==0||g[0][1]<b[0].id?d.rightBuffer:d.leftBuffer,j=i==d.leftBuffer?true:false;j&&b.reverse();var n=i.length>0?d.marks[i[j?0:i.length-1]]:d.scene.objects[j?0:d.scene.objects.length-1];for(g=0;g<b.length;g++)if(!(b[g].reference in
d.marks)){var p=JSON.parse(b[g].points_obj_simplified);if(!(!("strokes"in p)||p.strokes.length==0||p.strokes[0].length<2)){f=new Mark.gmlMark(p.strokes,b[g].reference,b[g].country_code,b[g].date_drawn,p.rtl,b[g].id,b[g].is_approved);if(b[g].contributor){f.contributor_name=b[g].contributor;f.extra_info=p.extra_info;f.color="0,139,211"}d.marks[f.reference]=f;n&&f.positionRelativeTo(n,j);j?i.unshift(f.reference):i.push(f.reference);n=f}}}},refillBuffer:function(c,b){var d=c.modules.linear;if(!d.requestingMarks){d.requestingMarks=
true;var g=b==d.leftBuffer,f=null;f=b.length>0?d.marks[b[g?0:b.length-1]]:d.scene.objects[g?0:d.scene.objects.length-1];modules.linear.fn.loadMarks(c,{reference:f.reference,include_forward:g?0:20,include_back:g?20:0,include_mark:0,success:function(i){if(i.success){modules.linear.fn.setupMarks(c,i.marks);if(i.marks.length==0)d[g?"moreLeft":"moreRight"]=false}else d[g?"moreLeft":"moreRight"]=false;d.requestingMarks=false}})}},updateBuffers:function(c,b,d){var g=c.modules.linear;if(g.scene.objects.length!=
0){for(var f=g.scene.objects[0];f&&f.position.x+f.bWidth<b;){g.leftBuffer.push(g.scene.objects.shift().reference);f=g.scene.objects[0]}for(f=g.scene.objects[g.scene.objects.length-1];f&&f.position.x>d;){g.rightBuffer.unshift(g.scene.objects.pop().reference);f=g.scene.objects[g.scene.objects-1]}if(g.leftBuffer.length<5&&g.scene.objects.length>0&&g.moreLeft&&!g.requestingMarks)modules.linear.fn.refillBuffer(c,g.leftBuffer);else g.rightBuffer.length<5&&g.scene.objects.length>0&&g.moreRight&&!g.requestingMarks&&
modules.linear.fn.refillBuffer(c,g.rightBuffer)}},updateScene:function(c,b,d){c=c.modules.linear;if(c.rightBuffer.length>0)for(var g=c.marks[c.rightBuffer[0]];g&&g.position&&g.position.x<d;){c.scene.objects.push(c.marks[c.rightBuffer.shift()]);g=c.rightBuffer[0]}if(c.leftBuffer.length>0)for(g=c.marks[c.leftBuffer[c.leftBuffer.length-1]];g&&g.position&&g.position.x+g.bWidth>b;){c.scene.objects.unshift(c.marks[c.leftBuffer.pop()]);g=c.leftBuffer[c.leftBuffer.length-1]}},jumpToMark:function(c,b,d){var g=
c.modules.linear;g.currentMark=g.marks[b];if(d){var f=(new Date).getTime()*2;g.scene.timers[b]={start:f,end:f+g.currentMark.maxTime,speed:1}}modules.linear.fn.centerCurrentMark(c,function(){d&&modules.linear.fn.replayCurrentMark(c);modules.linear.fn.showMarkInformation(c)})},closestMark:function(c){c=c.modules.linear;for(var b=c.scene.objects[0],d=1;d<c.scene.objects.length;d++){var g=c.scene.objects[d];if(Math.abs(c.scene.camera.position.x-(g.position.x+g.bWidth/2))<Math.abs(c.scene.camera.position.x-
(b.position.x+b.bWidth/2)))b=g}return b},hoverTest:function(c,b,d,g){if(g&&g.renderedBounds&&b>=g.renderedBounds.minX&&b<=g.renderedBounds.maxX&&d>=g.renderedBounds.minY&&d<=g.renderedBounds.maxY)return g;return modules.linear.fn.hitTest(c,b,d)},hitTest:function(c,b,d){c=c.modules.linear;for(var g=0;g<c.scene.objects.length;g++)if(c.scene.objects[g].renderedBounds&&b>=c.scene.objects[g].renderedBounds.minX&&b<=c.scene.objects[g].renderedBounds.maxX&&d>=c.scene.objects[g].renderedBounds.minY&&d<=c.scene.objects[g].renderedBounds.maxY)return c.scene.objects[g];
return false},showMarkInformation:function(c){var b=c.modules.linear;if(!b.currentMark)return false;var d=b.currentMark;a("#mark-id").text(d.id);var g=new Date(d.time),f=[];f.push(c.fn.getString("month-abbreviations",g.getMonth())+" "+g.getDate());f.push(g.getHours()+":"+(String(g.getMinutes()).length==1?"0"+g.getMinutes():g.getMinutes()));d.country_code?c.fn.withCountryCodes(function(i){a("#mark-country").text(" / "+i[d.country_code])}):a("#mark-country").text("");if(d.contributor_name){a("#mark-contributor-name").text("- "+
d.contributor_name);a("#mark-flag").hide();a("#contributor-quote").text(d.extra_info).html("&#8220;"+a("#contributor-quote").text()+"&#8221;");a("#contributor-name").text("- "+d.contributor_name)}else{a("#mark-contributor-name, #contributor-quote, #contributor-name").text("");a("#mark-flag").show()}a("#mark-timestamp").text(f.join(" / "));a("#url-share input").val(window.location.href);if(b.linear_root!="moderate"){a("#twitter-share").data("socialShare-context").share_params.url=window.location.href;
a("#facebook-share").data("socialShare-context").share_params.u=window.location.href}b.linear_root=="moderate"&&a("#approve-mark-checkbox").attr("checked",d.is_approved);b.currentMark.reference in b.flaggings?a("#mark-flag").addClass("disabled"):a("#mark-flag").removeClass("disabled");a("#mark-information").fadeIn("fast")},hideMarkInformation:function(){a("#mark-information").fadeOut("fast")},replayCurrentMark:function(c){c=c.modules.linear;var b=(new Date).getTime();c.eventChange=true;c.scene.timers[c.currentMark.reference]=
{start:b,end:b+c.currentMark.maxTime,speed:1}},flagCurrentMark:function(c){var b=c.modules.linear;b.currentMark.reference in b.flaggings||a.ajax({url:"/requests/flag_mark",data:{reference:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){a("#mark-flag").addClass("disabled");b.flaggings[b.currentMark.reference]=true;c.fn.storeData("markFlaggings",b.flaggings)},error:function(){c.fn.showError(b.errorMsg)}})},deleteCurrentMark:function(c){var b=c.modules.linear;a.ajax({url:"/requests/delete_mark",
data:{reference:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){var d=b.currentMark.reference,g=null;delete b.marks[b.currentMark.reference];b.currentMark=null;for(var f=0;f<b.scene.objects.length;f++)if(!(!g&&b.scene.objects[f].reference!=d)){if(!g){g=f;b.scene.objects.splice(f,1);b.currentMark=b.scene.objects[f]}f==0?b.scene.objects[f].positionToStart():b.scene.objects[f].positionRelativeTo(b.scene.objects[f-1])}c.app.setLocation("#/"+b.linear_root+"/"+b.currentMark.reference);
b.eventChange=true},error:function(){c.fn.showError(b.errorMs)}})},approveCurrentMark:function(c,b){var d=c.modules.linear;a.ajax({url:"/requests/approve_mark",data:{reference:d.currentMark.reference,should_approve:b},type:"POST",dataType:"JSON",success:function(){d.currentMark.is_approved=b},error:function(){c.fn.showError(d.errorMsg)}})},centerCurrentMark:function(c,b){var d=c.modules.linear;if(!d.currentMark)return false;modules.linear.fn.showMarkInformation(c);d.cameraChange.aX=0;d.cameraChange.vX=
0;d.cameraChange.aZ=0;d.cameraChange.vZ=0;var g=Math.abs(d.currentMark.position.x-d.scene.camera.position.x)/2;g=Math.max(1E3,g);var f="cameraEase"in d.tweens?d.tweens.cameraEase:new TWEEN.Tween(d.scene.camera.position);f.to({x:d.currentMark.position.x+d.currentMark.bWidth/2,y:d.currentMark.position.y+d.currentMark.bHeight/2,z:d.currentMark.position.z-1E3},g).onComplete(function(){delete d.tweens.cameraEase;typeof b==="function"&&b(this)}).easing(g>1200?TWEEN.Easing.Quadratic.EaseInOut:TWEEN.Easing.Quartic.EaseInOut).start();
d.tweens.cameraEase=f}}}})(jQuery);
(function(a){a.markApp=a.markApp||{};var c=a.markApp.modules=a.markApp.modules||{};c.capture={defaults:{state:"intro",invite_code:null,locale:null,contributor_type:null},config:{captureLimit:300,layerManager:null,capturedPoints:0,strokes:[],framecount:0,cleanedStrokes:[],lastX:null,lastY:null,captureTime:null,rtl:null,initialized:false,currentStroke:null,mark:null,timeBetweenStrokes:400,events:[]},evt:{resize:function(b){var d=b.modules.capture;d.layerManager.resizeAll(b.width,b.height);if(d.mark&&
d.mark.strokes.length>0)for(var g=0;g<d.mark.strokes.length;g++)c.capture.fn.drawStroke(b,d.mark.strokes[g])},mousemove:function(b){b.mouseDown&&b.modules.capture.state=="drawing"&&c.capture.fn.capturePoint(b)},mousedown:function(b){switch(b.modules.capture.state){case "drawing":a("#location-dialog").is(":visible")&&a("#location-dialog").fadeOut("fast");b.modules.capture.mark||c.capture.fn.startMark(b);b.modules.capture.currentStroke||c.capture.fn.startStroke(b);break;case "intro":b.modules.capture.mark||
c.capture.fn.startMark(b);b.modules.capture.currentStroke||c.capture.fn.startStroke(b);c.capture.fn.endIntro(b)}},mouseup:function(b){b.modules.capture.state=="drawing"&&c.capture.fn.endStroke(b)},ready:function(b){var d=b.modules.capture;a("#markmaker").hide().children().hide();a("#markmaker-reset a").addClass("disabled").bind("mousedown",function(g){g.preventDefault();c.capture.fn.reset(b)});a("#markmaker-submit a").addClass("disabled").bind("mousedown",function(g){g.preventDefault();c.capture.fn.submit(b)});
b.fn.withCountryCodes(function(g){for(var f=a("#markmaker-country"),i=0;i<g.length;i++){var j=a("<option />").val(g[i].code).text(g[i].name);f.append(j)}});a("#markmaker-location a").bind("mousedown",{context:b},c.capture.fn.locationDialogToggle);a("#markmaker-information").bind("mouseover",{context:b},c.capture.fn.informationDialogToggle).bind("mouseout",{context:b},c.capture.fn.informationDialogToggle);d.state=="drawing"&&c.capture.fn.initDrawing(b);a("#sammy #markmaker-country").selectBox({autoWidth:false})},
loop:function(b){var d=b.modules.capture;if(d.initialized){d.frameCount++;c.capture.fn.commonLoop(b);switch(b.modules.capture.state){case "drawing":c.capture.fn.drawLoop(b)}}}},fn:{init:function(b,d){var g=b.modules.capture;if("$capture"in g){if("state"in d){c.capture.fn.reset(b);d.state=="drawing"&&b.mouseDown&&b.fn.trigger("mousedown");g.state=d.state;c.capture.fn.initDrawing(b)}}else{a.extend(g,c.capture.defaults);a.extend(g,d);a.extend(g,c.capture.config);g.$capture=a("<div />").addClass("capture-container");
b.$container.css({zIndex:100,cursor:"none"}).append(g.$capture);g.layerManager=new Mark.layerManager(g.$capture.get(0));g.layerManager.addLayer("drawnLayer");g.layerManager.addLayer("liveDrawingLayer");b.fn.trigger("resize");g.initialized=true}},deinit:function(b){var d=b.modules.capture;d.$capture.fadeOut("fast",function(){d.layerManager.removeAll();d.$capture.remove();d.initialized=false})},initIntro:function(){},initDrawing:function(b){var d=b.modules.capture;if(a("#browse-marks").is(":visible")){a("#browse-marks, #click-anywhere, #intro-main-copy").fadeOut("fast");
a("#markmaker-legal-line").fadeIn("slow")}a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(){a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#location-dialog:visible").size()>0&&a("#location-dialog:visible").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})});a("#markmaker").is(":visible")?a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")}):
a("#markmaker").width(0).show().animate({width:b.width},"slow",function(){a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")});a("#markmaker-legal-line").fadeIn("slow")});if(d.invite_code&&d.contributor_type=="t"){d.captureLimit=1E3;d.$capture.addClass("translator");a("#translator-fields").find("#translator-locale").text("'"+b.locale+"'").end().collapsibleMod().fadeIn("slow")}else if(d.invite_code&&d.contributor_type=="c"){d.$capture.addClass("contributor");
a("#contributor-fields").collapsibleMod().fadeIn("slow")}},endIntro:function(b){b.app.setLocation("#/mark/new")},locationDialogToggle:function(b){b.preventDefault();a("#location-dialog").is(":visible")?a("#location-dialog").fadeOut("fast"):a("#location-dialog").fadeIn("fast").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})},informationDialogToggle:function(b){b.preventDefault();b.type=="mouseout"?a("#information-dialog").fadeOut("fast"):a("#information-dialog").fadeIn("fast").css({bottom:a("#markmaker-information").height()+
36,left:a("#markmaker-information").offset().left-a("#information-dialog").width()+30})},startMark:function(b){var d=b.modules.capture;d.captureTime=(new Date).getTime();d.rtl=b.mouseX>a(window).width()/2;d.mark=new Mark.gmlMark([],"","",d.captureTime,d.rtl);a("#markmaker-submit a, #markmaker-reset a").removeClass("disabled")},endMark:function(b){b.modules.capture.mark.setupVars()},startStroke:function(b){b=b.modules.capture;b.currentStroke=[];if(b.strokes.length>0)b.captureTime=(new Date).getTime()-
(b.strokes[b.strokes.length-1][b.strokes[b.strokes.length-1].length-1].time+b.timeBetweenStrokes)},endStroke:function(b){var d=b.modules.capture;if(d.currentStroke.length>2){d.strokes.push(d.currentStroke);var g=Mark.simplification.simplifyPath(d.currentStroke,1);g=Mark.simplification.weightPath(g,[5,10,20,40]);d.mark.strokes.push(g);d.cleanedStrokes.push(g);c.capture.fn.drawStroke(b,g);d.capturedPoints-=d.currentStroke.length-g.length}d.currentStroke=null},capturePoint:function(b){var d=b.modules.capture;
if(d.capturedPoints>d.captureLimit){b.fn.trigger("mouseup");c.capture.fn.closeShop(b)}else{var g=(new Date).getTime();b=new Mark.gmlPoint(b.mouseX,b.mouseY,g-d.captureTime,0);if(d.currentStroke.length>0){g=d.currentStroke[d.currentStroke.length-1];b.speed=g.speedToPoint(b);b.setAngleFromPoint(g);b.smoothAgainst(g,0.01)}else d.strokes.length>=1&&c.capture.fn.drawGuide(d.layerManager.layers.drawnLayer.context,d.lastX,d.lastY,b.x,b.y);d.currentStroke.push(b);d.lastX=b.x;d.lastY=b.y;d.capturedPoints++}},
reset:function(b){b=b.modules.capture;b.layerManager.layers.liveDrawingLayer.clean();b.layerManager.layers.drawnLayer.clean();b.capturedPoints=0;b.rtl=null;b.mouseDown=false;b.lastX=null;b.lastY=null;b.strokes=[];b.currentStroke=null;b.mark=null;b.captureTime=null;b.state="drawing";a("#markmaker-submit a, #markmaker-reset a").addClass("disabled");a("#markapp").css({cursor:"none"});a("#markmaker-instructions").fadeIn()},closeShop:function(b){var d=b.modules.capture;d.state="preview";c.capture.fn.endMark(b);
d.layerManager.layers.liveDrawingLayer.clean();b=d.layerManager.layers.liveDrawingLayer.context;var g=d.lastX,f=d.lastY;b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();b.dashedLineTo(g,f,d.rtl?0:d.layerManager.layers.liveDrawingLayer.canvas.width,f,[7,5]);b.closePath();b.stroke();a("#markapp").css({cursor:"default"})},submit:function(b){var d=b.modules.capture;if(d.state!="submitting"){d.state!="preview"&&c.capture.fn.closeShop(b);d.state="submitting";a("#markmaker-submit a").addClass("disabled");
var g={};g.rtl=d.rtl;g.strokes=d.strokes;g=JSON.stringify(g);var f=JSON.stringify(d.mark),i=a("#markmaker-country").val()=="label"?"":a("#markmaker-country").val();b.fn.showLoader(b.fn.getString("submitting-mark"));var j={points_obj:g,points_obj_simplified:f,country_code:i};if(d.invite_code&&d.contributor_type=="t"){j.contributor_locale=b.locale;j.invite=d.invite_code}else if(d.invite_code&&d.contributor_type=="c"){j.contributor=a("#contributor-name").val();d.mark.extra_info=a("#contributor-quote").val();
j.points_obj_simplified=JSON.stringify(d.mark);j.invite=d.invite_code}a.ajax({url:"/requests/save_mark",data:j,type:"POST",dataType:"JSON",success:function(n){if(j.contributor_locale)b.app.setLocation("#/linear/");else{b.fn.storeData("userMark",{reference:n.mark_reference,country_code:i});b.app.setLocation("#/linear/"+n.mark_reference+"?playback=true")}b.fn.hideLoader()},error:function(){b.fn.showError(b.fn.getString("submit-error"))}});return false}},drawStroke:function(b,d){var g=b.modules.capture;
Mark.thickBrush(g.layerManager.layers.drawnLayer.context,[d]);g.layerManager.layers.drawnLayer.context.fillStyle="rgba(255,255,255,0.3)";g.layerManager.layers.drawnLayer.context.strokeStyle="rgba(255,255,255,0.3)";Mark.circleBrush(g.layerManager.layers.drawnLayer.context,[d])},drawGuide:function(b,d,g,f,i){b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();b.dashedLineTo(d,g,f,i,[7,5]);b.closePath();b.stroke()},drawCursor:function(b,d,g,f){b.strokeStyle="#ff5400";b.fillStyle="#000000";b.beginPath();
b.moveTo(d,g);b.lineTo(d+1,g-8);b.lineTo(d+20,g-27);b.lineTo(d+23,g-23);b.lineTo(d,g);b.closePath();b.stroke();f*=18.5;f+=4.5;b.beginPath();b.moveTo(d,g);b.lineTo(d+1,g-8);b.lineTo(d+(f-3),g-(f+4));b.lineTo(d+f,g-f);b.lineTo(d,g);b.closePath();b.fill()},commonLoop:function(b){var d=b.modules.capture;d.layerManager.layers.liveDrawingLayer.clean();if(b.mouseIn&&(d.state=="drawing"||d.state=="intro"))c.capture.fn.drawCursor(d.layerManager.layers.liveDrawingLayer.context,b.mouseX,b.mouseY,(d.captureLimit-
d.capturedPoints)/d.captureLimit)},introLoop:function(){},drawLoop:function(b){var d=b.modules.capture;if(d.currentStroke&&d.currentStroke.length>0){Mark.thickBrush(d.layerManager.layers.liveDrawingLayer.context,[d.currentStroke]);d.layerManager.layers.liveDrawingLayer.context.fillStyle="rgba(255,255,255,0.3)";d.layerManager.layers.liveDrawingLayer.context.strokeStyle="rgba(255,255,255,0.3)";Mark.circleBrush(d.layerManager.layers.liveDrawingLayer.context,[d.currentStroke])}if(b.mouseIn)if(!b.mouseDown){var g,
f;if(d.strokes.length==0){g=b.mouseX>a(window).width()/2?d.layerManager.layers.liveDrawingLayer.canvas.width:0;f=b.mouseY}else{g=d.lastX;f=d.lastY}c.capture.fn.drawGuide(d.layerManager.layers.liveDrawingLayer.context,g,f,b.mouseX,b.mouseY)}}}}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.intro={defaults:{reference_mark:null},config:{marks:{},animationMarks:["vVR","myWb"],playbackTimes:{},vizScene:null,textScene:null,layerManager:null,initialized:false,eventChange:false,curLocaleMark:null,animationComplete:false,tweens:{}},evt:{resize:function(c){c.modules.intro.layerManager.resizeAll(c.width,c.height);c.modules.intro.eventChange=true;c.modules.intro.xAnimationComplete&&modules.intro.fn.drawX(c)},
loop:function(c){var b=c.modules.intro;TWEEN.update();b.layerManager.layers.viz.clean();Mark.renderer.renderScene(b.vizScene,{width:c.width,height:c.height});if(b.curLocaleMark||b.xMark){b.layerManager.layers.mainMark.clean();if(b.curLocaleMark){var d=500/b.curLocaleMark.bWidth;Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.curLocaleMark,{offset:{x:c.width/2-115,y:c.height-240},scale:{x:d,y:d,thickness:d},color:"255,84,0",timer:b.textScene.timers[b.curLocaleMark.reference]})}b.xMark&&
Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.xMark,{offset:{x:10,y:-100},scale:{x:(c.width/2-200)/b.xMark.bWidth,y:(c.height+200)/b.xMark.bHeight,thickness:5},color:"0,0,0",timer:b.textScene.timers[b.xMark.reference]})}},ready:function(c){a("#markmaker").hide().children().hide();a.when(modules.intro.fn.initInterface(c),modules.intro.fn.loadMarks(c)).then(function(){modules.intro.fn.runVizPreview(c)}).then(function(){modules.intro.fn.startDomAnimation(c)}).fail(function(){modules.intro.fn.simpleIntro(c)})}},
fn:{init:function(c,b){var d=c.modules.intro;if(d.initialized){a.extend(d,d,b);for(option in modules.intro.defaults)if(b[option]==null)d[option]=modules.intro.defaults[option]}else{a.extend(d,modules.intro.defaults,b);a.extend(d,d,modules.intro.config);d.$intro=a("<div />").addClass("intro-container");c.$container.append(d.$intro);d.vizScene=new Mark.scene;d.textScene=new Mark.scene;d.layerManager=new Mark.layerManager(d.$intro.get(0));d.layerManager.addLayer("viz");d.vizScene.canvasContext=d.layerManager.layers.viz.context;
d.layerManager.addLayer("mainMark");d.textScene.canvasContext=d.layerManager.layers.mainMark.context;d.layerManager.addLayer("X");c.fn.trigger("resize");d.initialized=true}},deinit:function(c){var b=c.modules.intro;b.$intro.fadeOut("fast",function(){b.layerManager.removeAll();b.$intro.remove();b.initialized=false})},initInterface:function(c){a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(b,d,g){b=d/2+485;g=g-140;d=false;a("#markmaker").css("background-position","0 "+g+"px");
if(!a("#markmaker").is(":visible")){d=true;a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"block"})}a("#browse-marks").css({top:g-50,left:b-85});a("#click-anywhere").css({top:g+12,left:b-a("#intro-main-copy").width()});a("#intro-main-copy").css({top:g-a("#intro-main-copy").height()-100,left:b-a("#intro-main-copy").width()});d&&a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"none"})}).trigger("resize.markApp",[c.width,c.height]).width(0).height(c.height)},
loadMarks:function(c){return a.ajax({url:"/requests/get_translated_marks",dataType:"JSON"}).success(function(b){modules.intro.fn.setupMarks(c,b.marks)})},setupMarks:function(c,b){var d=c.modules.intro;if(!(typeof b==="undefined"||b.length==0)){a(d.layerManager.layers.viz.canvas).css("opacity",0);b.sort(function(){return Math.round(Math.random())-0.5});for(var g=null,f=0;f<b.length;f++)try{var i=JSON.parse(b[f].points_obj_simplified),j=new Mark.gmlMark(i.strokes,b[f].reference,b[f].country_code,b[f].date_drawn,
i.rtl,b[f].id,b[f].is_approved);if(!d.currentMark)d.currentMark=j;b[f].reference in d.marks||(d.marks[j.reference]=j);g&&j.positionRelativeTo(g,false);if(b[f].contributor_locale==c.locale||!d.curLocaleMark){var n=(new Date).getTime()*3;d.curLocaleMark=new Mark.gmlMark(i.strokes,b[f].reference,b[f].country_code,b[f].date_drawn,i.rtl,b[f].id,b[f].is_approved);d.textScene.timers[d.curLocaleMark.reference]={start:n,end:n+d.curLocaleMark.maxTime,speed:2}}d.vizScene.objects.push(j);g=j}catch(p){}}},runVizPreview:function(c){var b=
c.modules.intro;if(!(b.vizScene.objects.length<3)){b.vizScene.camera.position.x=-2E3;b.vizScene.camera.position.z=-3E3;c=b.vizScene.objects[b.vizScene.objects.length-2];var d=new TWEEN.Tween(b.vizScene.camera.position);d.to({x:c.position.x+c.bWidth/2,y:c.position.y+c.bHeight/2,z:c.position.z-2E3},6E3).onComplete(function(){delete b.tweens.cameraEase}).easing(TWEEN.Easing.Quartic.EaseInOut).start();b.tweens.cameraEase=d;a(b.layerManager.layers.viz.canvas).animate({opacity:"1"},"slow").delay(2E3).animate({opacity:"0.1"},
"slow");a("#markmaker").delay(3E3)}},startDomAnimation:function(c){a("#markmaker").width(0).show().animate({width:c.width},"slow",function(){modules.intro.fn.startMarkAnimations(c);a("#intro-main-copy").fadeIn("slow");a("#click-anywhere").delay(200).fadeIn("slow");a("#browse-marks").delay(100).fadeIn("slow")})},startMarkAnimations:function(c){var b=c.modules.intro;modules.intro.fn.drawX(c);if(b.curLocaleMark){c=(new Date).getTime()+2E3;b.textScene.timers[b.curLocaleMark.reference]={start:c,end:c+
b.curLocaleMark.maxTime,speed:2}}},drawX:function(c){c=c.modules.intro;c.xMark=new Mark.gmlMark({strokes:[[{x:177,y:0,z:0,time:51,speed:0,angle:0,significance:5},{x:129,y:60,z:0,time:255,speed:0.45069390943299864,angle:0.5880026035475675,significance:1},{x:123,y:65,z:0,time:271,speed:0.4931203163041915,angle:0.7853981633974483,significance:1},{x:103,y:89,z:0,time:339,speed:0.45069390943299864,angle:0.5880026035475675,significance:1},{x:56,y:139,z:0,time:503,speed:0.45073896963561083,angle:0.7853981633974483,
significance:1},{x:38,y:162,z:0,time:584,speed:0.3572203090978693,angle:0.46364760900080615,significance:1},{x:9,y:192,z:0,time:691,speed:0.3535533905932738,angle:0.7853981633974483,significance:1},{x:0,y:206,z:0,time:727,speed:0.45069390943299864,angle:0.5880026035475675,significance:5}],[{x:11,y:23,z:0,time:1178,speed:0,angle:0,significance:5},{x:30,y:49,z:0,time:1246,speed:0.32424352695503,angle:5.639684198386302,significance:1},{x:55,y:77,z:0,time:1321,speed:0.48790367901871773,angle:5.497787143782138,
significance:1},{x:72,y:100,z:0,time:1367,speed:0.5216642390945547,angle:5.695182703632019,significance:1},{x:85,y:113,z:0,time:1408,speed:0.5355917833779965,angle:5.497787143782138,significance:2},{x:154,y:175,z:0,time:1662,speed:0.3311927108182759,angle:5.497787143782138,significance:1},{x:186,y:196,z:0,time:1802,speed:0.2849548128987055,angle:5.497787143782138,significance:5}]],country_code:"",time:1300925747439,rtl:false,maxTime:1802,reference:"",hoverState:false,renderedBounds:null,id:null,contributor_name:null,
extra_info:null,color:"0,0,0",hoverColor:"0,139,211",x:454,y:199,position:{x:0,y:0,z:0},rotationAngle:{x:0,y:0,z:0},sX:0,sY:0,bWidth:186,bHeight:206}.strokes,"xMark");c.textScene.objects.push(c.xMark);var b=(new Date).getTime();c.textScene.timers[c.xMark.reference]={start:b,end:b+c.xMark.maxTime,speed:1}},simpleIntro:function(c){a("#markmaker").width(0).show().animate({width:c.width},"slow",function(){a("#intro-main-copy").fadeIn("slow");a("#click-anywhere").delay(200).fadeIn("slow");a("#browse-marks").delay(100).fadeIn("slow")})}}}})(jQuery);
(function(a){function c(b){return b.replace(/-/g,"--").replace(/ /g,"-")}a.fn.extend({delayedBind:function(b,d,g,f){var i=c(d);return this.each(function(){var j=this;if(!a(this).data("_delayedBindBound-"+i+"-"+b)){a(this).data("_delayedBindBound-"+i+"-"+b,true);a(this).bind(d,function(){var n=a(this).data("_delayedBindTimerID-"+i+"-"+b);typeof n!="undefined"&&clearTimeout(n);n=setTimeout(function(){a(j).trigger("_delayedBind-"+i+"-"+b)},b);a(this).data("_delayedBindTimerID-"+i+"-"+b,n)})}a(this).bind("_delayedBind-"+
i+"-"+b,g,f)})},delayedBindCancel:function(b,d){var g=c(d);return this.each(function(){var f=a(this).data("_delayedBindTimerID-"+g+"-"+b);typeof f!="undefined"&&clearTimeout(f)})},delayedBindUnbind:function(b,d,g){var f=c(d);return this.each(function(){a(this).unbind("_delayedBind-"+f+"-"+b,g)})}})})(jQuery);
(function(a){a.collapsibleMod={cfg:{collapsedClass:"collapsibleMod-collapsed",expandedClass:"collapsibleMod-expanded",$header:null,expandedHeight:0,collapsedHeight:0,$content:null,collapsed:false,stateKey:"",saveState:true},fn:{init:function(c,b){var d=a(c),g=a.extend({},a.collapsibleMod.cfg,b);g.$container=d;g.$header=d.find("h3:first");g.$content=d.children().not("h3:first");g.expandedHeight=g.$content.height();g.$header.bind("click",function(f){f.preventDefault();a.collapsibleMod.fn.toggle(g)});
if(g.saveState&&g.$container.attr("id")!=""&&typeof localStorage!="undefined"){g.stateKey="collapsibleMod-state-"+g.$container.attr("id");a.collapsibleMod.fn.restoreState(g)}else g.saveState=false;g.collapsed?a.collapsibleMod.fn.collapse(g):g.$container.addClass(g.expandedClass);d.data("collapsibleMod-context",g)},collapse:function(c){c.$container.addClass(c.collapsedClass).removeClass(c.expandedClass);c.$content.animate({height:c.collapsedHeight},"fast",function(){c.collapsedHeight==0&&c.$content.hide()});
c.collapsed=true;a.collapsibleMod.fn.saveState(c)},expand:function(c){c.$container.removeClass(c.collapsedClass).addClass(c.expandedClass);c.$content.show().animate({height:c.expandedHeight},"fast");c.collapsed=false;a.collapsibleMod.fn.saveState(c)},saveState:function(c){if(c.saveState)try{localStorage.removeItem(c.stateKey);localStorage.setItem(c.stateKey,c.collapsed)}catch(b){}},restoreState:function(c){if(c.saveState&&localStorage.getItem(c.stateKey))c.collapsed=localStorage.getItem(c.stateKey)===
"true"},toggle:function(c){c.collapsed?a.collapsibleMod.fn.expand(c):a.collapsibleMod.fn.collapse(c)}}};a.fn.collapsibleMod=function(c){return a(this).each(function(){a.collapsibleMod.fn.init(this,c)})}})(jQuery);
(function(a){a.socialShare={cfg:{$link:null,share_url:"http://twitter.com/share",share_title:"Share on Twitter",share_params:{},popupWidth:550,popupHeight:450},fn:{init:function(c,b){var d=a(c),g=a.extend({},a.socialShare.cfg,b);g.$link=d;g.$link.bind("click",function(f){f.preventDefault();a.socialShare.fn.share(g)});d.data("socialShare-context",g)},shareURL:function(c){var b=[];for(param in c.share_params)b.push(param+"="+encodeURIComponent(c.share_params[param]));return c.share_url+"?"+b.join("&")},
share:function(c){window.open(a.socialShare.fn.shareURL(c),c.share_title,"height="+c.popupHeight+",width="+c.popupWidth)}}};a.fn.socialShare=function(c){return a(this).each(function(){a.socialShare.fn.init(this,c)})}})(jQuery);
jQuery&&function(a){a.extend(a.fn,{selectBox:function(c,b){var d=function(l){var m=l.data.select,e=l.data.control;if(a(e).hasClass("ui-selectBox-disabled"))return false;if(a(e).hasClass("ui-selectBox-focus")&&a("#ui-selectBox-dropdown").size()===1){g(l,true);return false}a(".ui-selectBox").not(e).trigger("blur");i(l);l.stopPropagation();a("#ui-selectBox-dropdown").remove();var h=a('<div id="ui-selectBox-dropdown" class="ui-corner-bottom" />'),k=a("<ul />");if(a(m).children("optgroup").size()===0)a(m).children("option").each(function(){var s=
a(this).text()!==""?a(this).text():"\u00a0",u="";if(a(this).attr("disabled"))u+=" ui-selectBox-disabled";a(k).append('<li class="ui-selectBox-option'+u+'">'+q(s)+"</li>")});else{a(h).addClass("ui-selectBox-hasOptgroups");a(m).children("optgroup").each(function(){a(k).append('<li class="ui-selectBox-optgroup">'+q(a(this).attr("label"))+"</li>");a(this).children("option").each(function(){var s=a(this).text()!==""?a(this).text():"\u00a0",u="";if(a(this).attr("disabled"))u+=" ui-selectBox-disabled";a(k).append('<li class="ui-selectBox-option'+
u+'">'+q(s)+"</li>")})})}a(h).append(k);l=a(m)[0].selectedIndex;a(h).find("LI.ui-selectBox-option").eq(l).addClass("ui-selectBox-initial ui-selectBox-current");a(h).find("LI.ui-selectBox-option").hover(function(){a(h).find(".ui-selectBox-current").removeClass("ui-selectBox-current");a(this).addClass("ui-selectBox-current")},function(){a(this).removeClass("ui-selectBox-current")}).click({select:m,control:e},function(s){f(s)}).mouseup({select:m,control:e},function(s){a(s.target).trigger("click")});
a("BODY").append(h);m=a(e).offset();l=a(e).outerHeight();var o=a(e).outerWidth(),t=parseInt(a(h).css("borderLeftWidth"))+parseInt(a(h).css("borderRightWidth"));a(h).css({position:"absolute",zIndex:"999999",top:m.top+l,left:m.left,width:o-t}).show();a(e).removeClass("ui-corner-all").addClass("ui-corner-top");r(h);p(true)},g=function(l,m){var e=l.data.control;a("#ui-selectBox-dropdown").remove();a(e).removeClass("ui-corner-top").addClass("ui-corner-all");m?a(e).focus():j(l)},f=function(l,m){var e=l.data.select,
h=l.data.control;m=m?m:l.target;if(a(m).hasClass("ui-selectBox-disabled"))return false;var k=a(e)[0].selectedIndex;a("#ui-selectBox-dropdown .ui-selectBox-optgroup").remove();var o=a("#ui-selectBox-dropdown").find("LI.ui-selectBox-current").index();if(k!==o){a(e)[0].selectedIndex=o;a(h).find(".ui-selectBox-label").text(a(m).text());a(e).trigger("change")}g(l,true)},i=function(l){var m=l.data.select;l=l.data.control;if(a(l).hasClass("ui-selectBox-disabled"))return true;if(a(l).hasClass("ui-selectBox-focus"))return false;
a(".ui-selectBox.ui-selectBox-focus").removeClass("ui-selectBox-focus");a("#ui-selectBox-dropdown").remove();a(l).addClass("ui-selectBox-focus");a(document).bind("mousedown",{select:m,control:l},j);a(document).bind("keydown",{select:m,control:l},n);a(m).trigger("focus");a(l).focus()},j=function(l){var m=l.data.select,e=l.data.control;if(l.target.id==="ui-selectBox-dropdown"||a(l.target).parents("#ui-selectBox-dropdown").size()===1){a(e).trigger("focus");return false}if(a(e).hasClass("ui-selectBox-focus")){a(e).removeClass("ui-selectBox-focus");
a(document).unbind("mousedown",j);a(document).unbind("keydown",n);a(m).trigger("blur");g(l)}},n=function(l){var m=l.data.select,e=l.data.control,h=a("#ui-selectBox-dropdown");if(a(e).hasClass("ui-selectBox-disabled"))return false;switch(l.keyCode){case 9:j(l);break;case 13:if(a(h).size()===0)return false;m=a(h).find(".ui-selectBox-option");var k=-1;a.each(m,function(t,s){if(a(s).hasClass("ui-selectBox-current"))k=t});k>=0&&f(l,a(m).eq(k));return false;case 27:g(l,true);break;case 38:case 37:case 33:var o=
l.keyCode===33?20:1;if(a(h).size()===0){if(l.altKey){d(l);return false}l=a(m).find("OPTION").size();h=a(m)[0].selectedIndex;for(o=a(m)[0].selectedIndex-o;a(m).find("OPTION").eq(o).attr("disabled")===true&&o>=0;)o--;if(o<0)o=a(m).find("OPTION:not([disabled]):first").index();a(m)[0].selectedIndex=o;if(a(m)[0].selectedIndex===-1){o=0;a(m)[0].selectedIndex=o}l=a(m).find("OPTION:selected").text();if(l==="")l="\u00a0";a(e).find(".ui-selectBox-label").text(l);o!==h&&a(m).trigger("change");return false}m=
a(h).find(".ui-selectBox-option");k=-1;a.each(m,function(t,s){if(a(s).hasClass("ui-selectBox-current"))k=t});k-=o;if(k<0)k=0;a(m).removeClass("ui-selectBox-current");a(m).eq(k).addClass("ui-selectBox-current");p();return false;case 40:case 39:case 34:o=l.keyCode===34?20:1;if(a(h).size()===0){if(l.altKey){d(l);return false}l=a(m).find("OPTION").size();h=a(m)[0].selectedIndex;for(o=a(m)[0].selectedIndex+o;a(m).find("OPTION").eq(o).attr("disabled")===true&&o<=a(m).find("OPTION").size();)o++;if(o>l-1)o=
a(m).find("OPTION:not([disabled]):last").index();a(m)[0].selectedIndex=o;if(a(m)[0].selectedIndex===-1){o=a(m).find("OPTION").size()-1;a(m)[0].selectedIndex=o}l=a(m).find("OPTION:selected").text();if(l==="")l="\u00a0";a(e).find(".ui-selectBox-label").text(l);o!=h&&a(m).trigger("change");return false}m=a(h).find(".ui-selectBox-option");k=-1;a.each(m,function(t,s){if(a(s).hasClass("ui-selectBox-current"))k=t});k+=o;if(k>a(m).size()-1)k=a(m).size()-1;a(m).removeClass("ui-selectBox-current");a(m).eq(k).addClass("ui-selectBox-current");
p();return false;case 36:case 35:if(a(h).size()===0){if(l.altKey){d(l);return false}h=a(m)[0].selectedIndex;o=l.keyCode===36?0:a(m).find("OPTION").size()-1;if(a(m).find("OPTION").eq(o).attr("disabled")===true)o=l.keyCode===36?a(m).find("OPTION:not([disabled]):first").index():a(m).find("OPTION:not([disabled]):last").index();a(m)[0].selectedIndex=o;l=a(m).find("OPTION:selected").text();if(l==="")l="\u00a0";a(e).find(".ui-selectBox-label").text(l);o!=h&&a(m).trigger("change");return false}a(h).find(".ui-selectBox-current").removeClass("ui-selectBox-current");
l.keyCode===36?a(h).find(".ui-selectBox-option:first").addClass("ui-selectBox-current"):a(h).find(".ui-selectBox-option:last").addClass("ui-selectBox-current");p();return false}},p=function(l){var m=a("#ui-selectBox-dropdown");if(a(m).size()===0)return false;var e=a(m).find(".ui-selectBox-current");if(a(e).size()===0)return false;var h=parseInt(a(e).offset().top-a(m).position().top),k=parseInt(h+a(e).outerHeight());if(l)a(m).scrollTop(a(e).offset().top-a(m).offset().top+a(m).scrollTop()-a(m).height()/
2);else{h<0&&a(m).scrollTop(a(e).offset().top-a(m).offset().top+a(m).scrollTop());k>a(m).height()&&a(m).scrollTop(a(e).offset().top+a(e).outerHeight()-a(m).offset().top+a(m).scrollTop()-a(m).height())}},r=function(l){a(l).css("MozUserSelect","none").bind("selectstart",function(){return false}).bind("mousedown",function(){return false});return true},q=function(l){return l.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};switch(c){case "destroy":a(this).each(function(){var l=
a(this),m=a(this).next(".ui-selectBox");if(a(l)[0].tagName.toLowerCase()==="select"){a(m).remove();a(l).removeData("selectBox-options").show()}});return a(this);case "disable":a(this).each(function(){var l=a(this),m=a(this).next(".ui-selectBox");a(l).attr("disabled",true);a(m).addClass("ui-selectBox-disabled")});return a(this);case "enable":a(this).each(function(){var l=a(this),m=a(this).next(".ui-selectBox");a(l).attr("disabled",false);a(m).removeClass("ui-selectBox-disabled")});return a(this);case "setOptions":if(!b)return a(this);
a(this).each(function(){var l=a(this);a(this).next(".ui-selectBox");switch(typeof b){case "string":a(l).html(b);break;case "object":a(l).html("");for(var m in b)if(b[m]!==null)if(typeof b[m]==="object"){var e=a('<optgroup label="'+m+'" />'),h;for(h in b[m])a(e).append('<option value="'+h+'">'+b[m][h]+"</option>");a(l).append(e)}else{e=a('<option value="'+m+'">'+b[m]+"</option>");a(l).append(e)}}m=a(l).data("selectBox-options");a(l).selectBox("destroy");a(l).selectBox(m)});return a(this);case "value":a("#ui-selectBox-dropdown").remove();
a(this).each(function(){var l=a(this),m=a(this).next(".ui-selectBox");a(l).val(b);l=a(l).find(":selected").text();if(l==="")l="\u00a0";a(m).removeClass("ui-corner-top").addClass("ui-corner-all").find(".ui-selectBox-label").text(l)});return a(this);default:a(this).each(function(){c||(c={});var l=a.extend({autoWidth:true},c),m=a(this);if(a(this).next(".ui-selectBox").size()===0){var e=a('<a href="#" class="ui-selectBox ui-corner-all" tabindex="'+parseInt(a(m).attr("tabindex"))+'" />');a(e).addClass(a(m).attr("class")).attr({style:(a(m).attr("style")+
"").replace(/inline/,"inline-block"),title:a(m).attr("title")});a(m).data("selectBox-options",l);if(l.autoWidth){var h="";a(m).find("OPTION").each(function(){if(a(this).text().length>h.length)h=a(this).text()});l=a('<div class="ui-selectBox-dropdown" style="position: absolute; top: -9999em; left: -9999em; width: auto; display: inline-block;" />');var k=a('<li class="ui-selectBox-option">'+q(h)+"</li>");a(l).append(k);a("BODY").append(l);a(e).width(k.outerWidth());a(l).remove()}if(!(a(m)[0].tagName.toLowerCase()!==
"select"||a(m).attr("multiple")===true)){a(m).attr("disabled")===true&&a(e).addClass("ui-selectBox-disabled");l=a(m).find("OPTION:selected").text();if(l==="")l="\u00a0";a(e).append('<span class="ui-selectBox-label">'+q(l)+"</span>");a(e).append('<span class="ui-selectBox-arrow"></span>');a(m).hide().after(e);r(e);a(e).bind("click",function(){return false}).bind("mousedown",{select:m,control:e},d).bind("focus",{select:m,control:e},i).bind("blur",{select:m,control:e},j)}}});return a(this)}}})}(jQuery);
CanvasRenderingContext2D.prototype.dashedLineTo=function(a,c,b,d,g){var f=function(m,e){return m<=e},i=function(m,e){return m>=e},j=function(m,e){return Math.min(m,e)},n=function(m,e){return Math.max(m,e)},p={thereYet:i,cap:j};i={thereYet:i,cap:j};if(c-d>0){i.thereYet=f;i.cap=n}if(a-b>0){p.thereYet=f;p.cap=n}this.moveTo(a,c);f=a;n=c;j=0;for(var r=true;!(p.thereYet(f,b)&&i.thereYet(n,d));){var q=Math.atan2(d-c,b-a),l=g[j];f=p.cap(b,f+Math.cos(q)*l);n=i.cap(d,n+Math.sin(q)*l);r?this.lineTo(f,n):this.moveTo(f,
n);j=(j+1)%g.length;r=!r}};CanvasRenderingContext2D.prototype.dottedArc=function(a,c,b,d,g,f){var i=Math.PI/b/2,j=d;for(d=d+i;d<g;){this.beginPath();this.arc(a,c,b,j,d,f);this.stroke();j=d+i;d=j+i}};
var Mark=function(a){a.layer=function(c,b){this.context=this.canvas=null;this.dirtyRectangles=[];this.layerName=b;this.manager=c;this.clean=function(){if(this.dirtyRectangles.length==0)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);else for(var d=0;d<this.dirtyRectangles.length;d++)this.context.clearRect(d.x,d.y,d.w,d.h)};this.setSize=function(d,g){if(this.canvas.width!=d)this.canvas.width=d;if(this.canvas.height!=g)this.canvas.height=g};this.init=function(){this.canvas=document.createElement("canvas");
this.context=this.canvas.getContext("2d");this.setSize(this.manager.container.scrollWidth,this.manager.container.scrollHeight);this.manager.layerWrapper.appendChild(this.canvas)};this.remove=function(){this.manager.layerWrapper.removeChild(this.canvas)};this.init()};return a}(Mark||{});
Mark=function(a){a.layerManager=function(c){this.container=c;this.layerWrapper=null;this.layers={};this.init=function(){this.layerWrapper=document.createElement("div");this.layerWrapper.className="mark-layerManager";this.container.appendChild(this.layerWrapper)};this.addLayer=function(b){var d=new a.layer(this,b);return this.layers[b]=d};this.removeAll=function(){for(var b in this.layers){this.layers[b].remove();delete this.layers[b]}};this.resizeAll=function(b,d){for(var g in this.layers)this.layers[g].setSize(b,
d)};this.init()};return a}(Mark||{});
Mark=function(a){a.gmlPoint=function(c,b,d,g,f){this.x=c;this.y=b;this.z=typeof f=="integer"?f:0;this.time=d;this.speed=g;this.angle=0;this.significance=1;this.distanceToPoint=function(i){return Math.sqrt(Math.pow(i.x-this.x,2)+Math.pow(i.y-this.y,2))};this.speedToPoint=function(i){return this.distanceToPoint(i)/(i.time-this.time)};this.smoothAgainst=function(i,j){var n=this.distanceToPoint(i);n=j*n;if(Math.abs(this.speed-i.speed)>n)this.speed=this.speed>i.speed?i.speed+n:i.speed-n};this.setAngleFromPoint=
function(i){this.angle=Math.atan2(i.y-this.y,i.x-this.x)+Math.PI/2;this.angle%=2*Math.PI;if(this.angle<0)this.angle=2*Math.PI+this.angle};this.clone=function(){return{x:this.x,y:this.y,z:this.z,time:this.time,significance:this.significance,angle:this.angle,speed:this.speed}};this.getTranslatedPoint=function(i,j){var n=this.clone();n.x+=i;n.y+=j;return n}};return a}(Mark||{});
Mark=function(a){a.simplification={Line:function(c,b){this.p1=c;this.p2=b;this.distanceToPoint=function(d){var g=(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x),f=[];f.push(Math.abs(d.y-g*d.x-(this.p1.y-g*this.p1.x))/Math.sqrt(Math.pow(g,2)+1));f.push(Math.sqrt(Math.pow(d.x-this.p1.x,2)+Math.pow(d.y-this.p1.y,2)));f.push(Math.sqrt(Math.pow(d.x-this.p2.x,2)+Math.pow(d.y-this.p2.y,2)));return f.sort(function(i,j){return i-j})[0]}},douglasPeucker:function(c,b){var d=[];if(c.length<=2)return[c[0]];for(var g=
new a.simplification.Line(c[0],c[c.length-1]),f=0,i=0,j=1;j<=c.length-2;j++){var n=g.distanceToPoint(c[j]);if(n>f){f=n;i=j}}if(f>=b){f=c[i];g.distanceToPoint(f,true);d=d.concat(a.simplification.douglasPeucker(c.slice(0,i+1),b));d=d.concat(a.simplification.douglasPeucker(c.slice(i,c.length),b))}else{f=c[i];g.distanceToPoint(f,true);d=[c[0]]}return d},simplifyPath:function(c,b){var d=a.simplification.douglasPeucker(c,b);d.push(c[c.length-1]);return d},weightPath:function(c,b){for(var d=b.length+1,g=
c;tolerance=b.shift();){g=a.simplification.douglasPeucker(g,tolerance);for(var f=0;f<g.length;f++)g[f].significance++}c[0].significance=d;c[c.length-1].significance=d;return c}};return a}(Mark||{});
Mark=function(a){a.dof=1E4;a.thickMarkBrush=function(c,b,d,g,f,i){g=g?g:"0,0,0";var j=Mark.renderer.translatePoint(b[0][0],d),n={minX:j.x,maxX:j.x,minY:j.y,maxY:j.y};if(!(f&&i&&(j.x>f*2||j.x<-f||j.y>i*2||j.y<-i||j.z>a.dof||j.z<0))){for(f=0;f<b.length;f++)if(!(typeof b[f]=="undefined"||b[f].length<=1))for(var p=null,r=0;r<b[f].length;r++){j=Mark.renderer.translatePoint(b[f][r],d);if(!(j.z&&j.z>a.dof))if(!(j.significance&&j.significance*(a.dof/5)<j.z-500))if(p){c.lineWidth=1;if(r==b[f].length-1)var q=
0,l=0;else{l=9-Math.max(0,Math.pow(j.speed+1,3));if(d.mode=="flatScale"&&d.scale.thickness)l*=d.scale.thickness;else if(j.z)l*=2/j.z*(i/2);if(l<0.1)l=0.1;l+=1;q=Math.cos(j.angle)*l;l=Math.sin(j.angle)*l}c.strokeStyle="rgba("+g+","+(a.dof-j.z)/a.dof+")";c.fillStyle="rgba("+g+","+(a.dof-j.z)/a.dof+")";try{c.beginPath();c.lineWidth=0.5*((a.dof-j.z)/a.dof);c.moveTo(p.x-prevPX-0.5,p.y-prevPY-0.5);c.lineTo(p.x+prevPX-0.5,p.y+prevPY-0.5);c.lineTo(j.x+q-0.5,j.y+l-0.5);c.lineTo(j.x-q-0.5,j.y-l-0.5);c.lineTo(p.x-
prevPX-0.5,p.y-prevPY-0.5);c.fill();c.stroke()}catch(m){}n.minX=j.x<n.minX?j.x:n.minX;n.minY=j.y<n.minY?j.y:n.minY;n.maxX=j.x>n.maxX?j.x:n.maxX;n.maxY=j.y>n.maxY?j.y:n.maxY;p=j;prevPX=q;prevPY=l}else{if(f!=0&&j.z<1500){p=Mark.renderer.translatePoint(b[f-1][b[f-1].length-1],d);if(p.z&&p.z<a.dof){c.strokeStyle="rgba(0,0,0,0.3)";c.lineWidth=1;c.beginPath();c.dashedLineTo(p.x,p.y,j.x,j.y,[6,4]);c.closePath();c.stroke()}}p=j;prevPY=prevPX=0}}return n}};a.connectionBrush=function(c,b,d,g,f,i,j){g={offset:g,
w:i,h:j,mode:"pinhole"};b=Mark.renderer.translatePoint(b,g);g.offset=f;d=Mark.renderer.translatePoint(d,g);if(!((b.x>i||b.x<0||b.y>j||b.y<0)&&(d.x>i||d.x<0||d.y>j||d.y<0)))if(!(b.z&&d.z&&(b.z>a.dof||b.z<0)&&(d.z>a.dof||d.z<0))){c.strokeStyle="rgba(0,0,0,"+(a.dof-b.z)/(a.dof*2)+")";f=3*(2/b.z)*(j/2);if(f<1)f=1;c.lineWidth=f;c.beginPath();c.moveTo(b.x,b.y);c.lineTo(d.x,d.y);c.closePath();c.stroke()}};a.thickBrush=function(c,b,d,g,f){d=d?d:0;g=g?g:0;f=f?f:1;for(var i=0;i<b.length;i++)if(!(typeof b[i]==
"undefined"||b[i].length<=1)){if(i>0){c.strokeStyle="rgba(0,0,0,0.1)";c.lineWidth=1;c.beginPath();c.dashedLineTo(b[i-1][b[i-1].length-1].x+d,b[i-1][b[i-1].length-1].y+g,b[i][0].x+d,b[i][0].y+g,[6,4]);c.closePath();c.stroke()}c.lineWidth=1;c.strokeStyle="#000000";c.fillStyle="#000000";for(var j=0,n=0,p=b[i][0].x,r=b[i][0].y,q=1;q<b[i].length;q++){var l=b[i][q];if(!(l.significance<f)){if(q==b[i].length-1)var m=0,e=0;else{e=9-Math.pow(l.speed+1,3);if(e<0.5)e=0.5;e+=1;m=Math.cos(l.angle)*e;e=Math.sin(l.angle)*
e}try{c.beginPath();c.moveTo(p-j-0.5+d,r-n-0.5+g);c.lineTo(p+j-0.5+d,r+n-0.5+g);c.lineTo(l.x+m-0.5+d,l.y+e-0.5+g);c.lineTo(l.x-m-0.5+d,l.y-e-0.5+g);c.lineTo(p-j-0.5+d,r-n-0.5+g);c.fill();c.stroke()}catch(h){}j=m;n=e;p=l.x;r=l.y;prevAng=l.angle}}}};a.circleMarkBrush=function(c,b,d){for(var g=3,f=0;f<b.length;f++)if(b[f].length!=0)for(var i=0;i<b[f].length;i++){var j=Mark.renderer.translatePoint(b[f][i],d);if(!(j.z&&j.z>a.dof)){g=3*((a.dof-j.z)/a.dof);c.fillStyle="rgba(255,255,255,0.4)";c.strokeStyle=
"rgba(255,255,255,0.4)";c.beginPath();c.arc(j.x,j.y,g,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.lineTo(j.x,j.y)}}};a.circleBrush=function(c,b,d,g,f){d=d?d:0;g=g?g:0;f=f?f:1;for(var i=0;i<b.length;i++)if(b[i].length!=0){c.beginPath();for(var j=0;j<b[i].length;j++){var n=b[i][j];if(!(n.significance<f)){c.beginPath();c.arc(n.x+d,n.y+g,3,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.lineTo(n.x+d,n.y+g)}}}};return a}(Mark||{});
Mark=function(a){a.gmlMark=function(c,b,d,g,f,i,j){this.strokes=c;this.country_code=d;this.time=g;this.rtl=f;this.maxTime=0;this.reference=b;this.hoverState=false;this.renderedBounds=null;this.id=i?i:null;this.is_approved=j;this.extra_info=this.contributor_name=null;this.color="0,0,0";this.y=this.x=0;this.position={x:0,y:0,z:0};this.rotationAngle={x:0,y:0,z:0};this.bHeight=this.bWidth=this.sY=this.sX=0;this.init=function(){this.strokes.length>0&&this.setupVars()};this.setupVars=function(){this.maxTime=
this.lastPoint().time;this.getBoundingBox()};this.leftmostStrokeStart=function(){for(var n=this.strokes[0][0],p=1;p<this.strokes.length;p++){var r=this.strokes[p][0];if(r.x<n.x)lastPoint=r}return n};this.rightmostStrokeEnd=function(){for(var n=this.strokes[0][this.strokes[0].length-1],p=1;p<this.strokes.length;p++){var r=this.strokes[p][this.strokes[p].length-1];if(r.x>n.x)n=r}return n};this.firstPoint=function(){return this.strokes[0][0]};this.lastPoint=function(){return this.strokes[this.strokes.length-
1][this.strokes[this.strokes.length-1].length-1]};this.translatePoint=function(n){var p=n.clone();p.x=this.x+n.x;p.y=this.y+n.y;return p};this.getBoundingBox=function(){var n=this.strokes[0][0],p=n.x,r=n.x,q=n.y;n=n.y;for(var l=0;l<this.strokes.length;l++)for(var m=0;m<this.strokes[l].length;m++){var e=this.strokes[l][m];p=e.x>p?e.x:p;q=e.y>q?e.y:q;r=e.x<r?e.x:r;n=e.y<n?e.y:n}this.bWidth=p-r;this.bHeight=q-n;this.x=r;this.y=n;if(r!=0||n!=0)this.fitPointsToBounds(r,n)};this.fitPointsToBounds=function(n,
p){for(var r=0;r<this.strokes.length;r++)for(var q=0;q<this.strokes[r].length;q++){this.strokes[r][q].x-=n;this.strokes[r][q].y-=p}};this.strokesAtTime=function(n){if(n>this.maxTime)return this.strokes;for(var p=[[]],r=[0,0],q=this.strokes[r[0]][r[1]];q.time<n;){p[p.length-1].push(q);r[1]++;if(this.strokes[r[0]].length==r[1]){r[0]++;r[1]=0;p.push([])}q=this.strokes[r[0]][r[1]]}return p};this.positionRelativeTo=function(n,p){if(p=p?!!p:false){this.position.x=n.position.x-50-this.bWidth;this.position.y=
n.position.y+n.leftmostStrokeStart().y-this.rightmostStrokeEnd().y;this.position.z=n.position.z-this.maxTime/50}else{this.position.x=n.position.x+n.bWidth+this.leftmostStrokeStart().x+50;this.position.y=n.position.y+n.rightmostStrokeEnd().y-this.firstPoint().y;this.position.z=n.position.z+n.maxTime/50}};this.positionToStart=function(){this.position.x=0;this.position.y=0;this.position.z=0};this.init()};return a}(Mark||{});
Mark=function(a){a.scene=function(){this.camera=new Mark.camera;this.objects=[];this.canvasContext=null;this.timers={};this.init=function(){};this.addObject=function(c){this.objects.push(c)};this.removeObject=function(c){this.objects.splice(c,1)};this.update=function(){var c=(new Date).getTime();for(a in this.timers)this.timers[a].end<c&&delete this.timers[a]};this.init()};return a}(Mark||{});
Mark=function(a){a.renderer={translatePoint:function(c,b){var d={flatScale:function(f,i){var j="offset"in i&&"x"in i.offset?i.offset.x:0,n="offset"in i&&"y"in i.offset?i.offset.y:0,p="scale"in i&&"y"in i.scale?i.scale.y:1;f.x*="scale"in i&&"x"in i.scale?i.scale.x:1;f.y*=p;f.x+=j;f.y+=n;return f},pinhole:function(f,i){var j="offset"in i&&"y"in i.offset?i.offset.y:0,n="offset"in i&&"z"in i.offset?i.offset.z:0,p="w"in i?i.w:500,r="h"in i?i.h:500;f.x+="offset"in i&&"x"in i.offset?i.offset.x:0;f.y+=j;
f.z=f.x>0?Math.pow((f.x- -100)/100,2)+n:Math.pow((f.x- -100)/100/2,2)+n;if(f.time)f.z+=f.time/50;j=2/f.z;f.x=f.x*j*(r/2)+p/2;f.y=f.y*j*(r/2)+r/2;return f}},g={x:c.x,y:c.y,z:c.z,time:c.time,significance:c.significance,angle:c.angle,speed:c.speed};return"mode"in b&&b.mode in d?d[b.mode](g,b):d.pinhole(g,b)},strokesAtTime:function(c,b){for(var d=[[]],g=[0,0],f=c[g[0]][g[1]];f.time<b;){d[d.length-1].push(f);g[1]++;if(c[g[0]].length==g[1]){if(c.length==g[0]+1)break;g[0]++;g[1]=0;d.push([])}f=c[g[0]][g[1]]}return d},
renderScene:function(c,b){for(var d=b.width,g=b.height,f=c.objects.length-1;f>=0;f--){var i={x:c.objects[f].position.x-c.camera.position.x,y:c.objects[f].position.y-c.camera.position.y,z:c.objects[f].position.z-c.camera.position.z};colorBase=c.objects[f].color;var j={offset:i,w:b.width,h:b.height,mode:"pinhole"};if(f<c.objects.length-1&&!(c.objects[f].reference in c.timers)){j={x:c.objects[f+1].position.x-c.camera.position.x,y:c.objects[f+1].position.y-c.camera.position.y,z:c.objects[f+1].position.z-
c.camera.position.z};var n={x:c.objects[f].position.x-c.camera.position.x,y:c.objects[f].position.y-c.camera.position.y,z:c.objects[f].position.z-c.camera.position.z},p=c.objects[f+1].leftmostStrokeStart(),r=c.objects[f].rightmostStrokeEnd();Mark.connectionBrush(c.canvasContext,p,r,j,n,d,g)}j={offset:i,w:b.width,h:b.height,mode:"pinhole"};if(c.objects[f].reference in c.timers){if((i=a.renderer.strokesAtTime(c.objects[f].strokes,((new Date).getTime()-c.timers[c.objects[f].reference].start)*c.timers[c.objects[f].reference].speed))&&
i.length>0&&i[0].length>0)c.objects[f].renderedBounds=Mark.thickMarkBrush(c.canvasContext,i,j,colorBase,b.width,b.height)}else c.objects[f].renderedBounds=Mark.thickMarkBrush(c.canvasContext,c.objects[f].strokes,j,colorBase,b.width,b.height)}},renderMark:function(c,b,d){var g={offset:d.offset,scale:d.scale,mode:"flatScale"};if("timer"in d&&d.timer){var f=a.renderer.strokesAtTime(b.strokes,((new Date).getTime()-d.timer.start)*d.timer.speed);if(f&&f.length>0&&f[0].length>0)b.renderedBounds=Mark.thickMarkBrush(c,
f,g,d.color)}else b.renderedBounds=Mark.thickMarkBrush(c,b.strokes,g,d.color)}};return a}(Mark||{});Mark=function(a){a.camera=function(){this.position=new a.vector(0,0,-1E3)};return a}(Mark||{});Mark=function(a){a.vector=function(c,b,d){this.x=c||0;this.y=b||0;this.z=d||0};return a}(Mark||{});
var TWEEN=TWEEN||function(){var a,c,b,d=[];this.add=function(g){d.push(g)};this.remove=function(g){a=d.indexOf(g);a!==-1&&d.splice(a,1)};this.update=function(){a=0;c=d.length;for(b=(new Date).getTime();a<c;)if(d[a].update(b))a++;else{d.splice(a,1);c--}};return this}();
TWEEN.Tween=function(a){var c={},b={},d={},g=1E3,f=0,i=null,j=TWEEN.Easing.Linear.EaseNone,n=null,p=null,r=null;this.to=function(q,l){if(l!==null)g=l;for(var m in q)if(a[m]!==null)d[m]=q[m];return this};this.start=function(){TWEEN.add(this);i=(new Date).getTime()+f;for(var q in d)if(a[q]!==null){c[q]=a[q];b[q]=d[q]-a[q]}return this};this.stop=function(){TWEEN.remove(this);return this};this.delay=function(q){f=q;return this};this.easing=function(q){j=q;return this};this.chain=function(q){n=q};this.onUpdate=
function(q){p=q;return this};this.onComplete=function(q){r=q;return this};this.update=function(q){var l,m;if(q<i)return true;q=(q-i)/g;q=q>1?1:q;m=j(q);for(l in b)a[l]=c[l]+b[l]*m;p!==null&&p.call(a,m);if(q==1){r!==null&&r.call(a);n!==null&&n.start();return false}return true}};TWEEN.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};TWEEN.Easing.Linear.EaseNone=function(a){return a};
TWEEN.Easing.Quadratic.EaseIn=function(a){return a*a};TWEEN.Easing.Quadratic.EaseOut=function(a){return-a*(a-2)};TWEEN.Easing.Quadratic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a;return-0.5*(--a*(a-2)-1)};TWEEN.Easing.Cubic.EaseIn=function(a){return a*a*a};TWEEN.Easing.Cubic.EaseOut=function(a){return--a*a*a+1};TWEEN.Easing.Cubic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a;return 0.5*((a-=2)*a*a+2)};TWEEN.Easing.Quartic.EaseIn=function(a){return a*a*a*a};
TWEEN.Easing.Quartic.EaseOut=function(a){return-(--a*a*a*a-1)};TWEEN.Easing.Quartic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a;return-0.5*((a-=2)*a*a*a-2)};TWEEN.Easing.Quintic.EaseIn=function(a){return a*a*a*a*a};TWEEN.Easing.Quintic.EaseOut=function(a){return(a-=1)*a*a*a*a+1};TWEEN.Easing.Quintic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a*a;return 0.5*((a-=2)*a*a*a*a+2)};TWEEN.Easing.Sinusoidal.EaseIn=function(a){return-Math.cos(a*Math.PI/2)+1};
TWEEN.Easing.Sinusoidal.EaseOut=function(a){return Math.sin(a*Math.PI/2)};TWEEN.Easing.Sinusoidal.EaseInOut=function(a){return-0.5*(Math.cos(Math.PI*a)-1)};TWEEN.Easing.Exponential.EaseIn=function(a){return a==0?0:Math.pow(2,10*(a-1))};TWEEN.Easing.Exponential.EaseOut=function(a){return a==1?1:-Math.pow(2,-10*a)+1};TWEEN.Easing.Exponential.EaseInOut=function(a){if(a==0)return 0;if(a==1)return 1;if((a*=2)<1)return 0.5*Math.pow(2,10*(a-1));return 0.5*(-Math.pow(2,-10*(a-1))+2)};
TWEEN.Easing.Circular.EaseIn=function(a){return-(Math.sqrt(1-a*a)-1)};TWEEN.Easing.Circular.EaseOut=function(a){return Math.sqrt(1- --a*a)};TWEEN.Easing.Circular.EaseInOut=function(a){if((a/=0.5)<1)return-0.5*(Math.sqrt(1-a*a)-1);return 0.5*(Math.sqrt(1-(a-=2)*a)+1)};TWEEN.Easing.Elastic.EaseIn=function(a){var c,b=0.1,d=0.4;if(a==0)return 0;if(a==1)return 1;d||(d=0.3);if(!b||b<1){b=1;c=d/4}else c=d/(2*Math.PI)*Math.asin(1/b);return-(b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/d))};
TWEEN.Easing.Elastic.EaseOut=function(a){var c,b=0.1,d=0.4;if(a==0)return 0;if(a==1)return 1;d||(d=0.3);if(!b||b<1){b=1;c=d/4}else c=d/(2*Math.PI)*Math.asin(1/b);return b*Math.pow(2,-10*a)*Math.sin((a-c)*2*Math.PI/d)+1};
TWEEN.Easing.Elastic.EaseInOut=function(a){var c,b=0.1,d=0.4;if(a==0)return 0;if(a==1)return 1;d||(d=0.3);if(!b||b<1){b=1;c=d/4}else c=d/(2*Math.PI)*Math.asin(1/b);if((a*=2)<1)return-0.5*b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/d);return b*Math.pow(2,-10*(a-=1))*Math.sin((a-c)*2*Math.PI/d)*0.5+1};TWEEN.Easing.Back.EaseIn=function(a){return a*a*(2.70158*a-1.70158)};TWEEN.Easing.Back.EaseOut=function(a){return(a-=1)*a*(2.70158*a+1.70158)+1};
TWEEN.Easing.Back.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*(3.5949095*a-2.5949095);return 0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)};TWEEN.Easing.Bounce.EaseIn=function(a){return 1-TWEEN.Easing.Bounce.EaseOut(1-a)};TWEEN.Easing.Bounce.EaseOut=function(a){return(a/=1)<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375};
TWEEN.Easing.Bounce.EaseInOut=function(a){if(a<0.5)return TWEEN.Easing.Bounce.EaseIn(a*2)*0.5;return TWEEN.Easing.Bounce.EaseOut(a*2-1)*0.5+0.5};
(function(a,c){var b,d=/:([\w\d]+)/g,g=/\?([^#]*)$/,f=function(e){return Array.prototype.slice.call(e)},i=function(e){return Object.prototype.toString.call(e)==="[object Function]"},j=function(e){return Object.prototype.toString.call(e)==="[object Array]"},n=function(e){return decodeURIComponent(e.replace(/\+/g," "))},p=encodeURIComponent,r=function(e){return String(e).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},q=function(e){return function(h,k){return this.route.apply(this,
[e,h,k])}},l={},m=[];b=function(){var e=f(arguments),h,k;b.apps=b.apps||{};if(e.length===0||e[0]&&i(e[0]))return b.apply(b,["body"].concat(e));else if(typeof(k=e.shift())=="string"){h=b.apps[k]||new b.Application;h.element_selector=k;e.length>0&&a.each(e,function(o,t){h.use(t)});h.element_selector!=k&&delete b.apps[k];return b.apps[h.element_selector]=h}};b.VERSION="0.6.3";b.addLogger=function(e){m.push(e)};b.log=function(){var e=f(arguments);e.unshift("["+Date()+"]");a.each(m,function(h,k){k.apply(b,
e)})};if(typeof c.console!="undefined")i(c.console.log.apply)?b.addLogger(function(){c.console.log.apply(c.console,arguments)}):b.addLogger(function(){c.console.log(arguments)});else typeof console!="undefined"&&b.addLogger(function(){console.log.apply(console,arguments)});a.extend(b,{makeArray:f,isFunction:i,isArray:j});b.Object=function(e){return a.extend(this,e||{})};a.extend(b.Object.prototype,{escapeHTML:r,h:r,toHash:function(){var e={};a.each(this,function(h,k){i(k)||(e[h]=k)});return e},toHTML:function(){var e=
"";a.each(this,function(h,k){i(k)||(e+="<strong>"+h+"</strong> "+k+"<br />")});return e},keys:function(e){var h=[],k;for(k in this)if(!i(this[k])||!e)h.push(k);return h},has:function(e){return this[e]&&a.trim(this[e].toString())!=""},join:function(){var e=f(arguments),h=e.shift();return e.join(h)},log:function(){b.log.apply(b,arguments)},toString:function(e){var h=[];a.each(this,function(k,o){if(!i(o)||e)h.push('"'+k+'": '+o.toString())});return"Sammy.Object: {"+h.join(",")+"}"}});b.HashLocationProxy=
function(e,h){this.app=e;this.is_native=false;this._startPolling(h)};b.HashLocationProxy.prototype={bind:function(){var e=this,h=this.app;a(c).bind("hashchange."+this.app.eventNamespace(),function(k,o){if(e.is_native===false&&!o){b.log("native hash change exists, using");e.is_native=true;c.clearInterval(b.HashLocationProxy._interval)}h.trigger("location-changed")});if(!b.HashLocationProxy._bindings)b.HashLocationProxy._bindings=0;b.HashLocationProxy._bindings++},unbind:function(){a(c).unbind("hashchange."+
this.app.eventNamespace());b.HashLocationProxy._bindings--;b.HashLocationProxy._bindings<=0&&c.clearInterval(b.HashLocationProxy._interval)},getLocation:function(){var e=c.location.toString().match(/^[^#]*(#.+)$/);return e?e[1]:""},setLocation:function(e){return c.location=e},_startPolling:function(e){var h=this;if(!b.HashLocationProxy._interval){e||(e=10);var k=function(){var o=h.getLocation();if(!b.HashLocationProxy._last_location||o!=b.HashLocationProxy._last_location)c.setTimeout(function(){a(c).trigger("hashchange",
[true])},13);b.HashLocationProxy._last_location=o};k();b.HashLocationProxy._interval=c.setInterval(k,e)}}};b.Application=function(e){var h=this;this.routes={};this.listeners=new b.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1E3,10);this.context_prototype=function(){b.EventContext.apply(this,arguments)};this.context_prototype.prototype=new b.EventContext;i(e)&&e.apply(this,[this]);this._location_proxy||this.setLocationProxy(new b.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(k,o){h.log(h.toString(),k.cleaned_type,o||{})})};b.Application.prototype=a.extend({},b.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:false,element_selector:"body",debug:false,raise_errors:false,
run_interval_every:50,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(e){return e?a(this.element_selector).find(e):a(this.element_selector)},use:function(){var e=f(arguments),h=e.shift(),k=h||"";try{e.unshift(this);if(typeof h=="string"){k="Sammy."+h;h=b[h]}h.apply(this,e)}catch(o){if(typeof h==="undefined")this.error("Plugin Error: called use() but plugin ("+k.toString()+") is not defined",o);else i(h)?this.error("Plugin Error",o):this.error("Plugin Error: called use() but '"+
k.toString()+"' is not a function",o)}return this},setLocationProxy:function(e){var h=this._location_proxy;this._location_proxy=e;if(this.isRunning()){h&&h.unbind();this._location_proxy.bind()}},route:function(e,h,k){var o=this,t=[],s,u;if(!k&&i(h)){k=h=e;e="any"}e=e.toLowerCase();if(h.constructor==String){for(d.lastIndex=0;(u=d.exec(h))!==null;)t.push(u[1]);h=RegExp("^"+h.replace(d,"([^/]+)")+"$")}if(typeof k=="string")k=o[k];s=function(v){var w={verb:v,path:h,callback:k,param_names:t};o.routes[v]=
o.routes[v]||[];o.routes[v].push(w)};e==="any"?a.each(this.ROUTE_VERBS,function(v,w){s(w)}):s(e);return this},get:q("get"),post:q("post"),put:q("put"),del:q("delete"),any:q("any"),mapRoutes:function(e){var h=this;a.each(e,function(k,o){h.route.apply(h,o)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(e,h,k){var o=this;if(typeof k=="undefined")k=h;h=function(t,s){var u;if(s&&s.context){u=s.context;delete s.context}else u=new o.context_prototype(o,
"bind",t.type,s,t.target);t.cleaned_type=t.type.replace(o.eventNamespace(),"");k.apply(u,[t,s])};this.listeners[e]||(this.listeners[e]=[]);this.listeners[e].push(h);this.isRunning()&&this._listen(e,h);return this},trigger:function(e,h){this.$element().trigger([e,this.eventNamespace()].join("."),[h]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(e,h){if(i(e)){h=e;e={}}this.befores.push([e,h]);return this},after:function(e){return this.bind("event-context-after",
e)},around:function(e){this.arounds.push(e);return this},isRunning:function(){return this._running},helpers:function(e){a.extend(this.context_prototype.prototype,e);return this},helper:function(e,h){this.context_prototype.prototype[e]=h;return this},run:function(e){if(this.isRunning())return false;var h=this;a.each(this.listeners.toHash(),function(k,o){a.each(o,function(t,s){h._listen(k,s)})});this.trigger("run",{start_url:e});this._running=true;this.last_location=null;this.getLocation()==""&&typeof e!=
"undefined"&&this.setLocation(e);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){h._checkLocation()});this.bind("submit",function(k){return h._checkFormSubmission(a(k.target).closest("form"))===false?k.preventDefault():false});a(c).bind("beforeunload",function(){h.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return false;var e=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(e.eventNamespace());
a.each(this.listeners.toHash(),function(h,k){a.each(k,function(o,t){e._unlisten(h,t)})});this._running=false;return this},bindToAllEvents:function(e){var h=this;a.each(this.APP_EVENTS,function(k,o){h.bind(o,e)});a.each(this.listeners.keys(true),function(k,o){h.APP_EVENTS.indexOf(o)==-1&&h.bind(o,e)});return this},routablePath:function(e){return e.replace(g,"")},lookupRoute:function(e,h){var k=this,o=false;this.trigger("lookup-route",{verb:e,path:h});typeof this.routes[e]!="undefined"&&a.each(this.routes[e],
function(t,s){if(k.routablePath(h).match(s.path)){o=s;return false}});return o},runRoute:function(e,h,k,o){var t=this,s=this.lookupRoute(e,h),u,v,w,x,B,A,C;this.log("runRoute",[e,h].join(" "));this.trigger("run-route",{verb:e,path:h,params:k});if(typeof k=="undefined")k={};a.extend(k,this._parseQueryString(h));if(s){this.trigger("route-found",{route:s});if((A=s.path.exec(this.routablePath(h)))!==null){A.shift();a.each(A,function(y,z){if(s.param_names[y])k[s.param_names[y]]=n(z);else{if(!k.splat)k.splat=
[];k.splat.push(n(z))}})}u=new this.context_prototype(this,e,h,k,o);o=this.arounds.slice(0);w=this.befores.slice(0);B=[u].concat(k.splat);v=function(){for(var y;w.length>0;){x=w.shift();if(t.contextMatchesOptions(u,x[0])){y=x[1].apply(u,[u]);if(y===false)return false}}t.last_route=s;u.trigger("event-context-before",{context:u});y=s.callback.apply(u,B);u.trigger("event-context-after",{context:u});return y};a.each(o.reverse(),function(y,z){var D=v;v=function(){return z.apply(u,[D])}});try{C=v()}catch(E){this.error(["500 Error",
e,h].join(" "),E)}return C}else return this.notFound(e,h)},contextMatchesOptions:function(e,h,k){h=h;if(typeof h==="undefined"||h=={})return true;if(typeof k==="undefined")k=true;if(typeof h==="string"||i(h.test))h={path:h};if(h.only)return this.contextMatchesOptions(e,h.only,true);else if(h.except)return this.contextMatchesOptions(e,h.except,false);var o=true,t=true;if(h.path)o=i(h.path.test)?h.path.test(e.path):h.path.toString()===e.path;if(h.verb)t=h.verb===e.verb;return k?t&&o:!(t&&o)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(e){return this._location_proxy.setLocation(e)},swap:function(e){return this.$element().html(e)},templateCache:function(e,h){return typeof h!="undefined"?l[e]=h:l[e]},clearTemplateCache:function(){return l={}},notFound:function(e,h){var k=this.error(["404 Not Found",e,h].join(" "));return e==="get"?k:true},error:function(e,h){h||(h=Error());h.message=[e,h.message].join(" ");this.trigger("error",{message:h.message,error:h});if(this.raise_errors)throw h;else this.log(h.message,h)},
_checkLocation:function(){var e,h;e=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=e){this.last_location=["get",e];h=this.runRoute("get",e)}return h},_getFormVerb:function(e){e=a(e);var h,k;k=e.find('input[name="_method"]');if(k.length>0)h=k.val();h||(h=e[0].getAttribute("method"));if(!h||h=="")h="get";return a.trim(h.toString().toLowerCase())},_checkFormSubmission:function(e){var h,k,o;this.trigger("check-form-submission",{form:e});h=a(e);k=h.attr("action");
o=this._getFormVerb(h);this.log("_checkFormSubmission",h,k,o);if(o==="get"){this.setLocation(k+"?"+this._serializeFormParams(h));e=false}else{h=a.extend({},this._parseFormParams(h));e=this.runRoute(o,k,h,e.get(0))}return typeof e=="undefined"?false:e},_serializeFormParams:function(e){var h="";e=e.serializeArray();var k;if(e.length>0){h=this._encodeFormPair(e[0].name,e[0].value);for(k=1;k<e.length;k++)h=h+"&"+this._encodeFormPair(e[k].name,e[k].value)}return h},_encodeFormPair:function(e,h){return p(e)+
"="+p(h)},_parseFormParams:function(e){var h={};e=e.serializeArray();var k;for(k=0;k<e.length;k++)h=this._parseParamPair(h,e[k].name,e[k].value);return h},_parseQueryString:function(e){var h={},k,o;if(e=e.match(g)){e=e[1].split("&");for(o=0;o<e.length;o++){k=e[o].split("=");h=this._parseParamPair(h,n(k[0]),n(k[1]))}}return h},_parseParamPair:function(e,h,k){if(e[h])if(j(e[h]))e[h].push(k);else e[h]=[e[h],k];else e[h]=k;return e},_listen:function(e,h){return this.$element().bind([e,this.eventNamespace()].join("."),
h)},_unlisten:function(e,h){return this.$element().unbind([e,this.eventNamespace()].join("."),h)}});b.RenderContext=function(e){this.event_context=e;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=false};b.RenderContext.prototype=a.extend({},b.Object.prototype,{then:function(e){if(!i(e))if(typeof e==="string"&&e in this.event_context){var h=this.event_context[e];e=function(o){return h.apply(this.event_context,[o])}}else return this;var k=this;if(this.waiting)this.callbacks.push(e);
else{this.wait();c.setTimeout(function(){var o=e.apply(k,[k.content,k.previous_content]);o!==false&&k.next(o)},13)}return this},wait:function(){this.waiting=true},next:function(e){this.waiting=false;if(typeof e!=="undefined"){this.previous_content=this.content;this.content=e}this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(e,h,k){var o=this;return this.then(function(){var t,s,u;if(i(h)){k=h;h={}}else h=a.extend({},h);k&&this.then(k);if(typeof e==="string"){t=(u=e.match(/\.json$/)||
h.json)&&h.cache===true||h.cache!==false;o.next_engine=o.event_context.engineFor(e);delete h.cache;delete h.json;if(h.engine){o.next_engine=h.engine;delete h.engine}if(t&&(s=this.event_context.app.templateCache(e)))return s;this.wait();a.ajax(a.extend({url:e,data:{},dataType:u?"json":null,type:"get",success:function(v){t&&o.event_context.app.templateCache(e,v);o.next(v)}},h));return false}else{if(e.nodeType)return e.innerHTML;if(e.selector){o.next_engine=e.attr("data-engine");return h.clone===false?
e.remove()[0].innerHTML.toString():e[0].innerHTML.toString()}}})},render:function(e,h,k){if(i(e)&&!h)return this.then(e);else{if(!h&&this.content)h=this.content;return this.load(e).interpolate(h,e).then(k)}},partial:function(e,h){return this.render(e,h).swap()},send:function(){var e=this,h=f(arguments),k=h.shift();if(j(h[0]))h=h[0];return this.then(function(){h.push(function(o){e.next(o)});e.wait();k.apply(k,h);return false})},collect:function(e,h,k){var o=this,t=function(){if(i(e)){h=e;e=this.content}var s=
[],u=false;a.each(e,function(v,w){var x=h.apply(o,[v,w]);if(x.jquery&&x.length==1){x=x[0];u=true}s.push(x);return x});return u?s:s.join("")};return k?t():this.then(t)},renderEach:function(e,h,k,o){if(j(h)){o=k;k=h;h=null}return this.load(e).then(function(t){var s=this;k||(k=j(this.previous_content)?this.previous_content:[]);if(o)a.each(k,function(u,v){var w={},x=this.next_engine||e;h?w[h]=v:w=v;o(v,s.event_context.interpolate(t,w,x))});else return this.collect(k,function(u,v){var w={},x=this.next_engine||
e;h?w[h]=v:w=v;return this.event_context.interpolate(t,w,x)},true)})},interpolate:function(e,h,k){var o=this;return this.then(function(t,s){if(!e&&s)e=s;if(this.next_engine){h=this.next_engine;this.next_engine=false}var u=o.event_context.interpolate(t,e,h);return k?s+u:u})},swap:function(){return this.then(function(e){this.event_context.swap(e)}).trigger("changed",{})},appendTo:function(e){return this.then(function(h){a(e).append(h)}).trigger("changed",{})},prependTo:function(e){return this.then(function(h){a(e).prepend(h)}).trigger("changed",
{})},replace:function(e){return this.then(function(h){a(e).html(h)}).trigger("changed",{})},trigger:function(e,h){return this.then(function(k){if(typeof h=="undefined")h={content:k};this.event_context.trigger(e,h)})}});b.EventContext=function(e,h,k,o,t){this.app=e;this.verb=h;this.path=k;this.params=new b.Object(o);this.target=t};b.EventContext.prototype=a.extend({},b.Object.prototype,{$element:function(){return this.app.$element(f(arguments).shift())},engineFor:function(e){var h;if(i(e))return e;
e=(e||this.app.template_engine).toString();if(h=e.match(/\.([^\.]+)$/))e=h[1];if(e&&i(this[e]))return this[e];if(this.app.template_engine)return this.engineFor(this.app.template_engine);return function(k){return k}},interpolate:function(e,h,k){return this.engineFor(k).apply(this,[e,h])},render:function(e,h,k){return(new b.RenderContext(this)).render(e,h,k)},renderEach:function(e,h,k,o){return(new b.RenderContext(this)).renderEach(e,h,k,o)},load:function(e,h,k){return(new b.RenderContext(this)).load(e,
h,k)},partial:function(e,h){return(new b.RenderContext(this)).partial(e,h)},send:function(){var e=new b.RenderContext(this);return e.send.apply(e,arguments)},redirect:function(){var e;e=f(arguments);var h=this.app.getLocation();if(e.length>1){e.unshift("/");e=this.join.apply(this,e)}else e=e[0];this.trigger("redirect",{to:e});this.app.last_location=[this.verb,this.path];this.app.setLocation(e);h==e&&this.app.trigger("location-changed")},trigger:function(e,h){if(typeof h=="undefined")h={};if(!h.context)h.context=
this;return this.app.trigger(e,h)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(e){return this.app.swap(e)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(e){return a.parseJSON(e)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});a.sammy=c.Sammy=b})(jQuery,window);
Sammy.HashPushProxy=function(a,c){this.app=a;this.supportsHistory=!!(window.history&&history.pushState);if(!this.supportsHistory){this._startPolling(c);this.is_native=false}};
Sammy.HashPushProxy.prototype={bind:function(){var a=this,c=this.app;if(this.app.supportsHistory){$(window).bind("popstate",function(){a.app.trigger("location-changed")});$("a").live("click",function(b){if(location.hostname==this.hostname){b.preventDefault();a.historyAPISupported?a.setLocation($(this).attr("href")):a.setLocation("#"+$(this).attr("href"));a.app.trigger("location-changed")}})}else{$(window).bind("hashchange."+this.app.eventNamespace(),function(b,d){if(a.is_native===false&&!d){Sammy.log("native hash change exists, using");
a.is_native=true;window.clearInterval(Sammy.HashLocationProxy._interval)}c.trigger("location-changed")});if(!Sammy.HashLocationProxy._bindings)Sammy.HashLocationProxy._bindings=0;Sammy.HashLocationProxy._bindings++}},unbind:function(){if(this.app.supportsHistory){$("a").unbind("click");$(window).unbind("popstate")}else{$(window).unbind("hashchange."+this.app.eventNamespace());Sammy.HashLocationProxy._bindings--;Sammy.HashLocationProxy._bindings<=0&&window.clearInterval(Sammy.HashLocationProxy._interval)}},
getLocation:function(){if(this.app.supportsHistory)return window.location.pathname;else{var a=window.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""}},setLocation:function(a){if(this.app.supportsHistory)history.pushState({path:this.path},"",a);else return window.location=a},_startPolling:function(a){var c=this;if(!Sammy.HashLocationProxy._interval){a||(a=10);var b=function(){var d=c.getLocation();if(!Sammy.HashLocationProxy._last_location||d!=Sammy.HashLocationProxy._last_location)window.setTimeout(function(){$(window).trigger("hashchange",
[true])},13);Sammy.HashLocationProxy._last_location=d};b();Sammy.HashLocationProxy._interval=window.setInterval(b,a)}}};
(function(a){var c={};Sammy=Sammy||{};Sammy.Template=function(b,d){d||(d="template");b.helper(d,function(g,f,i,j){if(typeof i=="undefined")i=g;if(typeof j=="undefined"&&typeof i=="object"){j=i;i=g}a:{f=a.extend({},this,f);if(c[i])g=c[i];else{if(typeof g=="undefined"){g=false;break a}j=j&&j.escape_html===false?'",$1,"':'",h($1),"';g=c[i]=new Function("obj",'var ___$$$___=[],print=function(){___$$$___.push.apply(___$$$___,arguments);};with(obj){___$$$___.push("'+String(g).replace(/[\r\t\n]/g," ").replace(/\"/g,
'\\"').split("<%").join("\t").replace(/((^|%>)[^\t]*)/g,"$1\r").replace(/\t=(.*?)%>/g,j).replace(/\t!(.*?)%>/g,'",$1,"').split("\t").join('");').split("%>").join('___$$$___.push("').split("\r").join("")+"\");}return ___$$$___.join('');")}g=typeof f!="undefined"?g(f):g}return g})}})(jQuery);
