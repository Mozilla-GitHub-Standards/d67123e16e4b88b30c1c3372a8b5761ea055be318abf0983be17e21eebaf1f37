(function(a){a.markApp={modules:{},instances:[],fn:{}};a.fn.markApp=function(){var e=a(this),b=e.data("markApp-context");if(!b||typeof b=="undefined")b={app:null,$container:e,frameCount:0,width:0,height:0,timezoneOffset:4,minWidth:700,minHeight:500,countries:[],mouseX:null,mouseY:null,mouseDown:!1,mouseIn:!1,modules:{},usersMark:null,translatedStrings:{},locale:window.location.pathname.split("/").length>1?window.location.pathname.split("/")[1]:"en",instance:a.markApp.instances.push(e)-1,evt:{resize:function(){var e=
a(window).width(),c=a(window).height()-(a("header").height()+a("#callout-boxes").height());if(e<b.minWidth)e=b.minWidth;if(c<b.minHeight)c=b.minHeight;b.$container.parent().width(e);b.$container.parent().height(c);b.width=e;b.height=c;a(".autoResize").height(c).width(e).trigger("resize.markApp",[e,c])},mousemove:function(a){b.mouseX=a.layerX;b.mouseY=a.layerY},mousedown:function(a){"preventDefault"in a&&a.preventDefault();b.mouseDown=!0},mouseup:function(a){"preventDefault"in a&&a.preventDefault();
b.mouseDown=!1},mouseover:function(a){"preventDefault"in a&&a.preventDefault();b.mouseIn=!0},mouseout:function(a){"preventDefault"in a&&a.preventDefault();b.mouseX=null;b.mouseY=null;b.mouseIn=!1},ready:function(){b.fn.loadTranslations()}},public_fn:{addModule:function(b,e){var c,f={};if(typeof e=="string")c=e;else if(typeof e=="object")for(var k in e){c=k;f=e[k];break}a.markApp.modules[c]&&(b.modules[c]=b.modules[c]||{},"init"in a.markApp.modules[c].fn&&a.markApp.modules[c].fn.init(b,f))},unloadModule:function(b,
e){if(e=="all")for(e in b.modules)"deinit"in a.markApp.modules[e].fn&&a.markApp.modules[e].fn.deinit(b),delete b.modules[e];else e in b.modules&&("deinit"in a.markApp.modules[e].fn&&a.markApp.modules[e].fn.deinit(b),delete b.modules[e])}},fn:{trigger:function(e,c,f){typeof c=="undefined"&&(c={type:"custom"});if(e in b.evt&&b.evt[e](c)==!1)return!1;for(var j in b.modules)if(j in a.markApp.modules&&"evt"in a.markApp.modules[j]&&e in a.markApp.modules[j].evt)a.markApp.modules[j].evt[e](b,c,f)},loop:function(){setTimeout(function(){b.fn.loop()},
42);b.frameCount++;b.fn.trigger("loop",{},[])},withCountryCodes:function(e){"US"in b.countries?e(b.countries):a.ajax({url:"/media/assets/js/vendor/country_codes.json",dataType:"JSON",success:function(a){b.countries=a;for(var c=0;c<a.length;c++)b.countries[a[c].code]=a[c].name;e(b.countries)},error:function(){}})},showLoader:function(e,c){c=typeof c==="string"?c:"";e=typeof e==="string"?e:b.fn.getString("default-loading-msg");b.fn.hideLoader();var f=a("<div />").width(b.width).height(b.height).hide().addClass("overlay-wrapper autoResize").addClass(c).attr("id",
"markapp-loader").append(a("<div />").text(e));b.$container.append(f);f.fadeIn("fast")},hideLoader:function(){a("#markapp-loader").fadeOut("fast",function(){a(this).remove()})},showError:function(e){e=typeof e==="string"?e:b.fn.getString("default-error-msg");b.fn.hideError();e=a("<div />").width(b.width).height(b.height).hide().click(function(a){a.preventDefault();b.fn.hideError()}).addClass("overlay-wrapper autoResize").attr("id","markapp-error").append(a("<div />").attr("id","markapp-error-content").append(a("<p />").html(e)));
b.$container.append(e);e.fadeIn("fast")},hideError:function(){a("#markapp-error").fadeOut("fast",function(){a(this).remove()})},localizeDate:function(a){d=new Date;utc=a.getTime()-d.getTimezoneOffset()*6E4;return nd=new Date(a.getTime()+36E5*b.timezoneOffset)},loadTranslations:function(){a("div.translated-strings").each(function(){a(this).children().each(function(){var e=a(this);e.is("ol")?(b.translatedStrings[e.attr("id")]=[],e.children().each(function(){b.translatedStrings[e.attr("id")].push(a(this).html())})):
b.translatedStrings[e.attr("id")]=e.html()})})},getString:function(a,e){return a in b.translatedStrings?typeof b.translatedStrings[a]==="object"&&typeof e==="number"?b.translatedStrings[a][e]:b.translatedStrings[a]:a},storeData:function(a,b){if(typeof localStorage!="undefined")try{typeof b==="object"&&(b=JSON.stringify(b)),localStorage.setItem(a,b)}catch(e){}},getData:function(a){if(typeof localStorage!="undefined")return(a=localStorage.getItem(a))?(a[0]=="{"&&(a=JSON.parse(a)),a):!1},validate:{url:function(a){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(a)},
string:function(a){return typeof a==="string"&&a.length!=""?!0:!1}}}},a(window).delayedBind(300,"resize",function(a){return b.fn.trigger("resize",a)}).bind("keydown keypress keyup",function(a){return b.fn.trigger(a.type,a)}).trigger("resize"),b.$container.bind("mousemove mousedown mouseup mouseover mouseout ready swap",function(a){return b.fn.trigger(a.type,a)}),b.fn.loop();var c=a.makeArray(arguments);if(c.length>0){var f=c.shift();if(f in b.public_fn)b.public_fn[f](b,typeof c[0]=="undefined"?{}:
c[0])}return e.data("markApp-context",b)}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.linear={defaults:{reference_mark:null,country_code:null,playback:!1,is_flagged:!1,linear_root:"linear"},config:{marks:{},flaggings:{},orderedMarks:[],leftBuffer:[],rightBuffer:[],bufferSize:20,bufferMinSize:5,scene:null,cameraChange:{},tweens:{},layerManager:null,initialized:!1,requestingMarks:!1,moreLeft:!0,moreRight:!0,hoverMark:null,currentMark:null,playbackTimes:{},eventChange:!1},evt:{ready:function(a){modules.linear.fn.initInterface(a)},
resize:function(a){a.modules.linear.eventChange=!0;a.modules.linear.layerManager.resizeAll(a.width,a.height)},keydown:function(a,b){var c=a.modules.linear;switch(b.keyCode){case 38:b.preventDefault();c.cameraChange.aZ=10;break;case 40:b.preventDefault();c.cameraChange.aZ=-10;break;case 39:b.preventDefault();c.cameraChange.aX=10;modules.linear.fn.hideMarkInformation(a);break;case 37:b.preventDefault(),c.cameraChange.aX=-10,modules.linear.fn.hideMarkInformation(a)}},keyup:function(a,b){var c=a.modules.linear;
switch(b.keyCode){case 38:case 40:b.preventDefault();c.cameraChange.aZ=0;break;case 39:case 37:b.preventDefault(),c.cameraChange.aX=0}},keypress:function(a,b){switch(b.keyCode){case 38:case 40:case 39:case 37:b.preventDefault()}},mousedown:function(a){var b=a.modules.linear;if(mark=modules.linear.fn.hitTest(a,a.mouseX,a.mouseY))mark==b.currentMark?modules.linear.fn.centerCurrentMark(a,function(){modules.linear.fn.showMarkInformation(a)}):b.country_code?a.app.setLocation("#/"+b.linear_root+"/country/"+
b.country_code+"/"+mark.reference):a.app.setLocation("#/"+b.linear_root+"/"+mark.reference)},mousemove:function(e){var b=e.modules.linear;b.eventChange=!0;if(mark=modules.linear.fn.hoverTest(e,e.mouseX,e.mouseY,b.hoverMark)){if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=mark;b.currentMark&&b.hoverMark.reference==b.currentMark.reference&&b.hoverMark.contributor_name&&a("#mark-information").is(":visible")?a("#contributor-quote-box").is(":not(:visible)")&&
a("#contributor-quote-box").fadeIn("fast").css({left:e.mouseX-15,top:e.mouseY-a("#contributor-quote-box").height()-15}):(a("#contributor-quote-box:visible").fadeOut("fast"),b.hoverMark.color="255,111,40")}else if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0",b.hoverMark=null,a("#contributor-quote-box:visible").fadeOut("fast")},loop:function(e){var b=e.modules.linear,c=b.layerManager.layers.drawingLayer,f={x:b.scene.camera.position.x,y:b.scene.camera.position.y,z:b.scene.camera.position.z};
if("cameraEase"in b.tweens)TWEEN.update();else{b.cameraChange.vZ+=b.cameraChange.aZ;b.cameraChange.vX+=b.cameraChange.aX;b.cameraChange.vX*=0.93;b.cameraChange.vZ*=0.93;b.scene.camera.position.x+=b.cameraChange.vX;b.scene.camera.position.z+=b.cameraChange.vZ;var g=modules.linear.fn.closestMark(e);if(g){var h=b.scene.camera.position.y-(g.position.y+g.bHeight/2);h!=0&&Math.abs(h)>=10&&(b.scene.camera.position.y+=h>0?-10:10)}}if(!b.eventChange&&f.x==b.scene.camera.position.x&&f.y==b.scene.camera.position.y&&
f.z==b.scene.camera.position.z)return!1;if(b.hoverMark&&!modules.linear.fn.hoverTest(e,e.mouseX,e.mouseY,b.hoverMark))b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0",b.hoverMark=null,a("#contributor-quote-box:visible").fadeOut("fast");c.clean();modules.linear.fn.updateScene(e,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);modules.linear.fn.updateBuffers(e,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);Mark.renderer.renderScene(b.scene,{cursor:{x:e.mouseX,
y:e.mouseY},width:e.width,height:e.height});b.eventChange=!1;for(g in b.scene.timers)e=(new Date).getTime(),b.scene.timers[g].end<e&&delete b.scene.timers[g],b.eventChange=!0}},fn:{init:function(e,b){var c=e.modules.linear;if("$linear"in e.modules.linear){b.country_code!=c.country_code&&modules.linear.fn.dumpAllMarks(e);a.extend(c,c,b);for(option in modules.linear.defaults)b[option]==null&&(c[option]=modules.linear.defaults[option]);modules.linear.fn.updateInterface(e);modules.linear.fn.initMarks(e)}else a.extend(c,
modules.linear.defaults,b),a.extend(c,c,modules.linear.config),c.$linear=a("<div />").addClass("linear-container"),e.$container.append(c.$linear),c.scene=new Mark.scene,c.cameraChange={aX:0,aY:0,aZ:0,vX:0,vY:0,vZ:0},c.layerManager=new Mark.layerManager(c.$linear.get(0)),c.layerManager.addLayer("drawingLayer"),c.scene.canvasContext=c.layerManager.layers.drawingLayer.context,e.fn.trigger("resize"),c.initialized=!0;c.flaggings=e.fn.getData("markFlaggings")||{}},deinit:function(a){var b=a.modules.linear;
b.$linear.fadeOut("fast",function(){b.layerManager.removeAll();b.$linear.remove();b.initialized=!1})},initInterface:function(e){var b=e.modules.linear;a("#stats").hide();a("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a, #mark-browsing-next a, #mark-browsing-prev a").click(function(a){a.preventDefault()}).bind("mouseup mouseout",function(b){b.preventDefault();if(a(this).data("mouseDown")){if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))e.modules.linear.cameraChange.aZ=0;
else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a"))e.modules.linear.cameraChange.aX=0;a(this).data("mouseDown",!1)}}).bind("mousedown",function(b){b.preventDefault();a(this).data("mouseDown",!0);if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))e.modules.linear.cameraChange.aZ=a(this).is("#mark-browsing-zoom-in a")?10:-10;else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a"))e.modules.linear.cameraChange.aX=a(this).is("#mark-browsing-next a")?10:-10,
modules.linear.fn.hideMarkInformation(e)});e.fn.withCountryCodes(function(c){for(var f=a("#country-select"),g=0;g<c.length;g++){var h=a("<option />").val(c[g].code).text(c[g].name);f.append(h)}f.change(function(){var c=a(this).val();c.length!=2&&b.country_code?e.app.setLocation("#/"+b.linear_root+"/"):c.length==2&&c!=b.country_code&&e.app.setLocation("#/"+b.linear_root+"/country/"+c+"/");a(this).blur();a(".ui-selectBox-focus").removeClass("ui-selectBox-focus");e.$container.focus()});b.country_code&&
f.val(b.country_code)});a("#mark-information").hide();a("#mark-playback").click(function(a){a.preventDefault();modules.linear.fn.replayCurrentMark(e)});a("#mark-gml-download").click(function(a){a.preventDefault();modules.linear.fn.downloadCurrentMark(e)});a("#mark-flag").click(function(a){a.preventDefault();modules.linear.fn.flagCurrentMark(e)});a("#delete-mark").click(function(a){a.preventDefault();modules.linear.fn.deleteCurrentMark(e)});a("#approve-mark-checkbox").change(function(b){b.preventDefault();
b=a(this).is(":checked");modules.linear.fn.approveCurrentMark(e,b)});a("#twitter-share").socialShare({share_url:"http://twitter.com/share",share_params:{text:e.fn.getString("twitter-msg")}});a("#facebook-share").socialShare({share_url:"http://www.facebook.com/sharer.php",share_params:{t:e.fn.getString("facebook-msg")}});modules.linear.fn.updateInterface(e);modules.linear.fn.initMarks(e);a("#sammy #country-select").selectBox({autoWidth:!1});a("#sammy #contributor-select").selectBox({autoWidth:!1})},
initMarks:function(a){var b=a.modules.linear;b.reference_mark&&b.reference_mark!=""?b.reference_mark in b.marks?modules.linear.fn.jumpToMark(a,b.reference_mark,b.playback):modules.linear.fn.loadMarks(a,{reference:b.reference_mark,include_forward:20,include_back:20,include_mark:1,success:function(c){c.success?(modules.linear.fn.setupMarks(a,c.marks),modules.linear.fn.jumpToMark(a,b.reference_mark,b.playback)):a.fn.showError(a.fn.getString("no-marks-error-msg"));b.requestingMarks=!1}}):modules.linear.fn.loadMarks(a,
{offset:0,max:20,success:function(c){if(c.success){if(modules.linear.fn.setupMarks(a,c.marks),firstMark=b.marks[c.marks[0].reference])b.scene.camera.position.x=-4E3,b.scene.camera.position.z=-3E3,c="cameraEase"in b.tweens?b.tweens.cameraEase:new TWEEN.Tween(b.scene.camera.position),c.to({x:firstMark.bWidth/2,y:firstMark.bHeight/2,z:-1E3},2E3).onComplete(function(){delete b.tweens.cameraEase;typeof callback==="function"&&callback(this)}).easing(TWEEN.Easing.Quartic.EaseInOut).start(),b.tweens.cameraEase=
c}else a.fn.showError(a.fn.getString("no-marks-error-msg"));b.requestingMarks=!1}})},updateInterface:function(e){var b=e.modules.linear,c=e.fn.getData("userMark");c&&(b.country_code?c.country_code==b.country_code:1)?a("#your-mark-link").attr("href","#/"+b.linear_root+"/"+e.fn.getData("userMark").reference).show():a("#your-mark-link").hide();var f={};b.country_code?(f.country_code=b.country_code,a("#contributor-select").next().hide(),a("#contributor-select-label").hide()):(a("#contributor-select").next().show(),
a("#contributor-select-label").show());b.linear_root!="moderate"&&!a("#mark-browsing-options").is(".country-"+(b.country_code?b.country_code:"all"))&&a.ajax({url:"/requests/init_viz_data",data:f,dataType:"JSON",success:function(c){a("#mark-browsing-options").removeAttr("class").addClass("country-"+(b.country_code?b.country_code:"all"));b.country_code?(a("#first-mark-link").attr("href","#/"+b.linear_root+"/country/"+b.country_code+"/"+c.country_first_mark),a("#last-mark-link").attr("href","#/"+b.linear_root+
"/country/"+b.country_code+"/"+c.country_last_mark)):(a("#first-mark-link").attr("href","#/"+b.linear_root+"/"+c.first_mark),a("#last-mark-link").attr("href","#/"+b.linear_root+"/"+c.last_mark));a("#mark-browsing").collapsibleMod();a("#total-mark-count").text(c.max_id);if(a("#contributor-select option").size()==1){var h=a("#contributor-select");if(c.contributor_marks)for(var i=0;i<c.contributor_marks.length;i++){var j=a("<option />").val(c.contributor_marks[i].reference).text(c.contributor_marks[i].contributor);
h.append(j)}h.change(function(){var c=a(this).val();c!="label"&&e.app.setLocation("#/"+b.linear_root+"/"+c);a(this).blur();e.$container.focus()});b.country_code?(f.country_code=b.country_code,a("#contributor-select").next().hide(),a("#contributor-select-label").hide()):(a("#contributor-select").next().show(),a("#contributor-select-label").show())}}})},dumpAllMarks:function(a){a=a.modules.linear;for(mark in a.marks)delete a.marks[mark];a.scene.objects=[];a.leftBuffer=[];a.rightBuffer=[];a.moreRight=
!0;a.moreLeft=!0;a.scene.camera.position.x=0;a.scene.camera.position.y=0;a.scene.camera.position.z=-1E3},loadMarks:function(e,b){var c=e.modules.linear,f=b.success;delete b.success;if(c.country_code)b.country_code=c.country_code;var g=b.reference?"/requests/marks_by_reference":"/requests/all_marks";c.is_flagged&&(g="/requests/marks_by_flagged");b.reference&&!(b.reference in c.marks)?(modules.linear.fn.dumpAllMarks(e),e.fn.showLoader(e.fn.getString("loading-marks-msg"),"overlay-light")):b.reference||
e.fn.showLoader(e.fn.getString("loading-marks-msg"),"overlay-light");a.ajax({url:g,data:b,dataType:"JSON"}).success(f).success(function(){e.fn.hideLoader()})},setupMarks:function(a,b){var c=a.modules.linear;if(b.length!=0){for(var f=0;f<b.length;f++)b[f].reference in c.marks&&b.shift(f,1);f=[];for(var g in c.marks)f.push([g,c.marks[g].id]);f.sort(function(a,b){return a[1]-b[1]});var h=f.length==0||f[0][1]<b[0].id?c.rightBuffer:c.leftBuffer,i=h==c.leftBuffer?!0:!1;i&&b.reverse();var j=h.length>0?c.marks[h[i?
0:h.length-1]]:c.scene.objects[i?0:c.scene.objects.length-1];for(f=0;f<b.length;f++)if(!(b[f].reference in c.marks)){var k=JSON.parse(b[f].points_obj_simplified);if(!(k==null||!("strokes"in k)||k.strokes.length==0||k.strokes[0].length<2)){g=new Mark.gmlMark(k.strokes,b[f].reference,b[f].country_code,b[f].date_drawn,k.rtl,b[f].id,b[f].is_approved);if(b[f].contributor)g.contributor_name=b[f].contributor,g.extra_info=k.extra_info,g.contributor_url=k.contributor_url,g.color="0,139,211";c.marks[g.reference]=
g;j&&g.positionRelativeTo(j,i);i?h.unshift(g.reference):h.push(g.reference);j=g}}}},refillBuffer:function(a,b){var c=a.modules.linear;if(!c.requestingMarks){c.requestingMarks=!0;var f=b==c.leftBuffer,g=null;g=b.length>0?c.marks[b[f?0:b.length-1]]:c.scene.objects[f?0:c.scene.objects.length-1];modules.linear.fn.loadMarks(a,{reference:g.reference,include_forward:f?0:20,include_back:f?20:0,include_mark:0,success:function(b){b.success?(modules.linear.fn.setupMarks(a,b.marks),b.marks.length<18&&(c[f?"moreLeft":
"moreRight"]=!1)):c[f?"moreLeft":"moreRight"]=!1;c.requestingMarks=!1}})}},updateBuffers:function(a,b,c){var f=a.modules.linear;if(f.scene.objects.length!=0){for(var g=f.scene.objects[0];g&&g.position.x+g.bWidth<b;)f.leftBuffer.push(f.scene.objects.shift().reference),g=f.scene.objects[0];for(g=f.scene.objects[f.scene.objects.length-1];g&&g.position.x>c;)f.rightBuffer.unshift(f.scene.objects.pop().reference),g=f.scene.objects[f.scene.objects-1];f.leftBuffer.length<5&&f.scene.objects.length>0&&f.moreLeft&&
!f.requestingMarks?modules.linear.fn.refillBuffer(a,f.leftBuffer):f.rightBuffer.length<5&&f.scene.objects.length>0&&f.moreRight&&!f.requestingMarks&&modules.linear.fn.refillBuffer(a,f.rightBuffer)}},updateScene:function(a,b,c){a=a.modules.linear;if(a.rightBuffer.length>0)for(var f=a.marks[a.rightBuffer[0]];f&&f.position&&f.position.x<c;)a.scene.objects.push(a.marks[a.rightBuffer.shift()]),f=a.rightBuffer[0];if(a.leftBuffer.length>0)for(f=a.marks[a.leftBuffer[a.leftBuffer.length-1]];f&&f.position&&
f.position.x+f.bWidth>b;)a.scene.objects.unshift(a.marks[a.leftBuffer.pop()]),f=a.leftBuffer[a.leftBuffer.length-1]},jumpToMark:function(a,b,c){var f=a.modules.linear;f.currentMark=f.marks[b];if(c){var g=(new Date).getTime()*2;f.scene.timers[b]={start:g,end:g+f.currentMark.maxTime,speed:1}}modules.linear.fn.centerCurrentMark(a,function(){c&&modules.linear.fn.replayCurrentMark(a);modules.linear.fn.showMarkInformation(a)})},closestMark:function(a){a=a.modules.linear;for(var b=a.scene.objects[0],c=1;c<
a.scene.objects.length;c++){var f=a.scene.objects[c];Math.abs(a.scene.camera.position.x-(f.position.x+f.bWidth/2))<Math.abs(a.scene.camera.position.x-(b.position.x+b.bWidth/2))&&(b=f)}return b},hoverTest:function(a,b,c,f){if(f&&f.renderedBounds&&b>=f.renderedBounds.minX&&b<=f.renderedBounds.maxX&&c>=f.renderedBounds.minY&&c<=f.renderedBounds.maxY)return f;return modules.linear.fn.hitTest(a,b,c)},hitTest:function(a,b,c){a=a.modules.linear;for(var f=0;f<a.scene.objects.length;f++)if(a.scene.objects[f].renderedBounds&&
b>=a.scene.objects[f].renderedBounds.minX&&b<=a.scene.objects[f].renderedBounds.maxX&&c>=a.scene.objects[f].renderedBounds.minY&&c<=a.scene.objects[f].renderedBounds.maxY)return a.scene.objects[f];return!1},showMarkInformation:function(e){var b=e.modules.linear;if(!b.currentMark)return!1;var c=b.currentMark;a("#mark-id").text(c.id);var f=new Date(c.time);f=new Date(f.getTime()+36E5*e.timezoneOffset);var g=[];g.push(f.getHours()+":"+(String(f.getMinutes()).length==1?"0"+f.getMinutes():f.getMinutes()));
g.push("GMT");g.push(e.fn.getString("month-abbreviations",f.getMonth())+" "+f.getDate()+", "+f.getFullYear());c.country_code?e.fn.withCountryCodes(function(b){c.country_code in b?a("#mark-country").text(" / "+b[c.country_code]):a("#mark-country").text("")}):a("#mark-country").text("");c.contributor_name?(a("#mark-contributor-name").text(c.contributor_name),a("#contributor-name").text(c.contributor_name),a("#mark-flag").hide(),"extra_info"in c&&c.extra_info!=null&&c.extra_info!=""&&a("#contributor-quote").text("\u201c"+
c.extra_info+"\u201d"),"contributor_url"in c&&e.fn.validate.url(c.contributor_url)?a("#mark-contributor-url").text(c.contributor_url.replace(/(ftp|http|https):\/\//,"").replace(/\/$/,"")).attr("href",c.contributor_url):a("#mark-contributor-url").text("").attr("href",""),a("#contributor-information").show()):(a("#mark-contributor-name, #contributor-quote, #contributor-name, #mark-contributor-url").text(""),a("#contributor-information").hide(),a("#mark-flag").show());a("#mark-timestamp").text(g.join(" "));
a("#url-share input").val(window.location.href);if(b.linear_root!="moderate")a("#twitter-share").data("socialShare-context").share_params.url=window.location.href,a("#facebook-share").data("socialShare-context").share_params.u=window.location.href;b.linear_root=="moderate"&&a("#approve-mark-checkbox").attr("checked",c.is_approved);b.currentMark.reference in b.flaggings?a("#mark-flag").addClass("disabled"):a("#mark-flag").removeClass("disabled");a("#mark-information").fadeIn("fast")},resetMarkInformation:function(){a("#mark-information").find("a").attr("href",
"#").end().find("#mark-id, #total-mark-count, #mark-timestamp, #mark-country")},hideMarkInformation:function(){a("#mark-information").fadeOut("fast")},replayCurrentMark:function(a){a=a.modules.linear;var b=(new Date).getTime();a.eventChange=!0;a.scene.timers[a.currentMark.reference]={start:b,end:b+a.currentMark.maxTime,speed:1}},downloadCurrentMark:function(a){a=a.modules.linear;a.currentMark&&a.currentMark.reference&&window.open("/gml/"+a.currentMark.reference)},flagCurrentMark:function(e){var b=
e.modules.linear;b.currentMark.reference in b.flaggings||a.ajax({url:"/requests/flag_mark",data:{reference:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){a("#mark-flag").addClass("disabled");b.flaggings[b.currentMark.reference]=!0;e.fn.storeData("markFlaggings",b.flaggings)},error:function(){e.fn.showError(e.fn.getString("error-msg"))}})},deleteCurrentMark:function(e){var b=e.modules.linear;a.ajax({url:"/requests/delete_mark",data:{reference:b.currentMark.reference},type:"POST",
dataType:"JSON",success:function(){var a=b.currentMark.reference,f=null;delete b.marks[b.currentMark.reference];b.currentMark=null;for(var g=0;g<b.scene.objects.length;g++)if(f||b.scene.objects[g].reference==a){if(!f)f=g,b.scene.objects.splice(g,1),b.currentMark=b.scene.objects[g];g==0?b.scene.objects[g].positionToStart():b.scene.objects[g].positionRelativeTo(b.scene.objects[g-1])}e.app.setLocation("#/"+b.linear_root+"/"+b.currentMark.reference);b.eventChange=!0},error:function(){e.fn.showError(e.fn.getString("error-msg"))}})},
approveCurrentMark:function(e,b){var c=e.modules.linear;a.ajax({url:"/requests/approve_mark",data:{reference:c.currentMark.reference,should_approve:b},type:"POST",dataType:"JSON",success:function(){c.currentMark.is_approved=b},error:function(){e.fn.showError(e.fn.getString("error-msg"))}})},centerCurrentMark:function(a,b){var c=a.modules.linear;if(!c.currentMark)return!1;modules.linear.fn.showMarkInformation(a);c.cameraChange.aX=0;c.cameraChange.vX=0;c.cameraChange.aZ=0;c.cameraChange.vZ=0;var f=
Math.abs(c.currentMark.position.x-c.scene.camera.position.x)/2;f=Math.max(1E3,f);var g="cameraEase"in c.tweens?c.tweens.cameraEase:new TWEEN.Tween(c.scene.camera.position);g.to({x:c.currentMark.position.x+c.currentMark.bWidth/2,y:c.currentMark.position.y+c.currentMark.bHeight/2,z:c.currentMark.position.z-1E3},f).onComplete(function(){delete c.tweens.cameraEase;typeof b==="function"&&b(this)}).easing(f>1200?TWEEN.Easing.Quadratic.EaseInOut:TWEEN.Easing.Quartic.EaseInOut).start();c.tweens.cameraEase=
g}}}})(jQuery);
(function(a){a.markApp=a.markApp||{};var e=a.markApp.modules=a.markApp.modules||{};e.capture={defaults:{state:"intro",invite_code:null,locale:null,contributor_type:null},config:{captureLimit:300,layerManager:null,capturedPoints:0,strokes:[],framecount:0,cleanedStrokes:[],lastX:null,lastY:null,captureTime:null,rtl:null,initialized:!1,currentStroke:null,mark:null,timeBetweenStrokes:400,events:[]},evt:{resize:function(a){var c=a.modules.capture;c.layerManager.resizeAll(a.width,a.height);if(c.mark&&c.mark.strokes.length>
0)for(var f=0;f<c.mark.strokes.length;f++)e.capture.fn.drawStroke(a,c.mark.strokes[f])},mousemove:function(a){a.mouseDown&&a.modules.capture.state=="drawing"&&e.capture.fn.capturePoint(a)},mousedown:function(b){switch(b.modules.capture.state){case "drawing":a("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",0);a("#location-dialog").is(":visible")&&a("#location-dialog").fadeOut("fast");b.modules.capture.mark||e.capture.fn.startMark(b);b.modules.capture.currentStroke||
e.capture.fn.startStroke(b);break;case "intro":b.modules.capture.mark||e.capture.fn.startMark(b),b.modules.capture.currentStroke||e.capture.fn.startStroke(b),e.capture.fn.endIntro(b)}},mouseup:function(b){b.modules.capture.state=="drawing"&&(e.capture.fn.endStroke(b),a("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",200))},ready:function(b){var c=b.modules.capture;a("#markmaker").hide().children().hide();a("#markmaker-reset a").addClass("disabled").bind("mousedown",
function(a){a.preventDefault();e.capture.fn.reset(b)});a("#markmaker-submit a").addClass("disabled").bind("mousedown",function(a){a.preventDefault();e.capture.fn.submit(b)});b.fn.withCountryCodes(function(b){for(var c=a("#markmaker-country"),e=0;e<b.length;e++){var i=a("<option />").val(b[e].code).text(b[e].name);c.append(i)}});a("#markmaker-location a").bind("mousedown",{context:b},e.capture.fn.locationDialogToggle);a("#markmaker-information").bind("mouseover",{context:b},e.capture.fn.informationDialogToggle).bind("mouseout",
{context:b},e.capture.fn.informationDialogToggle);c.state=="drawing"&&e.capture.fn.initDrawing(b);a("#sammy #markmaker-country").selectBox({autoWidth:!1})},loop:function(a){var c=a.modules.capture;if(c.initialized)switch(c.frameCount++,e.capture.fn.commonLoop(a),a.modules.capture.state){case "drawing":e.capture.fn.drawLoop(a)}}},fn:{init:function(b,c){var f=b.modules.capture;if("$capture"in f){if("state"in c)e.capture.fn.reset(b),c.state=="drawing"&&b.mouseDown&&b.fn.trigger("mousedown"),f.state=
c.state,e.capture.fn.initDrawing(b)}else a.extend(f,e.capture.defaults),a.extend(f,c),a.extend(f,e.capture.config),f.$capture=a("<div />").addClass("capture-container"),b.$container.css({zIndex:100,cursor:"none"}).append(f.$capture),f.layerManager=new Mark.layerManager(f.$capture.get(0)),f.layerManager.addLayer("drawnLayer"),f.layerManager.addLayer("liveDrawingLayer"),b.fn.trigger("resize"),f.initialized=!0},deinit:function(a){var c=a.modules.capture;c.$capture.fadeOut("fast",function(){c.layerManager.removeAll();
c.$capture.remove();c.initialized=!1})},initIntro:function(){},initDrawing:function(b){var c=b.modules.capture;a("#browse-marks").is(":visible")&&(a("#browse-marks, #click-anywhere, #intro-main-copy").fadeOut("fast"),a("#markmaker-legal-line").fadeIn("slow"));a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(){a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#location-dialog:visible").size()>
0&&a("#location-dialog:visible").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})});a("#markmaker").is(":visible")?a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")}):a("#markmaker").width(0).show().animate({width:b.width},"slow",function(){a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")});a("#markmaker-legal-line").fadeIn("slow")});c.invite_code&&c.contributor_type==
"t"?(c.captureLimit=1E3,c.$capture.addClass("translator"),a("#translator-fields").find("#translator-locale").text("'"+b.locale+"'").end().show().collapsibleMod().hide().fadeIn("slow")):c.invite_code&&c.contributor_type=="c"&&(c.$capture.addClass("contributor"),a("#contributor-fields").show().collapsibleMod().hide().fadeIn("slow"))},endIntro:function(a){a.app.setLocation("#/mark/new")},locationDialogToggle:function(b){b.preventDefault();a("#location-dialog").is(":visible")?a("#location-dialog").fadeOut("fast"):
a("#location-dialog").fadeIn("fast").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})},informationDialogToggle:function(b){b.preventDefault();b.type=="mouseout"?a("#information-dialog").fadeOut("fast"):a("#information-dialog").fadeIn("fast").css({bottom:a("#markmaker-information").height()+36,left:a("#markmaker-information").offset().left-a("#information-dialog").width()+30})},startMark:function(b){var c=b.modules.capture;c.captureTime=(new Date).getTime();
c.rtl=b.mouseX>a(window).width()/2;c.mark=new Mark.gmlMark([],"","",c.captureTime,c.rtl);a("#markmaker-submit a, #markmaker-reset a").removeClass("disabled")},endMark:function(a){a.modules.capture.mark.setupVars()},startStroke:function(a){a=a.modules.capture;a.currentStroke=[];if(a.strokes.length>0)a.captureTime=(new Date).getTime()-(a.strokes[a.strokes.length-1][a.strokes[a.strokes.length-1].length-1].time+a.timeBetweenStrokes)},endStroke:function(a){var c=a.modules.capture;if(c.currentStroke.length>
2){c.strokes.push(c.currentStroke);var f=Mark.simplification.simplifyPath(c.currentStroke,1);f=Mark.simplification.weightPath(f,[5,10,20,40]);c.mark.strokes.push(f);c.cleanedStrokes.push(f);e.capture.fn.drawStroke(a,f);c.capturedPoints-=c.currentStroke.length-f.length}c.currentStroke=null},capturePoint:function(a){var c=a.modules.capture;if(c.capturedPoints>c.captureLimit)a.fn.trigger("mouseup"),e.capture.fn.closeShop(a);else{var f=(new Date).getTime();a=new Mark.gmlPoint(a.mouseX,a.mouseY,f-c.captureTime,
0);c.currentStroke.length>0?(f=c.currentStroke[c.currentStroke.length-1],a.speed=f.speedToPoint(a),a.setAngleFromPoint(f),a.smoothAgainst(f,0.01)):c.strokes.length>=1&&e.capture.fn.drawGuide(c.layerManager.layers.drawnLayer.context,c.lastX,c.lastY,a.x,a.y);c.currentStroke.push(a);c.lastX=a.x;c.lastY=a.y;c.capturedPoints++}},reset:function(b){b=b.modules.capture;b.layerManager.layers.liveDrawingLayer.clean();b.layerManager.layers.drawnLayer.clean();b.capturedPoints=0;b.rtl=null;b.mouseDown=!1;b.lastX=
null;b.lastY=null;b.strokes=[];b.currentStroke=null;b.mark=null;b.captureTime=null;b.state="drawing";a("#markmaker-submit a, #markmaker-reset a").addClass("disabled");a("#markapp").css({cursor:"none"});a("#markmaker-instructions").fadeIn()},closeShop:function(b){var c=b.modules.capture;c.state="preview";e.capture.fn.endMark(b);c.layerManager.layers.liveDrawingLayer.clean();b=c.layerManager.layers.liveDrawingLayer.context;var f=c.lastX,g=c.lastY;b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();
b.dashedLineTo(f,g,c.rtl?0:c.layerManager.layers.liveDrawingLayer.canvas.width,g,[7,5]);b.closePath();b.stroke();a("#markapp").css({cursor:"default"})},submit:function(b){var c=b.modules.capture;if(c.state!="submitting"){c.state!="preview"&&e.capture.fn.closeShop(b);c.state="submitting";a("#markmaker-submit a").addClass("disabled");var f={};f.rtl=c.rtl;f.strokes=c.strokes;f=JSON.stringify(f);var g=JSON.stringify(c.mark),h=a("#markmaker-country").val()=="label"?"":a("#markmaker-country").val();b.fn.showLoader(b.fn.getString("submitting-mark"));
var i={points_obj:f,points_obj_simplified:g,country_code:h};if(c.invite_code&&c.contributor_type=="t")i.contributor_locale=b.locale,i.invite=c.invite_code;else if(c.invite_code&&c.contributor_type=="c")i.contributor=a("#contributor-name").val(),c.mark.extra_info=a("#contributor-quote").val(),c.mark.contributor_url=a("#contributor-url").val(),i.points_obj_simplified=JSON.stringify(c.mark),i.invite=c.invite_code;a.ajax({url:"/requests/save_mark",data:i,type:"POST",dataType:"JSON",success:function(a){i.contributor_locale?
b.app.setLocation("#/linear/"):(b.fn.storeData("userMark",{reference:a.mark_reference,country_code:h}),b.app.setLocation("#/linear/"+a.mark_reference+"?playback=true"));b.fn.hideLoader()},error:function(){b.fn.showError(b.fn.getString("submit-error"))}});return!1}},drawStroke:function(a,c){var e=a.modules.capture;Mark.thickBrush(e.layerManager.layers.drawnLayer.context,[c]);e.layerManager.layers.drawnLayer.context.fillStyle="rgba(255,255,255,0.3)";e.layerManager.layers.drawnLayer.context.strokeStyle=
"rgba(255,255,255,0.3)";Mark.circleBrush(e.layerManager.layers.drawnLayer.context,[c])},drawGuide:function(a,c,e,g,h){a.strokeStyle="rgba(0,0,0,0.2)";a.lineWidth=1;a.beginPath();a.dashedLineTo(c,e,g,h,[7,5]);a.closePath();a.stroke()},drawCursor:function(a,c,e,g){a.strokeStyle="#ff5400";a.fillStyle="#000000";a.beginPath();a.moveTo(c,e);a.lineTo(c+1,e-8);a.lineTo(c+20,e-27);a.lineTo(c+23,e-23);a.lineTo(c,e);a.closePath();a.stroke();g*=18.5;g+=4.5;a.beginPath();a.moveTo(c,e);a.lineTo(c+1,e-8);a.lineTo(c+
(g-3),e-(g+4));a.lineTo(c+g,e-g);a.lineTo(c,e);a.closePath();a.fill()},commonLoop:function(a){var c=a.modules.capture;c.layerManager.layers.liveDrawingLayer.clean();a.mouseIn&&(c.state=="drawing"||c.state=="intro")&&e.capture.fn.drawCursor(c.layerManager.layers.liveDrawingLayer.context,a.mouseX,a.mouseY,(c.captureLimit-c.capturedPoints)/c.captureLimit)},introLoop:function(){},drawLoop:function(b){var c=b.modules.capture;if(c.currentStroke&&c.currentStroke.length>0)Mark.thickBrush(c.layerManager.layers.liveDrawingLayer.context,
[c.currentStroke]),c.layerManager.layers.liveDrawingLayer.context.fillStyle="rgba(255,255,255,0.3)",c.layerManager.layers.liveDrawingLayer.context.strokeStyle="rgba(255,255,255,0.3)",Mark.circleBrush(c.layerManager.layers.liveDrawingLayer.context,[c.currentStroke]);if(b.mouseIn&&!b.mouseDown){var f,g;c.strokes.length==0?(f=b.mouseX>a(window).width()/2?c.layerManager.layers.liveDrawingLayer.canvas.width:0,g=b.mouseY):(f=c.lastX,g=c.lastY);e.capture.fn.drawGuide(c.layerManager.layers.liveDrawingLayer.context,
f,g,b.mouseX,b.mouseY)}}}}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.intro={defaults:{reference_mark:null},config:{marks:{},animationMarks:["vVR","myWb"],playbackTimes:{},vizScene:null,textScene:null,layerManager:null,initialized:!1,eventChange:!1,curLocaleMark:null,animationComplete:!1,tweens:{}},evt:{resize:function(a){a.modules.intro.layerManager.resizeAll(a.width,a.height);a.modules.intro.eventChange=!0;a.modules.intro.xAnimationComplete&&modules.intro.fn.drawX(a)},
loop:function(a){var b=a.modules.intro;TWEEN.update();b.layerManager.layers.viz.clean();Mark.renderer.renderScene(b.vizScene,{width:a.width,height:a.height});if(b.curLocaleMark||b.xMark){b.layerManager.layers.mainMark.clean();if(b.curLocaleMark){var c=500/b.curLocaleMark.bWidth;Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.curLocaleMark,{offset:{x:a.width/2-115,y:a.height-240},scale:{x:c,y:c,thickness:c},color:"255,84,0",timer:b.textScene.timers[b.curLocaleMark.reference]})}b.xMark&&
Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.xMark,{offset:{x:10,y:-400},scale:{x:a.width/2/b.xMark.bWidth,y:(a.height+800)/b.xMark.bHeight,thickness:6},color:"0,0,0",timer:b.textScene.timers[b.xMark.reference]})}},ready:function(e){a("#markmaker").hide().children().hide();a.when(modules.intro.fn.initInterface(e),modules.intro.fn.loadMarks(e)).then(function(){modules.intro.fn.runVizPreview(e)}).then(function(){modules.intro.fn.startDomAnimation(e)}).fail(function(){modules.intro.fn.simpleIntro(e)})}},
fn:{init:function(e,b){var c=e.modules.intro;if(c.initialized)for(option in a.extend(c,c,b),modules.intro.defaults)b[option]==null&&(c[option]=modules.intro.defaults[option]);else a.extend(c,modules.intro.defaults,b),a.extend(c,c,modules.intro.config),c.$intro=a("<div />").addClass("intro-container"),e.$container.append(c.$intro),c.vizScene=new Mark.scene,c.textScene=new Mark.scene,c.layerManager=new Mark.layerManager(c.$intro.get(0)),c.layerManager.addLayer("viz"),c.vizScene.canvasContext=c.layerManager.layers.viz.context,
c.layerManager.addLayer("mainMark"),c.textScene.canvasContext=c.layerManager.layers.mainMark.context,c.layerManager.addLayer("X"),e.fn.trigger("resize"),c.initialized=!0},deinit:function(a){var b=a.modules.intro;b.$intro.fadeOut("fast",function(){b.layerManager.removeAll();b.$intro.remove();b.initialized=!1})},initInterface:function(e){a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(b,c,e){b=c/2+485;e-=140;c=!1;a("#markmaker").css("background-position","0 "+e+"px");a("#markmaker").is(":visible")||
(c=!0,a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"block"}));a("#browse-marks").css({top:e-50,left:b-85});a("#click-anywhere").css({top:e+12,left:b-a("#intro-main-copy").width()});a("#intro-main-copy").css({top:e-a("#intro-main-copy").height()-100,left:b-a("#intro-main-copy").width()});c&&a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"none"})}).trigger("resize.markApp",[e.width,e.height]).width(0).height(e.height)},loadMarks:function(e){e.fn.showLoader(e.fn.getString("loading-intro-msg"),
"overlay-light");return a.ajax({url:"/requests/get_translated_marks",dataType:"JSON"}).success(function(a){modules.intro.fn.setupMarks(e,a.marks);e.fn.hideLoader()})},setupMarks:function(e,b){var c=e.modules.intro;if(!(typeof b==="undefined"||b.length==0)){a(c.layerManager.layers.viz.canvas).css("opacity",0);b.sort(function(){return Math.round(Math.random())-0.5});for(var f=null,g=0;g<b.length;g++)try{var h=JSON.parse(b[g].points_obj_simplified),i=new Mark.gmlMark(h.strokes,b[g].reference,b[g].country_code,
b[g].date_drawn,h.rtl,b[g].id,b[g].is_approved);if(!c.currentMark)c.currentMark=i;b[g].reference in c.marks||(c.marks[i.reference]=i);f&&i.positionRelativeTo(f,!1);if(b[g].contributor_locale==e.locale||!c.curLocaleMark){var j=(new Date).getTime()*3;c.curLocaleMark=new Mark.gmlMark(h.strokes,b[g].reference,b[g].country_code,b[g].date_drawn,h.rtl,b[g].id,b[g].is_approved);c.textScene.timers[c.curLocaleMark.reference]={start:j,end:j+c.curLocaleMark.maxTime,speed:2}}c.vizScene.objects.push(i);f=i}catch(k){}}},
runVizPreview:function(e){var b=e.modules.intro;if(!(b.vizScene.objects.length<3)){b.vizScene.camera.position.x=-2E3;b.vizScene.camera.position.z=-3E3;e=b.vizScene.objects[b.vizScene.objects.length-2];var c=new TWEEN.Tween(b.vizScene.camera.position);c.to({x:e.position.x+e.bWidth/2,y:e.position.y+e.bHeight/2,z:e.position.z-2E3},6E3).onComplete(function(){delete b.tweens.cameraEase}).easing(TWEEN.Easing.Quartic.EaseInOut).start();b.tweens.cameraEase=c;a(b.layerManager.layers.viz.canvas).animate({opacity:"1"},
"slow").delay(2E3).animate({opacity:"0.1"},"slow");a("#markmaker").delay(3E3)}},startDomAnimation:function(e){a("#markmaker").width(0).show().animate({width:e.width},"slow",function(){modules.intro.fn.startMarkAnimations(e);a("#intro-main-copy").fadeIn("slow");a("#click-anywhere").delay(200).fadeIn("slow");a("#browse-marks").delay(100).fadeIn("slow")})},startMarkAnimations:function(a){var b=a.modules.intro;modules.intro.fn.drawX(a);b.curLocaleMark&&(a=(new Date).getTime()+2E3,b.textScene.timers[b.curLocaleMark.reference]=
{start:a,end:a+b.curLocaleMark.maxTime,speed:2})},drawX:function(a){a=a.modules.intro;a.xMark=new Mark.gmlMark({strokes:[[{x:177,y:0,z:0,time:51,speed:0,angle:0,significance:5},{x:129,y:60,z:0,time:255,speed:0.45069390943299864,angle:0.5880026035475675,significance:1},{x:123,y:65,z:0,time:271,speed:0.4931203163041915,angle:0.7853981633974483,significance:1},{x:103,y:89,z:0,time:339,speed:0.45069390943299864,angle:0.5880026035475675,significance:1},{x:56,y:139,z:0,time:503,speed:0.45073896963561083,
angle:0.7853981633974483,significance:1},{x:38,y:162,z:0,time:584,speed:0.3572203090978693,angle:0.46364760900080615,significance:1},{x:9,y:192,z:0,time:691,speed:0.3535533905932738,angle:0.7853981633974483,significance:1},{x:0,y:206,z:0,time:727,speed:0.45069390943299864,angle:0.5880026035475675,significance:5}],[{x:11,y:23,z:0,time:1178,speed:0,angle:0,significance:5},{x:30,y:49,z:0,time:1246,speed:0.32424352695503,angle:5.639684198386302,significance:1},{x:55,y:77,z:0,time:1321,speed:0.48790367901871773,
angle:5.497787143782138,significance:1},{x:72,y:100,z:0,time:1367,speed:0.5216642390945547,angle:5.695182703632019,significance:1},{x:85,y:113,z:0,time:1408,speed:0.5355917833779965,angle:5.497787143782138,significance:2},{x:154,y:175,z:0,time:1662,speed:0.3311927108182759,angle:5.497787143782138,significance:1},{x:186,y:196,z:0,time:1802,speed:0.2849548128987055,angle:5.497787143782138,significance:5}]],country_code:"",time:1300925747439,rtl:!1,maxTime:1802,reference:"",hoverState:!1,renderedBounds:null,
id:null,contributor_name:null,extra_info:null,color:"0,0,0",hoverColor:"0,139,211",x:454,y:199,position:{x:0,y:0,z:0},rotationAngle:{x:0,y:0,z:0},sX:0,sY:0,bWidth:186,bHeight:206}.strokes,"xMark");a.textScene.objects.push(a.xMark);var b=(new Date).getTime();a.textScene.timers[a.xMark.reference]={start:b,end:b+a.xMark.maxTime,speed:1}},simpleIntro:function(e){a("#markmaker").width(0).show().animate({width:e.width},"slow",function(){a("#intro-main-copy").fadeIn("slow");a("#click-anywhere").delay(200).fadeIn("slow");
a("#browse-marks").delay(100).fadeIn("slow")})}}}})(jQuery);
(function(a){function e(a){return a.replace(/-/g,"--").replace(/ /g,"-")}a.fn.extend({delayedBind:function(b,c,f,g){var h=e(c);return this.each(function(){var e=this;a(this).data("_delayedBindBound-"+h+"-"+b)||(a(this).data("_delayedBindBound-"+h+"-"+b,!0),a(this).bind(c,function(){var c=a(this).data("_delayedBindTimerID-"+h+"-"+b);typeof c!="undefined"&&clearTimeout(c);c=setTimeout(function(){a(e).trigger("_delayedBind-"+h+"-"+b)},b);a(this).data("_delayedBindTimerID-"+h+"-"+b,c)}));a(this).bind("_delayedBind-"+
h+"-"+b,f,g)})},delayedBindCancel:function(b,c){var f=e(c);return this.each(function(){var c=a(this).data("_delayedBindTimerID-"+f+"-"+b);typeof c!="undefined"&&clearTimeout(c)})},delayedBindUnbind:function(b,c,f){var g=e(c);return this.each(function(){a(this).unbind("_delayedBind-"+g+"-"+b,f)})}})})(jQuery);
(function(a){a.collapsibleMod={cfg:{collapsedClass:"collapsibleMod-collapsed",expandedClass:"collapsibleMod-expanded",$header:null,expandedHeight:0,collapsedHeight:0,$content:null,collapsed:!1,stateKey:"",saveState:!0},fn:{init:function(e,b){var c=a(e),f=a.extend({},a.collapsibleMod.cfg,b);f.$container=c;f.$header=c.find("h3:first");f.$content=c.children().not("h3:first");f.expandedHeight=f.$content.height();f.$header.bind("click",function(b){b.preventDefault();a.collapsibleMod.fn.toggle(f)});f.saveState&&
f.$container.attr("id")!=""&&typeof localStorage!="undefined"?(f.stateKey="collapsibleMod-state-"+f.$container.attr("id"),a.collapsibleMod.fn.restoreState(f)):f.saveState=!1;f.collapsed?a.collapsibleMod.fn.collapse(f):f.$container.addClass(f.expandedClass);c.data("collapsibleMod-context",f)},collapse:function(e){e.$container.addClass(e.collapsedClass).removeClass(e.expandedClass);e.$content.animate({height:e.collapsedHeight},"fast",function(){e.collapsedHeight==0&&e.$content.hide()});e.collapsed=
!0;a.collapsibleMod.fn.saveState(e)},expand:function(e){e.$container.removeClass(e.collapsedClass).addClass(e.expandedClass);e.$content.show().animate({height:e.expandedHeight},"fast");e.collapsed=!1;a.collapsibleMod.fn.saveState(e)},saveState:function(a){if(a.saveState)try{localStorage.removeItem(a.stateKey),localStorage.setItem(a.stateKey,a.collapsed)}catch(b){}},restoreState:function(a){if(a.saveState&&localStorage.getItem(a.stateKey))a.collapsed=localStorage.getItem(a.stateKey)==="true"},toggle:function(e){e.collapsed?
a.collapsibleMod.fn.expand(e):a.collapsibleMod.fn.collapse(e)}}};a.fn.collapsibleMod=function(e){return a(this).each(function(){a.collapsibleMod.fn.init(this,e)})}})(jQuery);
(function(a){a.socialShare={cfg:{$link:null,share_url:"http://twitter.com/share",share_title:"Share on Twitter",share_params:{},popupWidth:550,popupHeight:450},fn:{init:function(e,b){var c=a(e),f=a.extend({},a.socialShare.cfg,b);f.$link=c;f.$link.bind("click",function(b){b.preventDefault();a.socialShare.fn.share(f)});c.data("socialShare-context",f)},shareURL:function(a){var b=[];for(param in a.share_params)b.push(param+"="+encodeURIComponent(a.share_params[param]));return a.share_url+"?"+b.join("&")},
share:function(e){window.open(a.socialShare.fn.shareURL(e),e.share_title,"height="+e.popupHeight+",width="+e.popupWidth)}}};a.fn.socialShare=function(e){return a(this).each(function(){a.socialShare.fn.init(this,e)})}})(jQuery);
jQuery&&function(a){a.extend(a.fn,{selectBox:function(e,b){var c=function(b){var c=b.data.select,e=b.data.control;if(a(e).hasClass("ui-selectBox-disabled"))return!1;if(a(e).hasClass("ui-selectBox-focus")&&a("#ui-selectBox-dropdown").size()===1)return f(b,!0),!1;a(".ui-selectBox").not(e).trigger("blur");h(b);b.stopPropagation();a("#ui-selectBox-dropdown").remove();var n=a('<div id="ui-selectBox-dropdown" class="ui-corner-bottom" />'),r=a("<ul />");a(c).children("optgroup").size()===0?a(c).children("option").each(function(){var b=
a(this).text()!==""?a(this).text():"\u00a0",c="";a(this).attr("disabled")&&(c+=" ui-selectBox-disabled");a(r).append('<li class="ui-selectBox-option'+c+'">'+p(b)+"</li>")}):(a(n).addClass("ui-selectBox-hasOptgroups"),a(c).children("optgroup").each(function(){a(r).append('<li class="ui-selectBox-optgroup">'+p(a(this).attr("label"))+"</li>");a(this).children("option").each(function(){var b=a(this).text()!==""?a(this).text():"\u00a0",c="";a(this).attr("disabled")&&(c+=" ui-selectBox-disabled");a(r).append('<li class="ui-selectBox-option'+
c+'">'+p(b)+"</li>")})}));a(n).append(r);b=a(c)[0].selectedIndex;a(n).find("LI.ui-selectBox-option").eq(b).addClass("ui-selectBox-initial ui-selectBox-current");a(n).find("LI.ui-selectBox-option").hover(function(){a(n).find(".ui-selectBox-current").removeClass("ui-selectBox-current");a(this).addClass("ui-selectBox-current")},function(){a(this).removeClass("ui-selectBox-current")}).click({select:c,control:e},function(a){g(a)}).mouseup({select:c,control:e},function(b){a(b.target).trigger("click")});
a("BODY").append(n);c=a(e).offset();b=a(e).outerHeight();var i=a(e).outerWidth(),j=parseInt(a(n).css("borderLeftWidth"))+parseInt(a(n).css("borderRightWidth"));a(n).css({position:"absolute",zIndex:"999999",top:c.top+b,left:c.left,width:i-j}).show();a(e).removeClass("ui-corner-all").addClass("ui-corner-top");o(n);k(!0)},f=function(b,c){var e=b.data.control;a("#ui-selectBox-dropdown").remove();a(e).removeClass("ui-corner-top").addClass("ui-corner-all");c?a(e).focus():i(b)},g=function(b,c){var e=b.data.select,
n=b.data.control;c=c?c:b.target;if(a(c).hasClass("ui-selectBox-disabled"))return!1;var g=a(e)[0].selectedIndex;a("#ui-selectBox-dropdown .ui-selectBox-optgroup").remove();var h=a("#ui-selectBox-dropdown").find("LI.ui-selectBox-current").index();if(g!==h)a(e)[0].selectedIndex=h,a(n).find(".ui-selectBox-label").text(a(c).text()),a(e).trigger("change");f(b,!0)},h=function(b){var c=b.data.select;b=b.data.control;if(a(b).hasClass("ui-selectBox-disabled"))return!0;if(a(b).hasClass("ui-selectBox-focus"))return!1;
a(".ui-selectBox.ui-selectBox-focus").removeClass("ui-selectBox-focus");a("#ui-selectBox-dropdown").remove();a(b).addClass("ui-selectBox-focus");a(document).bind("mousedown",{select:c,control:b},i);a(document).bind("keydown",{select:c,control:b},j);a(c).trigger("focus");a(b).focus()},i=function(b){var c=b.data.select,e=b.data.control;if(b.target.id==="ui-selectBox-dropdown"||a(b.target).parents("#ui-selectBox-dropdown").size()===1)return a(e).trigger("focus"),!1;a(e).hasClass("ui-selectBox-focus")&&
(a(e).removeClass("ui-selectBox-focus"),a(document).unbind("mousedown",i),a(document).unbind("keydown",j),a(c).trigger("blur"),f(b))},j=function(b){var e=b.data.select,l=b.data.control,n=a("#ui-selectBox-dropdown");if(a(l).hasClass("ui-selectBox-disabled"))return!1;switch(b.keyCode){case 9:i(b);break;case 13:if(a(n).size()===0)return!1;e=a(n).find(".ui-selectBox-option");var h=-1;a.each(e,function(b,c){a(c).hasClass("ui-selectBox-current")&&(h=b)});h>=0&&g(b,a(e).eq(h));return!1;case 27:f(b,!0);break;
case 38:case 37:case 33:var j=b.keyCode===33?20:1;if(a(n).size()===0){if(b.altKey)return c(b),!1;b=a(e).find("OPTION").size();n=a(e)[0].selectedIndex;for(j=a(e)[0].selectedIndex-j;a(e).find("OPTION").eq(j).attr("disabled")===!0&&j>=0;)j--;j<0&&(j=a(e).find("OPTION:not([disabled]):first").index());a(e)[0].selectedIndex=j;if(a(e)[0].selectedIndex===-1)j=0,a(e)[0].selectedIndex=j;b=a(e).find("OPTION:selected").text();b===""&&(b="\u00a0");a(l).find(".ui-selectBox-label").text(b);j!==n&&a(e).trigger("change");
return!1}e=a(n).find(".ui-selectBox-option");h=-1;a.each(e,function(b,c){a(c).hasClass("ui-selectBox-current")&&(h=b)});h-=j;h<0&&(h=0);a(e).removeClass("ui-selectBox-current");a(e).eq(h).addClass("ui-selectBox-current");k();return!1;case 40:case 39:case 34:j=b.keyCode===34?20:1;if(a(n).size()===0){if(b.altKey)return c(b),!1;b=a(e).find("OPTION").size();n=a(e)[0].selectedIndex;for(j=a(e)[0].selectedIndex+j;a(e).find("OPTION").eq(j).attr("disabled")===!0&&j<=a(e).find("OPTION").size();)j++;j>b-1&&
(j=a(e).find("OPTION:not([disabled]):last").index());a(e)[0].selectedIndex=j;if(a(e)[0].selectedIndex===-1)j=a(e).find("OPTION").size()-1,a(e)[0].selectedIndex=j;b=a(e).find("OPTION:selected").text();b===""&&(b="\u00a0");a(l).find(".ui-selectBox-label").text(b);j!=n&&a(e).trigger("change");return!1}e=a(n).find(".ui-selectBox-option");h=-1;a.each(e,function(b,c){a(c).hasClass("ui-selectBox-current")&&(h=b)});h+=j;h>a(e).size()-1&&(h=a(e).size()-1);a(e).removeClass("ui-selectBox-current");a(e).eq(h).addClass("ui-selectBox-current");
k();return!1;case 36:case 35:if(a(n).size()===0){if(b.altKey)return c(b),!1;n=a(e)[0].selectedIndex;j=b.keyCode===36?0:a(e).find("OPTION").size()-1;a(e).find("OPTION").eq(j).attr("disabled")===!0&&(j=b.keyCode===36?a(e).find("OPTION:not([disabled]):first").index():a(e).find("OPTION:not([disabled]):last").index());a(e)[0].selectedIndex=j;b=a(e).find("OPTION:selected").text();b===""&&(b="\u00a0");a(l).find(".ui-selectBox-label").text(b);j!=n&&a(e).trigger("change");return!1}a(n).find(".ui-selectBox-current").removeClass("ui-selectBox-current");
b.keyCode===36?a(n).find(".ui-selectBox-option:first").addClass("ui-selectBox-current"):a(n).find(".ui-selectBox-option:last").addClass("ui-selectBox-current");k();return!1}},k=function(b){var c=a("#ui-selectBox-dropdown");if(a(c).size()===0)return!1;var e=a(c).find(".ui-selectBox-current");if(a(e).size()===0)return!1;var f=parseInt(a(e).offset().top-a(c).position().top),g=parseInt(f+a(e).outerHeight());b?a(c).scrollTop(a(e).offset().top-a(c).offset().top+a(c).scrollTop()-a(c).height()/2):(f<0&&a(c).scrollTop(a(e).offset().top-
a(c).offset().top+a(c).scrollTop()),g>a(c).height()&&a(c).scrollTop(a(e).offset().top+a(e).outerHeight()-a(c).offset().top+a(c).scrollTop()-a(c).height()))},o=function(b){a(b).css("MozUserSelect","none").bind("selectstart",function(){return!1}).bind("mousedown",function(){return!1});return!0},p=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};switch(e){case "destroy":return a(this).each(function(){var b=a(this),c=a(this).next(".ui-selectBox");
a(b)[0].tagName.toLowerCase()==="select"&&(a(c).remove(),a(b).removeData("selectBox-options").show())}),a(this);case "disable":return a(this).each(function(){var b=a(this),c=a(this).next(".ui-selectBox");a(b).attr("disabled",!0);a(c).addClass("ui-selectBox-disabled")}),a(this);case "enable":return a(this).each(function(){var b=a(this),c=a(this).next(".ui-selectBox");a(b).attr("disabled",!1);a(c).removeClass("ui-selectBox-disabled")}),a(this);case "setOptions":if(!b)return a(this);a(this).each(function(){var c=
a(this);a(this).next(".ui-selectBox");switch(typeof b){case "string":a(c).html(b);break;case "object":for(var e in a(c).html(""),b)if(b[e]!==null){if(typeof b[e]==="object"){var l=a('<optgroup label="'+e+'" />'),f;for(f in b[e])a(l).append('<option value="'+f+'">'+b[e][f]+"</option>")}else l=a('<option value="'+e+'">'+b[e]+"</option>");a(c).append(l)}}e=a(c).data("selectBox-options");a(c).selectBox("destroy");a(c).selectBox(e)});return a(this);case "value":return a("#ui-selectBox-dropdown").remove(),
a(this).each(function(){var c=a(this),e=a(this).next(".ui-selectBox");a(c).val(b);c=a(c).find(":selected").text();c===""&&(c="\u00a0");a(e).removeClass("ui-corner-top").addClass("ui-corner-all").find(".ui-selectBox-label").text(c)}),a(this);default:return a(this).each(function(){e||(e={});var b=a.extend({autoWidth:!0},e),f=a(this);if(a(this).next(".ui-selectBox").size()===0){var l=a('<a href="#" class="ui-selectBox ui-corner-all" tabindex="'+parseInt(a(f).attr("tabindex"))+'" />');a(l).addClass(a(f).attr("class")).attr({style:(a(f).attr("style")+
"").replace(/inline/,"inline-block"),title:a(f).attr("title")});a(f).data("selectBox-options",b);if(b.autoWidth){var n="";a(f).find("OPTION").each(function(){a(this).text().length>n.length&&(n=a(this).text())});b=a('<div class="ui-selectBox-dropdown" style="position: absolute; top: -9999em; left: -9999em; width: auto; display: inline-block;" />');var g=a('<li class="ui-selectBox-option">'+p(n)+"</li>");a(b).append(g);a("BODY").append(b);a(l).width(g.outerWidth());a(b).remove()}a(f)[0].tagName.toLowerCase()!==
"select"||a(f).attr("multiple")===!0||(a(f).attr("disabled")===!0&&a(l).addClass("ui-selectBox-disabled"),b=a(f).find("OPTION:selected").text(),b===""&&(b="\u00a0"),a(l).append('<span class="ui-selectBox-label">'+p(b)+"</span>"),a(l).append('<span class="ui-selectBox-arrow"></span>'),a(f).hide().after(l),o(l),a(l).bind("click",function(){return!1}).bind("mousedown",{select:f,control:l},c).bind("focus",{select:f,control:l},h).bind("blur",{select:f,control:l},i))}}),a(this)}}})}(jQuery);
CanvasRenderingContext2D.prototype.dashedLineTo=function(a,e,b,c,f){var g=function(a,b){return a<=b},h=function(a,b){return a>=b},i=function(a,b){return Math.min(a,b)},j=function(a,b){return Math.max(a,b)},k={thereYet:h,cap:i};h={thereYet:h,cap:i};if(e-c>0)h.thereYet=g,h.cap=j;if(a-b>0)k.thereYet=g,k.cap=j;this.moveTo(a,e);g=a;j=e;i=0;for(var o=!0;!k.thereYet(g,b)||!h.thereYet(j,c);){var p=Math.atan2(c-e,b-a),m=f[i];g=k.cap(b,g+Math.cos(p)*m);j=h.cap(c,j+Math.sin(p)*m);o?this.lineTo(g,j):this.moveTo(g,
j);i=(i+1)%f.length;o=!o}};CanvasRenderingContext2D.prototype.dottedArc=function(a,e,b,c,f,g){var h=Math.PI/b/2,i=c;for(c+=h;c<f;)this.beginPath(),this.arc(a,e,b,i,c,g),this.stroke(),i=c+h,c=i+h};
var Mark=function(a){a.layer=function(a,b){this.context=this.canvas=null;this.dirtyRectangles=[];this.layerName=b;this.manager=a;this.clean=function(){if(this.dirtyRectangles.length==0)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);else for(var a=0;a<this.dirtyRectangles.length;a++)this.context.clearRect(a.x,a.y,a.w,a.h)};this.setSize=function(a,b){if(this.canvas.width!=a)this.canvas.width=a;if(this.canvas.height!=b)this.canvas.height=b};this.init=function(){this.canvas=document.createElement("canvas");
this.context=this.canvas.getContext("2d");this.setSize(this.manager.container.scrollWidth,this.manager.container.scrollHeight);this.manager.layerWrapper.appendChild(this.canvas)};this.remove=function(){this.manager.layerWrapper.removeChild(this.canvas)};this.init()};return a}(Mark||{});
Mark=function(a){a.layerManager=function(e){this.container=e;this.layerWrapper=null;this.layers={};this.init=function(){this.layerWrapper=document.createElement("div");this.layerWrapper.className="mark-layerManager";this.container.appendChild(this.layerWrapper)};this.addLayer=function(b){var c=new a.layer(this,b);return this.layers[b]=c};this.removeAll=function(){for(var a in this.layers)this.layers[a].remove(),delete this.layers[a]};this.resizeAll=function(a,c){for(var e in this.layers)this.layers[e].setSize(a,
c)};this.init()};return a}(Mark||{});
Mark=function(a){a.gmlPoint=function(a,b,c,f,g){this.x=a;this.y=b;this.z=typeof g=="integer"?g:0;this.time=c;this.speed=f;this.angle=0;this.significance=1;this.distanceToPoint=function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))};this.speedToPoint=function(a){return this.distanceToPoint(a)/(a.time-this.time)};this.smoothAgainst=function(a,b){var c=this.distanceToPoint(a);c*=b;if(Math.abs(this.speed-a.speed)>c)this.speed=this.speed>a.speed?a.speed+c:a.speed-c};this.setAngleFromPoint=
function(a){this.angle=Math.atan2(a.y-this.y,a.x-this.x)+Math.PI/2;this.angle%=2*Math.PI;if(this.angle<0)this.angle=2*Math.PI+this.angle};this.clone=function(){return{x:this.x,y:this.y,z:this.z,time:this.time,significance:this.significance,angle:this.angle,speed:this.speed}};this.getTranslatedPoint=function(a,b){var c=this.clone();c.x+=a;c.y+=b;return c}};return a}(Mark||{});
Mark=function(a){a.simplification={Line:function(a,b){this.p1=a;this.p2=b;this.distanceToPoint=function(a){var b=(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x),e=[];e.push(Math.abs(a.y-b*a.x-(this.p1.y-b*this.p1.x))/Math.sqrt(Math.pow(b,2)+1));e.push(Math.sqrt(Math.pow(a.x-this.p1.x,2)+Math.pow(a.y-this.p1.y,2)));e.push(Math.sqrt(Math.pow(a.x-this.p2.x,2)+Math.pow(a.y-this.p2.y,2)));return e.sort(function(a,b){return a-b})[0]}},douglasPeucker:function(e,b){var c=[];if(e.length<=2)return[e[0]];for(var f=
new a.simplification.Line(e[0],e[e.length-1]),g=0,h=0,i=1;i<=e.length-2;i++){var j=f.distanceToPoint(e[i]);j>g&&(g=j,h=i)}g>=b?(g=e[h],f.distanceToPoint(g,!0),c=c.concat(a.simplification.douglasPeucker(e.slice(0,h+1),b)),c=c.concat(a.simplification.douglasPeucker(e.slice(h,e.length),b))):(g=e[h],f.distanceToPoint(g,!0),c=[e[0]]);return c},simplifyPath:function(e,b){var c=a.simplification.douglasPeucker(e,b);c.push(e[e.length-1]);return c},weightPath:function(e,b){for(var c=b.length+1,f=e;tolerance=
b.shift();){f=a.simplification.douglasPeucker(f,tolerance);for(var g=0;g<f.length;g++)f[g].significance++}e[0].significance=c;e[e.length-1].significance=c;return e}};return a}(Mark||{});
Mark=function(a){a.dof=1E4;a.thickMarkBrush=function(e,b,c,f,g,h){f=f?f:"0,0,0";var i=Mark.renderer.translatePoint(b[0][0],c),j={minX:i.x,maxX:i.x,minY:i.y,maxY:i.y};if(!g||!h||!(i.x>g*2||i.x<-g||i.y>h*2||i.y<-h||i.z>a.dof||i.z<0)){for(g=0;g<b.length;g++)if(!(typeof b[g]=="undefined"||b[g].length<=1))for(var k=null,o=0;o<b[g].length;o++)if(i=Mark.renderer.translatePoint(b[g][o],c),!(i.z&&i.z>a.dof)&&!(i.significance&&i.significance*(a.dof/5)<i.z-500))if(k){e.lineWidth=1;if(o==b[g].length-1)var p=
0,m=0;else m=9-Math.max(0,Math.pow(i.speed+1,3)),c.mode=="flatScale"&&c.scale.thickness?m*=c.scale.thickness:i.z&&(m*=2/i.z*(h/2)),m<0.1&&(m=0.1),m+=1,p=Math.cos(i.angle)*m,m*=Math.sin(i.angle);e.strokeStyle="rgba("+f+","+(a.dof-i.z)/a.dof+")";e.fillStyle="rgba("+f+","+(a.dof-i.z)/a.dof+")";try{e.beginPath(),e.lineWidth=0.5*((a.dof-i.z)/a.dof),e.moveTo(k.x-prevPX-0.5,k.y-prevPY-0.5),e.lineTo(k.x+prevPX-0.5,k.y+prevPY-0.5),e.lineTo(i.x+p-0.5,i.y+m-0.5),e.lineTo(i.x-p-0.5,i.y-m-0.5),e.lineTo(k.x-prevPX-
0.5,k.y-prevPY-0.5),e.fill(),e.stroke()}catch(q){}j.minX=i.x<j.minX?i.x:j.minX;j.minY=i.y<j.minY?i.y:j.minY;j.maxX=i.x>j.maxX?i.x:j.maxX;j.maxY=i.y>j.maxY?i.y:j.maxY;k=i;prevPX=p;prevPY=m}else{if(g!=0&&i.z<1500&&(k=Mark.renderer.translatePoint(b[g-1][b[g-1].length-1],c),k.z&&k.z<a.dof))e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=1,e.beginPath(),e.dashedLineTo(k.x,k.y,i.x,i.y,[6,4]),e.closePath(),e.stroke();k=i;prevPY=prevPX=0}return j}};a.connectionBrush=function(e,b,c,f,g,h,i){f={offset:f,w:h,h:i,
mode:"pinhole"};b=Mark.renderer.translatePoint(b,f);f.offset=g;c=Mark.renderer.translatePoint(c,f);if(!(b.x>h||b.x<0||b.y>i||b.y<0)||!(c.x>h||c.x<0||c.y>i||c.y<0))if(!b.z||!c.z||!(b.z>a.dof||b.z<0)||!(c.z>a.dof||c.z<0))e.strokeStyle="rgba(0,0,0,"+(a.dof-b.z)/(a.dof*2)+")",g=3*(2/b.z)*(i/2),g<1&&(g=1),e.lineWidth=g,e.beginPath(),e.dashedLineTo(b.x,b.y,c.x,c.y,[6,4]),e.closePath(),e.stroke()};a.thickBrush=function(a,b,c,f,g){c=c?c:0;f=f?f:0;g=g?g:1;for(var h=0;h<b.length;h++)if(!(typeof b[h]=="undefined"||
b[h].length<=1)){if(h>0)a.strokeStyle="rgba(0,0,0,0.1)",a.lineWidth=1,a.beginPath(),a.dashedLineTo(b[h-1][b[h-1].length-1].x+c,b[h-1][b[h-1].length-1].y+f,b[h][0].x+c,b[h][0].y+f,[6,4]),a.closePath(),a.stroke();a.lineWidth=1;a.strokeStyle="#000000";a.fillStyle="#000000";for(var i=0,j=0,k=b[h][0].x,o=b[h][0].y,p=1;p<b[h].length;p++){var m=b[h][p];if(!(m.significance<g)){if(p==b[h].length-1)var q=0,l=0;else l=9-Math.pow(m.speed+1,3),l<0.5&&(l=0.5),l+=1,q=Math.cos(m.angle)*l,l*=Math.sin(m.angle);try{a.beginPath(),
a.moveTo(k-i-0.5+c,o-j-0.5+f),a.lineTo(k+i-0.5+c,o+j-0.5+f),a.lineTo(m.x+q-0.5+c,m.y+l-0.5+f),a.lineTo(m.x-q-0.5+c,m.y-l-0.5+f),a.lineTo(k-i-0.5+c,o-j-0.5+f),a.fill(),a.stroke()}catch(n){}i=q;j=l;k=m.x;o=m.y;prevAng=m.angle}}}};a.circleMarkBrush=function(e,b,c){for(var f=3,g=0;g<b.length;g++)if(b[g].length!=0)for(var h=0;h<b[g].length;h++){var i=Mark.renderer.translatePoint(b[g][h],c);if(!(i.z&&i.z>a.dof))f=3*((a.dof-i.z)/a.dof),e.fillStyle="rgba(255,255,255,0.4)",e.strokeStyle="rgba(255,255,255,0.4)",
e.beginPath(),e.arc(i.x,i.y,f,0,Math.PI*2,!0),e.closePath(),e.fill(),e.stroke(),e.lineTo(i.x,i.y)}};a.circleBrush=function(a,b,c,f,g){c=c?c:0;f=f?f:0;g=g?g:1;for(var h=0;h<b.length;h++)if(b[h].length!=0){a.beginPath();for(var i=0;i<b[h].length;i++){var j=b[h][i];j.significance<g||(a.beginPath(),a.arc(j.x+c,j.y+f,3,0,Math.PI*2,!0),a.closePath(),a.fill(),a.stroke(),a.lineTo(j.x+c,j.y+f))}}};return a}(Mark||{});
Mark=function(a){a.gmlMark=function(a,b,c,f,g,h,i){this.strokes=a;this.country_code=c;this.time=f;this.rtl=g;this.maxTime=0;this.reference=b;this.hoverState=!1;this.renderedBounds=null;this.id=h?h:null;this.is_approved=i;this.contributor_url=this.extra_info=this.contributor_name=null;this.color="0,0,0";this.y=this.x=0;this.position={x:0,y:0,z:0};this.rotationAngle={x:0,y:0,z:0};this.bHeight=this.bWidth=this.sY=this.sX=0;this.init=function(){this.strokes.length>0&&this.setupVars()};this.setupVars=
function(){this.maxTime=this.lastPoint().time;this.getBoundingBox()};this.leftmostStrokeStart=function(){for(var a=this.strokes[0][0],b=1;b<this.strokes.length;b++){var c=this.strokes[b][0];c.x<a.x&&(a=c)}return a};this.rightmostStrokeEnd=function(){for(var a=this.strokes[0][this.strokes[0].length-1],b=1;b<this.strokes.length;b++){var c=this.strokes[b][this.strokes[b].length-1];c.x>a.x&&(a=c)}return a};this.firstPoint=function(){return this.strokes[0][0]};this.lastPoint=function(){return this.strokes[this.strokes.length-
1][this.strokes[this.strokes.length-1].length-1]};this.translatePoint=function(a){var b=a.clone();b.x=this.x+a.x;b.y=this.y+a.y;return b};this.getBoundingBox=function(){var a=this.strokes[0][0],b=a.x,c=a.x,e=a.y;a=a.y;for(var f=0;f<this.strokes.length;f++)for(var g=0;g<this.strokes[f].length;g++){var l=this.strokes[f][g];b=l.x>b?l.x:b;e=l.y>e?l.y:e;c=l.x<c?l.x:c;a=l.y<a?l.y:a}this.bWidth=b-c;this.bHeight=e-a;this.x=c;this.y=a;(c!=0||a!=0)&&this.fitPointsToBounds(c,a)};this.fitPointsToBounds=function(a,
b){for(var c=0;c<this.strokes.length;c++)for(var e=0;e<this.strokes[c].length;e++)this.strokes[c][e].x-=a,this.strokes[c][e].y-=b};this.strokesAtTime=function(a){if(a>this.maxTime)return this.strokes;for(var b=[[]],c=[0,0],e=this.strokes[c[0]][c[1]];e.time<a;)b[b.length-1].push(e),c[1]++,this.strokes[c[0]].length==c[1]&&(c[0]++,c[1]=0,b.push([])),e=this.strokes[c[0]][c[1]];return b};this.positionRelativeTo=function(a,b){b&&b?(this.position.x=a.position.x-50-this.bWidth,this.position.y=a.position.y+
a.leftmostStrokeStart().y-this.rightmostStrokeEnd().y,this.position.z=a.position.z-this.maxTime/50):(this.position.x=a.position.x+a.bWidth+this.leftmostStrokeStart().x+50,this.position.y=a.position.y+a.rightmostStrokeEnd().y-this.leftmostStrokeStart().y,this.position.z=a.position.z+a.maxTime/50)};this.positionToStart=function(){this.position.x=0;this.position.y=0;this.position.z=0};this.init()};return a}(Mark||{});
Mark=function(a){a.scene=function(){this.camera=new Mark.camera;this.objects=[];this.canvasContext=null;this.timers={};this.init=function(){};this.addObject=function(a){this.objects.push(a)};this.removeObject=function(a){this.objects.splice(a,1)};this.update=function(){var e=(new Date).getTime();for(a in this.timers)this.timers[a].end<e&&delete this.timers[a]};this.init()};return a}(Mark||{});
Mark=function(a){a.renderer={translatePoint:function(a,b){var c={flatScale:function(a,b){var c="offset"in b&&"x"in b.offset?b.offset.x:0,e="offset"in b&&"y"in b.offset?b.offset.y:0,f="scale"in b&&"y"in b.scale?b.scale.y:1;a.x*="scale"in b&&"x"in b.scale?b.scale.x:1;a.y*=f;a.x+=c;a.y+=e;return a},pinhole:function(a,b){var c="offset"in b&&"y"in b.offset?b.offset.y:0,e="offset"in b&&"z"in b.offset?b.offset.z:0,f="w"in b?b.w:500,o="h"in b?b.h:500;a.x+="offset"in b&&"x"in b.offset?b.offset.x:0;a.y+=c;
a.z=a.x>0?Math.pow((a.x- -100)/100,2)+e:Math.pow((a.x- -100)/100/2,2)+e;a.time&&(a.z+=a.time/50);c=2/a.z;a.x=a.x*c*(o/2)+f/2;a.y=a.y*c*(o/2)+o/2;return a}},f={x:a.x,y:a.y,z:a.z,time:a.time,significance:a.significance,angle:a.angle,speed:a.speed};return"mode"in b&&b.mode in c?c[b.mode](f,b):c.pinhole(f,b)},strokesAtTime:function(a,b){for(var c=[[]],f=[0,0],g=a[f[0]][f[1]];g.time<b;){c[c.length-1].push(g);f[1]++;if(a[f[0]].length==f[1]){if(a.length==f[0]+1)break;f[0]++;f[1]=0;c.push([])}g=a[f[0]][f[1]]}return c},
renderScene:function(e,b){for(var c=b.width,f=b.height,g=e.objects.length-1;g>=0;g--){var h={x:e.objects[g].position.x-e.camera.position.x,y:e.objects[g].position.y-e.camera.position.y,z:e.objects[g].position.z-e.camera.position.z};colorBase=e.objects[g].color;var i={offset:h,w:b.width,h:b.height,mode:"pinhole"};if(g<e.objects.length-1&&!(e.objects[g].reference in e.timers)){i={x:e.objects[g+1].position.x-e.camera.position.x,y:e.objects[g+1].position.y-e.camera.position.y,z:e.objects[g+1].position.z-
e.camera.position.z};var j={x:e.objects[g].position.x-e.camera.position.x,y:e.objects[g].position.y-e.camera.position.y,z:e.objects[g].position.z-e.camera.position.z},k=e.objects[g+1].leftmostStrokeStart(),o=e.objects[g].rightmostStrokeEnd();Mark.connectionBrush(e.canvasContext,k,o,i,j,c,f)}i={offset:h,w:b.width,h:b.height,mode:"pinhole"};if(e.objects[g].reference in e.timers){if((h=a.renderer.strokesAtTime(e.objects[g].strokes,((new Date).getTime()-e.timers[e.objects[g].reference].start)*e.timers[e.objects[g].reference].speed))&&
h.length>0&&h[0].length>0)e.objects[g].renderedBounds=Mark.thickMarkBrush(e.canvasContext,h,i,colorBase,b.width,b.height)}else e.objects[g].renderedBounds=Mark.thickMarkBrush(e.canvasContext,e.objects[g].strokes,i,colorBase,b.width,b.height)}},renderMark:function(e,b,c){var f={offset:c.offset,scale:c.scale,mode:"flatScale"};if("timer"in c&&c.timer){var g=a.renderer.strokesAtTime(b.strokes,((new Date).getTime()-c.timer.start)*c.timer.speed);if(g&&g.length>0&&g[0].length>0)b.renderedBounds=Mark.thickMarkBrush(e,
g,f,c.color)}else b.renderedBounds=Mark.thickMarkBrush(e,b.strokes,f,c.color)}};return a}(Mark||{});Mark=function(a){a.camera=function(){this.position=new a.vector(0,0,-1E3)};return a}(Mark||{});Mark=function(a){a.vector=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};return a}(Mark||{});
var TWEEN=TWEEN||function(){var a,e,b,c=[];this.add=function(a){c.push(a)};this.remove=function(b){a=c.indexOf(b);a!==-1&&c.splice(a,1)};this.update=function(){a=0;e=c.length;for(b=(new Date).getTime();a<e;)c[a].update(b)?a++:(c.splice(a,1),e--)};return this}();
TWEEN.Tween=function(a){var e={},b={},c={},f=1E3,g=0,h=null,i=TWEEN.Easing.Linear.EaseNone,j=null,k=null,o=null;this.to=function(b,e){e!==null&&(f=e);for(var g in b)a[g]!==null&&(c[g]=b[g]);return this};this.start=function(){TWEEN.add(this);h=(new Date).getTime()+g;for(var f in c)a[f]!==null&&(e[f]=a[f],b[f]=c[f]-a[f]);return this};this.stop=function(){TWEEN.remove(this);return this};this.delay=function(a){g=a;return this};this.easing=function(a){i=a;return this};this.chain=function(a){j=a};this.onUpdate=
function(a){k=a;return this};this.onComplete=function(a){o=a;return this};this.update=function(c){var g,q;if(c<h)return!0;c=(c-h)/f;c=c>1?1:c;q=i(c);for(g in b)a[g]=e[g]+b[g]*q;k!==null&&k.call(a,q);if(c==1)return o!==null&&o.call(a),j!==null&&j.start(),!1;return!0}};TWEEN.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};TWEEN.Easing.Linear.EaseNone=function(a){return a};
TWEEN.Easing.Quadratic.EaseIn=function(a){return a*a};TWEEN.Easing.Quadratic.EaseOut=function(a){return-a*(a-2)};TWEEN.Easing.Quadratic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a;return-0.5*(--a*(a-2)-1)};TWEEN.Easing.Cubic.EaseIn=function(a){return a*a*a};TWEEN.Easing.Cubic.EaseOut=function(a){return--a*a*a+1};TWEEN.Easing.Cubic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a;return 0.5*((a-=2)*a*a+2)};TWEEN.Easing.Quartic.EaseIn=function(a){return a*a*a*a};
TWEEN.Easing.Quartic.EaseOut=function(a){return-(--a*a*a*a-1)};TWEEN.Easing.Quartic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a;return-0.5*((a-=2)*a*a*a-2)};TWEEN.Easing.Quintic.EaseIn=function(a){return a*a*a*a*a};TWEEN.Easing.Quintic.EaseOut=function(a){return(a-=1)*a*a*a*a+1};TWEEN.Easing.Quintic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a*a;return 0.5*((a-=2)*a*a*a*a+2)};TWEEN.Easing.Sinusoidal.EaseIn=function(a){return-Math.cos(a*Math.PI/2)+1};
TWEEN.Easing.Sinusoidal.EaseOut=function(a){return Math.sin(a*Math.PI/2)};TWEEN.Easing.Sinusoidal.EaseInOut=function(a){return-0.5*(Math.cos(Math.PI*a)-1)};TWEEN.Easing.Exponential.EaseIn=function(a){return a==0?0:Math.pow(2,10*(a-1))};TWEEN.Easing.Exponential.EaseOut=function(a){return a==1?1:-Math.pow(2,-10*a)+1};TWEEN.Easing.Exponential.EaseInOut=function(a){if(a==0)return 0;if(a==1)return 1;if((a*=2)<1)return 0.5*Math.pow(2,10*(a-1));return 0.5*(-Math.pow(2,-10*(a-1))+2)};
TWEEN.Easing.Circular.EaseIn=function(a){return-(Math.sqrt(1-a*a)-1)};TWEEN.Easing.Circular.EaseOut=function(a){return Math.sqrt(1- --a*a)};TWEEN.Easing.Circular.EaseInOut=function(a){if((a/=0.5)<1)return-0.5*(Math.sqrt(1-a*a)-1);return 0.5*(Math.sqrt(1-(a-=2)*a)+1)};TWEEN.Easing.Elastic.EaseIn=function(a){var e,b=0.1,c=0.4;if(a==0)return 0;if(a==1)return 1;c||(c=0.3);!b||b<1?(b=1,e=c/4):e=c/(2*Math.PI)*Math.asin(1/b);return-(b*Math.pow(2,10*(a-=1))*Math.sin((a-e)*2*Math.PI/c))};
TWEEN.Easing.Elastic.EaseOut=function(a){var e,b=0.1,c=0.4;if(a==0)return 0;if(a==1)return 1;c||(c=0.3);!b||b<1?(b=1,e=c/4):e=c/(2*Math.PI)*Math.asin(1/b);return b*Math.pow(2,-10*a)*Math.sin((a-e)*2*Math.PI/c)+1};
TWEEN.Easing.Elastic.EaseInOut=function(a){var e,b=0.1,c=0.4;if(a==0)return 0;if(a==1)return 1;c||(c=0.3);!b||b<1?(b=1,e=c/4):e=c/(2*Math.PI)*Math.asin(1/b);if((a*=2)<1)return-0.5*b*Math.pow(2,10*(a-=1))*Math.sin((a-e)*2*Math.PI/c);return b*Math.pow(2,-10*(a-=1))*Math.sin((a-e)*2*Math.PI/c)*0.5+1};TWEEN.Easing.Back.EaseIn=function(a){return a*a*(2.70158*a-1.70158)};TWEEN.Easing.Back.EaseOut=function(a){return(a-=1)*a*(2.70158*a+1.70158)+1};
TWEEN.Easing.Back.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*(3.5949095*a-2.5949095);return 0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)};TWEEN.Easing.Bounce.EaseIn=function(a){return 1-TWEEN.Easing.Bounce.EaseOut(1-a)};TWEEN.Easing.Bounce.EaseOut=function(a){return(a/=1)<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375};
TWEEN.Easing.Bounce.EaseInOut=function(a){if(a<0.5)return TWEEN.Easing.Bounce.EaseIn(a*2)*0.5;return TWEEN.Easing.Bounce.EaseOut(a*2-1)*0.5+0.5};
(function(a,e){var b,c=/:([\w\d]+)/g,f=/\?([^#]*)$/,g=function(a){return Array.prototype.slice.call(a)},h=function(a){return Object.prototype.toString.call(a)==="[object Function]"},i=function(a){return Object.prototype.toString.call(a)==="[object Array]"},j=function(a){return decodeURIComponent(a.replace(/\+/g," "))},k=encodeURIComponent,o=function(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},p=function(a){return function(b,c){return this.route.apply(this,
[a,b,c])}},m={},q=[];b=function(){var c=g(arguments),e,f;b.apps=b.apps||{};if(c.length===0||c[0]&&h(c[0]))return b.apply(b,["body"].concat(c));else if(typeof(f=c.shift())=="string")return e=b.apps[f]||new b.Application,e.element_selector=f,c.length>0&&a.each(c,function(a,b){e.use(b)}),e.element_selector!=f&&delete b.apps[f],b.apps[e.element_selector]=e};b.VERSION="0.6.3";b.addLogger=function(a){q.push(a)};b.log=function(){var c=g(arguments);c.unshift("["+Date()+"]");a.each(q,function(a,e){e.apply(b,
c)})};typeof e.console!="undefined"?h(e.console.log.apply)?b.addLogger(function(){e.console.log.apply(e.console,arguments)}):b.addLogger(function(){e.console.log(arguments)}):typeof console!="undefined"&&b.addLogger(function(){console.log.apply(console,arguments)});a.extend(b,{makeArray:g,isFunction:h,isArray:i});b.Object=function(b){return a.extend(this,b||{})};a.extend(b.Object.prototype,{escapeHTML:o,h:o,toHash:function(){var b={};a.each(this,function(a,c){h(c)||(b[a]=c)});return b},toHTML:function(){var b=
"";a.each(this,function(a,c){h(c)||(b+="<strong>"+a+"</strong> "+c+"<br />")});return b},keys:function(a){var b=[],c;for(c in this)(!h(this[c])||!a)&&b.push(c);return b},has:function(b){return this[b]&&a.trim(this[b].toString())!=""},join:function(){var a=g(arguments),b=a.shift();return a.join(b)},log:function(){b.log.apply(b,arguments)},toString:function(b){var c=[];a.each(this,function(a,e){(!h(e)||b)&&c.push('"'+a+'": '+e.toString())});return"Sammy.Object: {"+c.join(",")+"}"}});b.HashLocationProxy=
function(a,b){this.app=a;this.is_native=!1;this._startPolling(b)};b.HashLocationProxy.prototype={bind:function(){var c=this,f=this.app;a(e).bind("hashchange."+this.app.eventNamespace(),function(a,g){if(c.is_native===!1&&!g)b.log("native hash change exists, using"),c.is_native=!0,e.clearInterval(b.HashLocationProxy._interval);f.trigger("location-changed")});if(!b.HashLocationProxy._bindings)b.HashLocationProxy._bindings=0;b.HashLocationProxy._bindings++},unbind:function(){a(e).unbind("hashchange."+
this.app.eventNamespace());b.HashLocationProxy._bindings--;b.HashLocationProxy._bindings<=0&&e.clearInterval(b.HashLocationProxy._interval)},getLocation:function(){var a=e.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""},setLocation:function(a){return e.location=a},_startPolling:function(c){var f=this;if(!b.HashLocationProxy._interval){c||(c=10);var g=function(){var c=f.getLocation();(!b.HashLocationProxy._last_location||c!=b.HashLocationProxy._last_location)&&e.setTimeout(function(){a(e).trigger("hashchange",
[!0])},13);b.HashLocationProxy._last_location=c};g();b.HashLocationProxy._interval=e.setInterval(g,c)}}};b.Application=function(a){var c=this;this.routes={};this.listeners=new b.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1E3,10);this.context_prototype=function(){b.EventContext.apply(this,arguments)};this.context_prototype.prototype=new b.EventContext;h(a)&&a.apply(this,[this]);this._location_proxy||this.setLocationProxy(new b.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(a,b){c.log(c.toString(),a.cleaned_type,b||{})})};b.Application.prototype=a.extend({},b.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,
template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(b){return b?a(this.element_selector).find(b):a(this.element_selector)},use:function(){var a=g(arguments),c=a.shift(),e=c||"";try{a.unshift(this),typeof c=="string"&&(e="Sammy."+c,c=b[c]),c.apply(this,a)}catch(f){typeof c==="undefined"?this.error("Plugin Error: called use() but plugin ("+e.toString()+") is not defined",f):h(c)?this.error("Plugin Error",f):this.error("Plugin Error: called use() but '"+
e.toString()+"' is not a function",f)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a;this.isRunning()&&(b&&b.unbind(),this._location_proxy.bind())},route:function(b,e,f){var g=this,i=[],j,k;!f&&h(e)&&(f=e=b,b="any");b=b.toLowerCase();if(e.constructor==String){for(c.lastIndex=0;(k=c.exec(e))!==null;)i.push(k[1]);e=RegExp("^"+e.replace(c,"([^/]+)")+"$")}typeof f=="string"&&(f=g[f]);j=function(a){var b={verb:a,path:e,callback:f,param_names:i};g.routes[a]=
g.routes[a]||[];g.routes[a].push(b)};b==="any"?a.each(this.ROUTE_VERBS,function(a,b){j(b)}):j(b);return this},get:p("get"),post:p("post"),put:p("put"),del:p("delete"),any:p("any"),mapRoutes:function(b){var c=this;a.each(b,function(a,b){c.route.apply(c,b)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(a,b,c){var e=this;typeof c=="undefined"&&(c=b);b=function(a,b){var f;b&&b.context?(f=b.context,delete b.context):f=new e.context_prototype(e,"bind",
a.type,b,a.target);a.cleaned_type=a.type.replace(e.eventNamespace(),"");c.apply(f,[a,b])};this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b);this.isRunning()&&this._listen(a,b);return this},trigger:function(a,b){this.$element().trigger([a,this.eventNamespace()].join("."),[b]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(a,b){h(a)&&(b=a,a={});this.befores.push([a,b]);return this},after:function(a){return this.bind("event-context-after",
a)},around:function(a){this.arounds.push(a);return this},isRunning:function(){return this._running},helpers:function(b){a.extend(this.context_prototype.prototype,b);return this},helper:function(a,b){this.context_prototype.prototype[a]=b;return this},run:function(b){if(this.isRunning())return!1;var c=this;a.each(this.listeners.toHash(),function(b,e){a.each(e,function(a,e){c._listen(b,e)})});this.trigger("run",{start_url:b});this._running=!0;this.last_location=null;this.getLocation()==""&&typeof b!=
"undefined"&&this.setLocation(b);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){c._checkLocation()});this.bind("submit",function(b){return c._checkFormSubmission(a(b.target).closest("form"))===!1?b.preventDefault():!1});a(e).bind("beforeunload",function(){c.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var b=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(b.eventNamespace());
a.each(this.listeners.toHash(),function(c,e){a.each(e,function(a,e){b._unlisten(c,e)})});this._running=!1;return this},bindToAllEvents:function(b){var c=this;a.each(this.APP_EVENTS,function(a,e){c.bind(e,b)});a.each(this.listeners.keys(!0),function(a,e){c.APP_EVENTS.indexOf(e)==-1&&c.bind(e,b)});return this},routablePath:function(a){return a.replace(f,"")},lookupRoute:function(b,c){var e=this,f=!1;this.trigger("lookup-route",{verb:b,path:c});typeof this.routes[b]!="undefined"&&a.each(this.routes[b],
function(a,b){if(e.routablePath(c).match(b.path))return f=b,!1});return f},runRoute:function(b,c,e,f){var g=this,h=this.lookupRoute(b,c),i,k,m,o,p,q,s;this.log("runRoute",[b,c].join(" "));this.trigger("run-route",{verb:b,path:c,params:e});typeof e=="undefined"&&(e={});a.extend(e,this._parseQueryString(c));if(h){this.trigger("route-found",{route:h});if((q=h.path.exec(this.routablePath(c)))!==null)q.shift(),a.each(q,function(a,b){if(h.param_names[a])e[h.param_names[a]]=j(b);else{if(!e.splat)e.splat=
[];e.splat.push(j(b))}});i=new this.context_prototype(this,b,c,e,f);f=this.arounds.slice(0);m=this.befores.slice(0);p=[i].concat(e.splat);k=function(){for(var a;m.length>0;)if(o=m.shift(),g.contextMatchesOptions(i,o[0])&&(a=o[1].apply(i,[i]),a===!1))return!1;g.last_route=h;i.trigger("event-context-before",{context:i});a=h.callback.apply(i,p);i.trigger("event-context-after",{context:i});return a};a.each(f.reverse(),function(a,b){var c=k;k=function(){return b.apply(i,[c])}});try{s=k()}catch(t){this.error(["500 Error",
b,c].join(" "),t)}return s}else return this.notFound(b,c)},contextMatchesOptions:function(a,b,c){if(typeof b==="undefined"||b=={})return!0;typeof c==="undefined"&&(c=!0);if(typeof b==="string"||h(b.test))b={path:b};if(b.only)return this.contextMatchesOptions(a,b.only,!0);else if(b.except)return this.contextMatchesOptions(a,b.except,!1);var e=!0,f=!0;b.path&&(e=h(b.path.test)?b.path.test(a.path):b.path.toString()===a.path);b.verb&&(f=b.verb===a.verb);return c?f&&e:!(f&&e)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a){return this.$element().html(a)},templateCache:function(a,b){return typeof b!="undefined"?m[a]=b:m[a]},clearTemplateCache:function(){return m={}},notFound:function(a,b){var c=this.error(["404 Not Found",a,b].join(" "));return a==="get"?c:!0},error:function(a,b){b||(b=Error());b.message=[a,b.message].join(" ");this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;else this.log(b.message,b)},
_checkLocation:function(){var a,b;a=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=a)this.last_location=["get",a],b=this.runRoute("get",a);return b},_getFormVerb:function(b){b=a(b);var c,e;e=b.find('input[name="_method"]');e.length>0&&(c=e.val());c||(c=b[0].getAttribute("method"));if(!c||c=="")c="get";return a.trim(c.toString().toLowerCase())},_checkFormSubmission:function(b){var c,e,f;this.trigger("check-form-submission",{form:b});c=a(b);e=c.attr("action");
f=this._getFormVerb(c);this.log("_checkFormSubmission",c,e,f);f==="get"?(this.setLocation(e+"?"+this._serializeFormParams(c)),b=!1):(c=a.extend({},this._parseFormParams(c)),b=this.runRoute(f,e,c,b.get(0)));return typeof b=="undefined"?!1:b},_serializeFormParams:function(a){var b="";a=a.serializeArray();var c;if(a.length>0){b=this._encodeFormPair(a[0].name,a[0].value);for(c=1;c<a.length;c++)b=b+"&"+this._encodeFormPair(a[c].name,a[c].value)}return b},_encodeFormPair:function(a,b){return k(a)+"="+k(b)},
_parseFormParams:function(a){var b={};a=a.serializeArray();var c;for(c=0;c<a.length;c++)b=this._parseParamPair(b,a[c].name,a[c].value);return b},_parseQueryString:function(a){var b={},c,e;if(a=a.match(f)){a=a[1].split("&");for(e=0;e<a.length;e++)c=a[e].split("="),b=this._parseParamPair(b,j(c[0]),j(c[1]))}return b},_parseParamPair:function(a,b,c){a[b]?i(a[b])?a[b].push(c):a[b]=[a[b],c]:a[b]=c;return a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),b)},_unlisten:function(a,
b){return this.$element().unbind([a,this.eventNamespace()].join("."),b)}});b.RenderContext=function(a){this.event_context=a;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=!1};b.RenderContext.prototype=a.extend({},b.Object.prototype,{then:function(a){if(!h(a))if(typeof a==="string"&&a in this.event_context){var b=this.event_context[a];a=function(a){return b.apply(this.event_context,[a])}}else return this;var c=this;this.waiting?this.callbacks.push(a):(this.wait(),
e.setTimeout(function(){var b=a.apply(c,[c.content,c.previous_content]);b!==!1&&c.next(b)},13));return this},wait:function(){this.waiting=!0},next:function(a){this.waiting=!1;if(typeof a!=="undefined")this.previous_content=this.content,this.content=a;this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(b,c,e){var f=this;return this.then(function(){var g,i,j;h(c)?(e=c,c={}):c=a.extend({},c);e&&this.then(e);if(typeof b==="string"){g=(j=b.match(/\.json$/)||c.json)&&c.cache===!0||
c.cache!==!1;f.next_engine=f.event_context.engineFor(b);delete c.cache;delete c.json;if(c.engine)f.next_engine=c.engine,delete c.engine;if(g&&(i=this.event_context.app.templateCache(b)))return i;this.wait();a.ajax(a.extend({url:b,data:{},dataType:j?"json":null,type:"get",success:function(a){g&&f.event_context.app.templateCache(b,a);f.next(a)}},c));return!1}else{if(b.nodeType)return b.innerHTML;if(b.selector)return f.next_engine=b.attr("data-engine"),c.clone===!1?b.remove()[0].innerHTML.toString():
b[0].innerHTML.toString()}})},render:function(a,b,c){if(h(a)&&!b)return this.then(a);else{if(!b&&this.content)b=this.content;return this.load(a).interpolate(b,a).then(c)}},partial:function(a,b){return this.render(a,b).swap()},send:function(){var a=this,b=g(arguments),c=b.shift();i(b[0])&&(b=b[0]);return this.then(function(){b.push(function(b){a.next(b)});a.wait();c.apply(c,b);return!1})},collect:function(b,c,e){var f=this,g=function(){if(h(b))c=b,b=this.content;var e=[],g=!1;a.each(b,function(a,b){var h=
c.apply(f,[a,b]);h.jquery&&h.length==1&&(h=h[0],g=!0);e.push(h);return h});return g?e:e.join("")};return e?g():this.then(g)},renderEach:function(b,c,e,f){i(c)&&(f=e,e=c,c=null);return this.load(b).then(function(g){var h=this;e||(e=i(this.previous_content)?this.previous_content:[]);if(f)a.each(e,function(a,e){var i={},j=this.next_engine||b;c?i[c]=e:i=e;f(e,h.event_context.interpolate(g,i,j))});else return this.collect(e,function(a,e){var f={},h=this.next_engine||b;c?f[c]=e:f=e;return this.event_context.interpolate(g,
f,h)},!0)})},interpolate:function(a,b,c){var e=this;return this.then(function(f,g){!a&&g&&(a=g);if(this.next_engine)b=this.next_engine,this.next_engine=!1;var h=e.event_context.interpolate(f,a,b);return c?g+h:h})},swap:function(){return this.then(function(a){this.event_context.swap(a)}).trigger("changed",{})},appendTo:function(b){return this.then(function(c){a(b).append(c)}).trigger("changed",{})},prependTo:function(b){return this.then(function(c){a(b).prepend(c)}).trigger("changed",{})},replace:function(b){return this.then(function(c){a(b).html(c)}).trigger("changed",
{})},trigger:function(a,b){return this.then(function(c){typeof b=="undefined"&&(b={content:c});this.event_context.trigger(a,b)})}});b.EventContext=function(a,c,e,f,g){this.app=a;this.verb=c;this.path=e;this.params=new b.Object(f);this.target=g};b.EventContext.prototype=a.extend({},b.Object.prototype,{$element:function(){return this.app.$element(g(arguments).shift())},engineFor:function(a){var b;if(h(a))return a;a=(a||this.app.template_engine).toString();if(b=a.match(/\.([^\.]+)$/))a=b[1];if(a&&h(this[a]))return this[a];
if(this.app.template_engine)return this.engineFor(this.app.template_engine);return function(a){return a}},interpolate:function(a,b,c){return this.engineFor(c).apply(this,[a,b])},render:function(a,c,e){return(new b.RenderContext(this)).render(a,c,e)},renderEach:function(a,c,e,f){return(new b.RenderContext(this)).renderEach(a,c,e,f)},load:function(a,c,e){return(new b.RenderContext(this)).load(a,c,e)},partial:function(a,c){return(new b.RenderContext(this)).partial(a,c)},send:function(){var a=new b.RenderContext(this);
return a.send.apply(a,arguments)},redirect:function(){var a;a=g(arguments);var b=this.app.getLocation();a.length>1?(a.unshift("/"),a=this.join.apply(this,a)):a=a[0];this.trigger("redirect",{to:a});this.app.last_location=[this.verb,this.path];this.app.setLocation(a);b==a&&this.app.trigger("location-changed")},trigger:function(a,b){typeof b=="undefined"&&(b={});if(!b.context)b.context=this;return this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(a){return this.app.swap(a)},
notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(b){return a.parseJSON(b)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});a.sammy=e.Sammy=b})(jQuery,window);Sammy.HashPushProxy=function(a,e){this.app=a;this.supportsHistory=!(!window.history||!history.pushState);if(!this.supportsHistory)this._startPolling(e),this.is_native=!1};
Sammy.HashPushProxy.prototype={bind:function(){var a=this,e=this.app;if(this.app.supportsHistory)$(window).bind("popstate",function(){a.app.trigger("location-changed")}),$("a").live("click",function(b){location.hostname==this.hostname&&(b.preventDefault(),a.historyAPISupported?a.setLocation($(this).attr("href")):a.setLocation("#"+$(this).attr("href")),a.app.trigger("location-changed"))});else{$(window).bind("hashchange."+this.app.eventNamespace(),function(b,c){if(a.is_native===!1&&!c)Sammy.log("native hash change exists, using"),
a.is_native=!0,window.clearInterval(Sammy.HashLocationProxy._interval);e.trigger("location-changed")});if(!Sammy.HashLocationProxy._bindings)Sammy.HashLocationProxy._bindings=0;Sammy.HashLocationProxy._bindings++}},unbind:function(){this.app.supportsHistory?($("a").unbind("click"),$(window).unbind("popstate")):($(window).unbind("hashchange."+this.app.eventNamespace()),Sammy.HashLocationProxy._bindings--,Sammy.HashLocationProxy._bindings<=0&&window.clearInterval(Sammy.HashLocationProxy._interval))},
getLocation:function(){if(this.app.supportsHistory)return window.location.pathname;else{var a=window.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""}},setLocation:function(a){if(this.app.supportsHistory)history.pushState({path:this.path},"",a);else return window.location=a},_startPolling:function(a){var e=this;if(!Sammy.HashLocationProxy._interval){a||(a=10);var b=function(){var a=e.getLocation();(!Sammy.HashLocationProxy._last_location||a!=Sammy.HashLocationProxy._last_location)&&window.setTimeout(function(){$(window).trigger("hashchange",
[!0])},13);Sammy.HashLocationProxy._last_location=a};b();Sammy.HashLocationProxy._interval=window.setInterval(b,a)}}};
(function(a){var e={};Sammy=Sammy||{};Sammy.Template=function(b,c){c||(c="template");b.helper(c,function(b,c,h,i){typeof h=="undefined"&&(h=b);typeof i=="undefined"&&typeof h=="object"&&(i=h,h=b);a:{c=a.extend({},this,c);if(e[h])b=e[h];else{if(typeof b=="undefined"){b=!1;break a}i=i&&i.escape_html===!1?'",$1,"':'",h($1),"';b=e[h]=new Function("obj",'var ___$$$___=[],print=function(){___$$$___.push.apply(___$$$___,arguments);};with(obj){___$$$___.push("'+String(b).replace(/[\r\t\n]/g," ").replace(/\"/g,
'\\"').split("<%").join("\t").replace(/((^|%>)[^\t]*)/g,"$1\r").replace(/\t=(.*?)%>/g,i).replace(/\t!(.*?)%>/g,'",$1,"').split("\t").join('");').split("%>").join('___$$$___.push("').split("\r").join("")+"\");}return ___$$$___.join('');")}b=typeof c!="undefined"?b(c):b}return b})}})(jQuery);
(function(a){var e=a.sammy("#sammy",function(){this.get("#/",function(){a("#markapp").markApp("unloadModule","linear");this.partial("makemark_sammy.html").then(function(){a("#markapp").markApp("addModule",{capture:{state:"intro"}});a("#markapp").markApp("addModule",{intro:{}});a("#sammy").css("zIndex","")})});this.get("#/mark/new",function(b){a("#markapp").markApp("unloadModule","linear");var c={state:"drawing",invite_code:b.params.invite,contributor_type:b.params.contributor_type};a("#markmaker").size()>
0?(a("#markapp").markApp("unloadModule","intro"),a("#markapp").markApp("addModule",{capture:c})):this.partial("makemark_sammy.html").then(function(){a("body").addClass("make-your-mark");a("#markapp").markApp("addModule",{capture:c});a("#sammy").css("zIndex","")})});this.get("#/moderate",function(){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");this.partial("/en/moderate_sammy.html").then(function(){a("#markapp").markApp("addModule",{linear:{is_flagged:!0,
linear_root:"moderate"}})})});this.get("#/moderate/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{is_flagged:!0,linear_root:"moderate",reference_mark:b.params.splat[0],playback:b.params.playback}}):this.partial("/en/moderate_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});a("#markapp").markApp("addModule",{linear:{is_flagged:!0,
linear_root:"moderate",reference_mark:b.params.splat[0],playback:b.params.playback}})})});this.get("#/linear/country/:country_code/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{country_code:b.params.country_code,reference_mark:b.params.splat[0]}}):this.partial("linear_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});
a("#markapp").markApp("addModule",{linear:{country_code:b.params.country_code,reference_mark:b.params.splat[0]}})})});this.get("#/linear/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{reference_mark:b.params.splat[0],playback:b.params.playback}}):this.partial("linear_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});
a("#markapp").markApp("addModule",{linear:{reference_mark:b.params.splat[0],playback:b.params.playback}})})});this.bind("run",function(){a("#markapp").markApp().data("markApp-context").app=e});this.swap=function(b){a("body").removeClass("make-your-mark");this.$element().fadeOut("fast",function(){a(this).html(b).fadeIn("normal");a("#markapp").trigger("ready")});a("#markapp").trigger("swap")};this.use("Template")});a(document).ready(function(){if(function(){return!!("getContext"in document.createElement("canvas"))&&
!!("JSON"in window)})a("#fallback").remove(),e.run("#/");a("#current-locale").click(function(){a(this).parent().find("ul").toggle();a(this).toggleClass("selected");return!1})})})(jQuery);
