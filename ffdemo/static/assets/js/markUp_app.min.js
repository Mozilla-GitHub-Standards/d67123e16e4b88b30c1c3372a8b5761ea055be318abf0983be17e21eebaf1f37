(function(c){c.markApp={modules:{},instances:[],fn:{}};c.fn.markApp=function(){var a=c(this),b=a.data("markApp-context");if(!b||typeof b=="undefined")b={app:null,$container:a,frameCount:0,width:0,height:0,timezoneOffset:4,minWidth:700,minHeight:500,countries:[],mouseX:null,mouseY:null,mouseDown:!1,mouseIn:!1,modules:{},usersMark:null,translatedStrings:{},locale:window.location.pathname.split("/").length>1?window.location.pathname.split("/")[1]:"en",instance:c.markApp.instances.push(a)-1,evt:{resize:function(){var a=
c(window).width(),d=c(window).height()-(c("header").height()+c("#callout-boxes").height());if(a<b.minWidth)a=b.minWidth;if(d<b.minHeight)d=b.minHeight;b.$container.parent().width(a);b.$container.parent().height(d);b.width=a;b.height=d;c(".autoResize").height(d).width(a).trigger("resize.markApp",[a,d])},mousemove:function(a){b.mouseX=a.layerX;b.mouseY=a.layerY},mousedown:function(a){"preventDefault"in a&&a.preventDefault();b.mouseDown=!0},mouseup:function(a){"preventDefault"in a&&a.preventDefault();
b.mouseDown=!1},mouseover:function(a){"preventDefault"in a&&a.preventDefault();b.mouseIn=!0},mouseout:function(a){"preventDefault"in a&&a.preventDefault();b.mouseX=null;b.mouseY=null;b.mouseIn=!1},ready:function(){b.fn.loadTranslations()}},public_fn:{addModule:function(b,a){var d,e={};if(typeof a=="string")d=a;else if(typeof a=="object")for(var k in a){d=k;e=a[k];break}c.markApp.modules[d]&&(b.modules[d]=b.modules[d]||{},"init"in c.markApp.modules[d].fn&&c.markApp.modules[d].fn.init(b,e))},unloadModule:function(b,
a){if(a=="all")for(a in b.modules)"deinit"in c.markApp.modules[a].fn&&c.markApp.modules[a].fn.deinit(b),delete b.modules[a];else a in b.modules&&("deinit"in c.markApp.modules[a].fn&&c.markApp.modules[a].fn.deinit(b),delete b.modules[a])}},fn:{trigger:function(a,d,e){typeof d=="undefined"&&(d={type:"custom"});if(a in b.evt&&b.evt[a](d)==!1)return!1;for(var j in b.modules)if(j in c.markApp.modules&&"evt"in c.markApp.modules[j]&&a in c.markApp.modules[j].evt)c.markApp.modules[j].evt[a](b,d,e)},loop:function(){b.frameCount++;
b.fn.trigger("loop",{},[])},withCountryCodes:function(a){"US"in b.countries?a(b.countries):c.ajax({url:"/media/assets/js/vendor/country_codes.json",dataType:"JSON",success:function(d){b.countries=d;for(var c=0;c<d.length;c++)b.countries[d[c].code]=d[c].name;a(b.countries)},error:function(){}})},showLoader:function(a,d,e,j){clearTimeout(b.loaderTimeout);d=typeof d==="string"?d:"";a=typeof a==="string"?a:b.fn.getString("default-loading-msg");b.fn.hideLoader();var k=c("<div />").width(b.width).height(b.height).hide().bind("click mousedown mouseup",
function(b){b.preventDefault();return!1}).addClass("overlay-wrapper autoResize").addClass(d).attr("id","markapp-loader").append(c("<div />").text(a));e&&k.append(c("<p />").html(e));j&&typeof j==="number"?b.loaderTimeout=setTimeout(function(){b.$container.append(k);k.fadeIn("fast")},j):(b.$container.append(k),k.fadeIn("fast"))},hideLoader:function(){clearTimeout(b.loaderTimeout);c("#markapp-loader").fadeOut("fast",function(){c(this).remove()})},showError:function(a,d){a=typeof a==="string"?a:b.fn.getString("default-error-msg");
b.fn.hideError();b.fn.hideLoader();var e=c("<div />").width(b.width).height(b.height).hide().click(function(a){a.preventDefault();b.fn.hideError();d&&typeof d==="string"&&b.app.setLocation(d)}).addClass("overlay-wrapper autoResize").attr("id","markapp-error").append(c("<div />").attr("id","markapp-error-content").append(c("<p />").html(a)));b.$container.append(e);e.fadeIn("fast")},hideError:function(){c("#markapp-error").fadeOut("fast",function(){c(this).remove()})},loadTranslations:function(){c("div.translated-strings").each(function(){c(this).children().each(function(){var a=
c(this);a.is("ol")?(b.translatedStrings[a.attr("id")]=[],a.children().each(function(){b.translatedStrings[a.attr("id")].push(c(this).html())})):b.translatedStrings[a.attr("id")]=a.html()})})},getString:function(a,d){return a in b.translatedStrings?typeof b.translatedStrings[a]==="object"&&typeof d==="number"?b.translatedStrings[a][d]:b.translatedStrings[a]:a},storeData:function(b,a){if(typeof localStorage!="undefined")try{typeof a==="object"&&(a=JSON.stringify(a)),localStorage.setItem(b,a)}catch(d){}},
getData:function(a){if(typeof localStorage!="undefined")return(a=localStorage.getItem(a))?(a[0]=="{"&&(a=JSON.parse(a)),a):!1},validate:{url:function(a){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(a)},string:function(a){return typeof a==="string"&&a.length!=""?!0:!1}}}},c(window).delayedBind(300,"resize",function(a){return b.fn.trigger("resize",a)}).bind("keydown keypress keyup",function(a){return b.fn.trigger(a.type,a)}).trigger("resize"),b.$container.bind("mousemove mousedown mouseup mouseover mouseout ready swap",
function(a){return b.fn.trigger(a.type,a)}),setInterval(b.fn.loop,42);var d=c.makeArray(arguments);if(d.length>0){var e=d.shift();if(e in b.public_fn)b.public_fn[e](b,typeof d[0]=="undefined"?{}:d[0])}return a.data("markApp-context",b)}})(jQuery);
(function(c){markApp=c.markApp=c.markApp||{};modules=c.markApp.modules=c.markApp.modules||{};modules.linear={defaults:{reference_mark:null,country_code:null,playback:!1,show_thanks:!1,is_flagged:!1,linear_root:"linear"},config:{marks:{},flaggings:{},orderedMarks:[],leftBuffer:[],rightBuffer:[],bufferSize:20,bufferMinSize:5,scene:null,cameraChange:{},tweens:{},layerManager:null,initialized:!1,requestingMarks:!1,moreLeft:!0,moreRight:!0,hoverMark:null,currentMark:null,playbackTimes:{},eventChange:!1},
evt:{ready:function(a){modules.linear.fn.initInterface(a)},resize:function(a){a.modules.linear.eventChange=!0;a.modules.linear.layerManager.resizeAll(a.width,a.height)},keydown:function(a,b){var d=a.modules.linear;switch(b.keyCode){case 38:b.preventDefault();d.cameraChange.aZ=10;modules.linear.fn.hideContributorInformation(a);break;case 40:b.preventDefault();d.cameraChange.aZ=-10;modules.linear.fn.hideContributorInformation(a);break;case 39:b.preventDefault();d.cameraChange.aX=10;modules.linear.fn.hideMarkInformation(a);
modules.linear.fn.hideContributorInformation(a);break;case 37:b.preventDefault(),d.cameraChange.aX=-10,modules.linear.fn.hideMarkInformation(a),modules.linear.fn.hideContributorInformation(a)}},keyup:function(a,b){var d=a.modules.linear;switch(b.keyCode){case 38:case 40:b.preventDefault();d.cameraChange.aZ=0;break;case 39:case 37:b.preventDefault(),d.cameraChange.aX=0}},keypress:function(a,b){switch(b.keyCode){case 38:case 40:case 39:case 37:b.preventDefault()}},mousedown:function(a){var b=a.modules.linear;
if(mark=modules.linear.fn.hitTest(a,a.mouseX,a.mouseY))mark==b.currentMark?modules.linear.fn.centerCurrentMark(a,function(){modules.linear.fn.showMarkInformation(a)}):b.country_code?a.app.setLocation("#/"+b.linear_root+"/country/"+b.country_code+"/"+mark.reference):a.app.setLocation("#/"+b.linear_root+"/"+mark.reference)},mousemove:function(a){var b=a.modules.linear;b.eventChange=!0;if(mark=modules.linear.fn.hoverTest(a,a.mouseX,a.mouseY,b.hoverMark)){if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?
"0,139,211":"0,0,0";b.hoverMark=mark;if(b.hoverMark.reference!=b.currentMark.reference)b.hoverMark.color="255,111,40"}else if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0",b.hoverMark=null},loop:function(a){var b=a.modules.linear,d=b.layerManager.layers.drawingLayer,e={x:b.scene.camera.position.x,y:b.scene.camera.position.y,z:b.scene.camera.position.z};if("cameraEase"in b.tweens)TWEEN.update();else{b.cameraChange.vZ+=b.cameraChange.aZ;b.cameraChange.vX+=b.cameraChange.aX;
b.cameraChange.vX*=0.93;b.cameraChange.vZ*=0.93;b.scene.camera.position.x+=b.cameraChange.vX;b.scene.camera.position.z+=b.cameraChange.vZ;var f=modules.linear.fn.closestMark(a);if(f){var g=b.scene.camera.position.y-(f.position.y+f.bHeight/2);g!=0&&Math.abs(g)>=10&&(b.scene.camera.position.y+=g>0?-10:10)}}if(!b.eventChange&&e.x==b.scene.camera.position.x&&e.y==b.scene.camera.position.y&&e.z==b.scene.camera.position.z)return!1;if(b.hoverMark&&!modules.linear.fn.hoverTest(a,a.mouseX,a.mouseY,b.hoverMark))b.hoverMark.color=
b.hoverMark.contributor_name?"0,139,211":"0,0,0",b.hoverMark=null,c("#contributor-quote-box:visible").fadeOut("fast");d.clean();modules.linear.fn.updateScene(a,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);modules.linear.fn.updateBuffers(a,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);Mark.renderer.renderScene(b.scene,{cursor:{x:a.mouseX,y:a.mouseY},width:a.width,height:a.height});b.eventChange=!1;for(f in b.scene.timers)a=(new Date).getTime(),b.scene.timers[f].end<a&&
delete b.scene.timers[f],b.eventChange=!0}},fn:{init:function(a,b){var d=a.modules.linear;if("$linear"in a.modules.linear){b.country_code!=d.country_code&&modules.linear.fn.dumpAllMarks(a);c.extend(d,d,b);for(option in modules.linear.defaults)b[option]==null&&(d[option]=modules.linear.defaults[option]);modules.linear.fn.updateInterface(a);modules.linear.fn.initMarks(a)}else c.extend(d,modules.linear.defaults,b),c.extend(d,d,modules.linear.config),d.$linear=c("<div />").addClass("linear-container"),
a.$container.append(d.$linear),d.scene=new Mark.scene,d.cameraChange={aX:0,aY:0,aZ:0,vX:0,vY:0,vZ:0},d.layerManager=new Mark.layerManager(d.$linear.get(0)),d.layerManager.addLayer("drawingLayer"),d.scene.canvasContext=d.layerManager.layers.drawingLayer.context,a.fn.trigger("resize"),d.initialized=!0;d.flaggings=a.fn.getData("markFlaggings")||{}},deinit:function(a){var b=a.modules.linear;b.$linear.fadeOut("fast",function(){b.layerManager.removeAll();b.$linear.remove();b.initialized=!1})},initInterface:function(a){var b=
a.modules.linear;c("#stats").hide();c("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a, #mark-browsing-next a, #mark-browsing-prev a").click(function(a){a.preventDefault()}).bind("mouseup mouseout",function(b){b.preventDefault();if(c(this).data("mouseDown")){if(c(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))a.modules.linear.cameraChange.aZ=0;else if(c(this).is("#mark-browsing-next a, #mark-browsing-prev a"))a.modules.linear.cameraChange.aX=0;c(this).data("mouseDown",!1)}}).bind("mousedown",
function(b){b.preventDefault();c(this).data("mouseDown",!0);if(c(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))a.modules.linear.cameraChange.aZ=c(this).is("#mark-browsing-zoom-in a")?10:-10,modules.linear.fn.hideContributorInformation(a);else if(c(this).is("#mark-browsing-next a, #mark-browsing-prev a"))a.modules.linear.cameraChange.aX=c(this).is("#mark-browsing-next a")?10:-10,modules.linear.fn.hideMarkInformation(a),modules.linear.fn.hideContributorInformation(a)});a.fn.withCountryCodes(function(d){for(var e=
c("#country-select"),f=0;f<d.length;f++){var g=c("<option />").val(d[f].code).text(d[f].name);e.append(g)}e.change(function(){var d=c(this).val();d.length!=2&&b.country_code?a.app.setLocation("#/"+b.linear_root+"/"):d.length==2&&d!=b.country_code&&a.app.setLocation("#/"+b.linear_root+"/country/"+d+"/");c(this).blur();c(".ui-selectBox-focus").removeClass("ui-selectBox-focus");a.$container.focus()});b.country_code&&e.val(b.country_code)});c("#mark-information").hide();c("#mark-playback").click(function(b){b.preventDefault();
modules.linear.fn.replayCurrentMark(a)});c("#mark-gml-download").click(function(b){b.preventDefault();modules.linear.fn.downloadCurrentMark(a)});c("#mark-flag").click(function(b){b.preventDefault();modules.linear.fn.flagCurrentMark(a)});c("#delete-mark").click(function(b){b.preventDefault();modules.linear.fn.deleteCurrentMark(a)});c("#delete-all-from-ip").click(function(b){b.preventDefault();modules.linear.fn.deleteAllFromIp(a)});c("#approve-mark-checkbox").change(function(b){b.preventDefault();b=
c(this).is(":checked");modules.linear.fn.approveCurrentMark(a,b)});c("#twitter-share").socialShare({share_url:"http://twitter.com/share",share_params:{text:a.fn.getString("twitter-msg")}});c("#facebook-share").socialShare({share_url:"http://www.facebook.com/sharer.php",share_params:{t:a.fn.getString("facebook-msg")}});modules.linear.fn.updateInterface(a);modules.linear.fn.initMarks(a);c("#sammy #country-select").selectBox({autoWidth:!1});c("#sammy #contributor-select").selectBox({autoWidth:!1})},
initMarks:function(a){var b=a.modules.linear;b.reference_mark&&b.reference_mark!=""?b.reference_mark in b.marks?modules.linear.fn.jumpToMark(a,b.reference_mark,b.playback):modules.linear.fn.loadMarks(a,{reference:b.reference_mark,include_forward:20,include_back:20,include_mark:1,success:function(d){d.success?(modules.linear.fn.setupMarks(a,d.marks),modules.linear.fn.jumpToMark(a,b.reference_mark,b.playback)):(a.fn.showError(a.fn.getString("no-marks-error-msg"),"#/linear/"),b.eventChange=!0);b.requestingMarks=
!1}}):modules.linear.fn.loadMarks(a,{offset:0,max:20,success:function(d){if(d.success){if(modules.linear.fn.setupMarks(a,d.marks),firstMark=b.marks[b.rightBuffer[0]])b.scene.camera.position.x=-4E3,b.scene.camera.position.z=-3E3,d="cameraEase"in b.tweens?b.tweens.cameraEase:new TWEEN.Tween(b.scene.camera.position),d.to({x:firstMark.bWidth/2,y:firstMark.bHeight/2,z:-1E3},2E3).onComplete(function(){delete b.tweens.cameraEase;typeof callback==="function"&&callback(this)}).easing(TWEEN.Easing.Quartic.EaseInOut).start(),
b.tweens.cameraEase=d}else a.fn.showError(a.fn.getString("no-marks-error-msg"),"#/linear/"),b.eventChange=!0;b.requestingMarks=!1}})},updateInterface:function(a){var b=a.modules.linear,d=a.fn.getData("userMark");d&&(b.country_code?d.country_code==b.country_code:1)?c("#your-mark-link").attr("href","#/"+b.linear_root+"/"+a.fn.getData("userMark").reference).show():c("#your-mark-link").hide();var e={};b.country_code?(e.country_code=b.country_code,c("#contributor-select").next().hide(),c("#contributor-select-label").hide()):
(c("#contributor-select").next().show(),c("#contributor-select-label").show());b.linear_root!="moderate"&&!c("#mark-browsing-options").is(".country-"+(b.country_code?b.country_code:"all"))&&c.ajax({url:"/requests/init_viz_data",data:e,dataType:"JSON",success:function(d){c("#mark-browsing-options").removeAttr("class").addClass("country-"+(b.country_code?b.country_code:"all"));b.country_code?(c("#first-mark-link").attr("href","#/"+b.linear_root+"/country/"+b.country_code+"/"+d.country_first_mark),c("#last-mark-link").attr("href",
"#/"+b.linear_root+"/country/"+b.country_code+"/"+d.country_last_mark)):(c("#first-mark-link").click(function(c){c.preventDefault();b.currentMark!=null&&b.currentMark.reference==d.first_mark?modules.linear.fn.centerCurrentMark(a,function(){modules.linear.fn.showMarkInformation(a)}):a.app.setLocation("#/"+b.linear_root+"/"+d.first_mark)}),c("#last-mark-link").click(function(c){c.preventDefault();b.currentMark!=null&&b.currentMark.reference==d.last_mark?modules.linear.fn.centerCurrentMark(a,function(){modules.linear.fn.showMarkInformation(a)}):
a.app.setLocation("#/"+b.linear_root+"/"+d.last_mark)}));c("#mark-browsing").collapsibleMod();c("#total-mark-count").text(d.max_id);if(c("#contributor-select option").size()==1){var g=c("#contributor-select");if(d.contributor_marks)for(var h=0;h<d.contributor_marks.length;h++){var j=c("<option />").val(d.contributor_marks[h].reference).text(d.contributor_marks[h].contributor);g.append(j)}g.change(function(){var d=c(this).val();d!="label"&&a.app.setLocation("#/"+b.linear_root+"/"+d);c(this).blur();
a.$container.focus()});b.country_code?(e.country_code=b.country_code,c("#contributor-select").next().hide(),c("#contributor-select-label").hide()):(c("#contributor-select").next().show(),c("#contributor-select-label").show())}}})},dumpAllMarks:function(a){a=a.modules.linear;for(mark in a.marks)delete a.marks[mark];a.scene.objects=[];a.leftBuffer=[];a.rightBuffer=[];a.moreRight=!0;a.moreLeft=!0;a.scene.camera.position.x=0;a.scene.camera.position.y=0;a.scene.camera.position.z=-1E3},loadMarks:function(a,
b){var d=a.modules.linear,e=b.success;delete b.success;if(d.country_code)b.country_code=d.country_code;var f=b.reference?"/requests/marks_by_reference":"/requests/all_marks";d.is_flagged&&(f="/requests/marks_by_flagged");b.reference&&!(b.reference in d.marks)&&modules.linear.fn.dumpAllMarks(a);if(!b.reference||b.reference&&!(b.reference in d.marks)){var g=a.fn.getString("default-loading-msg");if(d.show_thanks)d.show_thanks=!1,g=a.fn.getString("submission-thanks-loading-msg");a.fn.showLoader(a.fn.getString("loading-marks-msg"),
"overlay-light",g)}else a.fn.showLoader(a.fn.getString("loading-marks-msg"),"overlay-light",a.fn.getString("default-loading-msg"),4E3);c.ajax({url:f,data:b,dataType:"JSON"}).success(e).success(function(){a.fn.hideLoader()}).error(function(){a.fn.showError(a.fn.getString("error-msg"),"#/linear/");d.eventChange=!0})},setupMarks:function(a,b){var d=a.modules.linear;if(b.length!=0){for(var c=0;c<b.length;c++)b[c].reference in d.marks&&b.shift(c,1);if(b.length!=0){c=[];for(var f in d.marks)c.push([f,d.marks[f].id]);
c.sort(function(a,b){return a[1]-b[1]});var g=c.length==0||c[0][1]<b[0].id?d.rightBuffer:d.leftBuffer,h=g==d.leftBuffer?!0:!1;h&&b.reverse();var j=g.length>0?d.marks[g[h?0:g.length-1]]:d.scene.objects[h?0:d.scene.objects.length-1];for(c=0;c<b.length;c++)if(!(b[c].reference in d.marks||typeof b[c].points_obj_simplified==="undefined"||b[c].points_obj_simplified==null||b[c].points_obj_simplified=="")){var k=JSON.parse(b[c].points_obj_simplified);if(!(k==null||!(k instanceof Object)||!("strokes"in k)||
k.strokes.length==0||k.strokes[0].length<2)){f=new Mark.gmlMark(k.strokes,b[c].reference,b[c].country_code,b[c].date_drawn,k.rtl,b[c].id,b[c].is_approved);if(b[c].contributor)f.contributor_name=b[c].contributor,f.extra_info=k.extra_info,f.contributor_url=k.contributor_url,f.color="0,139,211";d.marks[f.reference]=f;j&&f.positionRelativeTo(j,h);h?g.unshift(f.reference):g.push(f.reference);j=f}}}}},refillBuffer:function(a,b){var d=a.modules.linear;if(!d.requestingMarks){d.requestingMarks=!0;var c=b==
d.leftBuffer,f=null;f=b.length>0?d.marks[b[c?0:b.length-1]]:d.scene.objects[c?0:d.scene.objects.length-1];modules.linear.fn.loadMarks(a,{reference:f.reference,include_forward:c?0:20,include_back:c?20:0,include_mark:0,success:function(b){b.success?(modules.linear.fn.setupMarks(a,b.marks),b.marks.length<18&&(d[c?"moreLeft":"moreRight"]=!1)):d[c?"moreLeft":"moreRight"]=!1;d.requestingMarks=!1}})}},updateBuffers:function(a,b,c){var e=a.modules.linear;if(e.scene.objects.length!=0){for(var f=e.scene.objects[0];f&&
f.position.x+f.bWidth<b;)e.leftBuffer.push(e.scene.objects.shift().reference),f=e.scene.objects[0];for(f=e.scene.objects[e.scene.objects.length-1];f&&f.position.x>c;)e.rightBuffer.unshift(e.scene.objects.pop().reference),f=e.scene.objects[e.scene.objects-1];e.leftBuffer.length<5&&e.scene.objects.length>0&&e.moreLeft&&!e.requestingMarks?modules.linear.fn.refillBuffer(a,e.leftBuffer):e.rightBuffer.length<5&&e.scene.objects.length>0&&e.moreRight&&!e.requestingMarks&&modules.linear.fn.refillBuffer(a,
e.rightBuffer)}},updateScene:function(a,b,c){a=a.modules.linear;if(a.rightBuffer.length>0)for(var e=a.marks[a.rightBuffer[0]];e&&e.position&&e.position.x<c;)a.scene.objects.push(a.marks[a.rightBuffer.shift()]),e=a.rightBuffer[0];if(a.leftBuffer.length>0)for(e=a.marks[a.leftBuffer[a.leftBuffer.length-1]];e&&e.position&&e.position.x+e.bWidth>b;)a.scene.objects.unshift(a.marks[a.leftBuffer.pop()]),e=a.leftBuffer[a.leftBuffer.length-1]},jumpToMark:function(a,b,c){var e=a.modules.linear;e.currentMark=
e.marks[b];if(c){var f=(new Date).getTime()*2;e.scene.timers[b]={start:f,end:f+e.currentMark.maxTime,speed:1}}modules.linear.fn.centerCurrentMark(a,function(){c&&modules.linear.fn.replayCurrentMark(a);modules.linear.fn.showMarkInformation(a)})},closestMark:function(a){a=a.modules.linear;for(var b=a.scene.objects[0],c=1;c<a.scene.objects.length;c++){var e=a.scene.objects[c];Math.abs(a.scene.camera.position.x-(e.position.x+e.bWidth/2))<Math.abs(a.scene.camera.position.x-(b.position.x+b.bWidth/2))&&
(b=e)}return b},hoverTest:function(a,b,c,e){if(e&&e.renderedBounds&&b>=e.renderedBounds.minX&&b<=e.renderedBounds.maxX&&c>=e.renderedBounds.minY&&c<=e.renderedBounds.maxY)return e;return modules.linear.fn.hitTest(a,b,c)},hitTest:function(a,b,c){a=a.modules.linear;for(var e=0;e<a.scene.objects.length;e++)if(a.scene.objects[e].renderedBounds&&b>=a.scene.objects[e].renderedBounds.minX&&b<=a.scene.objects[e].renderedBounds.maxX&&c>=a.scene.objects[e].renderedBounds.minY&&c<=a.scene.objects[e].renderedBounds.maxY)return a.scene.objects[e];
return!1},showMarkInformation:function(a){var b=a.modules.linear;if(!b.currentMark)return!1;var d=b.currentMark;c("#mark-id").text(d.id);var e=new Date(d.time);e=new Date(e.getTime()+36E5*a.timezoneOffset);var f=[];f.push(e.getHours()+":"+(String(e.getMinutes()).length==1?"0"+e.getMinutes():e.getMinutes()));f.push("GMT");f.push(a.fn.getString("month-abbreviations",e.getMonth())+" "+e.getDate()+", "+e.getFullYear());d.country_code?a.fn.withCountryCodes(function(a){d.country_code in a?c("#mark-country").text(" / "+
a[d.country_code]):c("#mark-country").text("")}):c("#mark-country").text("");d.contributor_name?(c("#mark-contributor-name").text(d.contributor_name),c("#contributor-name").text(d.contributor_name),c("#mark-flag").hide(),"extra_info"in d&&d.extra_info!=null&&d.extra_info!=""&&c("#contributor-quote").text("\u201c"+d.extra_info+"\u201d"),"contributor_url"in d&&a.fn.validate.url(d.contributor_url)?c("#mark-contributor-url").text(d.contributor_url.replace(/(ftp|http|https):\/\//,"").replace(/\/$/,"")).attr("href",
d.contributor_url):c("#mark-contributor-url").text("").attr("href",""),c("#contributor-information").show()):(modules.linear.fn.hideContributorInformation(a),c("#contributor-information").hide(),c("#mark-flag").show());c("#mark-timestamp").text(f.join(" "));c("#url-share input").val(window.location.href);if(b.linear_root!="moderate")c("#twitter-share").data("socialShare-context").share_params.url=window.location.href,c("#facebook-share").data("socialShare-context").share_params.u=window.location.href;
b.linear_root=="moderate"&&c("#approve-mark-checkbox").attr("checked",d.is_approved);b.currentMark!=null&&b.currentMark.reference in b.flaggings?c("#mark-flag").addClass("disabled"):c("#mark-flag").removeClass("disabled");c("#mark-information").fadeIn("fast")},hideMarkInformation:function(){c("#mark-information").fadeOut("fast")},showContributorInformation:function(a){a=a.modules.linear;c("#contributor-quote-box").css({left:a.currentMark.renderedBounds.minX,top:a.currentMark.renderedBounds.minY-c("#contributor-quote-box").height()-
15}).fadeIn("fast")},hideContributorInformation:function(){c("#contributor-quote-box").fadeOut("fast",function(){c("#contributor-quote, #contributor-name").text("")})},resetMarkInformation:function(){c("#mark-information").find("a").attr("href","#").end().find("#mark-id, #total-mark-count, #mark-timestamp, #mark-country")},replayCurrentMark:function(a){a=a.modules.linear;var b=(new Date).getTime();a.eventChange=!0;a.scene.timers[a.currentMark.reference]={start:b,end:b+a.currentMark.maxTime,speed:1}},
downloadCurrentMark:function(a){a=a.modules.linear;a.currentMark!=null&&a.currentMark.reference&&window.open("/gml/"+a.currentMark.reference)},flagCurrentMark:function(a){var b=a.modules.linear;b.currentMark!=null&&b.currentMark.reference in b.flaggings||c.ajax({url:"/requests/flag_mark",data:{reference:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){c("#mark-flag").addClass("disabled");b.flaggings[b.currentMark.reference]=!0;a.fn.storeData("markFlaggings",b.flaggings)},error:function(){a.fn.showError(a.fn.getString("error-msg"),
"#/linear/");b.eventChange=!0}})},deleteCurrentMark:function(a){var b=a.modules.linear,d=b.currentMark.reference;c.ajax({url:"/requests/delete_mark",data:{reference:d},type:"POST",dataType:"JSON",success:function(){modules.linear.fn.removeMarkFromScreen(a,d);b.currentMark=null;modules.linear.fn.hideMarkInformation(a)},error:function(){a.fn.showError(a.fn.getString("error-msg"),"#/linear/");b.eventChange=!0}})},deleteAllFromIp:function(a){var b=a.modules.linear;c.ajax({url:"/requests/delete_all_based_on_ip",
data:{ip:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){location.reload()},error:function(){a.fn.showError(a.fn.getString("error-msg"),"#/linear/");b.eventChange=!0}})},approveCurrentMark:function(a,b){var d=a.modules.linear,e=d.currentMark.reference;c.ajax({url:"/requests/approve_mark",data:{reference:e,should_approve:b},type:"POST",dataType:"JSON",success:function(){modules.linear.fn.removeMarkFromScreen(a,e);d.currentMark=null;modules.linear.fn.hideMarkInformation(a)},
error:function(){a.fn.showError(a.fn.getString("error-msg"),"#/linear/");d.eventChange=!0}})},removeMarkFromScreen:function(a,b){for(var c=a.modules.linear,e=null,f=0;f<c.scene.objects.length;f++)if(e||c.scene.objects[f].reference==b)e?f==0?c.scene.objects[f].positionToStart():c.scene.objects[f].positionRelativeTo(c.scene.objects[f-1]):(e=f,c.scene.objects.splice(f,1));c.eventChange=!0},centerCurrentMark:function(a,b){var c=a.modules.linear;if(c.currentMark){modules.linear.fn.showMarkInformation(a);
c.cameraChange.aX=0;c.cameraChange.vX=0;c.cameraChange.aZ=0;c.cameraChange.vZ=0;var e=Math.abs(c.currentMark.position.x-c.scene.camera.position.x)/2;e=Math.max(1E3,e);var f="cameraEase"in c.tweens?c.tweens.cameraEase:new TWEEN.Tween(c.scene.camera.position);f.to({x:c.currentMark.position.x+c.currentMark.bWidth/2,y:c.currentMark.position.y+c.currentMark.bHeight/2,z:c.currentMark.position.z-1E3},e).onComplete(function(){delete c.tweens.cameraEase;typeof b==="function"&&b(this);c.currentMark.contributor_name&&
modules.linear.fn.showContributorInformation(a)}).easing(e>1200?TWEEN.Easing.Quadratic.EaseInOut:TWEEN.Easing.Quartic.EaseInOut).start();c.tweens.cameraEase=f}else return c.eventChange=!0,!1}}}})(jQuery);
(function(c){c.markApp=c.markApp||{};var a=c.markApp.modules=c.markApp.modules||{};a.capture={defaults:{state:"intro",invite_code:null,locale:null,contributor_type:null},config:{captureLimit:300,layerManager:null,capturedPoints:0,strokes:[],framecount:0,cleanedStrokes:[],lastX:null,lastY:null,captureTime:null,rtl:null,initialized:!1,currentStroke:null,mark:null,timeBetweenStrokes:400,events:[]},evt:{resize:function(b){var c=b.modules.capture;c.layerManager.resizeAll(b.width,b.height);if(c.mark&&c.mark.strokes.length>
0)for(var e=0;e<c.mark.strokes.length;e++)a.capture.fn.drawStroke(b,c.mark.strokes[e])},mousemove:function(b){b.mouseDown&&b.modules.capture.state=="drawing"&&a.capture.fn.capturePoint(b);a.capture.fn.updateCursor(b)},mousedown:function(b){switch(b.modules.capture.state){case "drawing":c("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",0);c("#location-dialog").is(":visible")&&c("#location-dialog").fadeOut("fast");b.modules.capture.mark||a.capture.fn.startMark(b);
b.modules.capture.currentStroke||a.capture.fn.startStroke(b);break;case "intro":b.modules.capture.mark||a.capture.fn.startMark(b),b.modules.capture.currentStroke||a.capture.fn.startStroke(b),a.capture.fn.endIntro(b)}},mouseup:function(b){b.modules.capture.state=="drawing"&&(a.capture.fn.endStroke(b),c("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",200))},mouseout:function(a){a.modules.capture.layerManager.layers.cursorLayer.clean();if(a.$cursorTooltip)clearTimeout(a.tooltipFader),
a.tooltipFader=setTimeout(function(){a.$cursorTooltip&&a.$cursorTooltip.stop(!0,!0).fadeOut("fast")},100)},mouseover:function(b){a.capture.fn.updateCursor(b,!0);if(b.$cursorTooltip)clearTimeout(b.tooltipFader),b.tooltipFader=setTimeout(function(){b.$cursorTooltip&&b.$cursorTooltip.stop(!0,!0).fadeIn("fast")},100)},ready:function(b){var d=b.modules.capture;c("#markmaker").hide().children().hide();c("#markmaker-reset a").addClass("disabled").bind("mousedown",function(c){c.preventDefault();a.capture.fn.reset(b)});
c("#markmaker-submit a").addClass("disabled").bind("mousedown",function(d){d.preventDefault();c(this).is(":not(.disabled)")&&a.capture.fn.submit(b)});b.fn.withCountryCodes(function(a){for(var b=c("#markmaker-country"),d=0;d<a.length;d++){var h=c("<option />").val(a[d].code).text(a[d].name);b.append(h)}});c("#markmaker-location a").bind("mousedown",{context:b},a.capture.fn.locationDialogToggle);c("#markmaker-information").bind("mouseover",{context:b},a.capture.fn.informationDialogToggle).bind("mouseout",
{context:b},a.capture.fn.informationDialogToggle);d.state=="drawing"&&a.capture.fn.initDrawing(b);c("#sammy #markmaker-country").selectBox({autoWidth:!1})},loop:function(b){var c=b.modules.capture;if(c.initialized)switch(c.frameCount++,b.modules.capture.state){case "drawing":a.capture.fn.drawLoop(b)}}},fn:{init:function(b,d){var e=b.modules.capture;if("$capture"in e){if("state"in d)a.capture.fn.reset(b),d.state=="drawing"&&b.mouseDown&&b.fn.trigger("mousedown"),e.state=d.state,a.capture.fn.initDrawing(b)}else c.extend(e,
a.capture.defaults),c.extend(e,d),c.extend(e,a.capture.config),e.$capture=c("<div />").addClass("capture-container"),b.$container.css({zIndex:100,cursor:"none"}).append(e.$capture),e.layerManager=new Mark.layerManager(e.$capture.get(0)),a.capture.fn.initCursor(b),e.layerManager.addLayer("drawnLayer"),e.layerManager.addLayer("liveDrawingLayer"),b.fn.trigger("resize"),e.initialized=!0},deinit:function(a){var c=a.modules.capture;c.$capture.fadeOut("fast",function(){c.layerManager.removeAll();c.$capture.remove();
c.initialized=!1})},initDrawing:function(a){var d=a.modules.capture;c("#browse-marks").is(":visible")&&(c("#browse-marks, #click-anywhere, #intro-main-copy, #the-big-x").fadeOut("fast"),c("#markmaker-legal-line").fadeIn("slow"));c("#markmaker").css("background-position","0 "+(a.height-140)+"px");c("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(){c("#markmaker").css("background-position","0 "+(a.height-140)+"px");c("#location-dialog:visible").size()>0&&c("#location-dialog:visible").css({bottom:c("#markmaker-location").height()+
25,left:c("#markmaker-location").offset().left+32})});c("#markmaker").is(":visible")?c("#markmaker-controls").fadeIn("slow",function(){c("#markmaker-information").fadeIn("slow")}):c("#markmaker").width(0).show().animate({width:a.width},"slow",function(){c("#markmaker-controls").fadeIn("slow",function(){c("#markmaker-information").fadeIn("slow")});c("#markmaker-legal-line").fadeIn("slow")});c("#save-location-button").click(function(a){a.preventDefault();c("#location-dialog").fadeOut();return!1});d.invite_code&&
d.contributor_type=="t"?(d.captureLimit=1E3,d.$capture.addClass("translator"),c("#translator-fields").find("#translator-locale").text("'"+a.locale+"'").end().show().collapsibleMod().hide().fadeIn("slow")):d.invite_code&&d.contributor_type=="c"&&(d.$capture.addClass("contributor"),c("#contributor-fields").show().collapsibleMod().hide().fadeIn("slow"));a.$cursorTooltip=a.$cursorTooltip||c("#cursor-tooltip");a.$cursorTooltip.fadeIn("fast").find("p").text(a.fn.getString("cursor-tooltip-capture-msg")).end().css({top:-400}).fadeIn("fast");
setTimeout(function(){var c=a.$cursorTooltip;delete a.$cursorTooltip;c.stop(!0,!0).fadeOut("fast")},5E3)},endIntro:function(a){a.app.setLocation("#/mark/new")},locationDialogToggle:function(a){a.preventDefault();c("#location-dialog").is(":visible")?c("#location-dialog").fadeOut("fast"):c("#location-dialog").fadeIn("fast").css({bottom:c("#markmaker-location").height()+25,left:c("#markmaker-location").offset().left+32})},informationDialogToggle:function(a){a.preventDefault();a.type=="mouseout"?c("#information-dialog").fadeOut("fast"):
c("#information-dialog").fadeIn("fast").css({bottom:c("#markmaker-information").height()+36,left:c("#markmaker-information").offset().left-c("#information-dialog").width()+30})},startMark:function(a){var d=a.modules.capture;d.captureTime=(new Date).getTime();d.rtl=a.mouseX>c(window).width()/2;d.mark=new Mark.gmlMark([],"","",d.captureTime,d.rtl)},endMark:function(a){a.modules.capture.mark.setupVars()},startStroke:function(a){a=a.modules.capture;a.currentStroke=[];if(a.strokes.length>0)a.captureTime=
(new Date).getTime()-(a.strokes[a.strokes.length-1][a.strokes[a.strokes.length-1].length-1].time+a.timeBetweenStrokes)},endStroke:function(b){var d=b.modules.capture;if(d.currentStroke.length>=4){if(d.mark.strokes.length==0)c("#markmaker-submit a, #markmaker-reset a").removeClass("disabled");else{var e=d.mark.strokes[d.mark.strokes.length-1];a.capture.fn.drawGuide(d.layerManager.layers.drawnLayer.context,e[e.length-1].x,e[e.length-1].y,d.currentStroke[0].x,d.currentStroke[0].y)}d.strokes.push(d.currentStroke);
e=Mark.simplification.simplifyPath(d.currentStroke,1);e=Mark.simplification.weightPath(e,[5,10,20,40]);d.mark.strokes.push(e);d.cleanedStrokes.push(e);a.capture.fn.drawStroke(b,e);d.capturedPoints-=d.currentStroke.length-e.length}d.currentStroke=null},capturePoint:function(b){var c=b.modules.capture;if(c.capturedPoints>c.captureLimit)b.fn.trigger("mouseup"),a.capture.fn.closeShop(b);else{var e=(new Date).getTime();b=new Mark.gmlPoint(b.mouseX,b.mouseY,e-c.captureTime,0);if(c.currentStroke.length>
0)e=c.currentStroke[c.currentStroke.length-1],b.speed=e.speedToPoint(b),b.setAngleFromPoint(e),b.smoothAgainst(e,0.01);c.currentStroke.push(b);c.lastX=b.x;c.lastY=b.y;c.capturedPoints++}},reset:function(a){a=a.modules.capture;a.layerManager.layers.liveDrawingLayer.clean();a.layerManager.layers.drawnLayer.clean();a.capturedPoints=0;a.rtl=null;a.mouseDown=!1;a.lastX=null;a.lastY=null;a.strokes=[];a.currentStroke=null;a.mark=null;a.captureTime=null;a.state="drawing";c("#markmaker-submit a, #markmaker-reset a").addClass("disabled");
c("#markapp").css({cursor:"none"});c("#markmaker-instructions").fadeIn()},closeShop:function(b){var d=b.modules.capture;d.state="preview";a.capture.fn.endMark(b);d.layerManager.layers.liveDrawingLayer.clean();b=d.layerManager.layers.liveDrawingLayer.context;var e=d.lastX,f=d.lastY;b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();b.dashedLineTo(e,f,d.rtl?0:d.layerManager.layers.liveDrawingLayer.canvas.width,f,[7,5]);b.closePath();b.stroke();c("#markapp").css({cursor:"default"})},submit:function(b){var d=
b.modules.capture;if(!(d.state=="submitting"||d.mark==null||d.mark.strokes.length==0)){d.state!="preview"&&a.capture.fn.closeShop(b);d.state="submitting";c("#markmaker-submit a").addClass("disabled");var e={};e.rtl=d.rtl;e.strokes=d.strokes;e=JSON.stringify(e);var f=JSON.stringify(d.mark),g=c("#markmaker-country").val()=="label"?"":c("#markmaker-country").val();b.fn.showLoader(b.fn.getString("submitting-mark"));var h={points_obj:e,points_obj_simplified:f,country_code:g};if(d.invite_code&&d.contributor_type==
"t")h.contributor_locale=b.locale,h.invite=d.invite_code;else if(d.invite_code&&d.contributor_type=="c")h.contributor=c("#contributor-name").val(),d.mark.extra_info=c("#contributor-quote").val(),d.mark.contributor_url=c("#contributor-url").val(),h.points_obj_simplified=JSON.stringify(d.mark),h.invite=d.invite_code;c.ajax({url:"/requests/save_mark",data:h,type:"POST",dataType:"JSON",success:function(a){h.contributor_locale?b.app.setLocation("#/linear/"):(b.fn.storeData("userMark",{reference:a.mark_reference,
country_code:g}),b.app.setLocation("#/linear/"+a.mark_reference+"?playback=true&be_grateful=true"));b.fn.hideLoader()},error:function(){b.fn.showError(b.fn.getString("submit-error"))}});return!1}},drawStroke:function(a,c){var e=a.modules.capture;Mark.thickBrush(e.layerManager.layers.drawnLayer.context,[c]);e.layerManager.layers.drawnLayer.context.fillStyle="rgba(255,255,255,0.3)";e.layerManager.layers.drawnLayer.context.strokeStyle="rgba(255,255,255,0.3)";Mark.circleBrush(e.layerManager.layers.drawnLayer.context,
[c])},drawGuide:function(a,c,e,f,g){a.strokeStyle="rgba(0,0,0,0.2)";a.lineWidth=1;a.beginPath();a.dashedLineTo(c,e,f,g,[7,5]);a.closePath();a.stroke()},drawCursor:function(a,c){var e=a.context;a.clean();e.strokeStyle="#ff5400";e.fillStyle="#000000";e.beginPath();e.moveTo(0,29);e.lineTo(1,21);e.lineTo(20,2);e.lineTo(23,6);e.lineTo(0,29);e.closePath();e.stroke();c*=18.5;c+=4.5;e.beginPath();e.moveTo(0,29);e.lineTo(1,21);e.lineTo(c-3,29-(c+4));e.lineTo(c,29-c);e.lineTo(0,29);e.closePath();e.fill();a.dirtyRectangles.push({x:0,
y:0,w:30,h:30})},initCursor:function(a){a=a.modules.capture;a.layerManager.addLayer("cursorLayer");a.layerManager.layers.cursorLayer.autoResize=!1;a.layerManager.layers.cursorLayer.setSize(25,29)},updateCursor:function(b,d){var e=b.modules.capture;c(e.layerManager.layers.cursorLayer.canvas).css({top:b.mouseY-29,left:b.mouseX});if(d||e.capturedPoints!=e.lastPointCount)e.lastPointCount=e.capturedPoints,a.capture.fn.drawCursor(e.layerManager.layers.cursorLayer,(e.captureLimit-e.capturedPoints)/e.captureLimit);
b.$cursorTooltip&&b.$cursorTooltip.css({top:b.mouseY-b.$cursorTooltip.height()-32,left:b.mouseX+8})},drawLoop:function(b){var d=b.modules.capture;d.layerManager.layers.liveDrawingLayer.clean();if(d.currentStroke&&d.currentStroke.length>0)Mark.thickBrush(d.layerManager.layers.liveDrawingLayer.context,[d.currentStroke]),d.layerManager.layers.liveDrawingLayer.context.fillStyle="rgba(255,255,255,0.3)",d.layerManager.layers.liveDrawingLayer.context.strokeStyle="rgba(255,255,255,0.3)",Mark.circleBrush(d.layerManager.layers.liveDrawingLayer.context,
[d.currentStroke]);if(b.mouseIn)if(b.mouseDown)d.mark!=null&&d.currentStroke!=null&&d.mark.strokes.length>0&&d.currentStroke.length>0&&(f=d.mark.strokes[d.mark.strokes.length-1],a.capture.fn.drawGuide(d.layerManager.layers.liveDrawingLayer.context,f[f.length-1].x,f[f.length-1].y,d.currentStroke[0].x,d.currentStroke[0].y));else{var e;if(d.mark==null||d.mark.strokes.length==0)e=b.mouseX>c(window).width()/2?d.layerManager.layers.liveDrawingLayer.canvas.width:0,f=b.mouseY;else{var f=d.mark.strokes[d.mark.strokes.length-
1];e=f[f.length-1].x;f=f[f.length-1].y}a.capture.fn.drawGuide(d.layerManager.layers.liveDrawingLayer.context,e,f,b.mouseX,b.mouseY)}}}}})(jQuery);
(function(c){markApp=c.markApp=c.markApp||{};modules=c.markApp.modules=c.markApp.modules||{};modules.intro={defaults:{reference_mark:null},config:{marks:{},animationMarks:["vVR","myWb"],playbackTimes:{},vizScene:null,textScene:null,layerManager:null,initialized:!1,eventChange:!1,curLocaleMark:null,animationComplete:!1,tweens:{}},evt:{resize:function(a){a.modules.intro.layerManager.resizeAll(a.width,a.height);a.modules.intro.eventChange=!0},loop:function(a){var b=a.modules.intro;if(!b.animationComplete&&
(TWEEN.update(),b.layerManager.layers.viz.clean(),Mark.renderer.renderScene(b.vizScene,{width:a.width,height:a.height}),b.curLocaleMark)){b.layerManager.layers.mainMark.clean();var c=500/b.curLocaleMark.bWidth;Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.curLocaleMark,{offset:{x:a.width/2-115,y:a.height-240},scale:{x:c,y:c,thickness:c},color:"255,84,0",timer:b.textScene.timers[b.curLocaleMark.reference]});if(b.curLocaleMark.reference in b.textScene.timers&&(a=(new Date).getTime(),
b.textScene.timers[b.curLocaleMark.reference].end<a))b.animationComplete=!0,delete b.textScene.timers[b.curLocaleMark.reference]}},ready:function(a){c("#markmaker").hide().children().hide();c.when(modules.intro.fn.initInterface(a),modules.intro.fn.loadMarks(a)).then(function(){modules.intro.fn.runVizPreview(a)}).then(function(){modules.intro.fn.startDomAnimation(a)}).fail(function(){modules.intro.fn.simpleIntro(a)})}},fn:{init:function(a,b){var d=a.modules.intro;if(d.initialized)for(option in c.extend(d,
d,b),modules.intro.defaults)b[option]==null&&(d[option]=modules.intro.defaults[option]);else c.extend(d,modules.intro.defaults,b),c.extend(d,d,modules.intro.config),d.$intro=c("<div />").addClass("intro-container"),a.$container.append(d.$intro),d.vizScene=new Mark.scene,d.textScene=new Mark.scene,d.layerManager=new Mark.layerManager(d.$intro.get(0)),d.layerManager.addLayer("viz"),d.vizScene.canvasContext=d.layerManager.layers.viz.context,d.layerManager.addLayer("mainMark"),d.textScene.canvasContext=
d.layerManager.layers.mainMark.context,a.fn.trigger("resize"),d.initialized=!0},deinit:function(a){var b=a.modules.intro;b.$intro.fadeOut("fast",function(){b.layerManager.removeAll();b.$intro.remove();b.initialized=!1})},initInterface:function(a){c("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(b,d,e){b=d/2+Math.min(500,d/2-20);e-=140;d=!1;c("#markmaker").css("background-position","0 "+e+"px");c("#markmaker").is(":visible")||(d=!0,c("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"block"}));
c("#browse-marks").css({top:e-50,left:b-85});c("#click-anywhere").css({top:e+12,left:b-c("#intro-main-copy").width()});c("#intro-main-copy").css({top:e-c("#intro-main-copy").height()-100,left:b-c("#intro-main-copy").width()});c("#learn-more-target").position()&&c("#learn-more-link").css({top:c("#learn-more-target").position().top-5,left:Math.ceil(c("#learn-more-target").position().left)+4});modules.intro.fn.drawX(a);d&&c("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"none"})}).trigger("resize.markApp",
[a.width,a.height]).width(0).height(a.height)},loadMarks:function(a){a.fn.showLoader(a.fn.getString("loading-intro-msg"),"overlay-light");return c.ajax({url:"/requests/get_translated_marks",dataType:"JSON"}).success(function(b){modules.intro.fn.setupMarks(a,b.marks);a.fn.hideLoader()}).error(function(){a.fn.hideLoader()})},setupMarks:function(a,b){var d=a.modules.intro;if(!(typeof b==="undefined"||b.length==0)){c(d.layerManager.layers.viz.canvas).css("opacity",0);b.sort(function(){return Math.round(Math.random())-
0.5});for(var e=null,f=0;f<b.length;f++)try{var g=JSON.parse(b[f].points_obj_simplified),h=new Mark.gmlMark(g.strokes,b[f].reference,b[f].country_code,b[f].date_drawn,g.rtl,b[f].id,b[f].is_approved);if(!d.currentMark)d.currentMark=h;b[f].reference in d.marks||(d.marks[h.reference]=h);e&&h.positionRelativeTo(e,!1);if(b[f].contributor_locale==a.locale||!d.curLocaleMark){var j=(new Date).getTime()*3;d.curLocaleMark=new Mark.gmlMark(g.strokes,b[f].reference,b[f].country_code,b[f].date_drawn,g.rtl,b[f].id,
b[f].is_approved);d.textScene.timers[d.curLocaleMark.reference]={start:j,end:j+d.curLocaleMark.maxTime,speed:2}}d.vizScene.objects.push(h);e=h}catch(k){}}},runVizPreview:function(a){var b=a.modules.intro;if(!b.initialized)return!1;if(!(b.vizScene.objects.length<3)){b.vizScene.camera.position.x=-2E3;b.vizScene.camera.position.z=-3E3;a=b.vizScene.objects[b.vizScene.objects.length-2];var d=new TWEEN.Tween(b.vizScene.camera.position);d.to({x:a.position.x+a.bWidth/2,y:a.position.y+a.bHeight/2,z:a.position.z-
2E3},6E3).onComplete(function(){delete b.tweens.cameraEase}).easing(TWEEN.Easing.Quartic.EaseInOut).start();b.tweens.cameraEase=d;c(b.layerManager.layers.viz.canvas).animate({opacity:"1"},"slow").delay(2E3).animate({opacity:"0.1"},"slow");c("#markmaker").delay(3E3)}},startDomAnimation:function(a){c("#markmaker").width(0).show().animate({width:a.width},"slow",function(){modules.intro.fn.startMarkAnimations(a);c("#intro-main-copy").fadeIn("slow");c("#click-anywhere").delay(200).fadeIn("slow");c("#browse-marks").delay(100).fadeIn("slow")});
setTimeout(function(){a.$cursorTooltip=c("#cursor-tooltip").find("p").text(a.fn.getString("cursor-tooltip-intro-msg")).end().css({top:-400}).fadeIn("fast")},3E3)},startMarkAnimations:function(a){var b=a.modules.intro;if(!b.initialized)return!1;c("#the-big-x").css({opacity:0,display:"block"});modules.intro.fn.drawX(a);c("#the-big-x").animate({opacity:1},"slow");b.curLocaleMark?(a=(new Date).getTime()+2E3,b.textScene.timers[b.curLocaleMark.reference]={start:a,end:a+b.curLocaleMark.maxTime,speed:2}):
b.animationComplete=!0},simpleIntro:function(a){var b=a.modules.intro;if(!b.initialized)return!1;c("#markmaker").width(0).show().animate({width:a.width},"slow",function(){c("#intro-main-copy").fadeIn("slow");c("#the-big-x").css({opacity:0,display:"block"});modules.intro.fn.drawX(a);c("#the-big-x").animate({opacity:1},"slow");c("#click-anywhere").delay(200).fadeIn("slow");c("#browse-marks").delay(100).fadeIn("slow");b.animationComplete=!0})},drawX:function(a){var b=a.height+a.height/5,d=b*1.545;c("#the-big-x").css({left:a.width/
2-d+(b-400)});a=c("#the-big-x").get(0);a.width=d;a.height=b;canvg("the-big-x",'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMinYMin meet" width="100%" height="100%" viewBox="0 0 1224 792" enable-background="new 0 0 1224 792" xml:space="preserve"> \t\t\t\t<g id="Layer_1" display="none"> \t\t\t\t\t<path display="inline" fill-rule="evenodd" clip-rule="evenodd" d="M816-97c87.916-2.688,37.294,85.749,13,117                       \t\t\t\t\t\tc-30.264,38.931-96.577,79.788-116,103s-27.335,32.668-41,49c-26.93,35.01-57.494,67.122-84,103                                    \t\t\t\t\t\tc-16.653,22.542-34.166,44.127-50,68c-3.897,5.876-17.228,19.424-14,25c11.202,35.223,38.947,68.553,59,97                          \t\t\t\t\t\tc58.998,83.695,129.565,155.93,224,204c26.559,13.52,62.671,26.923,93,34c15.449,3.605,38.232-2.668,50,5                           \t\t\t\t\t\tc21.894,14.268,14.497,65.961,2,85c-33.953,51.726-136.456,26.34-183,4c-85.947-41.252-169.389-100.814-226-172                     \t\t\t\t\t\tc-23.331-29.997-46.669-60.003-70-90c-8.666-13.332-17.334-26.668-26-40c-0.333,0-0.667,0-1,0c-18.332,39.996-36.668,80.004-55,120  \t\t\t\t\t\tc-21.665,62.994-43.335,126.006-65,189c-12.244,31.37-21.457,80.739-55,90c0-1.666,0-3.334,0-5c11.7-32.594,3.705-84.403-2-118      \t\t\t\t\t\tc-5.036-29.658,7.337-78.166,13-104c15.908-72.573,32.813-143.122,58-207c8.666-20.665,17.334-41.335,26-62                         \t\t\t\t\t\tc6-11.666,12-23.334,18-35c-3.667-9.666-7.333-19.334-11-29c-7.333-27.331-14.667-54.669-22-82                                     \t\t\t\t\t\tc-16.045-62.063-23.672-125.848-42-185c-9.999-32.664-20.001-65.336-30-98c-8.999-20.998-18.001-42.002-27-63                       \t\t\t\t\t\tc76.779,39.103,141.216,144.713,177,226c11.999,31.997,24.001,64.003,36,96c0.667-0.333,1.333-0.667,2-1                            \t\t\t\t\t\tc10.472-36.963,46.599-63.172,68-91c45.154-58.712,91.206-113.961,149-160c19.042-15.169,33.894-35.797,55-49                       \t\t\t\t\t\tC759.742-85.975,794.035-83.943,816-97z"/>                                                                                       \t\t\t\t</g> \t\t\t\t<g id="Layer_2">                                                                                                                   \t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M405,475c64.012,118.065,139.136,215.681,253,284                                  \t\t\t\t\t\tc27.768,16.66,57.316,30.021,93,42c11.072,3.717,22.793,9.136,33,11c15.808,2.887,31.178-1.219,45,4                                \t\t\t\t\t\tc21.542,8.133,21.188,50.264,12,74c-26.283,67.896-140.593,38.474-192,14c-141.305-67.271-239.556-176.736-319-300                  \t\t\t\t\t\tc-31.881,61.434-60.74,130.734-85,203c-11.82,35.209-23.604,73.089-36,108c-11.828,33.311-22.438,72.428-55,88                      \t\t\t\t\t\tc5.99-41.384-1.896-86.741-2-128c-0.095-37.508,8.334-77.391,16-114c22.08-105.453,55.84-206.441,99-289                            \t\t\t\t\t\tc-50.08-146.25-67.506-325.168-132-457c56.225,32.41,95.12,83.81,129,138c34.193,54.692,63.43,116.188,83,184                       \t\t\t\t\t\tc6.874-6.477,46.569-63.042,63-83c44.561-54.126,83.771-106.884,138-154c12.407-10.78,57.147-49.181,71.33-57.065                   \t\t\t\t\t\tC637.768,32.686,673.176,15.46,697,13c20.811-2.149,50.657,5.325,53,25c1.636,13.746-15.679,56.016-22,67                           \t\t\t\t\t\tc-19.771,34.351-53.602,61.791-86,88c-31.717,25.657-60.83,54.083-87,86C500.166,345.875,449.848,406.562,405,475z"/>               \t\t\t\t</g> \t\t\t\t</svg>')}}}})(jQuery);
(function(c){function a(a){return a.replace(/-/g,"--").replace(/ /g,"-")}c.fn.extend({delayedBind:function(b,d,e,f){var g=a(d);return this.each(function(){var a=this;c(this).data("_delayedBindBound-"+g+"-"+b)||(c(this).data("_delayedBindBound-"+g+"-"+b,!0),c(this).bind(d,function(){var d=c(this).data("_delayedBindTimerID-"+g+"-"+b);typeof d!="undefined"&&clearTimeout(d);d=setTimeout(function(){c(a).trigger("_delayedBind-"+g+"-"+b)},b);c(this).data("_delayedBindTimerID-"+g+"-"+b,d)}));c(this).bind("_delayedBind-"+
g+"-"+b,e,f)})},delayedBindCancel:function(b,d){var e=a(d);return this.each(function(){var a=c(this).data("_delayedBindTimerID-"+e+"-"+b);typeof a!="undefined"&&clearTimeout(a)})},delayedBindUnbind:function(b,d,e){var f=a(d);return this.each(function(){c(this).unbind("_delayedBind-"+f+"-"+b,e)})}})})(jQuery);
(function(c){c.collapsibleMod={cfg:{collapsedClass:"collapsibleMod-collapsed",expandedClass:"collapsibleMod-expanded",$header:null,expandedHeight:0,collapsedHeight:0,$content:null,collapsed:!1,stateKey:"",saveState:!0},fn:{init:function(a,b){var d=c(a),e=c.extend({},c.collapsibleMod.cfg,b);e.$container=d;e.$header=d.find("h3:first");e.$content=d.children().not("h3:first");e.expandedHeight=e.$content.height();e.$header.bind("click",function(a){a.preventDefault();c.collapsibleMod.fn.toggle(e)});e.saveState&&
e.$container.attr("id")!=""&&typeof localStorage!="undefined"?(e.stateKey="collapsibleMod-state-"+e.$container.attr("id"),c.collapsibleMod.fn.restoreState(e)):e.saveState=!1;e.collapsed?c.collapsibleMod.fn.collapse(e):e.$container.addClass(e.expandedClass);d.data("collapsibleMod-context",e)},collapse:function(a){a.$container.addClass(a.collapsedClass).removeClass(a.expandedClass);a.$content.animate({height:a.collapsedHeight},"fast",function(){a.collapsedHeight==0&&a.$content.hide()});a.collapsed=
!0;c.collapsibleMod.fn.saveState(a)},expand:function(a){a.$container.removeClass(a.collapsedClass).addClass(a.expandedClass);a.$content.show().animate({height:a.expandedHeight},"fast");a.collapsed=!1;c.collapsibleMod.fn.saveState(a)},saveState:function(a){if(a.saveState)try{localStorage.removeItem(a.stateKey),localStorage.setItem(a.stateKey,a.collapsed)}catch(b){}},restoreState:function(a){if(a.saveState&&localStorage.getItem(a.stateKey))a.collapsed=localStorage.getItem(a.stateKey)==="true"},toggle:function(a){a.collapsed?
c.collapsibleMod.fn.expand(a):c.collapsibleMod.fn.collapse(a)}}};c.fn.collapsibleMod=function(a){return c(this).each(function(){c.collapsibleMod.fn.init(this,a)})}})(jQuery);
(function(c){c.socialShare={cfg:{$link:null,share_url:"http://twitter.com/share",share_title:"Share on Twitter",share_params:{},popupWidth:550,popupHeight:450},fn:{init:function(a,b){var d=c(a),e=c.extend({},c.socialShare.cfg,b);e.$link=d;e.$link.bind("click",function(a){a.preventDefault();c.socialShare.fn.share(e)});d.data("socialShare-context",e)},shareURL:function(a){var b=[];for(param in a.share_params)b.push(param+"="+encodeURIComponent(a.share_params[param]));return a.share_url+"?"+b.join("&")},
share:function(a){window.open(c.socialShare.fn.shareURL(a),a.share_title,"height="+a.popupHeight+",width="+a.popupWidth)}}};c.fn.socialShare=function(a){return c(this).each(function(){c.socialShare.fn.init(this,a)})}})(jQuery);
jQuery&&function(c){c.extend(c.fn,{selectBox:function(a,b){var d=function(a){var b=a.data.select,d=a.data.control;if(c(d).hasClass("ui-selectBox-disabled"))return!1;if(c(d).hasClass("ui-selectBox-focus")&&c("#ui-selectBox-dropdown").size()===1)return e(a,!0),!1;c(".ui-selectBox").not(d).trigger("blur");g(a);a.stopPropagation();c("#ui-selectBox-dropdown").remove();var h=c('<div id="ui-selectBox-dropdown" class="ui-corner-bottom" />'),j=c("<ul />");c(b).children("optgroup").size()===0?c(b).children("option").each(function(){var a=
c(this).text()!==""?c(this).text():"\u00a0",b="";c(this).attr("disabled")&&(b+=" ui-selectBox-disabled");c(j).append('<li class="ui-selectBox-option'+b+'">'+o(a)+"</li>")}):(c(h).addClass("ui-selectBox-hasOptgroups"),c(b).children("optgroup").each(function(){c(j).append('<li class="ui-selectBox-optgroup">'+o(c(this).attr("label"))+"</li>");c(this).children("option").each(function(){var a=c(this).text()!==""?c(this).text():"\u00a0",b="";c(this).attr("disabled")&&(b+=" ui-selectBox-disabled");c(j).append('<li class="ui-selectBox-option'+
b+'">'+o(a)+"</li>")})}));c(h).append(j);a=c(b)[0].selectedIndex;c(h).find("LI.ui-selectBox-option").eq(a).addClass("ui-selectBox-initial ui-selectBox-current");c(h).find("LI.ui-selectBox-option").hover(function(){c(h).find(".ui-selectBox-current").removeClass("ui-selectBox-current");c(this).addClass("ui-selectBox-current")},function(){c(this).removeClass("ui-selectBox-current")}).click({select:b,control:d},function(a){f(a)}).mouseup({select:b,control:d},function(a){c(a.target).trigger("click")});
c("BODY").append(h);b=c(d).offset();a=c(d).outerHeight();var s=c(d).outerWidth(),u=parseInt(c(h).css("borderLeftWidth"))+parseInt(c(h).css("borderRightWidth"));c(h).css({position:"absolute",zIndex:"999999",top:b.top+a,left:b.left,width:s-u}).show();c(d).removeClass("ui-corner-all").addClass("ui-corner-top");l(h);k(!0)},e=function(a,b){var d=a.data.control;c("#ui-selectBox-dropdown").remove();c(d).removeClass("ui-corner-top").addClass("ui-corner-all");b?c(d).focus():h(a)},f=function(a,b){var d=a.data.select,
f=a.data.control;b=b?b:a.target;if(c(b).hasClass("ui-selectBox-disabled"))return!1;var g=c(d)[0].selectedIndex;c("#ui-selectBox-dropdown .ui-selectBox-optgroup").remove();var h=c("#ui-selectBox-dropdown").find("LI.ui-selectBox-current").index();if(g!==h)c(d)[0].selectedIndex=h,c(f).find(".ui-selectBox-label").text(c(b).text()),c(d).trigger("change");e(a,!0)},g=function(a){var b=a.data.select;a=a.data.control;if(c(a).hasClass("ui-selectBox-disabled"))return!0;if(c(a).hasClass("ui-selectBox-focus"))return!1;
c(".ui-selectBox.ui-selectBox-focus").removeClass("ui-selectBox-focus");c("#ui-selectBox-dropdown").remove();c(a).addClass("ui-selectBox-focus");c(document).bind("mousedown",{select:b,control:a},h);c(document).bind("keydown",{select:b,control:a},j);c(b).trigger("focus");c(a).focus()},h=function(a){var b=a.data.select,d=a.data.control;if(a.target.id==="ui-selectBox-dropdown"||c(a.target).parents("#ui-selectBox-dropdown").size()===1)return c(d).trigger("focus"),!1;c(d).hasClass("ui-selectBox-focus")&&
(c(d).removeClass("ui-selectBox-focus"),c(document).unbind("mousedown",h),c(document).unbind("keydown",j),c(b).trigger("blur"),e(a))},j=function(a){var b=a.data.select,g=a.data.control,p=c("#ui-selectBox-dropdown");if(c(g).hasClass("ui-selectBox-disabled"))return!1;switch(a.keyCode){case 9:h(a);break;case 13:if(c(p).size()===0)return!1;b=c(p).find(".ui-selectBox-option");var j=-1;c.each(b,function(a,b){c(b).hasClass("ui-selectBox-current")&&(j=a)});j>=0&&f(a,c(b).eq(j));return!1;case 27:e(a,!0);break;
case 38:case 37:case 33:var l=a.keyCode===33?20:1;if(c(p).size()===0){if(a.altKey)return d(a),!1;a=c(b).find("OPTION").size();p=c(b)[0].selectedIndex;for(l=c(b)[0].selectedIndex-l;c(b).find("OPTION").eq(l).attr("disabled")===!0&&l>=0;)l--;l<0&&(l=c(b).find("OPTION:not([disabled]):first").index());c(b)[0].selectedIndex=l;if(c(b)[0].selectedIndex===-1)l=0,c(b)[0].selectedIndex=l;a=c(b).find("OPTION:selected").text();a===""&&(a="\u00a0");c(g).find(".ui-selectBox-label").text(a);l!==p&&c(b).trigger("change");
return!1}b=c(p).find(".ui-selectBox-option");j=-1;c.each(b,function(a,b){c(b).hasClass("ui-selectBox-current")&&(j=a)});j-=l;j<0&&(j=0);c(b).removeClass("ui-selectBox-current");c(b).eq(j).addClass("ui-selectBox-current");k();return!1;case 40:case 39:case 34:l=a.keyCode===34?20:1;if(c(p).size()===0){if(a.altKey)return d(a),!1;a=c(b).find("OPTION").size();p=c(b)[0].selectedIndex;for(l=c(b)[0].selectedIndex+l;c(b).find("OPTION").eq(l).attr("disabled")===!0&&l<=c(b).find("OPTION").size();)l++;l>a-1&&
(l=c(b).find("OPTION:not([disabled]):last").index());c(b)[0].selectedIndex=l;if(c(b)[0].selectedIndex===-1)l=c(b).find("OPTION").size()-1,c(b)[0].selectedIndex=l;a=c(b).find("OPTION:selected").text();a===""&&(a="\u00a0");c(g).find(".ui-selectBox-label").text(a);l!=p&&c(b).trigger("change");return!1}b=c(p).find(".ui-selectBox-option");j=-1;c.each(b,function(a,b){c(b).hasClass("ui-selectBox-current")&&(j=a)});j+=l;j>c(b).size()-1&&(j=c(b).size()-1);c(b).removeClass("ui-selectBox-current");c(b).eq(j).addClass("ui-selectBox-current");
k();return!1;case 36:case 35:if(c(p).size()===0){if(a.altKey)return d(a),!1;p=c(b)[0].selectedIndex;l=a.keyCode===36?0:c(b).find("OPTION").size()-1;c(b).find("OPTION").eq(l).attr("disabled")===!0&&(l=a.keyCode===36?c(b).find("OPTION:not([disabled]):first").index():c(b).find("OPTION:not([disabled]):last").index());c(b)[0].selectedIndex=l;a=c(b).find("OPTION:selected").text();a===""&&(a="\u00a0");c(g).find(".ui-selectBox-label").text(a);l!=p&&c(b).trigger("change");return!1}c(p).find(".ui-selectBox-current").removeClass("ui-selectBox-current");
a.keyCode===36?c(p).find(".ui-selectBox-option:first").addClass("ui-selectBox-current"):c(p).find(".ui-selectBox-option:last").addClass("ui-selectBox-current");k();return!1}},k=function(a){var b=c("#ui-selectBox-dropdown");if(c(b).size()===0)return!1;var d=c(b).find(".ui-selectBox-current");if(c(d).size()===0)return!1;var e=parseInt(c(d).offset().top-c(b).position().top),f=parseInt(e+c(d).outerHeight());a?c(b).scrollTop(c(d).offset().top-c(b).offset().top+c(b).scrollTop()-c(b).height()/2):(e<0&&c(b).scrollTop(c(d).offset().top-
c(b).offset().top+c(b).scrollTop()),f>c(b).height()&&c(b).scrollTop(c(d).offset().top+c(d).outerHeight()-c(b).offset().top+c(b).scrollTop()-c(b).height()))},l=function(a){c(a).css("MozUserSelect","none").bind("selectstart",function(){return!1}).bind("mousedown",function(){return!1});return!0},o=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};switch(a){case "destroy":return c(this).each(function(){var a=c(this),b=c(this).next(".ui-selectBox");
c(a)[0].tagName.toLowerCase()==="select"&&(c(b).remove(),c(a).removeData("selectBox-options").show())}),c(this);case "disable":return c(this).each(function(){var a=c(this),b=c(this).next(".ui-selectBox");c(a).attr("disabled",!0);c(b).addClass("ui-selectBox-disabled")}),c(this);case "enable":return c(this).each(function(){var a=c(this),b=c(this).next(".ui-selectBox");c(a).attr("disabled",!1);c(b).removeClass("ui-selectBox-disabled")}),c(this);case "setOptions":if(!b)return c(this);c(this).each(function(){var a=
c(this);c(this).next(".ui-selectBox");switch(typeof b){case "string":c(a).html(b);break;case "object":for(var d in c(a).html(""),b)if(b[d]!==null){if(typeof b[d]==="object"){var e=c('<optgroup label="'+d+'" />'),f;for(f in b[d])c(e).append('<option value="'+f+'">'+b[d][f]+"</option>")}else e=c('<option value="'+d+'">'+b[d]+"</option>");c(a).append(e)}}d=c(a).data("selectBox-options");c(a).selectBox("destroy");c(a).selectBox(d)});return c(this);case "value":return c("#ui-selectBox-dropdown").remove(),
c(this).each(function(){var a=c(this),d=c(this).next(".ui-selectBox");c(a).val(b);a=c(a).find(":selected").text();a===""&&(a="\u00a0");c(d).removeClass("ui-corner-top").addClass("ui-corner-all").find(".ui-selectBox-label").text(a)}),c(this);default:return c(this).each(function(){a||(a={});var b=c.extend({autoWidth:!0},a),e=c(this);if(c(this).next(".ui-selectBox").size()===0){var f=c('<a href="#" class="ui-selectBox ui-corner-all" tabindex="'+parseInt(c(e).attr("tabindex"))+'" />');c(f).addClass(c(e).attr("class")).attr({style:(c(e).attr("style")+
"").replace(/inline/,"inline-block"),title:c(e).attr("title")});c(e).data("selectBox-options",b);if(b.autoWidth){var p="";c(e).find("OPTION").each(function(){c(this).text().length>p.length&&(p=c(this).text())});b=c('<div class="ui-selectBox-dropdown" style="position: absolute; top: -9999em; left: -9999em; width: auto; display: inline-block;" />');var j=c('<li class="ui-selectBox-option">'+o(p)+"</li>");c(b).append(j);c("BODY").append(b);c(f).width(j.outerWidth());c(b).remove()}c(e)[0].tagName.toLowerCase()!==
"select"||c(e).attr("multiple")===!0||(c(e).attr("disabled")===!0&&c(f).addClass("ui-selectBox-disabled"),b=c(e).find("OPTION:selected").text(),b===""&&(b="\u00a0"),c(f).append('<span class="ui-selectBox-label">'+o(b)+"</span>"),c(f).append('<span class="ui-selectBox-arrow"></span>'),c(e).hide().after(f),l(f),c(f).bind("click",function(){return!1}).bind("mousedown",{select:e,control:f},d).bind("focus",{select:e,control:f},g).bind("blur",{select:e,control:f},h))}}),c(this)}}})}(jQuery);
CanvasRenderingContext2D.prototype.dashedLineTo=function(c,a,b,d,e){var f=function(a,b){return a<=b},g=function(a,b){return a>=b},h=function(a,b){return Math.min(a,b)},j=function(a,b){return Math.max(a,b)},k={thereYet:g,cap:h};g={thereYet:g,cap:h};if(a-d>0)g.thereYet=f,g.cap=j;if(c-b>0)k.thereYet=f,k.cap=j;this.moveTo(c,a);f=c;j=a;h=0;for(var l=!0;!k.thereYet(f,b)||!g.thereYet(j,d);){var o=Math.atan2(d-a,b-c),m=e[h];f=k.cap(b,f+Math.cos(o)*m);j=g.cap(d,j+Math.sin(o)*m);l?this.lineTo(f,j):this.moveTo(f,
j);h=(h+1)%e.length;l=!l}};CanvasRenderingContext2D.prototype.dottedArc=function(c,a,b,d,e,f){var g=Math.PI/b/2,h=d;for(d+=g;d<e;)this.beginPath(),this.arc(c,a,b,h,d,f),this.stroke(),h=d+g,d=h+g};if(!window.console)window.console={},window.console.log=function(){},window.console.dir=function(){};if(!Array.indexOf)Array.prototype.indexOf=function(c){for(var a=0;a<this.length;a++)if(this[a]==c)return a;return-1};
(function(){function c(){var a={};a.FRAMERATE=30;a.init=function(b){a.Definitions={};a.Styles={};a.Animations=[];a.Images=[];a.ctx=b;a.ViewPort=new function(){this.viewPorts=[];this.SetCurrent=function(a,b){this.viewPorts.push({width:a,height:b})};this.RemoveCurrent=function(){this.viewPorts.pop()};this.Current=function(){return this.viewPorts[this.viewPorts.length-1]};this.width=function(){return this.Current().width};this.height=function(){return this.Current().height};this.ComputeSize=function(a){if(a!=
null&&typeof a=="number")return a;if(a=="x")return this.width();if(a=="y")return this.height();return Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}}};a.init();a.ImagesLoaded=function(){for(var b=0;b<a.Images.length;b++)if(!a.Images[b].loaded)return!1;return!0};a.trim=function(a){return a.replace(/^\s+|\s+$/g,"")};a.compressSpaces=function(a){return a.replace(/[\s\r\t\n]+/gm," ")};a.ajax=function(a){var c;if(c=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"))return c.open("GET",
a,!1),c.send(null),c.responseText;return null};a.parseXml=function(a){if(window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml");else{a=a.replace(/<!DOCTYPE svg[^>]*>/,"");var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(a);return c}};a.Property=function(b,c){this.name=b;this.value=c;this.hasValue=function(){return this.value!=null&&this.value!=""};this.numValue=function(){if(!this.hasValue())return 0;var a=parseFloat(this.value);(this.value+"").match(/%$/)&&(a/=
100);return a};this.valueOrDefault=function(a){if(this.hasValue())return this.value;return a};this.numValueOrDefault=function(a){if(this.hasValue())return this.numValue();return a};var e=this;this.Color={addOpacity:function(b){var c=e.value;if(b!=null&&b!=""){var d=new RGBColor(e.value);d.ok&&(c="rgba("+d.r+", "+d.g+", "+d.b+", "+b+")")}return new a.Property(e.name,c)}};this.Definition={getDefinition:function(){var b=e.value.replace(/^(url\()?#([^\)]+)\)?$/,"$2");return a.Definitions[b]},isUrl:function(){return e.value.indexOf("url(")==
0},getFillStyle:function(b){var c=this.getDefinition();if(c!=null&&c.createGradient)return c.createGradient(a.ctx,b);if(c!=null&&c.createPattern)return c.createPattern(a.ctx,b);return null}};this.Length={DPI:function(){return 96},EM:function(b){var c=12,d=new a.Property("fontSize",a.Font.Parse(a.ctx.font).fontSize);d.hasValue()&&(c=d.Length.toPixels(b));return c},toPixels:function(b){if(!e.hasValue())return 0;var c=e.value+"";if(c.match(/em$/))return e.numValue()*this.EM(b);if(c.match(/ex$/))return e.numValue()*
this.EM(b)/2;if(c.match(/px$/))return e.numValue();if(c.match(/pt$/))return e.numValue()*1.25;if(c.match(/pc$/))return e.numValue()*15;if(c.match(/cm$/))return e.numValue()*this.DPI(b)/2.54;if(c.match(/mm$/))return e.numValue()*this.DPI(b)/25.4;if(c.match(/in$/))return e.numValue()*this.DPI(b);if(c.match(/%$/))return e.numValue()*a.ViewPort.ComputeSize(b);return e.numValue()}};this.Time={toMilliseconds:function(){if(!e.hasValue())return 0;var a=e.value+"";if(a.match(/s$/))return e.numValue()*1E3;
a.match(/ms$/);return e.numValue()}};this.Angle={toRadians:function(){if(!e.hasValue())return 0;var a=e.value+"";if(a.match(/deg$/))return e.numValue()*(Math.PI/180);if(a.match(/grad$/))return e.numValue()*(Math.PI/200);if(a.match(/rad$/))return e.numValue();return e.numValue()*(Math.PI/180)}}};a.Font=new function(){this.Styles=["normal","italic","oblique","inherit"];this.Variants=["normal","small-caps","inherit"];this.Weights=["normal","bold","bolder","lighter","100","200","300","400","500","600",
"700","800","900","inherit"];this.CreateFont=function(b,c,f,g,h,j){j=j!=null?this.Parse(j):this.CreateFont("","","","","",a.ctx.font);return{fontFamily:h||j.fontFamily,fontSize:g||j.fontSize,fontStyle:b||j.fontStyle,fontWeight:f||j.fontWeight,fontVariant:c||j.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var b=this;this.Parse=function(c){var e={};c=a.trim(a.compressSpaces(c||"")).split(" ");for(var f={fontSize:!1,
fontStyle:!1,fontWeight:!1,fontVariant:!1},g="",h=0;h<c.length;h++)if(!f.fontStyle&&b.Styles.indexOf(c[h])!=-1){if(c[h]!="inherit")e.fontStyle=c[h];f.fontStyle=!0}else if(!f.fontVariant&&b.Variants.indexOf(c[h])!=-1){if(c[h]!="inherit")e.fontVariant=c[h];f.fontStyle=f.fontVariant=!0}else if(!f.fontWeight&&b.Weights.indexOf(c[h])!=-1){if(c[h]!="inherit")e.fontWeight=c[h];f.fontStyle=f.fontVariant=f.fontWeight=!0}else if(f.fontSize)c[h]!="inherit"&&(g+=c[h]);else{if(c[h]!="inherit")e.fontSize=c[h].split("/")[0];
f.fontStyle=f.fontVariant=f.fontWeight=f.fontSize=!0}if(g!="")e.fontFamily=g;return e}};a.ToNumberArray=function(b){b=a.trim(a.compressSpaces((b||"").replace(/,/g," "))).split(" ");for(var c=0;c<b.length;c++)b[c]=parseFloat(b[c]);return b};a.Point=function(a,c){this.x=a;this.y=c;this.angleTo=function(a){return Math.atan2(a.y-this.y,a.x-this.x)};this.applyTransform=function(a){var b=this.x*a[1]+this.y*a[3]+a[5];this.x=this.x*a[0]+this.y*a[2]+a[4];this.y=b}};a.CreatePoint=function(b){b=a.ToNumberArray(b);
return new a.Point(b[0],b[1])};a.CreatePath=function(b){b=a.ToNumberArray(b);for(var c=[],e=0;e<b.length;e+=2)c.push(new a.Point(b[e],b[e+1]));return c};a.BoundingBox=function(a,c,e,f){this.y2=this.x2=this.y1=this.x1=Number.NaN;this.x=function(){return this.x1};this.y=function(){return this.y1};this.width=function(){return this.x2-this.x1};this.height=function(){return this.y2-this.y1};this.addPoint=function(a,b){if(a!=null){if(isNaN(this.x1)||isNaN(this.x2))this.x2=this.x1=a;if(a<this.x1)this.x1=
a;if(a>this.x2)this.x2=a}if(b!=null){if(isNaN(this.y1)||isNaN(this.y2))this.y2=this.y1=b;if(b<this.y1)this.y1=b;if(b>this.y2)this.y2=b}};this.addX=function(a){this.addPoint(a,null)};this.addY=function(a){this.addPoint(null,a)};this.addBoundingBox=function(a){this.addPoint(a.x1,a.y1);this.addPoint(a.x2,a.y2)};this.addQuadraticCurve=function(a,b,c,d,e,f){c=a+2/3*(c-a);d=b+2/3*(d-b);this.addBezierCurve(a,b,c,c+1/3*(e-a),d,d+1/3*(f-b),e,f)};this.addBezierCurve=function(a,b,c,d,e,f,m,n){var q=[a,b],p=
[c,d],r=[e,f],s=[m,n];this.addPoint(q[0],q[1]);this.addPoint(s[0],s[1]);for(i=0;i<=1;i++)a=function(a){return Math.pow(1-a,3)*q[i]+3*Math.pow(1-a,2)*a*p[i]+3*(1-a)*Math.pow(a,2)*r[i]+Math.pow(a,3)*s[i]},b=6*q[i]-12*p[i]+6*r[i],c=-3*q[i]+9*p[i]-9*r[i]+3*s[i],d=3*p[i]-3*q[i],c==0?b!=0&&(b=-d/b,0<b&&b<1&&(i==0&&this.addX(a(b)),i==1&&this.addY(a(b)))):(d=Math.pow(b,2)-4*d*c,d<0||(e=(-b+Math.sqrt(d))/(2*c),0<e&&e<1&&(i==0&&this.addX(a(e)),i==1&&this.addY(a(e))),b=(-b-Math.sqrt(d))/(2*c),0<b&&b<1&&(i==
0&&this.addX(a(b)),i==1&&this.addY(a(b)))))};this.isPointInBox=function(a,b){return this.x1<=a&&a<=this.x2&&this.y1<=b&&b<=this.y2};this.addPoint(a,c);this.addPoint(e,f)};a.Transform=function(b){var c=this;this.Type={};this.Type.translate=function(b){this.p=a.CreatePoint(b);this.apply=function(a){a.translate(this.p.x||0,this.p.y||0)};this.applyToPoint=function(a){a.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}};this.Type.rotate=function(b){b=a.ToNumberArray(b);this.angle=new a.Property("angle",
b[0]);this.cx=b[1]||0;this.cy=b[2]||0;this.apply=function(a){a.translate(this.cx,this.cy);a.rotate(this.angle.Angle.toRadians());a.translate(-this.cx,-this.cy)};this.applyToPoint=function(a){var b=this.angle.Angle.toRadians();a.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]);a.applyTransform([Math.cos(b),Math.sin(b),-Math.sin(b),Math.cos(b),0,0]);a.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}};this.Type.scale=function(b){this.p=a.CreatePoint(b);this.apply=function(a){a.scale(this.p.x||1,
this.p.y||this.p.x||1)};this.applyToPoint=function(a){a.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}};this.Type.matrix=function(b){this.m=a.ToNumberArray(b);this.apply=function(a){a.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])};this.applyToPoint=function(a){a.applyTransform(this.m)}};this.Type.SkewBase=function(b){this.base=c.Type.matrix;this.base(b);this.angle=new a.Property("angle",b)};this.Type.SkewBase.prototype=new this.Type.matrix;this.Type.skewX=function(a){this.base=
c.Type.SkewBase;this.base(a);this.m=[1,0,Math.tan(this.angle.Angle.toRadians()),1,0,0]};this.Type.skewX.prototype=new this.Type.SkewBase;this.Type.skewY=function(a){this.base=c.Type.SkewBase;this.base(a);this.m=[1,Math.tan(this.angle.Angle.toRadians()),0,1,0,0]};this.Type.skewY.prototype=new this.Type.SkewBase;this.transforms=[];this.apply=function(a){for(var b=0;b<this.transforms.length;b++)this.transforms[b].apply(a)};this.applyToPoint=function(a){for(var b=0;b<this.transforms.length;b++)this.transforms[b].applyToPoint(a)};
b=b.split(/\s(?=[a-z])/);for(var e=0;e<b.length;e++){var f=b[e].split("(")[0],g=b[e].split("(")[1].replace(")","");this.transforms.push(new this.Type[f](g))}};a.AspectRatio=function(b,c,e,f,g,h,j,k,l,o){c=a.compressSpaces(c);c=c.replace(/^defer\s/,"");var m=c.split(" ")[0]||"xMidYMid";c=c.split(" ")[1]||"meet";var n=e/f,q=g/h,p=Math.min(n,q),r=Math.max(n,q);c=="meet"&&(f*=p,h*=p);c=="slice"&&(f*=r,h*=r);l=new a.Property("refX",l);o=new a.Property("refY",o);l.hasValue()&&o.hasValue()?b.translate(-p*
l.Length.toPixels("x"),-p*o.Length.toPixels("y")):(m.match(/^xMid/)&&(c=="meet"&&p==q||c=="slice"&&r==q)&&b.translate(e/2-f/2,0),m.match(/YMid$/)&&(c=="meet"&&p==n||c=="slice"&&r==n)&&b.translate(0,g/2-h/2),m.match(/^xMax/)&&(c=="meet"&&p==q||c=="slice"&&r==q)&&b.translate(e-f,0),m.match(/YMax$/)&&(c=="meet"&&p==n||c=="slice"&&r==n)&&b.translate(0,g-h));m=="none"?b.scale(n,q):c=="meet"?b.scale(p,p):c=="slice"&&b.scale(r,r);b.translate(j==null?0:-j,k==null?0:-k)};a.Element={};a.Element.ElementBase=
function(b){this.attributes={};this.styles={};this.children=[];this.attribute=function(b,c){var d=this.attributes[b];if(d!=null)return d;d=new a.Property(b,"");c==!0&&(this.attributes[b]=d);return d};this.style=function(b,c){var d=this.styles[b];if(d!=null)return d;d=this.attribute(b);if(d!=null&&d.hasValue())return d;d=new a.Property(b,"");c==!0&&(this.styles[b]=d);return d};this.render=function(a){this.attribute("display").value!="none"&&(a.save(),this.setContext(a),this.renderChildren(a),this.clearContext(a),
a.restore())};this.setContext=function(){};this.clearContext=function(){};this.renderChildren=function(a){for(var b=0;b<this.children.length;b++)this.children[b].render(a)};this.addChild=function(b,c){var d=b;c&&(d=a.CreateElement(b));d.parent=this;this.children.push(d)};if(b!=null&&b.nodeType==1){for(var c=0;c<b.childNodes.length;c++){var e=b.childNodes[c];e.nodeType==1&&this.addChild(e,!0)}for(c=0;c<b.attributes.length;c++)e=b.attributes[c],this.attributes[e.nodeName]=new a.Property(e.nodeName,
e.nodeValue);b=a.Styles[this.type];if(b!=null)for(var f in b)this.styles[f]=b[f];if(this.attribute("class").hasValue()){c=a.compressSpaces(this.attribute("class").value).split(" ");for(e=0;e<c.length;e++)if(b=a.Styles["."+c[e]],b!=null)for(f in b)this.styles[f]=b[f]}if(this.attribute("style").hasValue()){b=this.attribute("style").value.split(";");for(c=0;c<b.length;c++)a.trim(b[c])!=""&&(e=b[c].split(":"),f=a.trim(e[0]),e=a.trim(e[1]),this.styles[f]=new a.Property(f,e))}this.attribute("id").hasValue()&&
a.Definitions[this.attribute("id").value]==null&&(a.Definitions[this.attribute("id").value]=this)}};a.Element.RenderedElementBase=function(b){this.base=a.Element.ElementBase;this.base(b);this.setContext=function(b){if(this.style("fill").Definition.isUrl()){var c=this.style("fill").Definition.getFillStyle(this);if(c!=null)b.fillStyle=c}else if(this.style("fill").hasValue())c=this.style("fill"),this.style("fill-opacity").hasValue()&&(c=c.Color.addOpacity(this.style("fill-opacity").value)),b.fillStyle=
c.value=="none"?"rgba(0,0,0,0)":c.value;if(this.style("stroke").Definition.isUrl()){if(c=this.style("stroke").Definition.getFillStyle(this),c!=null)b.strokeStyle=c}else if(this.style("stroke").hasValue())c=this.style("stroke"),this.style("stroke-opacity").hasValue()&&(c=c.Color.addOpacity(this.style("stroke-opacity").value)),b.strokeStyle=c.value=="none"?"rgba(0,0,0,0)":c.value;if(this.style("stroke-width").hasValue())b.lineWidth=this.style("stroke-width").Length.toPixels();if(this.style("stroke-linecap").hasValue())b.lineCap=
this.style("stroke-linecap").value;if(this.style("stroke-linejoin").hasValue())b.lineJoin=this.style("stroke-linejoin").value;if(this.style("stroke-miterlimit").hasValue())b.miterLimit=this.style("stroke-miterlimit").value;if(typeof b.font!="undefined")b.font=a.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").Length.toPixels()+"px":"",this.style("font-family").value).toString();
this.attribute("transform").hasValue()&&(new a.Transform(this.attribute("transform").value)).apply(b);this.attribute("clip-path").hasValue()&&(c=this.attribute("clip-path").Definition.getDefinition(),c!=null&&c.apply(b));if(this.style("opacity").hasValue())b.globalAlpha=this.style("opacity").numValue()}};a.Element.RenderedElementBase.prototype=new a.Element.ElementBase;a.Element.PathElementBase=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.path=function(b){b!=null&&b.beginPath();
return new a.BoundingBox};this.renderChildren=function(b){this.path(b);a.Mouse.checkPath(this,b);b.fillStyle!=""&&b.fill();b.strokeStyle!=""&&b.stroke();var c=this.getMarkers();if(c!=null){if(this.attribute("marker-start").Definition.isUrl()){var f=this.attribute("marker-start").Definition.getDefinition();f.render(b,c[0][0],c[0][1])}if(this.attribute("marker-mid").Definition.isUrl()){f=this.attribute("marker-mid").Definition.getDefinition();for(var g=1;g<c.length-1;g++)f.render(b,c[g][0],c[g][1])}this.attribute("marker-end").Definition.isUrl()&&
(f=this.attribute("marker-end").Definition.getDefinition(),f.render(b,c[c.length-1][0],c[c.length-1][1]))}};this.getBoundingBox=function(){return this.path()};this.getMarkers=function(){return null}};a.Element.PathElementBase.prototype=new a.Element.RenderedElementBase;a.Element.svg=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.baseClearContext=this.clearContext;this.clearContext=function(b){this.baseClearContext(b);a.ViewPort.RemoveCurrent()};this.baseSetContext=this.setContext;
this.setContext=function(b){b.strokeStyle="rgba(0,0,0,0)";b.lineCap="butt";b.lineJoin="miter";b.miterLimit=4;this.baseSetContext(b);this.attribute("x").hasValue()&&this.attribute("y").hasValue()&&b.translate(this.attribute("x").Length.toPixels("x"),this.attribute("y").Length.toPixels("y"));var c=a.ViewPort.width(),f=a.ViewPort.height();if(this.attribute("width").hasValue()&&this.attribute("height").hasValue()){c=this.attribute("width").Length.toPixels("x");f=this.attribute("height").Length.toPixels("y");
var g=0,h=0;this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()&&(g=-this.attribute("refX").Length.toPixels("x"),h=-this.attribute("refY").Length.toPixels("y"));b.beginPath();b.moveTo(g,h);b.lineTo(c,h);b.lineTo(c,f);b.lineTo(g,f);b.closePath();b.clip()}a.ViewPort.SetCurrent(c,f);if(this.attribute("viewBox").hasValue()){g=a.ToNumberArray(this.attribute("viewBox").value);h=g[0];var j=g[1];c=g[2];f=g[3];a.AspectRatio(b,this.attribute("preserveAspectRatio").value,a.ViewPort.width(),
c,a.ViewPort.height(),f,h,j,this.attribute("refX").value,this.attribute("refY").value);a.ViewPort.RemoveCurrent();a.ViewPort.SetCurrent(g[2],g[3])}}};a.Element.svg.prototype=new a.Element.RenderedElementBase;a.Element.rect=function(b){this.base=a.Element.PathElementBase;this.base(b);this.path=function(b){var c=this.attribute("x").Length.toPixels("x"),f=this.attribute("y").Length.toPixels("y"),g=this.attribute("width").Length.toPixels("x"),h=this.attribute("height").Length.toPixels("y"),j=this.attribute("rx").Length.toPixels("x"),
k=this.attribute("ry").Length.toPixels("y");this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue()&&(k=j);this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue()&&(j=k);b!=null&&(b.beginPath(),b.moveTo(c+j,f),b.lineTo(c+g-j,f),b.quadraticCurveTo(c+g,f,c+g,f+k),b.lineTo(c+g,f+h-k),b.quadraticCurveTo(c+g,f+h,c+g-j,f+h),b.lineTo(c+j,f+h),b.quadraticCurveTo(c,f+h,c,f+h-k),b.lineTo(c,f+k),b.quadraticCurveTo(c,f,c+j,f),b.closePath());return new a.BoundingBox(c,f,c+g,f+h)}};a.Element.rect.prototype=
new a.Element.PathElementBase;a.Element.circle=function(b){this.base=a.Element.PathElementBase;this.base(b);this.path=function(b){var c=this.attribute("cx").Length.toPixels("x"),f=this.attribute("cy").Length.toPixels("y"),g=this.attribute("r").Length.toPixels();b!=null&&(b.beginPath(),b.arc(c,f,g,0,Math.PI*2,!0),b.closePath());return new a.BoundingBox(c-g,f-g,c+g,f+g)}};a.Element.circle.prototype=new a.Element.PathElementBase;a.Element.ellipse=function(b){this.base=a.Element.PathElementBase;this.base(b);
this.path=function(b){var c=4*((Math.sqrt(2)-1)/3),f=this.attribute("rx").Length.toPixels("x"),g=this.attribute("ry").Length.toPixels("y"),h=this.attribute("cx").Length.toPixels("x"),j=this.attribute("cy").Length.toPixels("y");b!=null&&(b.beginPath(),b.moveTo(h,j-g),b.bezierCurveTo(h+c*f,j-g,h+f,j-c*g,h+f,j),b.bezierCurveTo(h+f,j+c*g,h+c*f,j+g,h,j+g),b.bezierCurveTo(h-c*f,j+g,h-f,j+c*g,h-f,j),b.bezierCurveTo(h-f,j-c*g,h-c*f,j-g,h,j-g),b.closePath());return new a.BoundingBox(h-f,j-g,h+f,j+g)}};a.Element.ellipse.prototype=
new a.Element.PathElementBase;a.Element.line=function(b){this.base=a.Element.PathElementBase;this.base(b);this.getPoints=function(){return[new a.Point(this.attribute("x1").Length.toPixels("x"),this.attribute("y1").Length.toPixels("y")),new a.Point(this.attribute("x2").Length.toPixels("x"),this.attribute("y2").Length.toPixels("y"))]};this.path=function(b){var c=this.getPoints();b!=null&&(b.beginPath(),b.moveTo(c[0].x,c[0].y),b.lineTo(c[1].x,c[1].y));return new a.BoundingBox(c[0].x,c[0].y,c[1].x,c[1].y)};
this.getMarkers=function(){var a=this.getPoints(),b=a[0].angleTo(a[1]);return[[a[0],b],[a[1],b]]}};a.Element.line.prototype=new a.Element.PathElementBase;a.Element.polyline=function(b){this.base=a.Element.PathElementBase;this.base(b);this.points=a.CreatePath(this.attribute("points").value);this.path=function(b){var c=new a.BoundingBox(this.points[0].x,this.points[0].y);b!=null&&(b.beginPath(),b.moveTo(this.points[0].x,this.points[0].y));for(var f=1;f<this.points.length;f++)c.addPoint(this.points[f].x,
this.points[f].y),b!=null&&b.lineTo(this.points[f].x,this.points[f].y);return c};this.getMarkers=function(){for(var a=[],b=0;b<this.points.length-1;b++)a.push([this.points[b],this.points[b].angleTo(this.points[b+1])]);a.push([this.points[this.points.length-1],a[a.length-1][1]]);return a}};a.Element.polyline.prototype=new a.Element.PathElementBase;a.Element.polygon=function(b){this.base=a.Element.polyline;this.base(b);this.basePath=this.path;this.path=function(a){var b=this.basePath(a);a!=null&&(a.lineTo(this.points[0].x,
this.points[0].y),a.closePath());return b}};a.Element.polygon.prototype=new a.Element.polyline;a.Element.path=function(b){this.base=a.Element.PathElementBase;this.base(b);b=this.attribute("d").value;b=b.replace(/,/gm," ");b=b.replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");b=b.replace(/([MmZzLlHhVvCcSsQqTtAa])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");b=b.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");b=b.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");b=b.replace(/([0-9])([+\-])/gm,
"$1 $2");b=b.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");b=b.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 ");b=a.compressSpaces(b);b=a.trim(b);this.PathParser=new function(b){this.tokens=b.split(" ");this.reset=function(){this.i=-1;this.previousCommand=this.command="";this.start=new a.Point(0,0);this.control=new a.Point(0,0);this.current=new a.Point(0,0);this.points=[];this.angles=[]};this.isEnd=function(){return this.i>=this.tokens.length-1};this.isCommandOrEnd=function(){if(this.isEnd())return!0;
return this.tokens[this.i+1].match(/[A-Za-z]/)!=null};this.isRelativeCommand=function(){return this.command==this.command.toLowerCase()};this.getToken=function(){this.i+=1;return this.tokens[this.i]};this.getScalar=function(){return parseFloat(this.getToken())};this.nextCommand=function(){this.previousCommand=this.command;this.command=this.getToken()};this.getPoint=function(){return this.makeAbsolute(new a.Point(this.getScalar(),this.getScalar()))};this.getAsControlPoint=function(){var a=this.getPoint();
return this.control=a};this.getAsCurrentPoint=function(){var a=this.getPoint();return this.current=a};this.getReflectedControlPoint=function(){if(this.previousCommand.toLowerCase()!="c"&&this.previousCommand.toLowerCase()!="s")return this.current;return new a.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y)};this.makeAbsolute=function(a){if(this.isRelativeCommand())a.x=this.current.x+a.x,a.y=this.current.y+a.y;return a};this.addMarker=function(a,b){this.addMarkerAngle(a,b==null?
null:b.angleTo(a))};this.addMarkerAngle=function(a,b){this.points.push(a);this.angles.push(b)};this.getMarkerPoints=function(){return this.points};this.getMarkerAngles=function(){for(var a=0;a<this.angles.length;a++)if(this.angles[a]==null)for(var b=a+1;b<this.angles.length;b++)if(this.angles[b]!=null){this.angles[a]=this.angles[b];break}return this.angles}}(b);this.path=function(b){var c=this.PathParser;c.reset();var f=new a.BoundingBox;for(b!=null&&b.beginPath();!c.isEnd();)switch(c.nextCommand(),
c.command.toUpperCase()){case "M":var g=c.getAsCurrentPoint();c.addMarker(g);f.addPoint(g.x,g.y);b!=null&&b.moveTo(g.x,g.y);for(c.start=c.current;!c.isCommandOrEnd();)g=c.getAsCurrentPoint(),c.addMarker(g),f.addPoint(g.x,g.y),b!=null&&b.lineTo(g.x,g.y);break;case "L":for(;!c.isCommandOrEnd();){var h=c.current;g=c.getAsCurrentPoint();c.addMarker(g,h);f.addPoint(g.x,g.y);b!=null&&b.lineTo(g.x,g.y)}break;case "H":for(;!c.isCommandOrEnd();)g=new a.Point((c.isRelativeCommand()?c.current.x:0)+c.getScalar(),
c.current.y),c.addMarker(g,c.current),c.current=g,f.addPoint(c.current.x,c.current.y),b!=null&&b.lineTo(c.current.x,c.current.y);break;case "V":for(;!c.isCommandOrEnd();)g=new a.Point(c.current.x,(c.isRelativeCommand()?c.current.y:0)+c.getScalar()),c.addMarker(g,c.current),c.current=g,f.addPoint(c.current.x,c.current.y),b!=null&&b.lineTo(c.current.x,c.current.y);break;case "C":for(;!c.isCommandOrEnd();){var j=c.current;h=c.getPoint();var k=c.getAsControlPoint();g=c.getAsCurrentPoint();c.addMarker(g,
k);f.addBezierCurve(j.x,j.y,h.x,h.y,k.x,k.y,g.x,g.y);b!=null&&b.bezierCurveTo(h.x,h.y,k.x,k.y,g.x,g.y)}break;case "S":for(;!c.isCommandOrEnd();)j=c.current,h=c.getReflectedControlPoint(),k=c.getAsControlPoint(),g=c.getAsCurrentPoint(),c.addMarker(g,k),f.addBezierCurve(j.x,j.y,h.x,h.y,k.x,k.y,g.x,g.y),b!=null&&b.bezierCurveTo(h.x,h.y,k.x,k.y,g.x,g.y);break;case "Q":for(;!c.isCommandOrEnd();)j=c.current,k=c.getAsControlPoint(),g=c.getAsCurrentPoint(),c.addMarker(g,k),f.addQuadraticCurve(j.x,j.y,k.x,
k.y,g.x,g.y),b!=null&&b.quadraticCurveTo(k.x,k.y,g.x,g.y);break;case "T":for(;!c.isCommandOrEnd();)j=c.current,k=c.getReflectedControlPoint(),c.control=k,g=c.getAsCurrentPoint(),c.addMarker(g,k),f.addQuadraticCurve(j.x,j.y,k.x,k.y,g.x,g.y),b!=null&&b.quadraticCurveTo(k.x,k.y,g.x,g.y);break;case "A":for(;!c.isCommandOrEnd();){j=c.current;var l=c.getScalar(),o=c.getScalar();h=c.getScalar()*(Math.PI/180);var m=c.getScalar();k=c.getScalar();g=c.getAsCurrentPoint();var n=new a.Point(Math.cos(h)*(j.x-g.x)/
2+Math.sin(h)*(j.y-g.y)/2,-Math.sin(h)*(j.x-g.x)/2+Math.cos(h)*(j.y-g.y)/2),q=Math.pow(n.x,2)/Math.pow(l,2)+Math.pow(n.y,2)/Math.pow(o,2);q>1&&(l*=Math.sqrt(q),o*=Math.sqrt(q));m=(m==k?-1:1)*Math.sqrt((Math.pow(l,2)*Math.pow(o,2)-Math.pow(l,2)*Math.pow(n.y,2)-Math.pow(o,2)*Math.pow(n.x,2))/(Math.pow(l,2)*Math.pow(n.y,2)+Math.pow(o,2)*Math.pow(n.x,2)));isNaN(m)&&(m=0);var p=new a.Point(m*l*n.y/o,m*-o*n.x/l);j=new a.Point((j.x+g.x)/2+Math.cos(h)*p.x-Math.sin(h)*p.y,(j.y+g.y)/2+Math.sin(h)*p.x+Math.cos(h)*
p.y);var r=function(a,b){return(a[0]*b[0]+a[1]*b[1])/(Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2))*Math.sqrt(Math.pow(b[0],2)+Math.pow(b[1],2)))},s=function(a,b){return(a[0]*b[1]<a[1]*b[0]?-1:1)*Math.acos(r(a,b))};m=s([1,0],[(n.x-p.x)/l,(n.y-p.y)/o]);q=[(n.x-p.x)/l,(n.y-p.y)/o];p=[(-n.x-p.x)/l,(-n.y-p.y)/o];n=s(q,p);if(r(q,p)<=-1)n=Math.PI;r(q,p)>=1&&(n=0);k==0&&n>0&&(n-=2*Math.PI);k==1&&n<0&&(n+=2*Math.PI);q=new a.Point(j.x-l*Math.cos((m+n)/2),j.y-o*Math.sin((m+n)/2));c.addMarkerAngle(q,(m+n)/2+
(k==0?1:-1)*Math.PI/2);c.addMarkerAngle(g,n+(k==0?1:-1)*Math.PI/2);f.addPoint(g.x,g.y);b!=null&&(r=l>o?l:o,g=l>o?1:l/o,l=l>o?o/l:1,b.translate(j.x,j.y),b.rotate(h),b.scale(g,l),b.arc(0,0,r,m,m+n,1-k),b.scale(1/g,1/l),b.rotate(-h),b.translate(-j.x,-j.y))}break;case "Z":b!=null&&b.closePath(),c.current=c.start}return f};this.getMarkers=function(){for(var a=this.PathParser.getMarkerPoints(),b=this.PathParser.getMarkerAngles(),c=[],g=0;g<a.length;g++)c.push([a[g],b[g]]);return c}};a.Element.path.prototype=
new a.Element.PathElementBase;a.Element.pattern=function(b){this.base=a.Element.ElementBase;this.base(b);this.createPattern=function(b){var c=new a.Element.svg;c.attributes.viewBox=new a.Property("viewBox",this.attribute("viewBox").value);c.attributes.x=new a.Property("x",this.attribute("x").value);c.attributes.y=new a.Property("y",this.attribute("y").value);c.attributes.width=new a.Property("width",this.attribute("width").value);c.attributes.height=new a.Property("height",this.attribute("height").value);
c.children=this.children;var f=document.createElement("canvas");f.width=this.attribute("width").Length.toPixels();f.height=this.attribute("height").Length.toPixels();c.render(f.getContext("2d"));return b.createPattern(f,"repeat")}};a.Element.pattern.prototype=new a.Element.ElementBase;a.Element.marker=function(b){this.base=a.Element.ElementBase;this.base(b);this.baseRender=this.render;this.render=function(b,c,f){b.translate(c.x,c.y);this.attribute("orient").valueOrDefault("auto")=="auto"&&b.rotate(f);
this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth"&&b.scale(b.lineWidth,b.lineWidth);b.save();var g=new a.Element.svg;g.attributes.viewBox=new a.Property("viewBox",this.attribute("viewBox").value);g.attributes.refX=new a.Property("refX",this.attribute("refX").value);g.attributes.refY=new a.Property("refY",this.attribute("refY").value);g.attributes.width=new a.Property("width",this.attribute("markerWidth").value);g.attributes.height=new a.Property("height",this.attribute("markerHeight").value);
g.attributes.fill=new a.Property("fill",this.attribute("fill").valueOrDefault("black"));g.attributes.stroke=new a.Property("stroke",this.attribute("stroke").valueOrDefault("none"));g.children=this.children;g.render(b);b.restore();this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth"&&b.scale(1/b.lineWidth,1/b.lineWidth);this.attribute("orient").valueOrDefault("auto")=="auto"&&b.rotate(-f);b.translate(-c.x,-c.y)}};a.Element.marker.prototype=new a.Element.ElementBase;a.Element.defs=
function(b){this.base=a.Element.ElementBase;this.base(b);this.render=function(){}};a.Element.defs.prototype=new a.Element.ElementBase;a.Element.GradientBase=function(b){this.base=a.Element.ElementBase;this.base(b);this.gradientUnits=this.attribute("gradientUnits").valueOrDefault("objectBoundingBox");this.stops=[];for(b=0;b<this.children.length;b++)this.stops.push(this.children[b]);this.getGradient=function(){};this.createGradient=function(a,b){var c=this;this.attribute("xlink:href").hasValue()&&(c=
this.attribute("xlink:href").Definition.getDefinition());for(var g=this.getGradient(a,b),h=0;h<c.stops.length;h++)g.addColorStop(c.stops[h].offset,c.stops[h].color);return g}};a.Element.GradientBase.prototype=new a.Element.ElementBase;a.Element.linearGradient=function(b){this.base=a.Element.GradientBase;this.base(b);this.getGradient=function(b,c){var f=c.getBoundingBox(),g=this.gradientUnits=="objectBoundingBox"?f.x()+f.width()*this.attribute("x1").numValue():this.attribute("x1").Length.toPixels("x"),
h=this.gradientUnits=="objectBoundingBox"?f.y()+f.height()*this.attribute("y1").numValue():this.attribute("y1").Length.toPixels("y"),j=this.gradientUnits=="objectBoundingBox"?f.x()+f.width()*this.attribute("x2").numValue():this.attribute("x2").Length.toPixels("x");f=this.gradientUnits=="objectBoundingBox"?f.y()+f.height()*this.attribute("y2").numValue():this.attribute("y2").Length.toPixels("y");g=new a.Point(g,h);j=new a.Point(j,f);this.attribute("gradientTransform").hasValue()&&(h=new a.Transform(this.attribute("gradientTransform").value),
h.applyToPoint(g),h.applyToPoint(j));return b.createLinearGradient(g.x,g.y,j.x,j.y)}};a.Element.linearGradient.prototype=new a.Element.GradientBase;a.Element.radialGradient=function(b){this.base=a.Element.GradientBase;this.base(b);this.getGradient=function(b,c){var f=c.getBoundingBox(),g=this.gradientUnits=="objectBoundingBox"?f.x()+f.width()*this.attribute("cx").numValue():this.attribute("cx").Length.toPixels("x"),h=this.gradientUnits=="objectBoundingBox"?f.y()+f.height()*this.attribute("cy").numValue():
this.attribute("cy").Length.toPixels("y"),j=g,k=h;this.attribute("fx").hasValue()&&(j=this.gradientUnits=="objectBoundingBox"?f.x()+f.width()*this.attribute("fx").numValue():this.attribute("fx").Length.toPixels("x"));this.attribute("fy").hasValue()&&(k=this.gradientUnits=="objectBoundingBox"?f.y()+f.height()*this.attribute("fy").numValue():this.attribute("fy").Length.toPixels("y"));f=this.gradientUnits=="objectBoundingBox"?(f.width()+f.height())/2*this.attribute("r").numValue():this.attribute("r").Length.toPixels();
g=new a.Point(g,h);j=new a.Point(j,k);if(this.attribute("gradientTransform").hasValue()){k=new a.Transform(this.attribute("gradientTransform").value);k.applyToPoint(g);k.applyToPoint(j);for(h=0;h<k.transforms.length;h++)f*=(k.transforms[h].m[0]+k.transforms[h].m[3])/2}return b.createRadialGradient(j.x,j.y,0,g.x,g.y,f)}};a.Element.radialGradient.prototype=new a.Element.GradientBase;a.Element.stop=function(b){this.base=a.Element.ElementBase;this.base(b);this.offset=this.attribute("offset").numValue();
b=this.style("stop-color");this.style("stop-opacity").hasValue()&&(b=b.Color.addOpacity(this.style("stop-opacity").value));this.color=b.value};a.Element.stop.prototype=new a.Element.ElementBase;a.Element.AnimateBase=function(b){this.base=a.Element.ElementBase;this.base(b);a.Animations.push(this);this.duration=0;this.begin=this.attribute("begin").Time.toMilliseconds();this.maxDuration=this.begin+this.attribute("dur").Time.toMilliseconds();this.getProperty=function(){var a=this.attribute("attributeType").value,
b=this.attribute("attributeName").value;if(a=="CSS")return this.parent.style(b,!0);return this.parent.attribute(b,!0)};this.initialValue=null;this.removed=!1;this.calcValue=function(){return""};this.update=function(a){if(this.initialValue==null)this.initialValue=this.getProperty().value;if(this.duration>this.maxDuration)if(this.attribute("repeatCount").value=="indefinite")this.duration=0;else return this.attribute("fill").valueOrDefault("remove")=="remove"&&!this.removed?(this.removed=!0,this.getProperty().value=
this.initialValue,!0):!1;this.duration+=a;a=!1;if(this.begin<this.duration)a=this.calcValue(),this.attribute("type").hasValue()&&(a=this.attribute("type").value+"("+a+")"),this.getProperty().value=a,a=!0;return a};this.progress=function(){return(this.duration-this.begin)/(this.maxDuration-this.begin)}};a.Element.AnimateBase.prototype=new a.Element.ElementBase;a.Element.animate=function(b){this.base=a.Element.AnimateBase;this.base(b);this.calcValue=function(){var a=this.attribute("from").numValue(),
b=this.attribute("to").numValue();return a+(b-a)*this.progress()}};a.Element.animate.prototype=new a.Element.AnimateBase;a.Element.animateColor=function(b){this.base=a.Element.AnimateBase;this.base(b);this.calcValue=function(){var a=new RGBColor(this.attribute("from").value),b=new RGBColor(this.attribute("to").value);if(a.ok&&b.ok){var c=a.r+(b.r-a.r)*this.progress(),g=a.g+(b.g-a.g)*this.progress();a=a.b+(b.b-a.b)*this.progress();return"rgb("+parseInt(c,10)+","+parseInt(g,10)+","+parseInt(a,10)+")"}return this.attribute("from").value}};
a.Element.animateColor.prototype=new a.Element.AnimateBase;a.Element.animateTransform=function(b){this.base=a.Element.animate;this.base(b)};a.Element.animateTransform.prototype=new a.Element.animate;a.Element.text=function(b){this.base=a.Element.RenderedElementBase;this.base(b);if(b!=null){this.children=[];for(var c=0;c<b.childNodes.length;c++){var e=b.childNodes[c];e.nodeType==1?this.addChild(e,!0):e.nodeType==3&&this.addChild(new a.Element.tspan(e),!1)}}this.baseSetContext=this.setContext;this.setContext=
function(a){this.baseSetContext(a);if(this.attribute("text-anchor").hasValue()){var b=this.attribute("text-anchor").value;a.textAlign=b=="middle"?"center":b}if(this.attribute("alignment-baseline").hasValue())a.textBaseline=this.attribute("alignment-baseline").value};this.renderChildren=function(a){for(var b=this.attribute("x").Length.toPixels("x"),c=this.attribute("y").Length.toPixels("y"),d=0;d<this.children.length;d++){var e=this.children[d];e.attribute("x").hasValue()?e.x=e.attribute("x").Length.toPixels("x"):
(e.attribute("dx").hasValue()&&(b+=e.attribute("dx").Length.toPixels("x")),e.x=b,b+=e.measureText(a));e.attribute("y").hasValue()?e.y=e.attribute("y").Length.toPixels("y"):(e.attribute("dy").hasValue()&&(c+=e.attribute("dy").Length.toPixels("y")),e.y=c);e.render(a)}}};a.Element.text.prototype=new a.Element.RenderedElementBase;a.Element.TextElementBase=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.renderChildren=function(b){b.fillText(a.compressSpaces(this.getText()),this.x,
this.y)};this.getText=function(){};this.measureText=function(b){var c=a.compressSpaces(this.getText());if(!b.measureText)return c.length*10;return b.measureText(c).width}};a.Element.TextElementBase.prototype=new a.Element.RenderedElementBase;a.Element.tspan=function(b){this.base=a.Element.TextElementBase;this.base(b);this.text=b.nodeType==3?b.nodeValue:b.childNodes[0].nodeValue;this.getText=function(){return this.text}};a.Element.tspan.prototype=new a.Element.TextElementBase;a.Element.tref=function(b){this.base=
a.Element.TextElementBase;this.base(b);this.getText=function(){var a=this.attribute("xlink:href").Definition.getDefinition();if(a!=null)return a.children[0].getText()}};a.Element.tref.prototype=new a.Element.TextElementBase;a.Element.a=function(b){this.base=a.Element.TextElementBase;this.base(b);this.hasText=!0;for(var c=0;c<b.childNodes.length;c++)if(b.childNodes[c].nodeType!=3)this.hasText=!1;this.text=this.hasText?b.childNodes[0].nodeValue:"";this.getText=function(){return this.text};this.baseRenderChildren=
this.renderChildren;this.renderChildren=function(b){if(this.hasText){this.baseRenderChildren(b);var c=new a.Property("fontSize",a.Font.Parse(a.ctx.font).fontSize);a.Mouse.checkBoundingBox(this,new a.BoundingBox(this.x,this.y-c.Length.toPixels("y"),this.x+this.measureText(b),this.y))}else c=new a.Element.g,c.children=this.children,c.parent=this,c.render(b)};this.onclick=function(){window.open(this.attribute("xlink:href").value)};this.onmousemove=function(){a.ctx.canvas.style.cursor="pointer"}};a.Element.a.prototype=
new a.Element.TextElementBase;a.Element.image=function(b){this.base=a.Element.RenderedElementBase;this.base(b);a.Images.push(this);this.img=document.createElement("img");this.loaded=!1;var c=this;this.img.onload=function(){c.loaded=!0};this.img.src=this.attribute("xlink:href").value;this.renderChildren=function(b){var c=this.attribute("x").Length.toPixels("x"),d=this.attribute("y").Length.toPixels("y"),h=this.attribute("width").Length.toPixels("x"),j=this.attribute("height").Length.toPixels("y");
h==0||j==0||(b.save(),b.translate(c,d),a.AspectRatio(b,this.attribute("preserveAspectRatio").value,h,this.img.width,j,this.img.height,0,0),b.drawImage(this.img,0,0),b.restore())}};a.Element.image.prototype=new a.Element.RenderedElementBase;a.Element.g=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.getBoundingBox=function(){for(var b=new a.BoundingBox,c=0;c<this.children.length;c++)b.addBoundingBox(this.children[c].getBoundingBox());return b}};a.Element.g.prototype=new a.Element.RenderedElementBase;
a.Element.symbol=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.baseSetContext=this.setContext;this.setContext=function(b){this.baseSetContext(b);if(this.attribute("viewBox").hasValue()){var c=a.ToNumberArray(this.attribute("viewBox").value),f=c[0],g=c[1];width=c[2];height=c[3];a.AspectRatio(b,this.attribute("preserveAspectRatio").value,this.attribute("width").Length.toPixels("x"),width,this.attribute("height").Length.toPixels("y"),height,f,g);a.ViewPort.SetCurrent(c[2],c[3])}}};
a.Element.symbol.prototype=new a.Element.RenderedElementBase;a.Element.style=function(b){this.base=a.Element.ElementBase;this.base(b);b=b.childNodes[0].nodeValue;b=b.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/gm,"");b=a.compressSpaces(b);b=b.split("}");for(var c=0;c<b.length;c++)if(a.trim(b[c])!=""){var e=b[c].split("{"),f=e[0].split(",");e=e[1].split(";");for(var g=0;g<f.length;g++){var h=a.trim(f[g]);if(h!=""){for(var j={},k=0;k<e.length;k++){var l=e[k].split(":"),o=l[1];l[0]!=
null&&o!=null&&(j[a.trim(l[0])]=new a.Property(a.trim(l[0]),a.trim(l[1])))}a.Styles[h]=j}}}};a.Element.style.prototype=new a.Element.ElementBase;a.Element.use=function(b){this.base=a.Element.RenderedElementBase;this.base(b);this.baseSetContext=this.setContext;this.setContext=function(a){this.baseSetContext(a);this.attribute("x").hasValue()&&a.translate(this.attribute("x").Length.toPixels("x"),0);this.attribute("y").hasValue()&&a.translate(0,this.attribute("y").Length.toPixels("y"))};this.getDefinition=
function(){var a=this.attribute("xlink:href").Definition.getDefinition();if(this.attribute("width").hasValue())a.attribute("width",!0).value=this.attribute("width").value;if(this.attribute("height").hasValue())a.attribute("height",!0).value=this.attribute("height").value;return a};this.path=function(a){var b=this.getDefinition();b!=null&&b.path(a)};this.renderChildren=function(a){var b=this.getDefinition();b!=null&&b.render(a)}};a.Element.use.prototype=new a.Element.RenderedElementBase;a.Element.clipPath=
function(b){this.base=a.Element.ElementBase;this.base(b);this.apply=function(a){for(var b=0;b<this.children.length;b++)this.children[b].path&&(this.children[b].path(a),a.clip())}};a.Element.clipPath.prototype=new a.Element.ElementBase;a.Element.title=function(){};a.Element.title.prototype=new a.Element.ElementBase;a.Element.desc=function(){};a.Element.desc.prototype=new a.Element.ElementBase;a.Element.MISSING=function(a){console.log("ERROR: Element '"+a.nodeName+"' not yet implemented.")};a.Element.MISSING.prototype=
new a.Element.ElementBase;a.CreateElement=function(b){var c=b.nodeName.replace(/^[^:]+:/,""),e=null;e=typeof a.Element[c]!="undefined"?new a.Element[c](b):new a.Element.MISSING(b);e.type=b.nodeName;return e};a.load=function(b,c){a.loadXml(b,a.ajax(c))};a.loadXml=function(b,c){a.init(b);var e=function(a){for(var c=b.canvas;c;)a.x-=c.offsetLeft,a.y-=c.offsetTop,c=c.offsetParent;window.scrollX&&(a.x+=window.scrollX);window.scrollY&&(a.y+=window.scrollY);return a};if(a.opts==null||a.opts.ignoreMouse!=
!0)b.canvas.onclick=function(b){b=e(new a.Point(b!=null?b.clientX:event.clientX,b!=null?b.clientY:event.clientY));a.Mouse.onclick(b.x,b.y)},b.canvas.onmousemove=function(b){b=e(new a.Point(b!=null?b.clientX:event.clientX,b!=null?b.clientY:event.clientY));a.Mouse.onmousemove(b.x,b.y)};var f=a.parseXml(c),g=a.CreateElement(f.documentElement),h=!0,j=function(){if(a.opts==null||a.opts.ignoreDimensions!=!0){if(g.style("width").hasValue())b.canvas.width=g.style("width").Length.toPixels(b.canvas.parentNode.clientWidth);
if(g.style("height").hasValue())b.canvas.height=g.style("height").Length.toPixels(b.canvas.parentNode.clientHeight)}a.ViewPort.SetCurrent(b.canvas.clientWidth,b.canvas.clientHeight);if(a.opts!=null&&a.opts.offsetX!=null)g.attribute("x",!0).value=a.opts.offsetX;if(a.opts!=null&&a.opts.offsetY!=null)g.attribute("y",!0).value=a.opts.offsetY;if(a.opts!=null&&a.opts.scaleWidth!=null&&a.opts.scaleHeight!=null)g.attribute("width",!0).value=a.opts.scaleWidth,g.attribute("height",!0).value=a.opts.scaleHeight,
g.attribute("viewBox",!0).value="0 0 "+b.canvas.clientWidth+" "+b.canvas.clientHeight,g.attribute("preserveAspectRatio",!0).value="none";(a.opts==null||a.opts.ignoreClear!=!0)&&b.clearRect(0,0,b.canvas.clientWidth,b.canvas.clientHeight);g.render(b);h&&(h=!1,a.opts!=null&&typeof a.opts.renderCallback=="function"&&a.opts.renderCallback())},k=!0;a.ImagesLoaded()&&(k=!1,j());a.intervalID=setInterval(function(){var b=!1;k&&a.ImagesLoaded()&&(k=!1,b=!0);if(a.opts==null||a.opts.ignoreMouse!=!0)b|=a.Mouse.hasEvents();
if(a.opts==null||a.opts.ignoreAnimation!=!0)for(var c=0;c<a.Animations.length;c++)b|=a.Animations[c].update(1E3/a.FRAMERATE);a.opts!=null&&typeof a.opts.forceRedraw=="function"&&a.opts.forceRedraw()==!0&&(b=!0);b&&(j(),a.Mouse.runEvents())},1E3/a.FRAMERATE)};a.stop=function(){a.intervalID&&clearInterval(a.intervalID)};a.Mouse=new function(){this.events=[];this.hasEvents=function(){return this.events.length!=0};this.onclick=function(a,c){this.events.push({type:"onclick",x:a,y:c,run:function(a){if(a.onclick)a.onclick()}})};
this.onmousemove=function(a,c){this.events.push({type:"onmousemove",x:a,y:c,run:function(a){if(a.onmousemove)a.onmousemove()}})};this.eventElements=[];this.checkPath=function(a,c){for(var e=0;e<this.events.length;e++){var f=this.events[e];c.isPointInPath&&c.isPointInPath(f.x,f.y)&&(this.eventElements[e]=a)}};this.checkBoundingBox=function(a,c){for(var e=0;e<this.events.length;e++){var f=this.events[e];c.isPointInBox(f.x,f.y)&&(this.eventElements[e]=a)}};this.runEvents=function(){a.ctx.canvas.style.cursor=
"";for(var b=0;b<this.events.length;b++)for(var c=this.events[b],e=this.eventElements[b];e;)c.run(e),e=e.parent;this.events=[];this.eventElements=[]}};return a}this.canvg=function(a,b,d){if(a==null&&b==null&&d==null){b=document.getElementsByTagName("svg");for(var e=0;e<b.length;e++){a=b[e];d=document.createElement("canvas");d.width=a.clientWidth;d.height=a.clientHeight;a.parentNode.insertBefore(d,a);a.parentNode.removeChild(a);var f=document.createElement("div");f.appendChild(a);canvg(d,f.innerHTML)}}else typeof a==
"string"&&(a=document.getElementById(a)),a.svg==null?(e=c(),a.svg=e):(e=a.svg,e.stop()),e.opts=d,a=a.getContext("2d"),b.substr(0,1)=="<"?e.loadXml(a,b):e.load(a,b)}})();if(CanvasRenderingContext2D)CanvasRenderingContext2D.prototype.drawSvg=function(c,a,b,d,e){canvg(this.canvas,c,{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:a,offsetY:b,scaleWidth:d,scaleHeight:e})};
var Mark=function(c){c.layer=function(a,b){this.context=this.canvas=null;this.dirtyRectangles=[];this.layerName=b;this.manager=a;this.autoResize=!0;this.clean=function(){if(this.dirtyRectangles.length==0)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);else for(;this.dirtyRectangles.length>0;){var a=this.dirtyRectangles.pop();this.context.clearRect(a.x,a.y,a.w,a.h)}};this.setSize=function(a,b){if(this.canvas.width!=a)this.canvas.width=a;if(this.canvas.height!=b)this.canvas.height=
b};this.init=function(){this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");this.setSize(this.manager.container.scrollWidth,this.manager.container.scrollHeight);this.manager.layerWrapper.appendChild(this.canvas)};this.remove=function(){this.manager.layerWrapper.removeChild(this.canvas)};this.init()};return c}(Mark||{});
Mark=function(c){c.layerManager=function(a){this.container=a;this.layerWrapper=null;this.layers={};this.init=function(){this.layerWrapper=document.createElement("div");this.layerWrapper.className="mark-layerManager";this.container.appendChild(this.layerWrapper)};this.addLayer=function(a){var d=new c.layer(this,a);return this.layers[a]=d};this.removeAll=function(){for(var a in this.layers)this.layers[a].remove(),delete this.layers[a]};this.resizeAll=function(a,c){for(var e in this.layers)this.layers[e].autoResize&&
this.layers[e].setSize(a,c)};this.init()};return c}(Mark||{});
Mark=function(c){c.gmlPoint=function(a,b,c,e,f){this.x=a;this.y=b;this.z=typeof f=="integer"?f:0;this.time=c;this.speed=e;this.angle=0;this.significance=1;this.distanceToPoint=function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))};this.speedToPoint=function(a){return this.distanceToPoint(a)/(a.time-this.time)};this.smoothAgainst=function(a,b){var c=this.distanceToPoint(a);c*=b;if(Math.abs(this.speed-a.speed)>c)this.speed=this.speed>a.speed?a.speed+c:a.speed-c};this.setAngleFromPoint=
function(a){this.angle=Math.atan2(a.y-this.y,a.x-this.x)+Math.PI/2;this.angle%=2*Math.PI;if(this.angle<0)this.angle=2*Math.PI+this.angle};this.clone=function(){return{x:this.x,y:this.y,z:this.z,time:this.time,significance:this.significance,angle:this.angle,speed:this.speed}};this.getTranslatedPoint=function(a,b){var c=this.clone();c.x+=a;c.y+=b;return c}};return c}(Mark||{});
Mark=function(c){c.simplification={Line:function(a,b){this.p1=a;this.p2=b;this.distanceToPoint=function(a){var b=(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x),c=[];c.push(Math.abs(a.y-b*a.x-(this.p1.y-b*this.p1.x))/Math.sqrt(Math.pow(b,2)+1));c.push(Math.sqrt(Math.pow(a.x-this.p1.x,2)+Math.pow(a.y-this.p1.y,2)));c.push(Math.sqrt(Math.pow(a.x-this.p2.x,2)+Math.pow(a.y-this.p2.y,2)));return c.sort(function(a,b){return a-b})[0]}},douglasPeucker:function(a,b){var d=[];if(a.length<=2)return[a[0]];for(var e=
new c.simplification.Line(a[0],a[a.length-1]),f=0,g=0,h=1;h<=a.length-2;h++){var j=e.distanceToPoint(a[h]);j>f&&(f=j,g=h)}f>=b?(f=a[g],e.distanceToPoint(f,!0),d=d.concat(c.simplification.douglasPeucker(a.slice(0,g+1),b)),d=d.concat(c.simplification.douglasPeucker(a.slice(g,a.length),b))):(f=a[g],e.distanceToPoint(f,!0),d=[a[0]]);return d},simplifyPath:function(a,b){var d=[];d.push(a.shift());d=d.concat(c.simplification.douglasPeucker(a.slice(0,-1),b));d.push(a[a.length-2]);d.push(a[a.length-1]);return d},
weightPath:function(a,b){for(var d=b.length+1,e=a;tolerance=b.shift();){e=c.simplification.douglasPeucker(e,tolerance);for(var f=0;f<e.length;f++)e[f].significance++}a[0].significance=d;a[a.length-1].significance=d;return a}};return c}(Mark||{});
Mark=function(c){c.dof=1E4;c.thickMarkBrush=function(a,b,d,e,f,g){e=e?e:"0,0,0";var h=Mark.renderer.translatePoint(b[0][0],d),j={minX:h.x,maxX:h.x,minY:h.y,maxY:h.y};if(!f||!g||!(h.x>f*2||h.x<-f||h.y>g*2||h.y<-g||h.z>c.dof||h.z<0)){for(f=0;f<b.length;f++)if(!(typeof b[f]=="undefined"||b[f].length<=1))for(var k=null,l=0;l<b[f].length;l++)if(h=Mark.renderer.translatePoint(b[f][l],d),!(h.z&&h.z>c.dof)&&!(h.significance&&h.significance*(c.dof/5)<h.z-500))if(k){a.lineWidth=1;if(l==b[f].length-1)var o=
0,m=0;else m=9-Math.max(0,Math.pow(h.speed+1,3)),d.mode=="flatScale"&&d.scale.thickness?m*=d.scale.thickness:h.z&&(m*=2/h.z*(g/2)),m<0.1&&(m=0.1),m+=1,o=Math.cos(h.angle)*m,m*=Math.sin(h.angle);a.strokeStyle="rgba("+e+","+(c.dof-h.z)/c.dof+")";a.fillStyle="rgba("+e+","+(c.dof-h.z)/c.dof+")";try{a.beginPath(),a.lineWidth=0.5*((c.dof-h.z)/c.dof),a.moveTo(k.x-prevPX-0.5,k.y-prevPY-0.5),a.lineTo(k.x+prevPX-0.5,k.y+prevPY-0.5),a.lineTo(h.x+o-0.5,h.y+m-0.5),a.lineTo(h.x-o-0.5,h.y-m-0.5),a.lineTo(k.x-prevPX-
0.5,k.y-prevPY-0.5),a.fill(),a.stroke()}catch(n){}j.minX=h.x<j.minX?h.x:j.minX;j.minY=h.y<j.minY?h.y:j.minY;j.maxX=h.x>j.maxX?h.x:j.maxX;j.maxY=h.y>j.maxY?h.y:j.maxY;k=h;prevPX=o;prevPY=m}else{if(f!=0&&h.z<1500&&(k=Mark.renderer.translatePoint(b[f-1][b[f-1].length-1],d),k.z&&k.z<c.dof))a.strokeStyle="rgba(0,0,0,0.3)",a.lineWidth=1,a.beginPath(),a.dashedLineTo(k.x,k.y,h.x,h.y,[6,4]),a.closePath(),a.stroke();k=h;prevPY=prevPX=0}return j}};c.connectionBrush=function(a,b,d,e,f,g,h){e={offset:e,w:g,h:h,
mode:"pinhole"};b=Mark.renderer.translatePoint(b,e);e.offset=f;d=Mark.renderer.translatePoint(d,e);if(!(b.x>g||b.x<0||b.y>h||b.y<0)||!(d.x>g||d.x<0||d.y>h||d.y<0))if(!b.z||!d.z||!(b.z>c.dof||b.z<0)||!(d.z>c.dof||d.z<0))a.strokeStyle="rgba(0,0,0,"+(c.dof-b.z)/(c.dof*2)+")",f=3*(2/b.z)*(h/2),f<1&&(f=1),a.lineWidth=f,a.beginPath(),a.dashedLineTo(b.x,b.y,d.x,d.y,[6,4]),a.closePath(),a.stroke()};c.thickBrush=function(a,b,c,e,f){c=c?c:0;e=e?e:0;f=f?f:1;for(var g=0;g<b.length;g++)if(!(typeof b[g]=="undefined"||
b[g].length<=1)){if(g>0)a.strokeStyle="rgba(0,0,0,0.1)",a.lineWidth=1,a.beginPath(),a.dashedLineTo(b[g-1][b[g-1].length-1].x+c,b[g-1][b[g-1].length-1].y+e,b[g][0].x+c,b[g][0].y+e,[6,4]),a.closePath(),a.stroke();a.lineWidth=1;a.strokeStyle="#000000";a.fillStyle="#000000";for(var h=0,j=0,k=b[g][0].x,l=b[g][0].y,o=1;o<b[g].length;o++){var m=b[g][o];if(!(m.significance<f)){if(o==b[g].length-1)var n=0,q=0;else q=9-Math.pow(m.speed+1,3),q<0.5&&(q=0.5),q+=1,n=Math.cos(m.angle)*q,q*=Math.sin(m.angle);try{a.beginPath(),
a.moveTo(k-h-0.5+c,l-j-0.5+e),a.lineTo(k+h-0.5+c,l+j-0.5+e),a.lineTo(m.x+n-0.5+c,m.y+q-0.5+e),a.lineTo(m.x-n-0.5+c,m.y-q-0.5+e),a.lineTo(k-h-0.5+c,l-j-0.5+e),a.fill(),a.stroke()}catch(p){}h=n;j=q;k=m.x;l=m.y;prevAng=m.angle}}}};c.circleMarkBrush=function(a,b,d){for(var e=3,f=0;f<b.length;f++)if(b[f].length!=0)for(var g=0;g<b[f].length;g++){var h=Mark.renderer.translatePoint(b[f][g],d);if(!(h.z&&h.z>c.dof))e=3*((c.dof-h.z)/c.dof),a.fillStyle="rgba(255,255,255,0.4)",a.strokeStyle="rgba(255,255,255,0.4)",
a.beginPath(),a.arc(h.x,h.y,e,0,Math.PI*2,!0),a.closePath(),a.fill(),a.stroke(),a.lineTo(h.x,h.y)}};c.circleBrush=function(a,b,c,e,f){c=c?c:0;e=e?e:0;f=f?f:1;for(var g=0;g<b.length;g++)if(b[g].length!=0){a.beginPath();for(var h=0;h<b[g].length;h++){var j=b[g][h];j.significance<f||(a.beginPath(),a.arc(j.x+c,j.y+e,3,0,Math.PI*2,!0),a.closePath(),a.fill(),a.stroke(),a.lineTo(j.x+c,j.y+e))}}};return c}(Mark||{});
Mark=function(c){c.gmlMark=function(a,b,c,e,f,g,h){this.strokes=a;this.country_code=c;this.time=e;this.rtl=f;this.maxTime=0;this.reference=b;this.hoverState=!1;this.renderedBounds=null;this.id=g?g:null;this.is_approved=h;this.contributor_url=this.extra_info=this.contributor_name=null;this.color="0,0,0";this.y=this.x=0;this.position={x:0,y:0,z:0};this.rotationAngle={x:0,y:0,z:0};this.bHeight=this.bWidth=this.sY=this.sX=0;this.init=function(){this.strokes.length>0&&this.setupVars()};this.setupVars=
function(){this.maxTime=this.lastPoint().time;this.getBoundingBox()};this.leftmostStrokeStart=function(){for(var a=this.strokes[0][0],b=1;b<this.strokes.length;b++){var c=this.strokes[b][0];c.x<a.x&&(a=c)}return a};this.rightmostStrokeEnd=function(){for(var a=this.strokes[0][this.strokes[0].length-1],b=1;b<this.strokes.length;b++){var c=this.strokes[b][this.strokes[b].length-1];c.x>a.x&&(a=c)}return a};this.firstPoint=function(){return this.strokes[0][0]};this.lastPoint=function(){return this.strokes[this.strokes.length-
1][this.strokes[this.strokes.length-1].length-1]};this.translatePoint=function(a){var b=a.clone();b.x=this.x+a.x;b.y=this.y+a.y;return b};this.getBoundingBox=function(){var a=this.strokes[0][0],b=a.x,c=a.x,d=a.y;a=a.y;for(var e=0;e<this.strokes.length;e++)for(var f=0;f<this.strokes[e].length;f++){var g=this.strokes[e][f];b=g.x>b?g.x:b;d=g.y>d?g.y:d;c=g.x<c?g.x:c;a=g.y<a?g.y:a}this.bWidth=b-c;this.bHeight=d-a;this.x=c;this.y=a;(c!=0||a!=0)&&this.fitPointsToBounds(c,a)};this.fitPointsToBounds=function(a,
b){for(var c=0;c<this.strokes.length;c++)for(var d=0;d<this.strokes[c].length;d++)this.strokes[c][d].x-=a,this.strokes[c][d].y-=b};this.strokesAtTime=function(a){if(a>this.maxTime)return this.strokes;for(var b=[[]],c=[0,0],d=this.strokes[c[0]][c[1]];d.time<a;)b[b.length-1].push(d),c[1]++,this.strokes[c[0]].length==c[1]&&(c[0]++,c[1]=0,b.push([])),d=this.strokes[c[0]][c[1]];return b};this.positionRelativeTo=function(a,b){b&&b?(this.position.x=a.position.x-50-this.bWidth,this.position.y=a.position.y+
a.leftmostStrokeStart().y-this.rightmostStrokeEnd().y,this.position.z=a.position.z-this.maxTime/50):(this.position.x=a.position.x+a.bWidth+this.leftmostStrokeStart().x+50,this.position.y=a.position.y+a.rightmostStrokeEnd().y-this.leftmostStrokeStart().y,this.position.z=a.position.z+a.maxTime/50)};this.positionToStart=function(){this.position.x=0;this.position.y=0;this.position.z=0};this.init()};return c}(Mark||{});
Mark=function(c){c.scene=function(){this.camera=new Mark.camera;this.objects=[];this.canvasContext=null;this.timers={};this.init=function(){};this.addObject=function(a){this.objects.push(a)};this.removeObject=function(a){this.objects.splice(a,1)};this.update=function(){var a=(new Date).getTime();for(c in this.timers)this.timers[c].end<a&&delete this.timers[c]};this.init()};return c}(Mark||{});
Mark=function(c){c.renderer={translatePoint:function(a,b){var c={flatScale:function(a,b){var c="offset"in b&&"x"in b.offset?b.offset.x:0,d="offset"in b&&"y"in b.offset?b.offset.y:0,e="scale"in b&&"y"in b.scale?b.scale.y:1;a.x*="scale"in b&&"x"in b.scale?b.scale.x:1;a.y*=e;a.x+=c;a.y+=d;return a},pinhole:function(a,b){var c="offset"in b&&"y"in b.offset?b.offset.y:0,d="offset"in b&&"z"in b.offset?b.offset.z:0,e="w"in b?b.w:500,l="h"in b?b.h:500;a.x+="offset"in b&&"x"in b.offset?b.offset.x:0;a.y+=c;
a.z=a.x>0?Math.pow((a.x- -100)/100,2)+d:Math.pow((a.x- -100)/100/2,2)+d;a.time&&(a.z+=a.time/50);c=2/a.z;a.x=a.x*c*(l/2)+e/2;a.y=a.y*c*(l/2)+l/2;return a}},e={x:a.x,y:a.y,z:a.z,time:a.time,significance:a.significance,angle:a.angle,speed:a.speed};return"mode"in b&&b.mode in c?c[b.mode](e,b):c.pinhole(e,b)},strokesAtTime:function(a,b){for(var c=[[]],e=[0,0],f=a[e[0]][e[1]];f.time<b;){c[c.length-1].push(f);e[1]++;if(a[e[0]].length==e[1]){if(a.length==e[0]+1)break;e[0]++;e[1]=0;c.push([])}f=a[e[0]][e[1]]}return c},
renderScene:function(a,b){for(var d=b.width,e=b.height,f=a.objects.length-1;f>=0;f--){var g={x:a.objects[f].position.x-a.camera.position.x,y:a.objects[f].position.y-a.camera.position.y,z:a.objects[f].position.z-a.camera.position.z};colorBase=a.objects[f].color;var h={offset:g,w:b.width,h:b.height,mode:"pinhole"};if(f<a.objects.length-1&&!(a.objects[f].reference in a.timers)){h={x:a.objects[f+1].position.x-a.camera.position.x,y:a.objects[f+1].position.y-a.camera.position.y,z:a.objects[f+1].position.z-
a.camera.position.z};var j={x:a.objects[f].position.x-a.camera.position.x,y:a.objects[f].position.y-a.camera.position.y,z:a.objects[f].position.z-a.camera.position.z},k=a.objects[f+1].leftmostStrokeStart(),l=a.objects[f].rightmostStrokeEnd();Mark.connectionBrush(a.canvasContext,k,l,h,j,d,e)}h={offset:g,w:b.width,h:b.height,mode:"pinhole"};if(a.objects[f].reference in a.timers){if((g=c.renderer.strokesAtTime(a.objects[f].strokes,((new Date).getTime()-a.timers[a.objects[f].reference].start)*a.timers[a.objects[f].reference].speed))&&
g.length>0&&g[0].length>0)a.objects[f].renderedBounds=Mark.thickMarkBrush(a.canvasContext,g,h,colorBase,b.width,b.height)}else a.objects[f].renderedBounds=Mark.thickMarkBrush(a.canvasContext,a.objects[f].strokes,h,colorBase,b.width,b.height)}},renderMark:function(a,b,d){var e={offset:d.offset,scale:d.scale,mode:"flatScale"};if("timer"in d&&d.timer){var f=c.renderer.strokesAtTime(b.strokes,((new Date).getTime()-d.timer.start)*d.timer.speed);if(f&&f.length>0&&f[0].length>0)b.renderedBounds=Mark.thickMarkBrush(a,
f,e,d.color)}else b.renderedBounds=Mark.thickMarkBrush(a,b.strokes,e,d.color)}};return c}(Mark||{});Mark=function(c){c.camera=function(){this.position=new c.vector(0,0,-1E3)};return c}(Mark||{});Mark=function(c){c.vector=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};return c}(Mark||{});
var TWEEN=TWEEN||function(){var c,a,b,d=[];this.add=function(a){d.push(a)};this.remove=function(a){c=d.indexOf(a);c!==-1&&d.splice(c,1)};this.update=function(){c=0;a=d.length;for(b=(new Date).getTime();c<a;)d[c].update(b)?c++:(d.splice(c,1),a--)};return this}();
TWEEN.Tween=function(c){var a={},b={},d={},e=1E3,f=0,g=null,h=TWEEN.Easing.Linear.EaseNone,j=null,k=null,l=null;this.to=function(a,b){b!==null&&(e=b);for(var f in a)c[f]!==null&&(d[f]=a[f]);return this};this.start=function(){TWEEN.add(this);g=(new Date).getTime()+f;for(var e in d)c[e]!==null&&(a[e]=c[e],b[e]=d[e]-c[e]);return this};this.stop=function(){TWEEN.remove(this);return this};this.delay=function(a){f=a;return this};this.easing=function(a){h=a;return this};this.chain=function(a){j=a};this.onUpdate=
function(a){k=a;return this};this.onComplete=function(a){l=a;return this};this.update=function(d){var f,n;if(d<g)return!0;d=(d-g)/e;d=d>1?1:d;n=h(d);for(f in b)c[f]=a[f]+b[f]*n;k!==null&&k.call(c,n);if(d==1)return l!==null&&l.call(c),j!==null&&j.start(),!1;return!0}};TWEEN.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};TWEEN.Easing.Linear.EaseNone=function(c){return c};
TWEEN.Easing.Quadratic.EaseIn=function(c){return c*c};TWEEN.Easing.Quadratic.EaseOut=function(c){return-c*(c-2)};TWEEN.Easing.Quadratic.EaseInOut=function(c){if((c*=2)<1)return 0.5*c*c;return-0.5*(--c*(c-2)-1)};TWEEN.Easing.Cubic.EaseIn=function(c){return c*c*c};TWEEN.Easing.Cubic.EaseOut=function(c){return--c*c*c+1};TWEEN.Easing.Cubic.EaseInOut=function(c){if((c*=2)<1)return 0.5*c*c*c;return 0.5*((c-=2)*c*c+2)};TWEEN.Easing.Quartic.EaseIn=function(c){return c*c*c*c};
TWEEN.Easing.Quartic.EaseOut=function(c){return-(--c*c*c*c-1)};TWEEN.Easing.Quartic.EaseInOut=function(c){if((c*=2)<1)return 0.5*c*c*c*c;return-0.5*((c-=2)*c*c*c-2)};TWEEN.Easing.Quintic.EaseIn=function(c){return c*c*c*c*c};TWEEN.Easing.Quintic.EaseOut=function(c){return(c-=1)*c*c*c*c+1};TWEEN.Easing.Quintic.EaseInOut=function(c){if((c*=2)<1)return 0.5*c*c*c*c*c;return 0.5*((c-=2)*c*c*c*c+2)};TWEEN.Easing.Sinusoidal.EaseIn=function(c){return-Math.cos(c*Math.PI/2)+1};
TWEEN.Easing.Sinusoidal.EaseOut=function(c){return Math.sin(c*Math.PI/2)};TWEEN.Easing.Sinusoidal.EaseInOut=function(c){return-0.5*(Math.cos(Math.PI*c)-1)};TWEEN.Easing.Exponential.EaseIn=function(c){return c==0?0:Math.pow(2,10*(c-1))};TWEEN.Easing.Exponential.EaseOut=function(c){return c==1?1:-Math.pow(2,-10*c)+1};TWEEN.Easing.Exponential.EaseInOut=function(c){if(c==0)return 0;if(c==1)return 1;if((c*=2)<1)return 0.5*Math.pow(2,10*(c-1));return 0.5*(-Math.pow(2,-10*(c-1))+2)};
TWEEN.Easing.Circular.EaseIn=function(c){return-(Math.sqrt(1-c*c)-1)};TWEEN.Easing.Circular.EaseOut=function(c){return Math.sqrt(1- --c*c)};TWEEN.Easing.Circular.EaseInOut=function(c){if((c/=0.5)<1)return-0.5*(Math.sqrt(1-c*c)-1);return 0.5*(Math.sqrt(1-(c-=2)*c)+1)};TWEEN.Easing.Elastic.EaseIn=function(c){var a,b=0.1,d=0.4;if(c==0)return 0;if(c==1)return 1;d||(d=0.3);!b||b<1?(b=1,a=d/4):a=d/(2*Math.PI)*Math.asin(1/b);return-(b*Math.pow(2,10*(c-=1))*Math.sin((c-a)*2*Math.PI/d))};
TWEEN.Easing.Elastic.EaseOut=function(c){var a,b=0.1,d=0.4;if(c==0)return 0;if(c==1)return 1;d||(d=0.3);!b||b<1?(b=1,a=d/4):a=d/(2*Math.PI)*Math.asin(1/b);return b*Math.pow(2,-10*c)*Math.sin((c-a)*2*Math.PI/d)+1};
TWEEN.Easing.Elastic.EaseInOut=function(c){var a,b=0.1,d=0.4;if(c==0)return 0;if(c==1)return 1;d||(d=0.3);!b||b<1?(b=1,a=d/4):a=d/(2*Math.PI)*Math.asin(1/b);if((c*=2)<1)return-0.5*b*Math.pow(2,10*(c-=1))*Math.sin((c-a)*2*Math.PI/d);return b*Math.pow(2,-10*(c-=1))*Math.sin((c-a)*2*Math.PI/d)*0.5+1};TWEEN.Easing.Back.EaseIn=function(c){return c*c*(2.70158*c-1.70158)};TWEEN.Easing.Back.EaseOut=function(c){return(c-=1)*c*(2.70158*c+1.70158)+1};
TWEEN.Easing.Back.EaseInOut=function(c){if((c*=2)<1)return 0.5*c*c*(3.5949095*c-2.5949095);return 0.5*((c-=2)*c*(3.5949095*c+2.5949095)+2)};TWEEN.Easing.Bounce.EaseIn=function(c){return 1-TWEEN.Easing.Bounce.EaseOut(1-c)};TWEEN.Easing.Bounce.EaseOut=function(c){return(c/=1)<1/2.75?7.5625*c*c:c<2/2.75?7.5625*(c-=1.5/2.75)*c+0.75:c<2.5/2.75?7.5625*(c-=2.25/2.75)*c+0.9375:7.5625*(c-=2.625/2.75)*c+0.984375};
TWEEN.Easing.Bounce.EaseInOut=function(c){if(c<0.5)return TWEEN.Easing.Bounce.EaseIn(c*2)*0.5;return TWEEN.Easing.Bounce.EaseOut(c*2-1)*0.5+0.5};
(function(c,a){var b,d=/:([\w\d]+)/g,e=/\?([^#]*)$/,f=function(a){return Array.prototype.slice.call(a)},g=function(a){return Object.prototype.toString.call(a)==="[object Function]"},h=function(a){return Object.prototype.toString.call(a)==="[object Array]"},j=function(a){return decodeURIComponent(a.replace(/\+/g," "))},k=encodeURIComponent,l=function(a){return String(a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},o=function(a){return function(b,c){return this.route.apply(this,
[a,b,c])}},m={},n=[];b=function(){var a=f(arguments),d,e;b.apps=b.apps||{};if(a.length===0||a[0]&&g(a[0]))return b.apply(b,["body"].concat(a));else if(typeof(e=a.shift())=="string")return d=b.apps[e]||new b.Application,d.element_selector=e,a.length>0&&c.each(a,function(a,b){d.use(b)}),d.element_selector!=e&&delete b.apps[e],b.apps[d.element_selector]=d};b.VERSION="0.6.3";b.addLogger=function(a){n.push(a)};b.log=function(){var a=f(arguments);a.unshift("["+Date()+"]");c.each(n,function(c,d){d.apply(b,
a)})};typeof a.console!="undefined"?g(a.console.log.apply)?b.addLogger(function(){a.console.log.apply(a.console,arguments)}):b.addLogger(function(){a.console.log(arguments)}):typeof console!="undefined"&&b.addLogger(function(){console.log.apply(console,arguments)});c.extend(b,{makeArray:f,isFunction:g,isArray:h});b.Object=function(a){return c.extend(this,a||{})};c.extend(b.Object.prototype,{escapeHTML:l,h:l,toHash:function(){var a={};c.each(this,function(b,c){g(c)||(a[b]=c)});return a},toHTML:function(){var a=
"";c.each(this,function(b,c){g(c)||(a+="<strong>"+b+"</strong> "+c+"<br />")});return a},keys:function(a){var b=[],c;for(c in this)(!g(this[c])||!a)&&b.push(c);return b},has:function(a){return this[a]&&c.trim(this[a].toString())!=""},join:function(){var a=f(arguments),b=a.shift();return a.join(b)},log:function(){b.log.apply(b,arguments)},toString:function(a){var b=[];c.each(this,function(c,d){(!g(d)||a)&&b.push('"'+c+'": '+d.toString())});return"Sammy.Object: {"+b.join(",")+"}"}});b.HashLocationProxy=
function(a,b){this.app=a;this.is_native=!1;this._startPolling(b)};b.HashLocationProxy.prototype={bind:function(){var d=this,e=this.app;c(a).bind("hashchange."+this.app.eventNamespace(),function(c,f){if(d.is_native===!1&&!f)b.log("native hash change exists, using"),d.is_native=!0,a.clearInterval(b.HashLocationProxy._interval);e.trigger("location-changed")});if(!b.HashLocationProxy._bindings)b.HashLocationProxy._bindings=0;b.HashLocationProxy._bindings++},unbind:function(){c(a).unbind("hashchange."+
this.app.eventNamespace());b.HashLocationProxy._bindings--;b.HashLocationProxy._bindings<=0&&a.clearInterval(b.HashLocationProxy._interval)},getLocation:function(){var b=a.location.toString().match(/^[^#]*(#.+)$/);return b?b[1]:""},setLocation:function(b){return a.location=b},_startPolling:function(d){var e=this;if(!b.HashLocationProxy._interval){d||(d=10);var f=function(){var d=e.getLocation();(!b.HashLocationProxy._last_location||d!=b.HashLocationProxy._last_location)&&a.setTimeout(function(){c(a).trigger("hashchange",
[!0])},13);b.HashLocationProxy._last_location=d};f();b.HashLocationProxy._interval=a.setInterval(f,d)}}};b.Application=function(a){var c=this;this.routes={};this.listeners=new b.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1E3,10);this.context_prototype=function(){b.EventContext.apply(this,arguments)};this.context_prototype.prototype=new b.EventContext;g(a)&&a.apply(this,[this]);this._location_proxy||this.setLocationProxy(new b.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(a,b){c.log(c.toString(),a.cleaned_type,b||{})})};b.Application.prototype=c.extend({},b.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,
template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(a){return a?c(this.element_selector).find(a):c(this.element_selector)},use:function(){var a=f(arguments),c=a.shift(),d=c||"";try{a.unshift(this),typeof c=="string"&&(d="Sammy."+c,c=b[c]),c.apply(this,a)}catch(e){typeof c==="undefined"?this.error("Plugin Error: called use() but plugin ("+d.toString()+") is not defined",e):g(c)?this.error("Plugin Error",e):this.error("Plugin Error: called use() but '"+
d.toString()+"' is not a function",e)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a;this.isRunning()&&(b&&b.unbind(),this._location_proxy.bind())},route:function(a,b,e){var f=this,h=[],j,k;!e&&g(b)&&(e=b=a,a="any");a=a.toLowerCase();if(b.constructor==String){for(d.lastIndex=0;(k=d.exec(b))!==null;)h.push(k[1]);b=RegExp("^"+b.replace(d,"([^/]+)")+"$")}typeof e=="string"&&(e=f[e]);j=function(a){var c={verb:a,path:b,callback:e,param_names:h};f.routes[a]=
f.routes[a]||[];f.routes[a].push(c)};a==="any"?c.each(this.ROUTE_VERBS,function(a,b){j(b)}):j(a);return this},get:o("get"),post:o("post"),put:o("put"),del:o("delete"),any:o("any"),mapRoutes:function(a){var b=this;c.each(a,function(a,c){b.route.apply(b,c)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(a,b,c){var d=this;typeof c=="undefined"&&(c=b);b=function(a,b){var e;b&&b.context?(e=b.context,delete b.context):e=new d.context_prototype(d,"bind",
a.type,b,a.target);a.cleaned_type=a.type.replace(d.eventNamespace(),"");c.apply(e,[a,b])};this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b);this.isRunning()&&this._listen(a,b);return this},trigger:function(a,b){this.$element().trigger([a,this.eventNamespace()].join("."),[b]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(a,b){g(a)&&(b=a,a={});this.befores.push([a,b]);return this},after:function(a){return this.bind("event-context-after",
a)},around:function(a){this.arounds.push(a);return this},isRunning:function(){return this._running},helpers:function(a){c.extend(this.context_prototype.prototype,a);return this},helper:function(a,b){this.context_prototype.prototype[a]=b;return this},run:function(b){if(this.isRunning())return!1;var d=this;c.each(this.listeners.toHash(),function(a,b){c.each(b,function(b,c){d._listen(a,c)})});this.trigger("run",{start_url:b});this._running=!0;this.last_location=null;this.getLocation()==""&&typeof b!=
"undefined"&&this.setLocation(b);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){d._checkLocation()});this.bind("submit",function(a){return d._checkFormSubmission(c(a.target).closest("form"))===!1?a.preventDefault():!1});c(a).bind("beforeunload",function(){d.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return!1;var a=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(a.eventNamespace());
c.each(this.listeners.toHash(),function(b,d){c.each(d,function(c,d){a._unlisten(b,d)})});this._running=!1;return this},bindToAllEvents:function(a){var b=this;c.each(this.APP_EVENTS,function(c,d){b.bind(d,a)});c.each(this.listeners.keys(!0),function(c,d){b.APP_EVENTS.indexOf(d)==-1&&b.bind(d,a)});return this},routablePath:function(a){return a.replace(e,"")},lookupRoute:function(a,b){var d=this,e=!1;this.trigger("lookup-route",{verb:a,path:b});typeof this.routes[a]!="undefined"&&c.each(this.routes[a],
function(a,c){if(d.routablePath(b).match(c.path))return e=c,!1});return e},runRoute:function(a,b,d,e){var f=this,g=this.lookupRoute(a,b),h,k,l,m,o,n,t;this.log("runRoute",[a,b].join(" "));this.trigger("run-route",{verb:a,path:b,params:d});typeof d=="undefined"&&(d={});c.extend(d,this._parseQueryString(b));if(g){this.trigger("route-found",{route:g});if((n=g.path.exec(this.routablePath(b)))!==null)n.shift(),c.each(n,function(a,b){if(g.param_names[a])d[g.param_names[a]]=j(b);else{if(!d.splat)d.splat=
[];d.splat.push(j(b))}});h=new this.context_prototype(this,a,b,d,e);e=this.arounds.slice(0);l=this.befores.slice(0);o=[h].concat(d.splat);k=function(){for(var a;l.length>0;)if(m=l.shift(),f.contextMatchesOptions(h,m[0])&&(a=m[1].apply(h,[h]),a===!1))return!1;f.last_route=g;h.trigger("event-context-before",{context:h});a=g.callback.apply(h,o);h.trigger("event-context-after",{context:h});return a};c.each(e.reverse(),function(a,b){var c=k;k=function(){return b.apply(h,[c])}});try{t=k()}catch(v){this.error(["500 Error",
a,b].join(" "),v)}return t}else return this.notFound(a,b)},contextMatchesOptions:function(a,b,c){if(typeof b==="undefined"||b=={})return!0;typeof c==="undefined"&&(c=!0);if(typeof b==="string"||g(b.test))b={path:b};if(b.only)return this.contextMatchesOptions(a,b.only,!0);else if(b.except)return this.contextMatchesOptions(a,b.except,!1);var d=!0,e=!0;b.path&&(d=g(b.path.test)?b.path.test(a.path):b.path.toString()===a.path);b.verb&&(e=b.verb===a.verb);return c?e&&d:!(e&&d)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a){return this.$element().html(a)},templateCache:function(a,b){return typeof b!="undefined"?m[a]=b:m[a]},clearTemplateCache:function(){return m={}},notFound:function(a,b){var c=this.error(["404 Not Found",a,b].join(" "));return a==="get"?c:!0},error:function(a,b){b||(b=Error());b.message=[a,b.message].join(" ");this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;else this.log(b.message,b)},
_checkLocation:function(){var a,b;a=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=a)this.last_location=["get",a],b=this.runRoute("get",a);return b},_getFormVerb:function(a){a=c(a);var b,d;d=a.find('input[name="_method"]');d.length>0&&(b=d.val());b||(b=a[0].getAttribute("method"));if(!b||b=="")b="get";return c.trim(b.toString().toLowerCase())},_checkFormSubmission:function(a){var b,d,e;this.trigger("check-form-submission",{form:a});b=c(a);d=b.attr("action");
e=this._getFormVerb(b);this.log("_checkFormSubmission",b,d,e);e==="get"?(this.setLocation(d+"?"+this._serializeFormParams(b)),a=!1):(b=c.extend({},this._parseFormParams(b)),a=this.runRoute(e,d,b,a.get(0)));return typeof a=="undefined"?!1:a},_serializeFormParams:function(a){var b="";a=a.serializeArray();var c;if(a.length>0){b=this._encodeFormPair(a[0].name,a[0].value);for(c=1;c<a.length;c++)b=b+"&"+this._encodeFormPair(a[c].name,a[c].value)}return b},_encodeFormPair:function(a,b){return k(a)+"="+k(b)},
_parseFormParams:function(a){var b={};a=a.serializeArray();var c;for(c=0;c<a.length;c++)b=this._parseParamPair(b,a[c].name,a[c].value);return b},_parseQueryString:function(a){var b={},c,d;if(a=a.match(e)){a=a[1].split("&");for(d=0;d<a.length;d++)c=a[d].split("="),b=this._parseParamPair(b,j(c[0]),j(c[1]))}return b},_parseParamPair:function(a,b,c){a[b]?h(a[b])?a[b].push(c):a[b]=[a[b],c]:a[b]=c;return a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),b)},_unlisten:function(a,
b){return this.$element().unbind([a,this.eventNamespace()].join("."),b)}});b.RenderContext=function(a){this.event_context=a;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=!1};b.RenderContext.prototype=c.extend({},b.Object.prototype,{then:function(b){if(!g(b))if(typeof b==="string"&&b in this.event_context){var c=this.event_context[b];b=function(a){return c.apply(this.event_context,[a])}}else return this;var d=this;this.waiting?this.callbacks.push(b):(this.wait(),
a.setTimeout(function(){var a=b.apply(d,[d.content,d.previous_content]);a!==!1&&d.next(a)},13));return this},wait:function(){this.waiting=!0},next:function(a){this.waiting=!1;if(typeof a!=="undefined")this.previous_content=this.content,this.content=a;this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(a,b,d){var e=this;return this.then(function(){var f,h,j;g(b)?(d=b,b={}):b=c.extend({},b);d&&this.then(d);if(typeof a==="string"){f=(j=a.match(/\.json$/)||b.json)&&b.cache===!0||
b.cache!==!1;e.next_engine=e.event_context.engineFor(a);delete b.cache;delete b.json;if(b.engine)e.next_engine=b.engine,delete b.engine;if(f&&(h=this.event_context.app.templateCache(a)))return h;this.wait();c.ajax(c.extend({url:a,data:{},dataType:j?"json":null,type:"get",success:function(b){f&&e.event_context.app.templateCache(a,b);e.next(b)}},b));return!1}else{if(a.nodeType)return a.innerHTML;if(a.selector)return e.next_engine=a.attr("data-engine"),b.clone===!1?a.remove()[0].innerHTML.toString():
a[0].innerHTML.toString()}})},render:function(a,b,c){if(g(a)&&!b)return this.then(a);else{if(!b&&this.content)b=this.content;return this.load(a).interpolate(b,a).then(c)}},partial:function(a,b){return this.render(a,b).swap()},send:function(){var a=this,b=f(arguments),c=b.shift();h(b[0])&&(b=b[0]);return this.then(function(){b.push(function(b){a.next(b)});a.wait();c.apply(c,b);return!1})},collect:function(a,b,d){var e=this,f=function(){if(g(a))b=a,a=this.content;var d=[],f=!1;c.each(a,function(a,c){var g=
b.apply(e,[a,c]);g.jquery&&g.length==1&&(g=g[0],f=!0);d.push(g);return g});return f?d:d.join("")};return d?f():this.then(f)},renderEach:function(a,b,d,e){h(b)&&(e=d,d=b,b=null);return this.load(a).then(function(f){var g=this;d||(d=h(this.previous_content)?this.previous_content:[]);if(e)c.each(d,function(c,d){var h={},j=this.next_engine||a;b?h[b]=d:h=d;e(d,g.event_context.interpolate(f,h,j))});else return this.collect(d,function(c,d){var e={},g=this.next_engine||a;b?e[b]=d:e=d;return this.event_context.interpolate(f,
e,g)},!0)})},interpolate:function(a,b,c){var d=this;return this.then(function(e,f){!a&&f&&(a=f);if(this.next_engine)b=this.next_engine,this.next_engine=!1;var g=d.event_context.interpolate(e,a,b);return c?f+g:g})},swap:function(){return this.then(function(a){this.event_context.swap(a)}).trigger("changed",{})},appendTo:function(a){return this.then(function(b){c(a).append(b)}).trigger("changed",{})},prependTo:function(a){return this.then(function(b){c(a).prepend(b)}).trigger("changed",{})},replace:function(a){return this.then(function(b){c(a).html(b)}).trigger("changed",
{})},trigger:function(a,b){return this.then(function(c){typeof b=="undefined"&&(b={content:c});this.event_context.trigger(a,b)})}});b.EventContext=function(a,c,d,e,f){this.app=a;this.verb=c;this.path=d;this.params=new b.Object(e);this.target=f};b.EventContext.prototype=c.extend({},b.Object.prototype,{$element:function(){return this.app.$element(f(arguments).shift())},engineFor:function(a){var b;if(g(a))return a;a=(a||this.app.template_engine).toString();if(b=a.match(/\.([^\.]+)$/))a=b[1];if(a&&g(this[a]))return this[a];
if(this.app.template_engine)return this.engineFor(this.app.template_engine);return function(a){return a}},interpolate:function(a,b,c){return this.engineFor(c).apply(this,[a,b])},render:function(a,c,d){return(new b.RenderContext(this)).render(a,c,d)},renderEach:function(a,c,d,e){return(new b.RenderContext(this)).renderEach(a,c,d,e)},load:function(a,c,d){return(new b.RenderContext(this)).load(a,c,d)},partial:function(a,c){return(new b.RenderContext(this)).partial(a,c)},send:function(){var a=new b.RenderContext(this);
return a.send.apply(a,arguments)},redirect:function(){var a;a=f(arguments);var b=this.app.getLocation();a.length>1?(a.unshift("/"),a=this.join.apply(this,a)):a=a[0];this.trigger("redirect",{to:a});this.app.last_location=[this.verb,this.path];this.app.setLocation(a);b==a&&this.app.trigger("location-changed")},trigger:function(a,b){typeof b=="undefined"&&(b={});if(!b.context)b.context=this;return this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(a){return this.app.swap(a)},
notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(a){return c.parseJSON(a)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});c.sammy=a.Sammy=b})(jQuery,window);Sammy.HashPushProxy=function(c,a){this.app=c;this.supportsHistory=!(!window.history||!history.pushState);if(!this.supportsHistory)this._startPolling(a),this.is_native=!1};
Sammy.HashPushProxy.prototype={bind:function(){var c=this,a=this.app;if(this.app.supportsHistory)$(window).bind("popstate",function(){c.app.trigger("location-changed")}),$("a").live("click",function(a){location.hostname==this.hostname&&(a.preventDefault(),c.historyAPISupported?c.setLocation($(this).attr("href")):c.setLocation("#"+$(this).attr("href")),c.app.trigger("location-changed"))});else{$(window).bind("hashchange."+this.app.eventNamespace(),function(b,d){if(c.is_native===!1&&!d)Sammy.log("native hash change exists, using"),
c.is_native=!0,window.clearInterval(Sammy.HashLocationProxy._interval);a.trigger("location-changed")});if(!Sammy.HashLocationProxy._bindings)Sammy.HashLocationProxy._bindings=0;Sammy.HashLocationProxy._bindings++}},unbind:function(){this.app.supportsHistory?($("a").unbind("click"),$(window).unbind("popstate")):($(window).unbind("hashchange."+this.app.eventNamespace()),Sammy.HashLocationProxy._bindings--,Sammy.HashLocationProxy._bindings<=0&&window.clearInterval(Sammy.HashLocationProxy._interval))},
getLocation:function(){if(this.app.supportsHistory)return window.location.pathname;else{var c=window.location.toString().match(/^[^#]*(#.+)$/);return c?c[1]:""}},setLocation:function(c){if(this.app.supportsHistory)history.pushState({path:this.path},"",c);else return window.location=c},_startPolling:function(c){var a=this;if(!Sammy.HashLocationProxy._interval){c||(c=10);var b=function(){var b=a.getLocation();(!Sammy.HashLocationProxy._last_location||b!=Sammy.HashLocationProxy._last_location)&&window.setTimeout(function(){$(window).trigger("hashchange",
[!0])},13);Sammy.HashLocationProxy._last_location=b};b();Sammy.HashLocationProxy._interval=window.setInterval(b,c)}}};
(function(c){var a={};Sammy=Sammy||{};Sammy.Template=function(b,d){d||(d="template");b.helper(d,function(b,d,g,h){typeof g=="undefined"&&(g=b);typeof h=="undefined"&&typeof g=="object"&&(h=g,g=b);a:{d=c.extend({},this,d);if(a[g])b=a[g];else{if(typeof b=="undefined"){b=!1;break a}h=h&&h.escape_html===!1?'",$1,"':'",h($1),"';b=a[g]=new Function("obj",'var ___$$$___=[],print=function(){___$$$___.push.apply(___$$$___,arguments);};with(obj){___$$$___.push("'+String(b).replace(/[\r\t\n]/g," ").replace(/\"/g,
'\\"').split("<%").join("\t").replace(/((^|%>)[^\t]*)/g,"$1\r").replace(/\t=(.*?)%>/g,h).replace(/\t!(.*?)%>/g,'",$1,"').split("\t").join('");').split("%>").join('___$$$___.push("').split("\r").join("")+"\");}return ___$$$___.join('');")}b=typeof d!="undefined"?b(d):b}return b})}})(jQuery);function browserSupportsRequiredFeatures(){return!!("getContext"in document.createElement("canvas"))&&!!("JSON"in window)}if(browserSupportsRequiredFeatures){var elem=document.getElementById("fallback");elem&&elem.parentNode.removeChild(elem)}
(function(c){var a=c.sammy("#sammy",function(){this.get("#/",function(){c("#markapp").markApp("unloadModule","linear");this.partial("makemark_sammy.html").then(function(){c("#markapp").markApp("addModule",{capture:{state:"intro"}});c("#markapp").markApp("addModule",{intro:{}});c("#sammy").css("zIndex","")})});this.get("#/mark/new",function(a){c("#markapp").markApp("unloadModule","linear");var d={state:"drawing",invite_code:a.params.invite,contributor_type:a.params.contributor_type};c("#markmaker").size()>
0?(c("#markapp").markApp("unloadModule","intro"),c("#markapp").markApp("addModule",{capture:d})):this.partial("makemark_sammy.html").then(function(){c("body").addClass("make-your-mark");c("#markapp").markApp("addModule",{capture:d});c("#sammy").css("zIndex","")})});this.get("#/moderate",function(){c("#markapp").markApp("unloadModule","intro");c("#markapp").markApp("unloadModule","capture");this.partial("moderate_sammy.html").then(function(){c("#markapp").markApp("addModule",{linear:{is_flagged:!0,
linear_root:"moderate"}})})});this.get("#/moderate/(.*)",function(a){c("#markapp").markApp("unloadModule","intro");c("#markapp").markApp("unloadModule","capture");c("#linear").size()>0?c("#markapp").markApp("addModule",{linear:{is_flagged:!0,linear_root:"moderate",reference_mark:a.params.splat[0]}}):this.partial("moderate_sammy.html").then(function(){c("#sammy").css("zIndex","");c("#markapp").css({zIndex:100,cursor:"default"});c("#markapp").markApp("addModule",{linear:{is_flagged:!0,linear_root:"moderate",
reference_mark:a.params.splat[0]}})})});this.get("#/linear/country/:country_code/(.*)",function(a){c("#markapp").markApp("unloadModule","intro");c("#markapp").markApp("unloadModule","capture");c("#linear").size()>0?c("#markapp").markApp("addModule",{linear:{country_code:a.params.country_code,reference_mark:a.params.splat[0]}}):this.partial("linear_sammy.html").then(function(){c("#sammy").css("zIndex","");c("#markapp").css({zIndex:100,cursor:"default"});c("#markapp").markApp("addModule",{linear:{country_code:a.params.country_code,
reference_mark:a.params.splat[0]}})})});this.get("#/linear/(.*)",function(a){c("#markapp").markApp("unloadModule","intro");c("#markapp").markApp("unloadModule","capture");c("#linear").size()>0?c("#markapp").markApp("addModule",{linear:{reference_mark:a.params.splat[0],playback:a.params.playback,show_thanks:a.params.be_grateful}}):this.partial("linear_sammy.html").then(function(){c("#sammy").css("zIndex","");c("#markapp").css({zIndex:100,cursor:"default"});c("#markapp").markApp("addModule",{linear:{reference_mark:a.params.splat[0],
playback:a.params.playback,show_thanks:a.params.be_grateful}})})});this.bind("run",function(){c("#markapp").markApp().data("markApp-context").app=a});this.swap=function(a){c("body").removeClass("make-your-mark");this.$element().fadeOut("fast",function(){c(this).html(a).fadeIn("normal");c("#markapp").trigger("ready")});c("#markapp").trigger("swap")};this.use("Template")});c(document).ready(function(){browserSupportsRequiredFeatures&&a.run("#/");c("#current-locale").click(function(){c(this).parent().find("ul").toggle();
c(this).toggleClass("selected");return!1})})})(jQuery);
