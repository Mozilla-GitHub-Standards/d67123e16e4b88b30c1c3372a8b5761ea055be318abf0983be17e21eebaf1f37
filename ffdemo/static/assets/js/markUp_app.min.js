(function(a){a.markApp={modules:{},instances:[],fn:{}};a.fn.markApp=function(){var c=a(this),b=c.data("markApp-context");if(!b||typeof b=="undefined"){b={app:null,$container:c,frameCount:0,width:0,height:0,timezoneOffset:4,minWidth:700,minHeight:500,countries:[],mouseX:null,mouseY:null,mouseDown:false,mouseIn:false,modules:{},usersMark:null,translatedStrings:{},locale:window.location.pathname.split("/").length>1?window.location.pathname.split("/")[1]:"en",instance:a.markApp.instances.push(c)-1,evt:{resize:function(){var g=
a(window).width(),j=a(window).height()-(a("header").height()+a("#callout-boxes").height());if(g<b.minWidth)g=b.minWidth;if(j<b.minHeight)j=b.minHeight;b.$container.parent().width(g);b.$container.parent().height(j);b.width=g;b.height=j;a(".autoResize").height(j).width(g).trigger("resize.markApp",[g,j])},mousemove:function(g){b.mouseX=g.layerX;b.mouseY=g.layerY},mousedown:function(g){"preventDefault"in g&&g.preventDefault();b.mouseDown=true},mouseup:function(g){"preventDefault"in g&&g.preventDefault();
b.mouseDown=false},mouseover:function(g){"preventDefault"in g&&g.preventDefault();b.mouseIn=true},mouseout:function(g){"preventDefault"in g&&g.preventDefault();b.mouseX=null;b.mouseY=null;b.mouseIn=false},ready:function(){b.fn.loadTranslations()}},public_fn:{addModule:function(g,j){var k,o={};if(typeof j=="string")k=j;else if(typeof j=="object")for(var q in j){k=q;o=j[q];break}if(a.markApp.modules[k]){g.modules[k]=g.modules[k]||{};"init"in a.markApp.modules[k].fn&&a.markApp.modules[k].fn.init(g,o)}},
unloadModule:function(g,j){if(j=="all")for(j in g.modules){"deinit"in a.markApp.modules[j].fn&&a.markApp.modules[j].fn.deinit(g);delete g.modules[j]}else if(j in g.modules){"deinit"in a.markApp.modules[j].fn&&a.markApp.modules[j].fn.deinit(g);delete g.modules[j]}}},fn:{trigger:function(g,j,k){if(typeof j=="undefined")j={type:"custom"};if(g in b.evt)if(b.evt[g](j)==false)return false;for(var o in b.modules)o in a.markApp.modules&&"evt"in a.markApp.modules[o]&&g in a.markApp.modules[o].evt&&a.markApp.modules[o].evt[g](b,
j,k)},loop:function(){setTimeout(function(){b.fn.loop()},42);b.frameCount++;b.fn.trigger("loop",{},[])},withCountryCodes:function(g){"US"in b.countries?g(b.countries):a.ajax({url:"/media/assets/js/vendor/country_codes.json",dataType:"JSON",success:function(j){b.countries=j;for(var k=0;k<j.length;k++)b.countries[j[k].code]=j[k].name;g(b.countries)},error:function(){}})},showLoader:function(g,j){j=typeof j==="string"?j:"";g=typeof g==="string"?g:b.fn.getString("default-loading-msg");b.fn.hideLoader();
var k=a("<div />").width(b.width).height(b.height).hide().addClass("overlay-wrapper autoResize").addClass(j).attr("id","markapp-loader").append(a("<div />").text(g));b.$container.append(k);k.fadeIn("fast")},hideLoader:function(){a("#markapp-loader").fadeOut("fast",function(){a(this).remove()})},showError:function(g){g=typeof g==="string"?g:b.fn.getString("default-error-msg");b.fn.hideError();g=a("<div />").width(b.width).height(b.height).hide().click(function(j){j.preventDefault();b.fn.hideError()}).addClass("overlay-wrapper autoResize").attr("id",
"markapp-error").append(a("<div />").attr("id","markapp-error-content").append(a("<p />").html(g)));b.$container.append(g);g.fadeIn("fast")},hideError:function(){a("#markapp-error").fadeOut("fast",function(){a(this).remove()})},localizeDate:function(g){d=new Date;utc=g.getTime()-d.getTimezoneOffset()*6E4;return nd=new Date(g.getTime()+36E5*b.timezoneOffset)},loadTranslations:function(){a("div.translated-strings").each(function(){a(this).children().each(function(){var g=a(this);if(g.is("ol")){b.translatedStrings[g.attr("id")]=
[];g.children().each(function(){b.translatedStrings[g.attr("id")].push(a(this).html())})}else b.translatedStrings[g.attr("id")]=g.html()})})},getString:function(g,j){return g in b.translatedStrings?typeof b.translatedStrings[g]==="object"&&typeof j==="number"?b.translatedStrings[g][j]:b.translatedStrings[g]:g},storeData:function(g,j){if(typeof localStorage!="undefined")try{if(typeof j==="object")j=JSON.stringify(j);localStorage.setItem(g,j)}catch(k){}},getData:function(g){if(typeof localStorage!=
"undefined")if(g=localStorage.getItem(g)){if(g[0]=="{")g=JSON.parse(g);return g}else return false},validate:{url:function(g){return/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/.test(g)},string:function(g){return typeof g==="string"&&g.length!=""?true:false}}}};a(window).delayedBind(300,"resize",function(g){return b.fn.trigger("resize",g)}).bind("keydown keypress keyup",function(g){return b.fn.trigger(g.type,g)}).trigger("resize");b.$container.bind("mousemove mousedown mouseup mouseover mouseout ready swap",
function(g){return b.fn.trigger(g.type,g)});b.fn.loop()}var e=a.makeArray(arguments);if(e.length>0){var h=e.shift();if(h in b.public_fn)b.public_fn[h](b,typeof e[0]=="undefined"?{}:e[0])}return c.data("markApp-context",b)}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.linear={defaults:{reference_mark:null,country_code:null,playback:false,is_flagged:false,linear_root:"linear"},config:{marks:{},flaggings:{},orderedMarks:[],leftBuffer:[],rightBuffer:[],bufferSize:20,bufferMinSize:5,scene:null,cameraChange:{},tweens:{},layerManager:null,initialized:false,requestingMarks:false,moreLeft:true,moreRight:true,hoverMark:null,currentMark:null,playbackTimes:{},eventChange:false},
evt:{ready:function(c){modules.linear.fn.initInterface(c)},resize:function(c){c.modules.linear.eventChange=true;c.modules.linear.layerManager.resizeAll(c.width,c.height)},keydown:function(c,b){var e=c.modules.linear;switch(b.keyCode){case 38:b.preventDefault();e.cameraChange.aZ=10;break;case 40:b.preventDefault();e.cameraChange.aZ=-10;break;case 39:b.preventDefault();e.cameraChange.aX=10;modules.linear.fn.hideMarkInformation(c);break;case 37:b.preventDefault();e.cameraChange.aX=-10;modules.linear.fn.hideMarkInformation(c)}},
keyup:function(c,b){var e=c.modules.linear;switch(b.keyCode){case 38:case 40:b.preventDefault();e.cameraChange.aZ=0;break;case 39:case 37:b.preventDefault();e.cameraChange.aX=0}},keypress:function(c,b){switch(b.keyCode){case 38:case 40:case 39:case 37:b.preventDefault()}},mousedown:function(c){var b=c.modules.linear;if(mark=modules.linear.fn.hitTest(c,c.mouseX,c.mouseY))if(mark==b.currentMark)modules.linear.fn.centerCurrentMark(c,function(){modules.linear.fn.showMarkInformation(c)});else b.country_code?
c.app.setLocation("#/"+b.linear_root+"/country/"+b.country_code+"/"+mark.reference):c.app.setLocation("#/"+b.linear_root+"/"+mark.reference)},mousemove:function(c){var b=c.modules.linear;b.eventChange=true;if(mark=modules.linear.fn.hoverTest(c,c.mouseX,c.mouseY,b.hoverMark)){if(b.hoverMark)b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=mark;if(b.currentMark&&b.hoverMark.reference==b.currentMark.reference&&b.hoverMark.contributor_name&&a("#mark-information").is(":visible"))a("#contributor-quote-box").is(":not(:visible)")&&
a("#contributor-quote-box").fadeIn("fast").css({left:c.mouseX-15,top:c.mouseY-a("#contributor-quote-box").height()-15});else{a("#contributor-quote-box:visible").fadeOut("fast");b.hoverMark.color="255,111,40"}}else if(b.hoverMark){b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=null;a("#contributor-quote-box:visible").fadeOut("fast")}},loop:function(c){var b=c.modules.linear,e=b.layerManager.layers.drawingLayer,h={x:b.scene.camera.position.x,y:b.scene.camera.position.y,
z:b.scene.camera.position.z};if("cameraEase"in b.tweens)TWEEN.update();else{b.cameraChange.vZ+=b.cameraChange.aZ;b.cameraChange.vX+=b.cameraChange.aX;b.cameraChange.vX*=0.93;b.cameraChange.vZ*=0.93;b.scene.camera.position.x+=b.cameraChange.vX;b.scene.camera.position.z+=b.cameraChange.vZ;var g=modules.linear.fn.closestMark(c);if(g){var j=b.scene.camera.position.y-(g.position.y+g.bHeight/2);if(j!=0&&Math.abs(j)>=10)b.scene.camera.position.y+=j>0?-10:10}}if(!b.eventChange&&h.x==b.scene.camera.position.x&&
h.y==b.scene.camera.position.y&&h.z==b.scene.camera.position.z)return false;if(b.hoverMark&&!modules.linear.fn.hoverTest(c,c.mouseX,c.mouseY,b.hoverMark)){b.hoverMark.color=b.hoverMark.contributor_name?"0,139,211":"0,0,0";b.hoverMark=null;a("#contributor-quote-box:visible").fadeOut("fast")}e.clean();modules.linear.fn.updateScene(c,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);modules.linear.fn.updateBuffers(c,b.scene.camera.position.x-1E4,b.scene.camera.position.x+1E4);Mark.renderer.renderScene(b.scene,
{cursor:{x:c.mouseX,y:c.mouseY},width:c.width,height:c.height});b.eventChange=false;for(g in b.scene.timers){c=(new Date).getTime();b.scene.timers[g].end<c&&delete b.scene.timers[g];b.eventChange=true}}},fn:{init:function(c,b){var e=c.modules.linear;if("$linear"in c.modules.linear){b.country_code!=e.country_code&&modules.linear.fn.dumpAllMarks(c);a.extend(e,e,b);for(option in modules.linear.defaults)if(b[option]==null)e[option]=modules.linear.defaults[option];modules.linear.fn.updateInterface(c);
modules.linear.fn.initMarks(c)}else{a.extend(e,modules.linear.defaults,b);a.extend(e,e,modules.linear.config);e.$linear=a("<div />").addClass("linear-container");c.$container.append(e.$linear);e.scene=new Mark.scene;e.cameraChange={aX:0,aY:0,aZ:0,vX:0,vY:0,vZ:0};e.layerManager=new Mark.layerManager(e.$linear.get(0));e.layerManager.addLayer("drawingLayer");e.scene.canvasContext=e.layerManager.layers.drawingLayer.context;c.fn.trigger("resize");e.initialized=true}e.flaggings=c.fn.getData("markFlaggings")||
{}},deinit:function(c){var b=c.modules.linear;b.$linear.fadeOut("fast",function(){b.layerManager.removeAll();b.$linear.remove();b.initialized=false})},initInterface:function(c){var b=c.modules.linear;a("#stats").hide();a("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a, #mark-browsing-next a, #mark-browsing-prev a").click(function(e){e.preventDefault()}).bind("mouseup mouseout",function(e){e.preventDefault();if(a(this).data("mouseDown")){if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))c.modules.linear.cameraChange.aZ=
0;else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a"))c.modules.linear.cameraChange.aX=0;a(this).data("mouseDown",false)}}).bind("mousedown",function(e){e.preventDefault();a(this).data("mouseDown",true);if(a(this).is("#mark-browsing-zoom-in a, #mark-browsing-zoom-out a"))c.modules.linear.cameraChange.aZ=a(this).is("#mark-browsing-zoom-in a")?10:-10;else if(a(this).is("#mark-browsing-next a, #mark-browsing-prev a")){c.modules.linear.cameraChange.aX=a(this).is("#mark-browsing-next a")?
10:-10;modules.linear.fn.hideMarkInformation(c)}});c.fn.withCountryCodes(function(e){for(var h=a("#country-select"),g=0;g<e.length;g++){var j=a("<option />").val(e[g].code).text(e[g].name);h.append(j)}h.change(function(){var k=a(this).val();if(k.length!=2&&b.country_code)c.app.setLocation("#/"+b.linear_root+"/");else k.length==2&&k!=b.country_code&&c.app.setLocation("#/"+b.linear_root+"/country/"+k+"/");a(this).blur();a(".ui-selectBox-focus").removeClass("ui-selectBox-focus");c.$container.focus()});
b.country_code&&h.val(b.country_code)});a("#mark-information").hide();a("#mark-playback").click(function(e){e.preventDefault();modules.linear.fn.replayCurrentMark(c)});a("#mark-gml-download").click(function(e){e.preventDefault();modules.linear.fn.downloadCurrentMark(c)});a("#mark-flag").click(function(e){e.preventDefault();modules.linear.fn.flagCurrentMark(c)});a("#delete-mark").click(function(e){e.preventDefault();modules.linear.fn.deleteCurrentMark(c)});a("#approve-mark-checkbox").change(function(e){e.preventDefault();
e=a(this).is(":checked");modules.linear.fn.approveCurrentMark(c,e)});a("#twitter-share").socialShare({share_url:"http://twitter.com/share",share_params:{text:c.fn.getString("twitter-msg")}});a("#facebook-share").socialShare({share_url:"http://www.facebook.com/sharer.php",share_params:{t:c.fn.getString("facebook-msg")}});modules.linear.fn.updateInterface(c);modules.linear.fn.initMarks(c);a("#sammy #country-select").selectBox({autoWidth:false});a("#sammy #contributor-select").selectBox({autoWidth:false})},
initMarks:function(c){var b=c.modules.linear;if(b.reference_mark&&b.reference_mark!="")b.reference_mark in b.marks?modules.linear.fn.jumpToMark(c,b.reference_mark,b.playback):modules.linear.fn.loadMarks(c,{reference:b.reference_mark,include_forward:20,include_back:20,include_mark:1,success:function(e){if(e.success){modules.linear.fn.setupMarks(c,e.marks);modules.linear.fn.jumpToMark(c,b.reference_mark,b.playback)}else c.fn.showError(c.fn.getString("no-marks-error-msg"));b.requestingMarks=false}});
else modules.linear.fn.loadMarks(c,{offset:0,max:20,success:function(e){if(e.success){modules.linear.fn.setupMarks(c,e.marks);if(firstMark=b.marks[e.marks[0].reference]){b.scene.camera.position.x=-4E3;b.scene.camera.position.z=-3E3;e="cameraEase"in b.tweens?b.tweens.cameraEase:new TWEEN.Tween(b.scene.camera.position);e.to({x:firstMark.bWidth/2,y:firstMark.bHeight/2,z:-1E3},2E3).onComplete(function(){delete b.tweens.cameraEase;typeof callback==="function"&&callback(this)}).easing(TWEEN.Easing.Quartic.EaseInOut).start();
b.tweens.cameraEase=e}}else c.fn.showError(c.fn.getString("no-marks-error-msg"));b.requestingMarks=false}})},updateInterface:function(c){var b=c.modules.linear,e=c.fn.getData("userMark");e&&(b.country_code?e.country_code==b.country_code:true)?a("#your-mark-link").attr("href","#/"+b.linear_root+"/"+c.fn.getData("userMark").reference).show():a("#your-mark-link").hide();var h={};if(b.country_code){h.country_code=b.country_code;a("#contributor-select").next().hide();a("#contributor-select-label").hide()}else{a("#contributor-select").next().show();
a("#contributor-select-label").show()}if(b.linear_root!="moderate"&&!a("#mark-browsing-options").is(".country-"+(b.country_code?b.country_code:"all")))a.ajax({url:"/requests/init_viz_data",data:h,dataType:"JSON",success:function(g){a("#mark-browsing-options").removeAttr("class").addClass("country-"+(b.country_code?b.country_code:"all"));if(b.country_code){a("#first-mark-link").attr("href","#/"+b.linear_root+"/country/"+b.country_code+"/"+g.country_first_mark);a("#last-mark-link").attr("href","#/"+
b.linear_root+"/country/"+b.country_code+"/"+g.country_last_mark)}else{a("#first-mark-link").attr("href","#/"+b.linear_root+"/"+g.first_mark);a("#last-mark-link").attr("href","#/"+b.linear_root+"/"+g.last_mark)}a("#mark-browsing").collapsibleMod();a("#total-mark-count").text(g.max_id);if(a("#contributor-select option").size()==1){var j=a("#contributor-select");if(g.contributor_marks)for(var k=0;k<g.contributor_marks.length;k++){var o=a("<option />").val(g.contributor_marks[k].reference).text(g.contributor_marks[k].contributor);
j.append(o)}j.change(function(){var q=a(this).val();q!="label"&&c.app.setLocation("#/"+b.linear_root+"/"+q);a(this).blur();c.$container.focus()});if(b.country_code){h.country_code=b.country_code;a("#contributor-select").next().hide();a("#contributor-select-label").hide()}else{a("#contributor-select").next().show();a("#contributor-select-label").show()}}}})},dumpAllMarks:function(c){c=c.modules.linear;for(mark in c.marks)delete c.marks[mark];c.scene.objects=[];c.leftBuffer=[];c.rightBuffer=[];c.moreRight=
true;c.moreLeft=true;c.scene.camera.position.x=0;c.scene.camera.position.y=0;c.scene.camera.position.z=-1E3},loadMarks:function(c,b){var e=c.modules.linear,h=b.success;delete b.success;if(e.country_code)b.country_code=e.country_code;var g=b.reference?"/requests/marks_by_reference":"/requests/all_marks";if(e.is_flagged)g="/requests/marks_by_flagged";if(b.reference&&!(b.reference in e.marks)){modules.linear.fn.dumpAllMarks(c);c.fn.showLoader(c.fn.getString("loading-marks-msg"),"overlay-light")}else b.reference||
c.fn.showLoader(c.fn.getString("loading-marks-msg"),"overlay-light");a.ajax({url:g,data:b,dataType:"JSON"}).success(h).success(function(){c.fn.hideLoader()})},setupMarks:function(c,b){var e=c.modules.linear;if(b.length!=0){for(var h=0;h<b.length;h++)b[h].reference in e.marks&&b.shift(h,1);h=[];for(var g in e.marks)h.push([g,e.marks[g].id]);h.sort(function(s,r){return s[1]-r[1]});var j=h.length==0||h[0][1]<b[0].id?e.rightBuffer:e.leftBuffer,k=j==e.leftBuffer?true:false;k&&b.reverse();var o=j.length>
0?e.marks[j[k?0:j.length-1]]:e.scene.objects[k?0:e.scene.objects.length-1];for(h=0;h<b.length;h++)if(!(b[h].reference in e.marks)){var q=JSON.parse(b[h].points_obj_simplified);if(!(q==null||!("strokes"in q)||q.strokes.length==0||q.strokes[0].length<2)){g=new Mark.gmlMark(q.strokes,b[h].reference,b[h].country_code,b[h].date_drawn,q.rtl,b[h].id,b[h].is_approved);if(b[h].contributor){g.contributor_name=b[h].contributor;g.extra_info=q.extra_info;g.contributor_url=q.contributor_url;g.color="0,139,211"}e.marks[g.reference]=
g;o&&g.positionRelativeTo(o,k);k?j.unshift(g.reference):j.push(g.reference);o=g}}}},refillBuffer:function(c,b){var e=c.modules.linear;if(!e.requestingMarks){e.requestingMarks=true;var h=b==e.leftBuffer,g=null;g=b.length>0?e.marks[b[h?0:b.length-1]]:e.scene.objects[h?0:e.scene.objects.length-1];modules.linear.fn.loadMarks(c,{reference:g.reference,include_forward:h?0:20,include_back:h?20:0,include_mark:0,success:function(j){if(j.success){modules.linear.fn.setupMarks(c,j.marks);if(j.marks.length<18)e[h?
"moreLeft":"moreRight"]=false}else e[h?"moreLeft":"moreRight"]=false;e.requestingMarks=false}})}},updateBuffers:function(c,b,e){var h=c.modules.linear;if(h.scene.objects.length!=0){for(var g=h.scene.objects[0];g&&g.position.x+g.bWidth<b;){h.leftBuffer.push(h.scene.objects.shift().reference);g=h.scene.objects[0]}for(g=h.scene.objects[h.scene.objects.length-1];g&&g.position.x>e;){h.rightBuffer.unshift(h.scene.objects.pop().reference);g=h.scene.objects[h.scene.objects-1]}if(h.leftBuffer.length<5&&h.scene.objects.length>
0&&h.moreLeft&&!h.requestingMarks)modules.linear.fn.refillBuffer(c,h.leftBuffer);else h.rightBuffer.length<5&&h.scene.objects.length>0&&h.moreRight&&!h.requestingMarks&&modules.linear.fn.refillBuffer(c,h.rightBuffer)}},updateScene:function(c,b,e){c=c.modules.linear;if(c.rightBuffer.length>0)for(var h=c.marks[c.rightBuffer[0]];h&&h.position&&h.position.x<e;){c.scene.objects.push(c.marks[c.rightBuffer.shift()]);h=c.rightBuffer[0]}if(c.leftBuffer.length>0)for(h=c.marks[c.leftBuffer[c.leftBuffer.length-
1]];h&&h.position&&h.position.x+h.bWidth>b;){c.scene.objects.unshift(c.marks[c.leftBuffer.pop()]);h=c.leftBuffer[c.leftBuffer.length-1]}},jumpToMark:function(c,b,e){var h=c.modules.linear;h.currentMark=h.marks[b];if(e){var g=(new Date).getTime()*2;h.scene.timers[b]={start:g,end:g+h.currentMark.maxTime,speed:1}}modules.linear.fn.centerCurrentMark(c,function(){e&&modules.linear.fn.replayCurrentMark(c);modules.linear.fn.showMarkInformation(c)})},closestMark:function(c){c=c.modules.linear;for(var b=c.scene.objects[0],
e=1;e<c.scene.objects.length;e++){var h=c.scene.objects[e];if(Math.abs(c.scene.camera.position.x-(h.position.x+h.bWidth/2))<Math.abs(c.scene.camera.position.x-(b.position.x+b.bWidth/2)))b=h}return b},hoverTest:function(c,b,e,h){if(h&&h.renderedBounds&&b>=h.renderedBounds.minX&&b<=h.renderedBounds.maxX&&e>=h.renderedBounds.minY&&e<=h.renderedBounds.maxY)return h;return modules.linear.fn.hitTest(c,b,e)},hitTest:function(c,b,e){c=c.modules.linear;for(var h=0;h<c.scene.objects.length;h++)if(c.scene.objects[h].renderedBounds&&
b>=c.scene.objects[h].renderedBounds.minX&&b<=c.scene.objects[h].renderedBounds.maxX&&e>=c.scene.objects[h].renderedBounds.minY&&e<=c.scene.objects[h].renderedBounds.maxY)return c.scene.objects[h];return false},showMarkInformation:function(c){var b=c.modules.linear;if(!b.currentMark)return false;var e=b.currentMark;a("#mark-id").text(e.id);var h=new Date(e.time);h=new Date(h.getTime()+36E5*c.timezoneOffset);var g=[];g.push(h.getHours()+":"+(String(h.getMinutes()).length==1?"0"+h.getMinutes():h.getMinutes()));
g.push("GMT");g.push(c.fn.getString("month-abbreviations",h.getMonth())+" "+h.getDate()+", "+h.getFullYear());e.country_code?c.fn.withCountryCodes(function(j){e.country_code in j?a("#mark-country").text(" / "+j[e.country_code]):a("#mark-country").text("")}):a("#mark-country").text("");if(e.contributor_name){a("#mark-contributor-name").text(e.contributor_name);a("#contributor-name").text(e.contributor_name);a("#mark-flag").hide();"extra_info"in e&&e.extra_info!=null&&e.extra_info!=""&&a("#contributor-quote").text("\u201c"+
e.extra_info+"\u201d");"contributor_url"in e&&c.fn.validate.url(e.contributor_url)?a("#mark-contributor-url").text(e.contributor_url.replace(/(ftp|http|https):\/\//,"").replace(/\/$/,"")).attr("href",e.contributor_url):a("#mark-contributor-url").text("").attr("href","");a("#contributor-information").show()}else{a("#mark-contributor-name, #contributor-quote, #contributor-name, #mark-contributor-url").text("");a("#contributor-information").hide();a("#mark-flag").show()}a("#mark-timestamp").text(g.join(" "));
a("#url-share input").val(window.location.href);if(b.linear_root!="moderate"){a("#twitter-share").data("socialShare-context").share_params.url=window.location.href;a("#facebook-share").data("socialShare-context").share_params.u=window.location.href}b.linear_root=="moderate"&&a("#approve-mark-checkbox").attr("checked",e.is_approved);b.currentMark.reference in b.flaggings?a("#mark-flag").addClass("disabled"):a("#mark-flag").removeClass("disabled");a("#mark-information").fadeIn("fast")},resetMarkInformation:function(){a("#mark-information").find("a").attr("href",
"#").end().find("#mark-id, #total-mark-count, #mark-timestamp, #mark-country")},hideMarkInformation:function(){a("#mark-information").fadeOut("fast")},replayCurrentMark:function(c){c=c.modules.linear;var b=(new Date).getTime();c.eventChange=true;c.scene.timers[c.currentMark.reference]={start:b,end:b+c.currentMark.maxTime,speed:1}},downloadCurrentMark:function(c){c=c.modules.linear;c.currentMark&&c.currentMark.reference&&window.open("/gml/"+c.currentMark.reference)},flagCurrentMark:function(c){var b=
c.modules.linear;b.currentMark.reference in b.flaggings||a.ajax({url:"/requests/flag_mark",data:{reference:b.currentMark.reference},type:"POST",dataType:"JSON",success:function(){a("#mark-flag").addClass("disabled");b.flaggings[b.currentMark.reference]=true;c.fn.storeData("markFlaggings",b.flaggings)},error:function(){c.fn.showError(c.fn.getString("error-msg"))}})},deleteCurrentMark:function(c){var b=c.modules.linear;a.ajax({url:"/requests/delete_mark",data:{reference:b.currentMark.reference},type:"POST",
dataType:"JSON",success:function(){var e=b.currentMark.reference,h=null;delete b.marks[b.currentMark.reference];b.currentMark=null;for(var g=0;g<b.scene.objects.length;g++)if(!(!h&&b.scene.objects[g].reference!=e)){if(!h){h=g;b.scene.objects.splice(g,1);b.currentMark=b.scene.objects[g]}g==0?b.scene.objects[g].positionToStart():b.scene.objects[g].positionRelativeTo(b.scene.objects[g-1])}c.app.setLocation("#/"+b.linear_root+"/"+b.currentMark.reference);b.eventChange=true},error:function(){c.fn.showError(c.fn.getString("error-msg"))}})},
approveCurrentMark:function(c,b){var e=c.modules.linear;a.ajax({url:"/requests/approve_mark",data:{reference:e.currentMark.reference,should_approve:b},type:"POST",dataType:"JSON",success:function(){e.currentMark.is_approved=b},error:function(){c.fn.showError(c.fn.getString("error-msg"))}})},centerCurrentMark:function(c,b){var e=c.modules.linear;if(!e.currentMark)return false;modules.linear.fn.showMarkInformation(c);e.cameraChange.aX=0;e.cameraChange.vX=0;e.cameraChange.aZ=0;e.cameraChange.vZ=0;var h=
Math.abs(e.currentMark.position.x-e.scene.camera.position.x)/2;h=Math.max(1E3,h);var g="cameraEase"in e.tweens?e.tweens.cameraEase:new TWEEN.Tween(e.scene.camera.position);g.to({x:e.currentMark.position.x+e.currentMark.bWidth/2,y:e.currentMark.position.y+e.currentMark.bHeight/2,z:e.currentMark.position.z-1E3},h).onComplete(function(){delete e.tweens.cameraEase;typeof b==="function"&&b(this)}).easing(h>1200?TWEEN.Easing.Quadratic.EaseInOut:TWEEN.Easing.Quartic.EaseInOut).start();e.tweens.cameraEase=
g}}}})(jQuery);
(function(a){a.markApp=a.markApp||{};var c=a.markApp.modules=a.markApp.modules||{};c.capture={defaults:{state:"intro",invite_code:null,locale:null,contributor_type:null},config:{captureLimit:300,layerManager:null,capturedPoints:0,strokes:[],framecount:0,cleanedStrokes:[],lastX:null,lastY:null,captureTime:null,rtl:null,initialized:false,currentStroke:null,mark:null,timeBetweenStrokes:400,events:[]},evt:{resize:function(b){var e=b.modules.capture;e.layerManager.resizeAll(b.width,b.height);if(e.mark&&
e.mark.strokes.length>0)for(var h=0;h<e.mark.strokes.length;h++)c.capture.fn.drawStroke(b,e.mark.strokes[h])},mousemove:function(b){b.mouseDown&&b.modules.capture.state=="drawing"&&c.capture.fn.capturePoint(b)},mousedown:function(b){switch(b.modules.capture.state){case "drawing":a("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",0);a("#location-dialog").is(":visible")&&a("#location-dialog").fadeOut("fast");b.modules.capture.mark||c.capture.fn.startMark(b);
b.modules.capture.currentStroke||c.capture.fn.startStroke(b);break;case "intro":b.modules.capture.mark||c.capture.fn.startMark(b);b.modules.capture.currentStroke||c.capture.fn.startStroke(b);c.capture.fn.endIntro(b)}},mouseup:function(b){if(b.modules.capture.state=="drawing"){c.capture.fn.endStroke(b);a("#markmaker-controls, #contributor-fields, #translator-fields, #markmaker-legal-line").css("zIndex",200)}},ready:function(b){var e=b.modules.capture;a("#markmaker").hide().children().hide();a("#markmaker-reset a").addClass("disabled").bind("mousedown",
function(h){h.preventDefault();c.capture.fn.reset(b)});a("#markmaker-submit a").addClass("disabled").bind("mousedown",function(h){h.preventDefault();c.capture.fn.submit(b)});b.fn.withCountryCodes(function(h){for(var g=a("#markmaker-country"),j=0;j<h.length;j++){var k=a("<option />").val(h[j].code).text(h[j].name);g.append(k)}});a("#markmaker-location a").bind("mousedown",{context:b},c.capture.fn.locationDialogToggle);a("#markmaker-information").bind("mouseover",{context:b},c.capture.fn.informationDialogToggle).bind("mouseout",
{context:b},c.capture.fn.informationDialogToggle);e.state=="drawing"&&c.capture.fn.initDrawing(b);a("#sammy #markmaker-country").selectBox({autoWidth:false})},loop:function(b){var e=b.modules.capture;if(e.initialized){e.frameCount++;c.capture.fn.commonLoop(b);switch(b.modules.capture.state){case "drawing":c.capture.fn.drawLoop(b)}}}},fn:{init:function(b,e){var h=b.modules.capture;if("$capture"in h){if("state"in e){c.capture.fn.reset(b);e.state=="drawing"&&b.mouseDown&&b.fn.trigger("mousedown");h.state=
e.state;c.capture.fn.initDrawing(b)}}else{a.extend(h,c.capture.defaults);a.extend(h,e);a.extend(h,c.capture.config);h.$capture=a("<div />").addClass("capture-container");b.$container.css({zIndex:100,cursor:"none"}).append(h.$capture);h.layerManager=new Mark.layerManager(h.$capture.get(0));h.layerManager.addLayer("drawnLayer");h.layerManager.addLayer("liveDrawingLayer");b.fn.trigger("resize");h.initialized=true}},deinit:function(b){var e=b.modules.capture;e.$capture.fadeOut("fast",function(){e.layerManager.removeAll();
e.$capture.remove();e.initialized=false})},initIntro:function(){},initDrawing:function(b){var e=b.modules.capture;if(a("#browse-marks").is(":visible")){a("#browse-marks, #click-anywhere, #intro-main-copy").fadeOut("fast");a("#markmaker-legal-line").fadeIn("slow")}a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(){a("#markmaker").css("background-position","0 "+(b.height-140)+"px");a("#location-dialog:visible").size()>
0&&a("#location-dialog:visible").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})});a("#markmaker").is(":visible")?a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")}):a("#markmaker").width(0).show().animate({width:b.width},"slow",function(){a("#markmaker-controls").fadeIn("slow",function(){a("#markmaker-information").fadeIn("slow")});a("#markmaker-legal-line").fadeIn("slow")});a("#save-location-button").click(function(h){h.preventDefault();
a("#location-dialog").fadeOut();return false});if(e.invite_code&&e.contributor_type=="t"){e.captureLimit=1E3;e.$capture.addClass("translator");a("#translator-fields").find("#translator-locale").text("'"+b.locale+"'").end().show().collapsibleMod().hide().fadeIn("slow")}else if(e.invite_code&&e.contributor_type=="c"){e.$capture.addClass("contributor");a("#contributor-fields").show().collapsibleMod().hide().fadeIn("slow")}},endIntro:function(b){b.app.setLocation("#/mark/new")},locationDialogToggle:function(b){b.preventDefault();
a("#location-dialog").is(":visible")?a("#location-dialog").fadeOut("fast"):a("#location-dialog").fadeIn("fast").css({bottom:a("#markmaker-location").height()+25,left:a("#markmaker-location").offset().left+32})},informationDialogToggle:function(b){b.preventDefault();b.type=="mouseout"?a("#information-dialog").fadeOut("fast"):a("#information-dialog").fadeIn("fast").css({bottom:a("#markmaker-information").height()+36,left:a("#markmaker-information").offset().left-a("#information-dialog").width()+30})},
startMark:function(b){var e=b.modules.capture;e.captureTime=(new Date).getTime();e.rtl=b.mouseX>a(window).width()/2;e.mark=new Mark.gmlMark([],"","",e.captureTime,e.rtl);a("#markmaker-submit a, #markmaker-reset a").removeClass("disabled")},endMark:function(b){b.modules.capture.mark.setupVars()},startStroke:function(b){b=b.modules.capture;b.currentStroke=[];if(b.strokes.length>0)b.captureTime=(new Date).getTime()-(b.strokes[b.strokes.length-1][b.strokes[b.strokes.length-1].length-1].time+b.timeBetweenStrokes)},
endStroke:function(b){var e=b.modules.capture;if(e.currentStroke.length>2){e.strokes.push(e.currentStroke);var h=Mark.simplification.simplifyPath(e.currentStroke,1);h=Mark.simplification.weightPath(h,[5,10,20,40]);e.mark.strokes.push(h);e.cleanedStrokes.push(h);c.capture.fn.drawStroke(b,h);e.capturedPoints-=e.currentStroke.length-h.length}e.currentStroke=null},capturePoint:function(b){var e=b.modules.capture;if(e.capturedPoints>e.captureLimit){b.fn.trigger("mouseup");c.capture.fn.closeShop(b)}else{var h=
(new Date).getTime();b=new Mark.gmlPoint(b.mouseX,b.mouseY,h-e.captureTime,0);if(e.currentStroke.length>0){h=e.currentStroke[e.currentStroke.length-1];b.speed=h.speedToPoint(b);b.setAngleFromPoint(h);b.smoothAgainst(h,0.01)}else e.strokes.length>=1&&c.capture.fn.drawGuide(e.layerManager.layers.drawnLayer.context,e.lastX,e.lastY,b.x,b.y);e.currentStroke.push(b);e.lastX=b.x;e.lastY=b.y;e.capturedPoints++}},reset:function(b){b=b.modules.capture;b.layerManager.layers.liveDrawingLayer.clean();b.layerManager.layers.drawnLayer.clean();
b.capturedPoints=0;b.rtl=null;b.mouseDown=false;b.lastX=null;b.lastY=null;b.strokes=[];b.currentStroke=null;b.mark=null;b.captureTime=null;b.state="drawing";a("#markmaker-submit a, #markmaker-reset a").addClass("disabled");a("#markapp").css({cursor:"none"});a("#markmaker-instructions").fadeIn()},closeShop:function(b){var e=b.modules.capture;e.state="preview";c.capture.fn.endMark(b);e.layerManager.layers.liveDrawingLayer.clean();b=e.layerManager.layers.liveDrawingLayer.context;var h=e.lastX,g=e.lastY;
b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();b.dashedLineTo(h,g,e.rtl?0:e.layerManager.layers.liveDrawingLayer.canvas.width,g,[7,5]);b.closePath();b.stroke();a("#markapp").css({cursor:"default"})},submit:function(b){var e=b.modules.capture;if(e.state!="submitting"){e.state!="preview"&&c.capture.fn.closeShop(b);e.state="submitting";a("#markmaker-submit a").addClass("disabled");var h={};h.rtl=e.rtl;h.strokes=e.strokes;h=JSON.stringify(h);var g=JSON.stringify(e.mark),j=a("#markmaker-country").val()==
"label"?"":a("#markmaker-country").val();b.fn.showLoader(b.fn.getString("submitting-mark"));var k={points_obj:h,points_obj_simplified:g,country_code:j};if(e.invite_code&&e.contributor_type=="t"){k.contributor_locale=b.locale;k.invite=e.invite_code}else if(e.invite_code&&e.contributor_type=="c"){k.contributor=a("#contributor-name").val();e.mark.extra_info=a("#contributor-quote").val();e.mark.contributor_url=a("#contributor-url").val();k.points_obj_simplified=JSON.stringify(e.mark);k.invite=e.invite_code}a.ajax({url:"/requests/save_mark",
data:k,type:"POST",dataType:"JSON",success:function(o){if(k.contributor_locale)b.app.setLocation("#/linear/");else{b.fn.storeData("userMark",{reference:o.mark_reference,country_code:j});b.app.setLocation("#/linear/"+o.mark_reference+"?playback=true")}b.fn.hideLoader()},error:function(){b.fn.showError(b.fn.getString("submit-error"))}});return false}},drawStroke:function(b,e){var h=b.modules.capture;Mark.thickBrush(h.layerManager.layers.drawnLayer.context,[e]);h.layerManager.layers.drawnLayer.context.fillStyle=
"rgba(255,255,255,0.3)";h.layerManager.layers.drawnLayer.context.strokeStyle="rgba(255,255,255,0.3)";Mark.circleBrush(h.layerManager.layers.drawnLayer.context,[e])},drawGuide:function(b,e,h,g,j){b.strokeStyle="rgba(0,0,0,0.2)";b.lineWidth=1;b.beginPath();b.dashedLineTo(e,h,g,j,[7,5]);b.closePath();b.stroke()},drawCursor:function(b,e,h,g){b.strokeStyle="#ff5400";b.fillStyle="#000000";b.beginPath();b.moveTo(e,h);b.lineTo(e+1,h-8);b.lineTo(e+20,h-27);b.lineTo(e+23,h-23);b.lineTo(e,h);b.closePath();b.stroke();
g*=18.5;g+=4.5;b.beginPath();b.moveTo(e,h);b.lineTo(e+1,h-8);b.lineTo(e+(g-3),h-(g+4));b.lineTo(e+g,h-g);b.lineTo(e,h);b.closePath();b.fill()},commonLoop:function(b){var e=b.modules.capture;e.layerManager.layers.liveDrawingLayer.clean();if(b.mouseIn&&(e.state=="drawing"||e.state=="intro"))c.capture.fn.drawCursor(e.layerManager.layers.liveDrawingLayer.context,b.mouseX,b.mouseY,(e.captureLimit-e.capturedPoints)/e.captureLimit)},introLoop:function(){},drawLoop:function(b){var e=b.modules.capture;if(e.currentStroke&&
e.currentStroke.length>0){Mark.thickBrush(e.layerManager.layers.liveDrawingLayer.context,[e.currentStroke]);e.layerManager.layers.liveDrawingLayer.context.fillStyle="rgba(255,255,255,0.3)";e.layerManager.layers.liveDrawingLayer.context.strokeStyle="rgba(255,255,255,0.3)";Mark.circleBrush(e.layerManager.layers.liveDrawingLayer.context,[e.currentStroke])}if(b.mouseIn)if(!b.mouseDown){var h,g;if(e.strokes.length==0){h=b.mouseX>a(window).width()/2?e.layerManager.layers.liveDrawingLayer.canvas.width:0;
g=b.mouseY}else{h=e.lastX;g=e.lastY}c.capture.fn.drawGuide(e.layerManager.layers.liveDrawingLayer.context,h,g,b.mouseX,b.mouseY)}}}}})(jQuery);
(function(a){markApp=a.markApp=a.markApp||{};modules=a.markApp.modules=a.markApp.modules||{};modules.intro={defaults:{reference_mark:null},config:{marks:{},animationMarks:["vVR","myWb"],playbackTimes:{},vizScene:null,textScene:null,layerManager:null,initialized:false,eventChange:false,curLocaleMark:null,animationComplete:false,tweens:{}},evt:{resize:function(c){c.modules.intro.layerManager.resizeAll(c.width,c.height);c.modules.intro.eventChange=true;c.modules.intro.xAnimationComplete&&modules.intro.fn.drawX(c)},
loop:function(c){var b=c.modules.intro;TWEEN.update();b.layerManager.layers.viz.clean();Mark.renderer.renderScene(b.vizScene,{width:c.width,height:c.height});if(b.curLocaleMark||b.xMark){b.layerManager.layers.mainMark.clean();if(b.curLocaleMark){var e=500/b.curLocaleMark.bWidth;Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.curLocaleMark,{offset:{x:c.width/2-115,y:c.height-240},scale:{x:e,y:e,thickness:e},color:"255,84,0",timer:b.textScene.timers[b.curLocaleMark.reference]})}b.xMark&&
Mark.renderer.renderMark(b.layerManager.layers.mainMark.context,b.xMark,{offset:{x:10,y:-400},scale:{x:c.width/2/b.xMark.bWidth,y:(c.height+800)/b.xMark.bHeight,thickness:6},color:"0,0,0",timer:b.textScene.timers[b.xMark.reference]})}},ready:function(c){a("#markmaker").hide().children().hide();a.when(modules.intro.fn.initInterface(c),modules.intro.fn.loadMarks(c)).then(function(){modules.intro.fn.runVizPreview(c)}).then(function(){modules.intro.fn.startDomAnimation(c)}).fail(function(){modules.intro.fn.simpleIntro(c)})}},
fn:{init:function(c,b){var e=c.modules.intro;if(e.initialized){a.extend(e,e,b);for(option in modules.intro.defaults)if(b[option]==null)e[option]=modules.intro.defaults[option]}else{a.extend(e,modules.intro.defaults,b);a.extend(e,e,modules.intro.config);e.$intro=a("<div />").addClass("intro-container");c.$container.append(e.$intro);e.vizScene=new Mark.scene;e.textScene=new Mark.scene;e.layerManager=new Mark.layerManager(e.$intro.get(0));e.layerManager.addLayer("viz");e.vizScene.canvasContext=e.layerManager.layers.viz.context;
e.layerManager.addLayer("mainMark");e.textScene.canvasContext=e.layerManager.layers.mainMark.context;e.layerManager.addLayer("X");c.fn.trigger("resize");e.initialized=true}},deinit:function(c){var b=c.modules.intro;b.$intro.fadeOut("fast",function(){b.layerManager.removeAll();b.$intro.remove();b.initialized=false})},initInterface:function(c){a("#markmaker").unbind("resize.markApp").bind("resize.markApp",function(b,e,h){b=e/2+485;h=h-140;e=false;a("#markmaker").css("background-position","0 "+h+"px");
if(!a("#markmaker").is(":visible")){e=true;a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"block"})}a("#browse-marks").css({top:h-50,left:b-85});a("#click-anywhere").css({top:h+12,left:b-a("#intro-main-copy").width()});a("#intro-main-copy").css({top:h-a("#intro-main-copy").height()-100,left:b-a("#intro-main-copy").width()});e&&a("#markmaker, #browse-marks, #click-anywhere, #intro-main-copy").css({display:"none"})}).trigger("resize.markApp",[c.width,c.height]).width(0).height(c.height)},
loadMarks:function(c){c.fn.showLoader(c.fn.getString("loading-intro-msg"),"overlay-light");return a.ajax({url:"/requests/get_translated_marks",dataType:"JSON"}).success(function(b){modules.intro.fn.setupMarks(c,b.marks);c.fn.hideLoader()})},setupMarks:function(c,b){var e=c.modules.intro;if(!(typeof b==="undefined"||b.length==0)){a(e.layerManager.layers.viz.canvas).css("opacity",0);b.sort(function(){return Math.round(Math.random())-0.5});for(var h=null,g=0;g<b.length;g++)try{var j=JSON.parse(b[g].points_obj_simplified),
k=new Mark.gmlMark(j.strokes,b[g].reference,b[g].country_code,b[g].date_drawn,j.rtl,b[g].id,b[g].is_approved);if(!e.currentMark)e.currentMark=k;b[g].reference in e.marks||(e.marks[k.reference]=k);h&&k.positionRelativeTo(h,false);if(b[g].contributor_locale==c.locale||!e.curLocaleMark){var o=(new Date).getTime()*3;e.curLocaleMark=new Mark.gmlMark(j.strokes,b[g].reference,b[g].country_code,b[g].date_drawn,j.rtl,b[g].id,b[g].is_approved);e.textScene.timers[e.curLocaleMark.reference]={start:o,end:o+e.curLocaleMark.maxTime,
speed:2}}e.vizScene.objects.push(k);h=k}catch(q){}}},runVizPreview:function(c){var b=c.modules.intro;if(!(b.vizScene.objects.length<3)){b.vizScene.camera.position.x=-2E3;b.vizScene.camera.position.z=-3E3;c=b.vizScene.objects[b.vizScene.objects.length-2];var e=new TWEEN.Tween(b.vizScene.camera.position);e.to({x:c.position.x+c.bWidth/2,y:c.position.y+c.bHeight/2,z:c.position.z-2E3},6E3).onComplete(function(){delete b.tweens.cameraEase}).easing(TWEEN.Easing.Quartic.EaseInOut).start();b.tweens.cameraEase=
e;a(b.layerManager.layers.viz.canvas).animate({opacity:"1"},"slow").delay(2E3).animate({opacity:"0.1"},"slow");a("#markmaker").delay(3E3)}},startDomAnimation:function(c){a("#markmaker").width(0).show().animate({width:c.width},"slow",function(){modules.intro.fn.startMarkAnimations(c);a("#intro-main-copy").fadeIn("slow");a("#click-anywhere").delay(200).fadeIn("slow");a("#browse-marks").delay(100).fadeIn("slow")})},startMarkAnimations:function(c){var b=c.modules.intro;modules.intro.fn.drawX(c);if(b.curLocaleMark){c=
(new Date).getTime()+2E3;b.textScene.timers[b.curLocaleMark.reference]={start:c,end:c+b.curLocaleMark.maxTime,speed:2}}},drawX:function(c){c=c.modules.intro;c.xMark=new Mark.gmlMark({strokes:[[{x:177,y:0,z:0,time:51,speed:0,angle:0,significance:5},{x:129,y:60,z:0,time:255,speed:0.45069390943299864,angle:0.5880026035475675,significance:1},{x:123,y:65,z:0,time:271,speed:0.4931203163041915,angle:0.7853981633974483,significance:1},{x:103,y:89,z:0,time:339,speed:0.45069390943299864,angle:0.5880026035475675,
significance:1},{x:56,y:139,z:0,time:503,speed:0.45073896963561083,angle:0.7853981633974483,significance:1},{x:38,y:162,z:0,time:584,speed:0.3572203090978693,angle:0.46364760900080615,significance:1},{x:9,y:192,z:0,time:691,speed:0.3535533905932738,angle:0.7853981633974483,significance:1},{x:0,y:206,z:0,time:727,speed:0.45069390943299864,angle:0.5880026035475675,significance:5}],[{x:11,y:23,z:0,time:1178,speed:0,angle:0,significance:5},{x:30,y:49,z:0,time:1246,speed:0.32424352695503,angle:5.639684198386302,
significance:1},{x:55,y:77,z:0,time:1321,speed:0.48790367901871773,angle:5.497787143782138,significance:1},{x:72,y:100,z:0,time:1367,speed:0.5216642390945547,angle:5.695182703632019,significance:1},{x:85,y:113,z:0,time:1408,speed:0.5355917833779965,angle:5.497787143782138,significance:2},{x:154,y:175,z:0,time:1662,speed:0.3311927108182759,angle:5.497787143782138,significance:1},{x:186,y:196,z:0,time:1802,speed:0.2849548128987055,angle:5.497787143782138,significance:5}]],country_code:"",time:1300925747439,
rtl:false,maxTime:1802,reference:"",hoverState:false,renderedBounds:null,id:null,contributor_name:null,extra_info:null,color:"0,0,0",hoverColor:"0,139,211",x:454,y:199,position:{x:0,y:0,z:0},rotationAngle:{x:0,y:0,z:0},sX:0,sY:0,bWidth:186,bHeight:206}.strokes,"xMark");c.textScene.objects.push(c.xMark);var b=(new Date).getTime();c.textScene.timers[c.xMark.reference]={start:b,end:b+c.xMark.maxTime,speed:1}},simpleIntro:function(c){a("#markmaker").width(0).show().animate({width:c.width},"slow",function(){a("#intro-main-copy").fadeIn("slow");
a("#click-anywhere").delay(200).fadeIn("slow");a("#browse-marks").delay(100).fadeIn("slow")})}}}})(jQuery);
(function(a){function c(b){return b.replace(/-/g,"--").replace(/ /g,"-")}a.fn.extend({delayedBind:function(b,e,h,g){var j=c(e);return this.each(function(){var k=this;if(!a(this).data("_delayedBindBound-"+j+"-"+b)){a(this).data("_delayedBindBound-"+j+"-"+b,true);a(this).bind(e,function(){var o=a(this).data("_delayedBindTimerID-"+j+"-"+b);typeof o!="undefined"&&clearTimeout(o);o=setTimeout(function(){a(k).trigger("_delayedBind-"+j+"-"+b)},b);a(this).data("_delayedBindTimerID-"+j+"-"+b,o)})}a(this).bind("_delayedBind-"+
j+"-"+b,h,g)})},delayedBindCancel:function(b,e){var h=c(e);return this.each(function(){var g=a(this).data("_delayedBindTimerID-"+h+"-"+b);typeof g!="undefined"&&clearTimeout(g)})},delayedBindUnbind:function(b,e,h){var g=c(e);return this.each(function(){a(this).unbind("_delayedBind-"+g+"-"+b,h)})}})})(jQuery);
(function(a){a.collapsibleMod={cfg:{collapsedClass:"collapsibleMod-collapsed",expandedClass:"collapsibleMod-expanded",$header:null,expandedHeight:0,collapsedHeight:0,$content:null,collapsed:false,stateKey:"",saveState:true},fn:{init:function(c,b){var e=a(c),h=a.extend({},a.collapsibleMod.cfg,b);h.$container=e;h.$header=e.find("h3:first");h.$content=e.children().not("h3:first");h.expandedHeight=h.$content.height();h.$header.bind("click",function(g){g.preventDefault();a.collapsibleMod.fn.toggle(h)});
if(h.saveState&&h.$container.attr("id")!=""&&typeof localStorage!="undefined"){h.stateKey="collapsibleMod-state-"+h.$container.attr("id");a.collapsibleMod.fn.restoreState(h)}else h.saveState=false;h.collapsed?a.collapsibleMod.fn.collapse(h):h.$container.addClass(h.expandedClass);e.data("collapsibleMod-context",h)},collapse:function(c){c.$container.addClass(c.collapsedClass).removeClass(c.expandedClass);c.$content.animate({height:c.collapsedHeight},"fast",function(){c.collapsedHeight==0&&c.$content.hide()});
c.collapsed=true;a.collapsibleMod.fn.saveState(c)},expand:function(c){c.$container.removeClass(c.collapsedClass).addClass(c.expandedClass);c.$content.show().animate({height:c.expandedHeight},"fast");c.collapsed=false;a.collapsibleMod.fn.saveState(c)},saveState:function(c){if(c.saveState)try{localStorage.removeItem(c.stateKey);localStorage.setItem(c.stateKey,c.collapsed)}catch(b){}},restoreState:function(c){if(c.saveState&&localStorage.getItem(c.stateKey))c.collapsed=localStorage.getItem(c.stateKey)===
"true"},toggle:function(c){c.collapsed?a.collapsibleMod.fn.expand(c):a.collapsibleMod.fn.collapse(c)}}};a.fn.collapsibleMod=function(c){return a(this).each(function(){a.collapsibleMod.fn.init(this,c)})}})(jQuery);
(function(a){a.socialShare={cfg:{$link:null,share_url:"http://twitter.com/share",share_title:"Share on Twitter",share_params:{},popupWidth:550,popupHeight:450},fn:{init:function(c,b){var e=a(c),h=a.extend({},a.socialShare.cfg,b);h.$link=e;h.$link.bind("click",function(g){g.preventDefault();a.socialShare.fn.share(h)});e.data("socialShare-context",h)},shareURL:function(c){var b=[];for(param in c.share_params)b.push(param+"="+encodeURIComponent(c.share_params[param]));return c.share_url+"?"+b.join("&")},
share:function(c){window.open(a.socialShare.fn.shareURL(c),c.share_title,"height="+c.popupHeight+",width="+c.popupWidth)}}};a.fn.socialShare=function(c){return a(this).each(function(){a.socialShare.fn.init(this,c)})}})(jQuery);
jQuery&&function(a){a.extend(a.fn,{selectBox:function(c,b){var e=function(m){var n=m.data.select,f=m.data.control;if(a(f).hasClass("ui-selectBox-disabled"))return false;if(a(f).hasClass("ui-selectBox-focus")&&a("#ui-selectBox-dropdown").size()===1){h(m,true);return false}a(".ui-selectBox").not(f).trigger("blur");j(m);m.stopPropagation();a("#ui-selectBox-dropdown").remove();var i=a('<div id="ui-selectBox-dropdown" class="ui-corner-bottom" />'),l=a("<ul />");if(a(n).children("optgroup").size()===0)a(n).children("option").each(function(){var t=
a(this).text()!==""?a(this).text():"\u00a0",v="";if(a(this).attr("disabled"))v+=" ui-selectBox-disabled";a(l).append('<li class="ui-selectBox-option'+v+'">'+r(t)+"</li>")});else{a(i).addClass("ui-selectBox-hasOptgroups");a(n).children("optgroup").each(function(){a(l).append('<li class="ui-selectBox-optgroup">'+r(a(this).attr("label"))+"</li>");a(this).children("option").each(function(){var t=a(this).text()!==""?a(this).text():"\u00a0",v="";if(a(this).attr("disabled"))v+=" ui-selectBox-disabled";a(l).append('<li class="ui-selectBox-option'+
v+'">'+r(t)+"</li>")})})}a(i).append(l);m=a(n)[0].selectedIndex;a(i).find("LI.ui-selectBox-option").eq(m).addClass("ui-selectBox-initial ui-selectBox-current");a(i).find("LI.ui-selectBox-option").hover(function(){a(i).find(".ui-selectBox-current").removeClass("ui-selectBox-current");a(this).addClass("ui-selectBox-current")},function(){a(this).removeClass("ui-selectBox-current")}).click({select:n,control:f},function(t){g(t)}).mouseup({select:n,control:f},function(t){a(t.target).trigger("click")});
a("BODY").append(i);n=a(f).offset();m=a(f).outerHeight();var p=a(f).outerWidth(),u=parseInt(a(i).css("borderLeftWidth"))+parseInt(a(i).css("borderRightWidth"));a(i).css({position:"absolute",zIndex:"999999",top:n.top+m,left:n.left,width:p-u}).show();a(f).removeClass("ui-corner-all").addClass("ui-corner-top");s(i);q(true)},h=function(m,n){var f=m.data.control;a("#ui-selectBox-dropdown").remove();a(f).removeClass("ui-corner-top").addClass("ui-corner-all");n?a(f).focus():k(m)},g=function(m,n){var f=m.data.select,
i=m.data.control;n=n?n:m.target;if(a(n).hasClass("ui-selectBox-disabled"))return false;var l=a(f)[0].selectedIndex;a("#ui-selectBox-dropdown .ui-selectBox-optgroup").remove();var p=a("#ui-selectBox-dropdown").find("LI.ui-selectBox-current").index();if(l!==p){a(f)[0].selectedIndex=p;a(i).find(".ui-selectBox-label").text(a(n).text());a(f).trigger("change")}h(m,true)},j=function(m){var n=m.data.select;m=m.data.control;if(a(m).hasClass("ui-selectBox-disabled"))return true;if(a(m).hasClass("ui-selectBox-focus"))return false;
a(".ui-selectBox.ui-selectBox-focus").removeClass("ui-selectBox-focus");a("#ui-selectBox-dropdown").remove();a(m).addClass("ui-selectBox-focus");a(document).bind("mousedown",{select:n,control:m},k);a(document).bind("keydown",{select:n,control:m},o);a(n).trigger("focus");a(m).focus()},k=function(m){var n=m.data.select,f=m.data.control;if(m.target.id==="ui-selectBox-dropdown"||a(m.target).parents("#ui-selectBox-dropdown").size()===1){a(f).trigger("focus");return false}if(a(f).hasClass("ui-selectBox-focus")){a(f).removeClass("ui-selectBox-focus");
a(document).unbind("mousedown",k);a(document).unbind("keydown",o);a(n).trigger("blur");h(m)}},o=function(m){var n=m.data.select,f=m.data.control,i=a("#ui-selectBox-dropdown");if(a(f).hasClass("ui-selectBox-disabled"))return false;switch(m.keyCode){case 9:k(m);break;case 13:if(a(i).size()===0)return false;n=a(i).find(".ui-selectBox-option");var l=-1;a.each(n,function(u,t){if(a(t).hasClass("ui-selectBox-current"))l=u});l>=0&&g(m,a(n).eq(l));return false;case 27:h(m,true);break;case 38:case 37:case 33:var p=
m.keyCode===33?20:1;if(a(i).size()===0){if(m.altKey){e(m);return false}m=a(n).find("OPTION").size();i=a(n)[0].selectedIndex;for(p=a(n)[0].selectedIndex-p;a(n).find("OPTION").eq(p).attr("disabled")===true&&p>=0;)p--;if(p<0)p=a(n).find("OPTION:not([disabled]):first").index();a(n)[0].selectedIndex=p;if(a(n)[0].selectedIndex===-1){p=0;a(n)[0].selectedIndex=p}m=a(n).find("OPTION:selected").text();if(m==="")m="\u00a0";a(f).find(".ui-selectBox-label").text(m);p!==i&&a(n).trigger("change");return false}n=
a(i).find(".ui-selectBox-option");l=-1;a.each(n,function(u,t){if(a(t).hasClass("ui-selectBox-current"))l=u});l-=p;if(l<0)l=0;a(n).removeClass("ui-selectBox-current");a(n).eq(l).addClass("ui-selectBox-current");q();return false;case 40:case 39:case 34:p=m.keyCode===34?20:1;if(a(i).size()===0){if(m.altKey){e(m);return false}m=a(n).find("OPTION").size();i=a(n)[0].selectedIndex;for(p=a(n)[0].selectedIndex+p;a(n).find("OPTION").eq(p).attr("disabled")===true&&p<=a(n).find("OPTION").size();)p++;if(p>m-1)p=
a(n).find("OPTION:not([disabled]):last").index();a(n)[0].selectedIndex=p;if(a(n)[0].selectedIndex===-1){p=a(n).find("OPTION").size()-1;a(n)[0].selectedIndex=p}m=a(n).find("OPTION:selected").text();if(m==="")m="\u00a0";a(f).find(".ui-selectBox-label").text(m);p!=i&&a(n).trigger("change");return false}n=a(i).find(".ui-selectBox-option");l=-1;a.each(n,function(u,t){if(a(t).hasClass("ui-selectBox-current"))l=u});l+=p;if(l>a(n).size()-1)l=a(n).size()-1;a(n).removeClass("ui-selectBox-current");a(n).eq(l).addClass("ui-selectBox-current");
q();return false;case 36:case 35:if(a(i).size()===0){if(m.altKey){e(m);return false}i=a(n)[0].selectedIndex;p=m.keyCode===36?0:a(n).find("OPTION").size()-1;if(a(n).find("OPTION").eq(p).attr("disabled")===true)p=m.keyCode===36?a(n).find("OPTION:not([disabled]):first").index():a(n).find("OPTION:not([disabled]):last").index();a(n)[0].selectedIndex=p;m=a(n).find("OPTION:selected").text();if(m==="")m="\u00a0";a(f).find(".ui-selectBox-label").text(m);p!=i&&a(n).trigger("change");return false}a(i).find(".ui-selectBox-current").removeClass("ui-selectBox-current");
m.keyCode===36?a(i).find(".ui-selectBox-option:first").addClass("ui-selectBox-current"):a(i).find(".ui-selectBox-option:last").addClass("ui-selectBox-current");q();return false}},q=function(m){var n=a("#ui-selectBox-dropdown");if(a(n).size()===0)return false;var f=a(n).find(".ui-selectBox-current");if(a(f).size()===0)return false;var i=parseInt(a(f).offset().top-a(n).position().top),l=parseInt(i+a(f).outerHeight());if(m)a(n).scrollTop(a(f).offset().top-a(n).offset().top+a(n).scrollTop()-a(n).height()/
2);else{i<0&&a(n).scrollTop(a(f).offset().top-a(n).offset().top+a(n).scrollTop());l>a(n).height()&&a(n).scrollTop(a(f).offset().top+a(f).outerHeight()-a(n).offset().top+a(n).scrollTop()-a(n).height())}},s=function(m){a(m).css("MozUserSelect","none").bind("selectstart",function(){return false}).bind("mousedown",function(){return false});return true},r=function(m){return m.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};switch(c){case "destroy":a(this).each(function(){var m=
a(this),n=a(this).next(".ui-selectBox");if(a(m)[0].tagName.toLowerCase()==="select"){a(n).remove();a(m).removeData("selectBox-options").show()}});return a(this);case "disable":a(this).each(function(){var m=a(this),n=a(this).next(".ui-selectBox");a(m).attr("disabled",true);a(n).addClass("ui-selectBox-disabled")});return a(this);case "enable":a(this).each(function(){var m=a(this),n=a(this).next(".ui-selectBox");a(m).attr("disabled",false);a(n).removeClass("ui-selectBox-disabled")});return a(this);case "setOptions":if(!b)return a(this);
a(this).each(function(){var m=a(this);a(this).next(".ui-selectBox");switch(typeof b){case "string":a(m).html(b);break;case "object":a(m).html("");for(var n in b)if(b[n]!==null)if(typeof b[n]==="object"){var f=a('<optgroup label="'+n+'" />'),i;for(i in b[n])a(f).append('<option value="'+i+'">'+b[n][i]+"</option>");a(m).append(f)}else{f=a('<option value="'+n+'">'+b[n]+"</option>");a(m).append(f)}}n=a(m).data("selectBox-options");a(m).selectBox("destroy");a(m).selectBox(n)});return a(this);case "value":a("#ui-selectBox-dropdown").remove();
a(this).each(function(){var m=a(this),n=a(this).next(".ui-selectBox");a(m).val(b);m=a(m).find(":selected").text();if(m==="")m="\u00a0";a(n).removeClass("ui-corner-top").addClass("ui-corner-all").find(".ui-selectBox-label").text(m)});return a(this);default:a(this).each(function(){c||(c={});var m=a.extend({autoWidth:true},c),n=a(this);if(a(this).next(".ui-selectBox").size()===0){var f=a('<a href="#" class="ui-selectBox ui-corner-all" tabindex="'+parseInt(a(n).attr("tabindex"))+'" />');a(f).addClass(a(n).attr("class")).attr({style:(a(n).attr("style")+
"").replace(/inline/,"inline-block"),title:a(n).attr("title")});a(n).data("selectBox-options",m);if(m.autoWidth){var i="";a(n).find("OPTION").each(function(){if(a(this).text().length>i.length)i=a(this).text()});m=a('<div class="ui-selectBox-dropdown" style="position: absolute; top: -9999em; left: -9999em; width: auto; display: inline-block;" />');var l=a('<li class="ui-selectBox-option">'+r(i)+"</li>");a(m).append(l);a("BODY").append(m);a(f).width(l.outerWidth());a(m).remove()}if(!(a(n)[0].tagName.toLowerCase()!==
"select"||a(n).attr("multiple")===true)){a(n).attr("disabled")===true&&a(f).addClass("ui-selectBox-disabled");m=a(n).find("OPTION:selected").text();if(m==="")m="\u00a0";a(f).append('<span class="ui-selectBox-label">'+r(m)+"</span>");a(f).append('<span class="ui-selectBox-arrow"></span>');a(n).hide().after(f);s(f);a(f).bind("click",function(){return false}).bind("mousedown",{select:n,control:f},e).bind("focus",{select:n,control:f},j).bind("blur",{select:n,control:f},k)}}});return a(this)}}})}(jQuery);
CanvasRenderingContext2D.prototype.dashedLineTo=function(a,c,b,e,h){var g=function(n,f){return n<=f},j=function(n,f){return n>=f},k=function(n,f){return Math.min(n,f)},o=function(n,f){return Math.max(n,f)},q={thereYet:j,cap:k};j={thereYet:j,cap:k};if(c-e>0){j.thereYet=g;j.cap=o}if(a-b>0){q.thereYet=g;q.cap=o}this.moveTo(a,c);g=a;o=c;k=0;for(var s=true;!(q.thereYet(g,b)&&j.thereYet(o,e));){var r=Math.atan2(e-c,b-a),m=h[k];g=q.cap(b,g+Math.cos(r)*m);o=j.cap(e,o+Math.sin(r)*m);s?this.lineTo(g,o):this.moveTo(g,
o);k=(k+1)%h.length;s=!s}};CanvasRenderingContext2D.prototype.dottedArc=function(a,c,b,e,h,g){var j=Math.PI/b/2,k=e;for(e=e+j;e<h;){this.beginPath();this.arc(a,c,b,k,e,g);this.stroke();k=e+j;e=k+j}};
var Mark=function(a){a.layer=function(c,b){this.context=this.canvas=null;this.dirtyRectangles=[];this.layerName=b;this.manager=c;this.clean=function(){if(this.dirtyRectangles.length==0)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);else for(var e=0;e<this.dirtyRectangles.length;e++)this.context.clearRect(e.x,e.y,e.w,e.h)};this.setSize=function(e,h){if(this.canvas.width!=e)this.canvas.width=e;if(this.canvas.height!=h)this.canvas.height=h};this.init=function(){this.canvas=document.createElement("canvas");
this.context=this.canvas.getContext("2d");this.setSize(this.manager.container.scrollWidth,this.manager.container.scrollHeight);this.manager.layerWrapper.appendChild(this.canvas)};this.remove=function(){this.manager.layerWrapper.removeChild(this.canvas)};this.init()};return a}(Mark||{});
Mark=function(a){a.layerManager=function(c){this.container=c;this.layerWrapper=null;this.layers={};this.init=function(){this.layerWrapper=document.createElement("div");this.layerWrapper.className="mark-layerManager";this.container.appendChild(this.layerWrapper)};this.addLayer=function(b){var e=new a.layer(this,b);return this.layers[b]=e};this.removeAll=function(){for(var b in this.layers){this.layers[b].remove();delete this.layers[b]}};this.resizeAll=function(b,e){for(var h in this.layers)this.layers[h].setSize(b,
e)};this.init()};return a}(Mark||{});
Mark=function(a){a.gmlPoint=function(c,b,e,h,g){this.x=c;this.y=b;this.z=typeof g=="integer"?g:0;this.time=e;this.speed=h;this.angle=0;this.significance=1;this.distanceToPoint=function(j){return Math.sqrt(Math.pow(j.x-this.x,2)+Math.pow(j.y-this.y,2))};this.speedToPoint=function(j){return this.distanceToPoint(j)/(j.time-this.time)};this.smoothAgainst=function(j,k){var o=this.distanceToPoint(j);o=k*o;if(Math.abs(this.speed-j.speed)>o)this.speed=this.speed>j.speed?j.speed+o:j.speed-o};this.setAngleFromPoint=
function(j){this.angle=Math.atan2(j.y-this.y,j.x-this.x)+Math.PI/2;this.angle%=2*Math.PI;if(this.angle<0)this.angle=2*Math.PI+this.angle};this.clone=function(){return{x:this.x,y:this.y,z:this.z,time:this.time,significance:this.significance,angle:this.angle,speed:this.speed}};this.getTranslatedPoint=function(j,k){var o=this.clone();o.x+=j;o.y+=k;return o}};return a}(Mark||{});
Mark=function(a){a.simplification={Line:function(c,b){this.p1=c;this.p2=b;this.distanceToPoint=function(e){var h=(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x),g=[];g.push(Math.abs(e.y-h*e.x-(this.p1.y-h*this.p1.x))/Math.sqrt(Math.pow(h,2)+1));g.push(Math.sqrt(Math.pow(e.x-this.p1.x,2)+Math.pow(e.y-this.p1.y,2)));g.push(Math.sqrt(Math.pow(e.x-this.p2.x,2)+Math.pow(e.y-this.p2.y,2)));return g.sort(function(j,k){return j-k})[0]}},douglasPeucker:function(c,b){var e=[];if(c.length<=2)return[c[0]];for(var h=
new a.simplification.Line(c[0],c[c.length-1]),g=0,j=0,k=1;k<=c.length-2;k++){var o=h.distanceToPoint(c[k]);if(o>g){g=o;j=k}}if(g>=b){g=c[j];h.distanceToPoint(g,true);e=e.concat(a.simplification.douglasPeucker(c.slice(0,j+1),b));e=e.concat(a.simplification.douglasPeucker(c.slice(j,c.length),b))}else{g=c[j];h.distanceToPoint(g,true);e=[c[0]]}return e},simplifyPath:function(c,b){var e=a.simplification.douglasPeucker(c,b);e.push(c[c.length-1]);return e},weightPath:function(c,b){for(var e=b.length+1,h=
c;tolerance=b.shift();){h=a.simplification.douglasPeucker(h,tolerance);for(var g=0;g<h.length;g++)h[g].significance++}c[0].significance=e;c[c.length-1].significance=e;return c}};return a}(Mark||{});
Mark=function(a){a.dof=1E4;a.thickMarkBrush=function(c,b,e,h,g,j){h=h?h:"0,0,0";var k=Mark.renderer.translatePoint(b[0][0],e),o={minX:k.x,maxX:k.x,minY:k.y,maxY:k.y};if(!(g&&j&&(k.x>g*2||k.x<-g||k.y>j*2||k.y<-j||k.z>a.dof||k.z<0))){for(g=0;g<b.length;g++)if(!(typeof b[g]=="undefined"||b[g].length<=1))for(var q=null,s=0;s<b[g].length;s++){k=Mark.renderer.translatePoint(b[g][s],e);if(!(k.z&&k.z>a.dof))if(!(k.significance&&k.significance*(a.dof/5)<k.z-500))if(q){c.lineWidth=1;if(s==b[g].length-1)var r=
0,m=0;else{m=9-Math.max(0,Math.pow(k.speed+1,3));if(e.mode=="flatScale"&&e.scale.thickness)m*=e.scale.thickness;else if(k.z)m*=2/k.z*(j/2);if(m<0.1)m=0.1;m+=1;r=Math.cos(k.angle)*m;m=Math.sin(k.angle)*m}c.strokeStyle="rgba("+h+","+(a.dof-k.z)/a.dof+")";c.fillStyle="rgba("+h+","+(a.dof-k.z)/a.dof+")";try{c.beginPath();c.lineWidth=0.5*((a.dof-k.z)/a.dof);c.moveTo(q.x-prevPX-0.5,q.y-prevPY-0.5);c.lineTo(q.x+prevPX-0.5,q.y+prevPY-0.5);c.lineTo(k.x+r-0.5,k.y+m-0.5);c.lineTo(k.x-r-0.5,k.y-m-0.5);c.lineTo(q.x-
prevPX-0.5,q.y-prevPY-0.5);c.fill();c.stroke()}catch(n){}o.minX=k.x<o.minX?k.x:o.minX;o.minY=k.y<o.minY?k.y:o.minY;o.maxX=k.x>o.maxX?k.x:o.maxX;o.maxY=k.y>o.maxY?k.y:o.maxY;q=k;prevPX=r;prevPY=m}else{if(g!=0&&k.z<1500){q=Mark.renderer.translatePoint(b[g-1][b[g-1].length-1],e);if(q.z&&q.z<a.dof){c.strokeStyle="rgba(0,0,0,0.3)";c.lineWidth=1;c.beginPath();c.dashedLineTo(q.x,q.y,k.x,k.y,[6,4]);c.closePath();c.stroke()}}q=k;prevPY=prevPX=0}}return o}};a.connectionBrush=function(c,b,e,h,g,j,k){h={offset:h,
w:j,h:k,mode:"pinhole"};b=Mark.renderer.translatePoint(b,h);h.offset=g;e=Mark.renderer.translatePoint(e,h);if(!((b.x>j||b.x<0||b.y>k||b.y<0)&&(e.x>j||e.x<0||e.y>k||e.y<0)))if(!(b.z&&e.z&&(b.z>a.dof||b.z<0)&&(e.z>a.dof||e.z<0))){c.strokeStyle="rgba(0,0,0,"+(a.dof-b.z)/(a.dof*2)+")";g=3*(2/b.z)*(k/2);if(g<1)g=1;c.lineWidth=g;c.beginPath();c.dashedLineTo(b.x,b.y,e.x,e.y,[6,4]);c.closePath();c.stroke()}};a.thickBrush=function(c,b,e,h,g){e=e?e:0;h=h?h:0;g=g?g:1;for(var j=0;j<b.length;j++)if(!(typeof b[j]==
"undefined"||b[j].length<=1)){if(j>0){c.strokeStyle="rgba(0,0,0,0.1)";c.lineWidth=1;c.beginPath();c.dashedLineTo(b[j-1][b[j-1].length-1].x+e,b[j-1][b[j-1].length-1].y+h,b[j][0].x+e,b[j][0].y+h,[6,4]);c.closePath();c.stroke()}c.lineWidth=1;c.strokeStyle="#000000";c.fillStyle="#000000";for(var k=0,o=0,q=b[j][0].x,s=b[j][0].y,r=1;r<b[j].length;r++){var m=b[j][r];if(!(m.significance<g)){if(r==b[j].length-1)var n=0,f=0;else{f=9-Math.pow(m.speed+1,3);if(f<0.5)f=0.5;f+=1;n=Math.cos(m.angle)*f;f=Math.sin(m.angle)*
f}try{c.beginPath();c.moveTo(q-k-0.5+e,s-o-0.5+h);c.lineTo(q+k-0.5+e,s+o-0.5+h);c.lineTo(m.x+n-0.5+e,m.y+f-0.5+h);c.lineTo(m.x-n-0.5+e,m.y-f-0.5+h);c.lineTo(q-k-0.5+e,s-o-0.5+h);c.fill();c.stroke()}catch(i){}k=n;o=f;q=m.x;s=m.y;prevAng=m.angle}}}};a.circleMarkBrush=function(c,b,e){for(var h=3,g=0;g<b.length;g++)if(b[g].length!=0)for(var j=0;j<b[g].length;j++){var k=Mark.renderer.translatePoint(b[g][j],e);if(!(k.z&&k.z>a.dof)){h=3*((a.dof-k.z)/a.dof);c.fillStyle="rgba(255,255,255,0.4)";c.strokeStyle=
"rgba(255,255,255,0.4)";c.beginPath();c.arc(k.x,k.y,h,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.lineTo(k.x,k.y)}}};a.circleBrush=function(c,b,e,h,g){e=e?e:0;h=h?h:0;g=g?g:1;for(var j=0;j<b.length;j++)if(b[j].length!=0){c.beginPath();for(var k=0;k<b[j].length;k++){var o=b[j][k];if(!(o.significance<g)){c.beginPath();c.arc(o.x+e,o.y+h,3,0,Math.PI*2,true);c.closePath();c.fill();c.stroke();c.lineTo(o.x+e,o.y+h)}}}};return a}(Mark||{});
Mark=function(a){a.gmlMark=function(c,b,e,h,g,j,k){this.strokes=c;this.country_code=e;this.time=h;this.rtl=g;this.maxTime=0;this.reference=b;this.hoverState=false;this.renderedBounds=null;this.id=j?j:null;this.is_approved=k;this.contributor_url=this.extra_info=this.contributor_name=null;this.color="0,0,0";this.y=this.x=0;this.position={x:0,y:0,z:0};this.rotationAngle={x:0,y:0,z:0};this.bHeight=this.bWidth=this.sY=this.sX=0;this.init=function(){this.strokes.length>0&&this.setupVars()};this.setupVars=
function(){this.maxTime=this.lastPoint().time;this.getBoundingBox()};this.leftmostStrokeStart=function(){for(var o=this.strokes[0][0],q=1;q<this.strokes.length;q++){var s=this.strokes[q][0];if(s.x<o.x)o=s}return o};this.rightmostStrokeEnd=function(){for(var o=this.strokes[0][this.strokes[0].length-1],q=1;q<this.strokes.length;q++){var s=this.strokes[q][this.strokes[q].length-1];if(s.x>o.x)o=s}return o};this.firstPoint=function(){return this.strokes[0][0]};this.lastPoint=function(){return this.strokes[this.strokes.length-
1][this.strokes[this.strokes.length-1].length-1]};this.translatePoint=function(o){var q=o.clone();q.x=this.x+o.x;q.y=this.y+o.y;return q};this.getBoundingBox=function(){var o=this.strokes[0][0],q=o.x,s=o.x,r=o.y;o=o.y;for(var m=0;m<this.strokes.length;m++)for(var n=0;n<this.strokes[m].length;n++){var f=this.strokes[m][n];q=f.x>q?f.x:q;r=f.y>r?f.y:r;s=f.x<s?f.x:s;o=f.y<o?f.y:o}this.bWidth=q-s;this.bHeight=r-o;this.x=s;this.y=o;if(s!=0||o!=0)this.fitPointsToBounds(s,o)};this.fitPointsToBounds=function(o,
q){for(var s=0;s<this.strokes.length;s++)for(var r=0;r<this.strokes[s].length;r++){this.strokes[s][r].x-=o;this.strokes[s][r].y-=q}};this.strokesAtTime=function(o){if(o>this.maxTime)return this.strokes;for(var q=[[]],s=[0,0],r=this.strokes[s[0]][s[1]];r.time<o;){q[q.length-1].push(r);s[1]++;if(this.strokes[s[0]].length==s[1]){s[0]++;s[1]=0;q.push([])}r=this.strokes[s[0]][s[1]]}return q};this.positionRelativeTo=function(o,q){if(q=q?!!q:false){this.position.x=o.position.x-50-this.bWidth;this.position.y=
o.position.y+o.leftmostStrokeStart().y-this.rightmostStrokeEnd().y;this.position.z=o.position.z-this.maxTime/50}else{this.position.x=o.position.x+o.bWidth+this.leftmostStrokeStart().x+50;this.position.y=o.position.y+o.rightmostStrokeEnd().y-this.leftmostStrokeStart().y;this.position.z=o.position.z+o.maxTime/50}};this.positionToStart=function(){this.position.x=0;this.position.y=0;this.position.z=0};this.init()};return a}(Mark||{});
Mark=function(a){a.scene=function(){this.camera=new Mark.camera;this.objects=[];this.canvasContext=null;this.timers={};this.init=function(){};this.addObject=function(c){this.objects.push(c)};this.removeObject=function(c){this.objects.splice(c,1)};this.update=function(){var c=(new Date).getTime();for(a in this.timers)this.timers[a].end<c&&delete this.timers[a]};this.init()};return a}(Mark||{});
Mark=function(a){a.renderer={translatePoint:function(c,b){var e={flatScale:function(g,j){var k="offset"in j&&"x"in j.offset?j.offset.x:0,o="offset"in j&&"y"in j.offset?j.offset.y:0,q="scale"in j&&"y"in j.scale?j.scale.y:1;g.x*="scale"in j&&"x"in j.scale?j.scale.x:1;g.y*=q;g.x+=k;g.y+=o;return g},pinhole:function(g,j){var k="offset"in j&&"y"in j.offset?j.offset.y:0,o="offset"in j&&"z"in j.offset?j.offset.z:0,q="w"in j?j.w:500,s="h"in j?j.h:500;g.x+="offset"in j&&"x"in j.offset?j.offset.x:0;g.y+=k;
g.z=g.x>0?Math.pow((g.x- -100)/100,2)+o:Math.pow((g.x- -100)/100/2,2)+o;if(g.time)g.z+=g.time/50;k=2/g.z;g.x=g.x*k*(s/2)+q/2;g.y=g.y*k*(s/2)+s/2;return g}},h={x:c.x,y:c.y,z:c.z,time:c.time,significance:c.significance,angle:c.angle,speed:c.speed};return"mode"in b&&b.mode in e?e[b.mode](h,b):e.pinhole(h,b)},strokesAtTime:function(c,b){for(var e=[[]],h=[0,0],g=c[h[0]][h[1]];g.time<b;){e[e.length-1].push(g);h[1]++;if(c[h[0]].length==h[1]){if(c.length==h[0]+1)break;h[0]++;h[1]=0;e.push([])}g=c[h[0]][h[1]]}return e},
renderScene:function(c,b){for(var e=b.width,h=b.height,g=c.objects.length-1;g>=0;g--){var j={x:c.objects[g].position.x-c.camera.position.x,y:c.objects[g].position.y-c.camera.position.y,z:c.objects[g].position.z-c.camera.position.z};colorBase=c.objects[g].color;var k={offset:j,w:b.width,h:b.height,mode:"pinhole"};if(g<c.objects.length-1&&!(c.objects[g].reference in c.timers)){k={x:c.objects[g+1].position.x-c.camera.position.x,y:c.objects[g+1].position.y-c.camera.position.y,z:c.objects[g+1].position.z-
c.camera.position.z};var o={x:c.objects[g].position.x-c.camera.position.x,y:c.objects[g].position.y-c.camera.position.y,z:c.objects[g].position.z-c.camera.position.z},q=c.objects[g+1].leftmostStrokeStart(),s=c.objects[g].rightmostStrokeEnd();Mark.connectionBrush(c.canvasContext,q,s,k,o,e,h)}k={offset:j,w:b.width,h:b.height,mode:"pinhole"};if(c.objects[g].reference in c.timers){if((j=a.renderer.strokesAtTime(c.objects[g].strokes,((new Date).getTime()-c.timers[c.objects[g].reference].start)*c.timers[c.objects[g].reference].speed))&&
j.length>0&&j[0].length>0)c.objects[g].renderedBounds=Mark.thickMarkBrush(c.canvasContext,j,k,colorBase,b.width,b.height)}else c.objects[g].renderedBounds=Mark.thickMarkBrush(c.canvasContext,c.objects[g].strokes,k,colorBase,b.width,b.height)}},renderMark:function(c,b,e){var h={offset:e.offset,scale:e.scale,mode:"flatScale"};if("timer"in e&&e.timer){var g=a.renderer.strokesAtTime(b.strokes,((new Date).getTime()-e.timer.start)*e.timer.speed);if(g&&g.length>0&&g[0].length>0)b.renderedBounds=Mark.thickMarkBrush(c,
g,h,e.color)}else b.renderedBounds=Mark.thickMarkBrush(c,b.strokes,h,e.color)}};return a}(Mark||{});Mark=function(a){a.camera=function(){this.position=new a.vector(0,0,-1E3)};return a}(Mark||{});Mark=function(a){a.vector=function(c,b,e){this.x=c||0;this.y=b||0;this.z=e||0};return a}(Mark||{});
var TWEEN=TWEEN||function(){var a,c,b,e=[];this.add=function(h){e.push(h)};this.remove=function(h){a=e.indexOf(h);a!==-1&&e.splice(a,1)};this.update=function(){a=0;c=e.length;for(b=(new Date).getTime();a<c;)if(e[a].update(b))a++;else{e.splice(a,1);c--}};return this}();
TWEEN.Tween=function(a){var c={},b={},e={},h=1E3,g=0,j=null,k=TWEEN.Easing.Linear.EaseNone,o=null,q=null,s=null;this.to=function(r,m){if(m!==null)h=m;for(var n in r)if(a[n]!==null)e[n]=r[n];return this};this.start=function(){TWEEN.add(this);j=(new Date).getTime()+g;for(var r in e)if(a[r]!==null){c[r]=a[r];b[r]=e[r]-a[r]}return this};this.stop=function(){TWEEN.remove(this);return this};this.delay=function(r){g=r;return this};this.easing=function(r){k=r;return this};this.chain=function(r){o=r};this.onUpdate=
function(r){q=r;return this};this.onComplete=function(r){s=r;return this};this.update=function(r){var m,n;if(r<j)return true;r=(r-j)/h;r=r>1?1:r;n=k(r);for(m in b)a[m]=c[m]+b[m]*n;q!==null&&q.call(a,n);if(r==1){s!==null&&s.call(a);o!==null&&o.start();return false}return true}};TWEEN.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};TWEEN.Easing.Linear.EaseNone=function(a){return a};
TWEEN.Easing.Quadratic.EaseIn=function(a){return a*a};TWEEN.Easing.Quadratic.EaseOut=function(a){return-a*(a-2)};TWEEN.Easing.Quadratic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a;return-0.5*(--a*(a-2)-1)};TWEEN.Easing.Cubic.EaseIn=function(a){return a*a*a};TWEEN.Easing.Cubic.EaseOut=function(a){return--a*a*a+1};TWEEN.Easing.Cubic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a;return 0.5*((a-=2)*a*a+2)};TWEEN.Easing.Quartic.EaseIn=function(a){return a*a*a*a};
TWEEN.Easing.Quartic.EaseOut=function(a){return-(--a*a*a*a-1)};TWEEN.Easing.Quartic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a;return-0.5*((a-=2)*a*a*a-2)};TWEEN.Easing.Quintic.EaseIn=function(a){return a*a*a*a*a};TWEEN.Easing.Quintic.EaseOut=function(a){return(a-=1)*a*a*a*a+1};TWEEN.Easing.Quintic.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*a*a*a;return 0.5*((a-=2)*a*a*a*a+2)};TWEEN.Easing.Sinusoidal.EaseIn=function(a){return-Math.cos(a*Math.PI/2)+1};
TWEEN.Easing.Sinusoidal.EaseOut=function(a){return Math.sin(a*Math.PI/2)};TWEEN.Easing.Sinusoidal.EaseInOut=function(a){return-0.5*(Math.cos(Math.PI*a)-1)};TWEEN.Easing.Exponential.EaseIn=function(a){return a==0?0:Math.pow(2,10*(a-1))};TWEEN.Easing.Exponential.EaseOut=function(a){return a==1?1:-Math.pow(2,-10*a)+1};TWEEN.Easing.Exponential.EaseInOut=function(a){if(a==0)return 0;if(a==1)return 1;if((a*=2)<1)return 0.5*Math.pow(2,10*(a-1));return 0.5*(-Math.pow(2,-10*(a-1))+2)};
TWEEN.Easing.Circular.EaseIn=function(a){return-(Math.sqrt(1-a*a)-1)};TWEEN.Easing.Circular.EaseOut=function(a){return Math.sqrt(1- --a*a)};TWEEN.Easing.Circular.EaseInOut=function(a){if((a/=0.5)<1)return-0.5*(Math.sqrt(1-a*a)-1);return 0.5*(Math.sqrt(1-(a-=2)*a)+1)};TWEEN.Easing.Elastic.EaseIn=function(a){var c,b=0.1,e=0.4;if(a==0)return 0;if(a==1)return 1;e||(e=0.3);if(!b||b<1){b=1;c=e/4}else c=e/(2*Math.PI)*Math.asin(1/b);return-(b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/e))};
TWEEN.Easing.Elastic.EaseOut=function(a){var c,b=0.1,e=0.4;if(a==0)return 0;if(a==1)return 1;e||(e=0.3);if(!b||b<1){b=1;c=e/4}else c=e/(2*Math.PI)*Math.asin(1/b);return b*Math.pow(2,-10*a)*Math.sin((a-c)*2*Math.PI/e)+1};
TWEEN.Easing.Elastic.EaseInOut=function(a){var c,b=0.1,e=0.4;if(a==0)return 0;if(a==1)return 1;e||(e=0.3);if(!b||b<1){b=1;c=e/4}else c=e/(2*Math.PI)*Math.asin(1/b);if((a*=2)<1)return-0.5*b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/e);return b*Math.pow(2,-10*(a-=1))*Math.sin((a-c)*2*Math.PI/e)*0.5+1};TWEEN.Easing.Back.EaseIn=function(a){return a*a*(2.70158*a-1.70158)};TWEEN.Easing.Back.EaseOut=function(a){return(a-=1)*a*(2.70158*a+1.70158)+1};
TWEEN.Easing.Back.EaseInOut=function(a){if((a*=2)<1)return 0.5*a*a*(3.5949095*a-2.5949095);return 0.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)};TWEEN.Easing.Bounce.EaseIn=function(a){return 1-TWEEN.Easing.Bounce.EaseOut(1-a)};TWEEN.Easing.Bounce.EaseOut=function(a){return(a/=1)<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375};
TWEEN.Easing.Bounce.EaseInOut=function(a){if(a<0.5)return TWEEN.Easing.Bounce.EaseIn(a*2)*0.5;return TWEEN.Easing.Bounce.EaseOut(a*2-1)*0.5+0.5};
(function(a,c){var b,e=/:([\w\d]+)/g,h=/\?([^#]*)$/,g=function(f){return Array.prototype.slice.call(f)},j=function(f){return Object.prototype.toString.call(f)==="[object Function]"},k=function(f){return Object.prototype.toString.call(f)==="[object Array]"},o=function(f){return decodeURIComponent(f.replace(/\+/g," "))},q=encodeURIComponent,s=function(f){return String(f).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},r=function(f){return function(i,l){return this.route.apply(this,
[f,i,l])}},m={},n=[];b=function(){var f=g(arguments),i,l;b.apps=b.apps||{};if(f.length===0||f[0]&&j(f[0]))return b.apply(b,["body"].concat(f));else if(typeof(l=f.shift())=="string"){i=b.apps[l]||new b.Application;i.element_selector=l;f.length>0&&a.each(f,function(p,u){i.use(u)});i.element_selector!=l&&delete b.apps[l];return b.apps[i.element_selector]=i}};b.VERSION="0.6.3";b.addLogger=function(f){n.push(f)};b.log=function(){var f=g(arguments);f.unshift("["+Date()+"]");a.each(n,function(i,l){l.apply(b,
f)})};if(typeof c.console!="undefined")j(c.console.log.apply)?b.addLogger(function(){c.console.log.apply(c.console,arguments)}):b.addLogger(function(){c.console.log(arguments)});else typeof console!="undefined"&&b.addLogger(function(){console.log.apply(console,arguments)});a.extend(b,{makeArray:g,isFunction:j,isArray:k});b.Object=function(f){return a.extend(this,f||{})};a.extend(b.Object.prototype,{escapeHTML:s,h:s,toHash:function(){var f={};a.each(this,function(i,l){j(l)||(f[i]=l)});return f},toHTML:function(){var f=
"";a.each(this,function(i,l){j(l)||(f+="<strong>"+i+"</strong> "+l+"<br />")});return f},keys:function(f){var i=[],l;for(l in this)if(!j(this[l])||!f)i.push(l);return i},has:function(f){return this[f]&&a.trim(this[f].toString())!=""},join:function(){var f=g(arguments),i=f.shift();return f.join(i)},log:function(){b.log.apply(b,arguments)},toString:function(f){var i=[];a.each(this,function(l,p){if(!j(p)||f)i.push('"'+l+'": '+p.toString())});return"Sammy.Object: {"+i.join(",")+"}"}});b.HashLocationProxy=
function(f,i){this.app=f;this.is_native=false;this._startPolling(i)};b.HashLocationProxy.prototype={bind:function(){var f=this,i=this.app;a(c).bind("hashchange."+this.app.eventNamespace(),function(l,p){if(f.is_native===false&&!p){b.log("native hash change exists, using");f.is_native=true;c.clearInterval(b.HashLocationProxy._interval)}i.trigger("location-changed")});if(!b.HashLocationProxy._bindings)b.HashLocationProxy._bindings=0;b.HashLocationProxy._bindings++},unbind:function(){a(c).unbind("hashchange."+
this.app.eventNamespace());b.HashLocationProxy._bindings--;b.HashLocationProxy._bindings<=0&&c.clearInterval(b.HashLocationProxy._interval)},getLocation:function(){var f=c.location.toString().match(/^[^#]*(#.+)$/);return f?f[1]:""},setLocation:function(f){return c.location=f},_startPolling:function(f){var i=this;if(!b.HashLocationProxy._interval){f||(f=10);var l=function(){var p=i.getLocation();if(!b.HashLocationProxy._last_location||p!=b.HashLocationProxy._last_location)c.setTimeout(function(){a(c).trigger("hashchange",
[true])},13);b.HashLocationProxy._last_location=p};l();b.HashLocationProxy._interval=c.setInterval(l,f)}}};b.Application=function(f){var i=this;this.routes={};this.listeners=new b.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+"-"+parseInt(Math.random()*1E3,10);this.context_prototype=function(){b.EventContext.apply(this,arguments)};this.context_prototype.prototype=new b.EventContext;j(f)&&f.apply(this,[this]);this._location_proxy||this.setLocationProxy(new b.HashLocationProxy(this,
this.run_interval_every));this.debug&&this.bindToAllEvents(function(l,p){i.log(i.toString(),l.cleaned_type,p||{})})};b.Application.prototype=a.extend({},b.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect","location-changed"],_last_route:null,_location_proxy:null,_running:false,element_selector:"body",debug:false,raise_errors:false,
run_interval_every:50,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(f){return f?a(this.element_selector).find(f):a(this.element_selector)},use:function(){var f=g(arguments),i=f.shift(),l=i||"";try{f.unshift(this);if(typeof i=="string"){l="Sammy."+i;i=b[i]}i.apply(this,f)}catch(p){if(typeof i==="undefined")this.error("Plugin Error: called use() but plugin ("+l.toString()+") is not defined",p);else j(i)?this.error("Plugin Error",p):this.error("Plugin Error: called use() but '"+
l.toString()+"' is not a function",p)}return this},setLocationProxy:function(f){var i=this._location_proxy;this._location_proxy=f;if(this.isRunning()){i&&i.unbind();this._location_proxy.bind()}},route:function(f,i,l){var p=this,u=[],t,v;if(!l&&j(i)){l=i=f;f="any"}f=f.toLowerCase();if(i.constructor==String){for(e.lastIndex=0;(v=e.exec(i))!==null;)u.push(v[1]);i=RegExp("^"+i.replace(e,"([^/]+)")+"$")}if(typeof l=="string")l=p[l];t=function(w){var x={verb:w,path:i,callback:l,param_names:u};p.routes[w]=
p.routes[w]||[];p.routes[w].push(x)};f==="any"?a.each(this.ROUTE_VERBS,function(w,x){t(x)}):t(f);return this},get:r("get"),post:r("post"),put:r("put"),del:r("delete"),any:r("any"),mapRoutes:function(f){var i=this;a.each(f,function(l,p){i.route.apply(i,p)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(f,i,l){var p=this;if(typeof l=="undefined")l=i;i=function(u,t){var v;if(t&&t.context){v=t.context;delete t.context}else v=new p.context_prototype(p,
"bind",u.type,t,u.target);u.cleaned_type=u.type.replace(p.eventNamespace(),"");l.apply(v,[u,t])};this.listeners[f]||(this.listeners[f]=[]);this.listeners[f].push(i);this.isRunning()&&this._listen(f,i);return this},trigger:function(f,i){this.$element().trigger([f,this.eventNamespace()].join("."),[i]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(f,i){if(j(f)){i=f;f={}}this.befores.push([f,i]);return this},after:function(f){return this.bind("event-context-after",
f)},around:function(f){this.arounds.push(f);return this},isRunning:function(){return this._running},helpers:function(f){a.extend(this.context_prototype.prototype,f);return this},helper:function(f,i){this.context_prototype.prototype[f]=i;return this},run:function(f){if(this.isRunning())return false;var i=this;a.each(this.listeners.toHash(),function(l,p){a.each(p,function(u,t){i._listen(l,t)})});this.trigger("run",{start_url:f});this._running=true;this.last_location=null;this.getLocation()==""&&typeof f!=
"undefined"&&this.setLocation(f);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){i._checkLocation()});this.bind("submit",function(l){return i._checkFormSubmission(a(l.target).closest("form"))===false?l.preventDefault():false});a(c).bind("beforeunload",function(){i.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning())return false;var f=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(f.eventNamespace());
a.each(this.listeners.toHash(),function(i,l){a.each(l,function(p,u){f._unlisten(i,u)})});this._running=false;return this},bindToAllEvents:function(f){var i=this;a.each(this.APP_EVENTS,function(l,p){i.bind(p,f)});a.each(this.listeners.keys(true),function(l,p){i.APP_EVENTS.indexOf(p)==-1&&i.bind(p,f)});return this},routablePath:function(f){return f.replace(h,"")},lookupRoute:function(f,i){var l=this,p=false;this.trigger("lookup-route",{verb:f,path:i});typeof this.routes[f]!="undefined"&&a.each(this.routes[f],
function(u,t){if(l.routablePath(i).match(t.path)){p=t;return false}});return p},runRoute:function(f,i,l,p){var u=this,t=this.lookupRoute(f,i),v,w,x,y,C,B,D;this.log("runRoute",[f,i].join(" "));this.trigger("run-route",{verb:f,path:i,params:l});if(typeof l=="undefined")l={};a.extend(l,this._parseQueryString(i));if(t){this.trigger("route-found",{route:t});if((B=t.path.exec(this.routablePath(i)))!==null){B.shift();a.each(B,function(z,A){if(t.param_names[z])l[t.param_names[z]]=o(A);else{if(!l.splat)l.splat=
[];l.splat.push(o(A))}})}v=new this.context_prototype(this,f,i,l,p);p=this.arounds.slice(0);x=this.befores.slice(0);C=[v].concat(l.splat);w=function(){for(var z;x.length>0;){y=x.shift();if(u.contextMatchesOptions(v,y[0])){z=y[1].apply(v,[v]);if(z===false)return false}}u.last_route=t;v.trigger("event-context-before",{context:v});z=t.callback.apply(v,C);v.trigger("event-context-after",{context:v});return z};a.each(p.reverse(),function(z,A){var E=w;w=function(){return A.apply(v,[E])}});try{D=w()}catch(F){this.error(["500 Error",
f,i].join(" "),F)}return D}else return this.notFound(f,i)},contextMatchesOptions:function(f,i,l){i=i;if(typeof i==="undefined"||i=={})return true;if(typeof l==="undefined")l=true;if(typeof i==="string"||j(i.test))i={path:i};if(i.only)return this.contextMatchesOptions(f,i.only,true);else if(i.except)return this.contextMatchesOptions(f,i.except,false);var p=true,u=true;if(i.path)p=j(i.path.test)?i.path.test(f.path):i.path.toString()===f.path;if(i.verb)u=i.verb===f.verb;return l?u&&p:!(u&&p)},getLocation:function(){return this._location_proxy.getLocation()},
setLocation:function(f){return this._location_proxy.setLocation(f)},swap:function(f){return this.$element().html(f)},templateCache:function(f,i){return typeof i!="undefined"?m[f]=i:m[f]},clearTemplateCache:function(){return m={}},notFound:function(f,i){var l=this.error(["404 Not Found",f,i].join(" "));return f==="get"?l:true},error:function(f,i){i||(i=Error());i.message=[f,i.message].join(" ");this.trigger("error",{message:i.message,error:i});if(this.raise_errors)throw i;else this.log(i.message,i)},
_checkLocation:function(){var f,i;f=this.getLocation();if(!this.last_location||this.last_location[0]!="get"||this.last_location[1]!=f){this.last_location=["get",f];i=this.runRoute("get",f)}return i},_getFormVerb:function(f){f=a(f);var i,l;l=f.find('input[name="_method"]');if(l.length>0)i=l.val();i||(i=f[0].getAttribute("method"));if(!i||i=="")i="get";return a.trim(i.toString().toLowerCase())},_checkFormSubmission:function(f){var i,l,p;this.trigger("check-form-submission",{form:f});i=a(f);l=i.attr("action");
p=this._getFormVerb(i);this.log("_checkFormSubmission",i,l,p);if(p==="get"){this.setLocation(l+"?"+this._serializeFormParams(i));f=false}else{i=a.extend({},this._parseFormParams(i));f=this.runRoute(p,l,i,f.get(0))}return typeof f=="undefined"?false:f},_serializeFormParams:function(f){var i="";f=f.serializeArray();var l;if(f.length>0){i=this._encodeFormPair(f[0].name,f[0].value);for(l=1;l<f.length;l++)i=i+"&"+this._encodeFormPair(f[l].name,f[l].value)}return i},_encodeFormPair:function(f,i){return q(f)+
"="+q(i)},_parseFormParams:function(f){var i={};f=f.serializeArray();var l;for(l=0;l<f.length;l++)i=this._parseParamPair(i,f[l].name,f[l].value);return i},_parseQueryString:function(f){var i={},l,p;if(f=f.match(h)){f=f[1].split("&");for(p=0;p<f.length;p++){l=f[p].split("=");i=this._parseParamPair(i,o(l[0]),o(l[1]))}}return i},_parseParamPair:function(f,i,l){if(f[i])if(k(f[i]))f[i].push(l);else f[i]=[f[i],l];else f[i]=l;return f},_listen:function(f,i){return this.$element().bind([f,this.eventNamespace()].join("."),
i)},_unlisten:function(f,i){return this.$element().unbind([f,this.eventNamespace()].join("."),i)}});b.RenderContext=function(f){this.event_context=f;this.callbacks=[];this.content=this.previous_content=null;this.waiting=this.next_engine=false};b.RenderContext.prototype=a.extend({},b.Object.prototype,{then:function(f){if(!j(f))if(typeof f==="string"&&f in this.event_context){var i=this.event_context[f];f=function(p){return i.apply(this.event_context,[p])}}else return this;var l=this;if(this.waiting)this.callbacks.push(f);
else{this.wait();c.setTimeout(function(){var p=f.apply(l,[l.content,l.previous_content]);p!==false&&l.next(p)},13)}return this},wait:function(){this.waiting=true},next:function(f){this.waiting=false;if(typeof f!=="undefined"){this.previous_content=this.content;this.content=f}this.callbacks.length>0&&this.then(this.callbacks.shift())},load:function(f,i,l){var p=this;return this.then(function(){var u,t,v;if(j(i)){l=i;i={}}else i=a.extend({},i);l&&this.then(l);if(typeof f==="string"){u=(v=f.match(/\.json$/)||
i.json)&&i.cache===true||i.cache!==false;p.next_engine=p.event_context.engineFor(f);delete i.cache;delete i.json;if(i.engine){p.next_engine=i.engine;delete i.engine}if(u&&(t=this.event_context.app.templateCache(f)))return t;this.wait();a.ajax(a.extend({url:f,data:{},dataType:v?"json":null,type:"get",success:function(w){u&&p.event_context.app.templateCache(f,w);p.next(w)}},i));return false}else{if(f.nodeType)return f.innerHTML;if(f.selector){p.next_engine=f.attr("data-engine");return i.clone===false?
f.remove()[0].innerHTML.toString():f[0].innerHTML.toString()}}})},render:function(f,i,l){if(j(f)&&!i)return this.then(f);else{if(!i&&this.content)i=this.content;return this.load(f).interpolate(i,f).then(l)}},partial:function(f,i){return this.render(f,i).swap()},send:function(){var f=this,i=g(arguments),l=i.shift();if(k(i[0]))i=i[0];return this.then(function(){i.push(function(p){f.next(p)});f.wait();l.apply(l,i);return false})},collect:function(f,i,l){var p=this,u=function(){if(j(f)){i=f;f=this.content}var t=
[],v=false;a.each(f,function(w,x){var y=i.apply(p,[w,x]);if(y.jquery&&y.length==1){y=y[0];v=true}t.push(y);return y});return v?t:t.join("")};return l?u():this.then(u)},renderEach:function(f,i,l,p){if(k(i)){p=l;l=i;i=null}return this.load(f).then(function(u){var t=this;l||(l=k(this.previous_content)?this.previous_content:[]);if(p)a.each(l,function(v,w){var x={},y=this.next_engine||f;i?x[i]=w:x=w;p(w,t.event_context.interpolate(u,x,y))});else return this.collect(l,function(v,w){var x={},y=this.next_engine||
f;i?x[i]=w:x=w;return this.event_context.interpolate(u,x,y)},true)})},interpolate:function(f,i,l){var p=this;return this.then(function(u,t){if(!f&&t)f=t;if(this.next_engine){i=this.next_engine;this.next_engine=false}var v=p.event_context.interpolate(u,f,i);return l?t+v:v})},swap:function(){return this.then(function(f){this.event_context.swap(f)}).trigger("changed",{})},appendTo:function(f){return this.then(function(i){a(f).append(i)}).trigger("changed",{})},prependTo:function(f){return this.then(function(i){a(f).prepend(i)}).trigger("changed",
{})},replace:function(f){return this.then(function(i){a(f).html(i)}).trigger("changed",{})},trigger:function(f,i){return this.then(function(l){if(typeof i=="undefined")i={content:l};this.event_context.trigger(f,i)})}});b.EventContext=function(f,i,l,p,u){this.app=f;this.verb=i;this.path=l;this.params=new b.Object(p);this.target=u};b.EventContext.prototype=a.extend({},b.Object.prototype,{$element:function(){return this.app.$element(g(arguments).shift())},engineFor:function(f){var i;if(j(f))return f;
f=(f||this.app.template_engine).toString();if(i=f.match(/\.([^\.]+)$/))f=i[1];if(f&&j(this[f]))return this[f];if(this.app.template_engine)return this.engineFor(this.app.template_engine);return function(l){return l}},interpolate:function(f,i,l){return this.engineFor(l).apply(this,[f,i])},render:function(f,i,l){return(new b.RenderContext(this)).render(f,i,l)},renderEach:function(f,i,l,p){return(new b.RenderContext(this)).renderEach(f,i,l,p)},load:function(f,i,l){return(new b.RenderContext(this)).load(f,
i,l)},partial:function(f,i){return(new b.RenderContext(this)).partial(f,i)},send:function(){var f=new b.RenderContext(this);return f.send.apply(f,arguments)},redirect:function(){var f;f=g(arguments);var i=this.app.getLocation();if(f.length>1){f.unshift("/");f=this.join.apply(this,f)}else f=f[0];this.trigger("redirect",{to:f});this.app.last_location=[this.verb,this.path];this.app.setLocation(f);i==f&&this.app.trigger("location-changed")},trigger:function(f,i){if(typeof i=="undefined")i={};if(!i.context)i.context=
this;return this.app.trigger(f,i)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(f){return this.app.swap(f)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(f){return a.parseJSON(f)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});a.sammy=c.Sammy=b})(jQuery,window);
Sammy.HashPushProxy=function(a,c){this.app=a;this.supportsHistory=!!(window.history&&history.pushState);if(!this.supportsHistory){this._startPolling(c);this.is_native=false}};
Sammy.HashPushProxy.prototype={bind:function(){var a=this,c=this.app;if(this.app.supportsHistory){$(window).bind("popstate",function(){a.app.trigger("location-changed")});$("a").live("click",function(b){if(location.hostname==this.hostname){b.preventDefault();a.historyAPISupported?a.setLocation($(this).attr("href")):a.setLocation("#"+$(this).attr("href"));a.app.trigger("location-changed")}})}else{$(window).bind("hashchange."+this.app.eventNamespace(),function(b,e){if(a.is_native===false&&!e){Sammy.log("native hash change exists, using");
a.is_native=true;window.clearInterval(Sammy.HashLocationProxy._interval)}c.trigger("location-changed")});if(!Sammy.HashLocationProxy._bindings)Sammy.HashLocationProxy._bindings=0;Sammy.HashLocationProxy._bindings++}},unbind:function(){if(this.app.supportsHistory){$("a").unbind("click");$(window).unbind("popstate")}else{$(window).unbind("hashchange."+this.app.eventNamespace());Sammy.HashLocationProxy._bindings--;Sammy.HashLocationProxy._bindings<=0&&window.clearInterval(Sammy.HashLocationProxy._interval)}},
getLocation:function(){if(this.app.supportsHistory)return window.location.pathname;else{var a=window.location.toString().match(/^[^#]*(#.+)$/);return a?a[1]:""}},setLocation:function(a){if(this.app.supportsHistory)history.pushState({path:this.path},"",a);else return window.location=a},_startPolling:function(a){var c=this;if(!Sammy.HashLocationProxy._interval){a||(a=10);var b=function(){var e=c.getLocation();if(!Sammy.HashLocationProxy._last_location||e!=Sammy.HashLocationProxy._last_location)window.setTimeout(function(){$(window).trigger("hashchange",
[true])},13);Sammy.HashLocationProxy._last_location=e};b();Sammy.HashLocationProxy._interval=window.setInterval(b,a)}}};
(function(a){var c={};Sammy=Sammy||{};Sammy.Template=function(b,e){e||(e="template");b.helper(e,function(h,g,j,k){if(typeof j=="undefined")j=h;if(typeof k=="undefined"&&typeof j=="object"){k=j;j=h}a:{g=a.extend({},this,g);if(c[j])h=c[j];else{if(typeof h=="undefined"){h=false;break a}k=k&&k.escape_html===false?'",$1,"':'",h($1),"';h=c[j]=new Function("obj",'var ___$$$___=[],print=function(){___$$$___.push.apply(___$$$___,arguments);};with(obj){___$$$___.push("'+String(h).replace(/[\r\t\n]/g," ").replace(/\"/g,
'\\"').split("<%").join("\t").replace(/((^|%>)[^\t]*)/g,"$1\r").replace(/\t=(.*?)%>/g,k).replace(/\t!(.*?)%>/g,'",$1,"').split("\t").join('");').split("%>").join('___$$$___.push("').split("\r").join("")+"\");}return ___$$$___.join('');")}h=typeof g!="undefined"?h(g):h}return h})}})(jQuery);
(function(a){var c=a.sammy("#sammy",function(){this.get("#/",function(){a("#markapp").markApp("unloadModule","linear");this.partial("makemark_sammy.html").then(function(){a("#markapp").markApp("addModule",{capture:{state:"intro"}});a("#markapp").markApp("addModule",{intro:{}});a("#sammy").css("zIndex","")})});this.get("#/mark/new",function(b){a("#markapp").markApp("unloadModule","linear");var e={state:"drawing",invite_code:b.params.invite,contributor_type:b.params.contributor_type};if(a("#markmaker").size()>
0){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("addModule",{capture:e})}else this.partial("makemark_sammy.html").then(function(){a("body").addClass("make-your-mark");a("#markapp").markApp("addModule",{capture:e});a("#sammy").css("zIndex","")})});this.get("#/moderate",function(){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");this.partial("/en/moderate_sammy.html").then(function(){a("#markapp").markApp("addModule",{linear:{is_flagged:true,
linear_root:"moderate"}})})});this.get("#/moderate/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{is_flagged:true,linear_root:"moderate",reference_mark:b.params.splat[0],playback:b.params.playback}}):this.partial("/en/moderate_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});a("#markapp").markApp("addModule",{linear:{is_flagged:true,
linear_root:"moderate",reference_mark:b.params.splat[0],playback:b.params.playback}})})});this.get("#/linear/country/:country_code/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{country_code:b.params.country_code,reference_mark:b.params.splat[0]}}):this.partial("linear_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});
a("#markapp").markApp("addModule",{linear:{country_code:b.params.country_code,reference_mark:b.params.splat[0]}})})});this.get("#/linear/(.*)",function(b){a("#markapp").markApp("unloadModule","intro");a("#markapp").markApp("unloadModule","capture");a("#linear").size()>0?a("#markapp").markApp("addModule",{linear:{reference_mark:b.params.splat[0],playback:b.params.playback}}):this.partial("linear_sammy.html").then(function(){a("#sammy").css("zIndex","");a("#markapp").css({zIndex:100,cursor:"default"});
a("#markapp").markApp("addModule",{linear:{reference_mark:b.params.splat[0],playback:b.params.playback}})})});this.bind("run",function(){a("#markapp").markApp().data("markApp-context").app=c});this.swap=function(b){a("body").removeClass("make-your-mark");this.$element().fadeOut("fast",function(){a(this).html(b).fadeIn("normal");a("#markapp").trigger("ready")});a("#markapp").trigger("swap")};this.use("Template")});a(document).ready(function(){if(function(){return!!("getContext"in document.createElement("canvas"))&&
!!("JSON"in window)}){a("#fallback").remove();c.run("#/")}a("#current-locale").click(function(){a(this).parent().find("ul").toggle();a(this).toggleClass("selected");return false})})})(jQuery);
